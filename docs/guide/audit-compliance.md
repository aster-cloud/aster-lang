# 审计与合规指南

> **状态**: 用户指南
> **版本**: 1.0
> **最后更新**: 2025-11-27

## 概述

Aster 提供企业级审计和合规功能，帮助组织满足 GDPR、HIPAA、SOC2 等法规要求。本指南涵盖防篡改审计日志、PII 合规检查、版本控制和回滚机制。

## 合规功能矩阵

| 功能 | GDPR | HIPAA | SOC2 | 状态 |
|------|------|-------|------|------|
| 防篡改审计日志 | ✅ Art. 30 | ✅ §164.312 | ✅ CC7.2 | 已实现 |
| PII 污点追踪 | ✅ Art. 5 | ✅ PHI 保护 | ✅ CC6.1 | 已实现 |
| 数据脱敏 | ✅ Art. 25 | ✅ Safe Harbor | ✅ CC6.6 | 已实现 |
| 同意管理 | ✅ Art. 6 | ✅ Authorization | - | 已实现 |
| 版本控制 | ✅ Art. 17 | ✅ §164.530 | ✅ CC8.1 | 已实现 |
| 来源追踪 | - | - | ✅ CC6.8 | 已实现 |

---

## 1. 防篡改审计日志

### 工作原理

Aster 使用 SHA-256 哈希链实现防篡改审计：

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Record 1   │    │  Record 2   │    │  Record 3   │
│ prev: null  │───▶│ prev: hash1 │───▶│ prev: hash2 │
│ curr: hash1 │    │ curr: hash2 │    │ curr: hash3 │
└─────────────┘    └─────────────┘    └─────────────┘
    Genesis              Chain              Chain
```

任何记录的删除、插入或修改都会导致哈希链断裂，立即被检测到。

### 哈希计算规则

```
content = prevHash + eventType + timestamp + tenantId
        + policyModule + policyFunction + success
currentHash = SHA256(content)
```

### 验证审计链

```java
import io.aster.audit.chain.AuditChainVerifier;
import io.aster.audit.chain.ChainVerificationResult;

@ApplicationScoped
public class AuditGuard {
    @Inject
    AuditChainVerifier verifier;

    public void verifyBeforeExport(String tenantId) {
        ChainVerificationResult result = verifier.verifyChainPaginated(
            tenantId,
            Instant.now().minus(14, ChronoUnit.DAYS),
            Instant.now(),
            500  // 分页大小
        );

        if (!result.isValid()) {
            throw new IllegalStateException(
                "审计链断裂，位置=" + result.getBrokenAt() +
                ", 原因=" + result.getReason()
            );
        }
    }
}
```

### 数据库 Schema

```sql
-- V2__create_audit_logs_table.sql
CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    tenant_id VARCHAR(64) NOT NULL,
    event_type VARCHAR(32) NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    policy_module VARCHAR(128),
    policy_function VARCHAR(128),
    success BOOLEAN NOT NULL,
    prev_hash VARCHAR(64),
    current_hash VARCHAR(64) NOT NULL,
    metadata JSONB,
    CONSTRAINT idx_audit_chain UNIQUE (tenant_id, timestamp, id)
);

CREATE INDEX idx_audit_tenant_time ON audit_logs(tenant_id, timestamp);
```

### 性能建议

| 场景 | 建议 |
|------|------|
| 日志量 > 1000 条 | 使用 `verifyChainPaginated` 分页验证 |
| 多天数据 | 按天循环验证，设定最大窗口 24 小时 |
| 多租户 | 使用 `CompletableFuture` 并发校验 |
| 遗留数据 | 自动跳过无哈希字段的旧记录 |

---

## 2. PII 合规检查

### PII 类型标注

```
Define User with
  email: @pii(L2, email) Text,
  ssn: @pii(L3, ssn) Text,
  name: @pii(L1, name) Text.
```

| 级别 | 说明 | 示例 | 法规要求 |
|------|------|------|----------|
| L1 | 低敏感 | 姓名、偏好 | GDPR Art. 6: 记录处理目的 |
| L2 | 中敏感 | 邮箱、电话 | GDPR Art. 6: 需合法依据 |
| L3 | 高敏感 | SSN、护照 | GDPR Art. 9: 需明确同意 |

### LSP 实时检测

LSP 自动检测以下合规问题：

| 错误码 | 问题 | 修复方案 |
|--------|------|----------|
| E400 | HTTP 传输 PII | 使用 HTTPS 或 `redact()` |
| W074 | 日志泄露 PII | 使用 `redact()` 脱敏 |
| E403 | 缺失同意检查 | 添加 `@consent_required` |

### 数据脱敏函数

```
// redact() - 完全遮盖
Log.info("User: " + redact(email))  // User: ***

// tokenize() - 可逆令牌化
Let token be tokenize(ssn).
// 后续可通过 detokenize(token) 恢复

// Crypto.hash() - 单向哈希
Let hashed be Crypto.hash(password, "SHA-256").
```

### 同意检查

```
// 方式 1: 使用注解
@consent_required
To process_user with data: @pii(L2, email) Text:
  Return store(data).

// 方式 2: 显式检查
To process_user with data: @pii(L2, email) Text:
  checkConsent().
  Return store(data).
```

详细配置请参阅 [PII 合规最佳实践](/docs/guide/pii-compliance.md)。

---

## 3. 版本控制与变更追踪

### Policy 版本历史

Policy Editor 自动记录每次修改：

```
data/history/{policy-id}/
├── v1_2025-11-27T10-00-00.json
├── v2_2025-11-27T14-30-00.json
└── v3_2025-11-27T16-45-00.json
```

### 版本比较 API

```java
@Path("/policies/{id}/history")
public class PolicyHistoryResource {

    @GET
    public List<PolicyVersion> getHistory(@PathParam("id") String id) {
        return policyService.getVersionHistory(id);
    }

    @GET
    @Path("/diff")
    public PolicyDiff compareVersions(
        @QueryParam("v1") String v1,
        @QueryParam("v2") String v2
    ) {
        return policyService.diff(v1, v2);
    }
}
```

### 回滚操作

```bash
# 1. 锁定目标版本
git fetch --tags
git checkout v0.x.y

# 2. 恢复依赖与产物
npm ci
npm run build

# 3. 清理缓存
rm -rf dist node_modules/.cache
npm ci && npm run build

# 4. 验证
npm run ci
```

---

## 4. AI 生成代码来源追踪

### Provenance 元数据

每个 AI 生成的文件都包含来源信息：

```
// ========================================
// Generated by: Aster AI Code Generator
// Model: gpt-4
// Provider: openai
// Prompt: Calculate loan risk score
// Timestamp: 2025-11-27T10:30:00.000Z
// Validated: true
// ========================================
```

### 审计用途

| 字段 | 审计价值 |
|------|----------|
| Model | 追溯使用的 AI 模型版本 |
| Provider | 确定数据流向（OpenAI/Anthropic） |
| Prompt | 记录业务意图 |
| Timestamp | 建立时间线 |
| Validated | 确认代码经过类型检查 |

### 提取元数据

```typescript
import { ProvenanceTracker } from 'aster-lang/ai/provenance';

const tracker = new ProvenanceTracker();
const metadata = tracker.extractMetadata(code);

// 写入审计日志
auditLog.record({
  eventType: 'AI_CODE_GENERATION',
  model: metadata.model,
  prompt: metadata.prompt,
  validated: metadata.validated
});
```

---

## 5. 合规配置

### aster.config.json

```json
{
  "compliance": {
    "auditLog": {
      "enabled": true,
      "hashAlgorithm": "SHA-256",
      "retentionDays": 365
    },
    "pii": {
      "enabled": true,
      "strictMode": false,
      "minLevel": "L2",
      "allowedDomains": ["internal-api.company.com"]
    },
    "provenance": {
      "enabled": true,
      "includePrompt": true
    }
  }
}
```

### 环境变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `ASTER_AUDIT_ENABLED` | 启用审计日志 | `true` |
| `ASTER_PII_STRICT` | PII 严格模式 | `false` |
| `ASTER_RETENTION_DAYS` | 日志保留天数 | `365` |

---

## 6. 合规检查清单

### GDPR 准备

- [ ] 所有 PII 字段已标注敏感级别
- [ ] 处理 PII 的函数包含同意检查
- [ ] 审计日志启用且保留至少 6 年
- [ ] 数据主体权利 API 已实现
- [ ] 数据处理协议已与第三方签订

### HIPAA 准备

- [ ] PHI 数据使用 L3 级别标注
- [ ] 传输使用 HTTPS 加密
- [ ] 访问控制已配置
- [ ] 审计日志支持 6 年保留
- [ ] 应急响应计划已制定

### SOC2 准备

- [ ] 审计链完整性验证已启用
- [ ] AI 生成代码包含来源追踪
- [ ] 版本控制和变更管理已实施
- [ ] 访问日志可追溯
- [ ] 定期安全评估已安排

---

## 7. 故障排查

### 审计链断裂

| 现象 | 原因 | 解决方案 |
|------|------|----------|
| `prev_hash mismatch` | 记录被删除或插入 | 检查数据库审计表操作历史 |
| `current_hash tampered` | 字段被修改 | 对比新旧值，检查补写流程 |
| 验证超时 | 查询窗口过大 | 使用分页验证，添加索引 |

### PII 检测误报

1. 使用 `@safe-pii` 注解标记已审计代码
2. 将净化函数添加到 `sanitizers` 配置
3. 将内部域名加入 `allowedDomains`

---

## 相关文档

- [PII 合规最佳实践](/docs/guide/pii-compliance.md)
- [AI 代码生成指南](/docs/guide/ai-code-generation.md)
- [防篡改审计日志技术文档](/docs/phase0/tamper-evident-audit.md)
- [回滚操作指南](/docs/operations/rollback.md)

---

**免责声明**：本指南提供技术实现指导，不构成法律建议。请咨询专业法律顾问以确保完整合规。
