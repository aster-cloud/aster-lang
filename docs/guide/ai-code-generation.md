# AI 代码生成指南

> **状态**: 用户指南
> **版本**: 1.0
> **最后更新**: 2025-11-27

## 概述

Aster 提供内置的 AI 代码生成功能，可以从自然语言描述自动生成类型安全的 CNL 代码。该功能支持 OpenAI 和 Anthropic 两种 LLM 提供商，并包含完整的代码验证、缓存和来源追踪机制。

## 快速开始

### 1. 设置 API Key

```bash
# OpenAI（默认）
export OPENAI_API_KEY=your-openai-api-key

# 或 Anthropic
export ANTHROPIC_API_KEY=your-anthropic-api-key
```

### 2. 生成代码

```bash
# 基本用法
./dist/scripts/aster.js ai-generate "Calculate the total price of items with tax"

# 指定输出文件
./dist/scripts/aster.js ai-generate "Join first and last name with space" --output my-policy.aster

# 使用 Anthropic
./dist/scripts/aster.js ai-generate "Validate email format" --provider anthropic
```

### 3. 查看结果

生成的代码会包含来源追踪注释：

```
// ========================================
// Generated by: Aster AI Code Generator
// Model: gpt-4
// Provider: openai
// Prompt: Calculate the total price of items with tax
// Timestamp: 2025-11-27T10:30:00.000Z
// Validated: true
// ========================================

Define Item with
  name: Text,
  price: Number,
  quantity: Number.

To calculate_total with items: List of Item, tax_rate: Number, produce Number:
  Let subtotal be List.reduce(items, 0, fn (acc, item) -> acc + item.price * item.quantity).
  Return subtotal * (1 + tax_rate).
```

## 命令选项

| 选项 | 说明 | 默认值 |
|------|------|--------|
| `--provider` | LLM 提供商 (openai/anthropic) | `openai` |
| `--model` | 模型名称 | `gpt-4` / `claude-3-5-sonnet` |
| `--output` | 输出文件路径 | 控制台输出 |
| `--temperature` | 温度参数 (0.0-1.0) | `0.7` |
| `--few-shot-count` | Few-shot 示例数量 | `3` |
| `--no-cache` | 禁用缓存 | 启用缓存 |

## 使用场景

### 业务规则生成

```bash
# 贷款审批规则
./dist/scripts/aster.js ai-generate "Score a loan request by checking credit score above 650, debt ratio below 40%, and assign interest rate based on risk level"

# 折扣计算
./dist/scripts/aster.js ai-generate "Calculate discount for premium members returning 10 percent off, VIP members 20 percent off"
```

### 数据验证

```bash
# 邮箱验证
./dist/scripts/aster.js ai-generate "Validate that email contains @ symbol and domain"

# 电话号码格式化
./dist/scripts/aster.js ai-generate "Format phone number to include country code and dashes"
```

### 工作流逻辑

```bash
# 订单处理
./dist/scripts/aster.js ai-generate "Process order: validate inventory, calculate shipping, apply discount, return confirmation"

# 用户注册
./dist/scripts/aster.js ai-generate "Register user with email verification and welcome notification"
```

## 缓存机制

AI 生成结果会自动缓存到 `.cache/ai-generation/` 目录，避免重复调用 LLM API：

```
.cache/
└── ai-generation/
    ├── openai-gpt-4-temp0.7-fs3-abc123.json
    └── anthropic-claude-temp0.7-fs3-def456.json
```

**缓存策略**：
- 基于 provider + model + temperature + few-shot-count + description 生成唯一键
- 相同请求直接返回缓存结果（< 1 秒）
- 使用 `--no-cache` 强制重新生成

**清理缓存**：
```bash
# 清理 7 天前的缓存
find .cache/ai-generation -mtime +7 -delete

# 清理所有缓存
rm -rf .cache/ai-generation
```

## 来源追踪（Provenance）

每个生成的文件都包含来源元数据，用于审计和追溯：

| 字段 | 说明 |
|------|------|
| `Model` | 使用的 LLM 模型 |
| `Provider` | LLM 提供商 |
| `Prompt` | 用户输入的描述 |
| `Timestamp` | 生成时间 (ISO 8601) |
| `Validated` | 是否通过类型检查 |

**提取元数据**：
```javascript
import { ProvenanceTracker } from 'aster-lang/ai/provenance';

const tracker = new ProvenanceTracker();
const metadata = tracker.extractMetadata(code);
// { model: 'gpt-4', provider: 'openai', prompt: '...', timestamp: '...', validated: true }
```

## 代码验证

生成的代码会自动经过完整的编译管线验证：

1. **词法分析** - 检查语法结构
2. **语法分析** - 构建 AST
3. **类型检查** - 验证类型安全
4. **效应推断** - 检查副作用标注

如果验证失败，会显示诊断信息：

```
⚠️ 验证失败:
  Line 5: Type mismatch: expected Number, got Text
  Line 8: Unknown function 'calculate'
```

## 扩展 LLM 提供商

### 添加新提供商

1. 创建 provider 实现：

```typescript
// src/ai/providers/my-provider.ts
import { LLMProvider, LLMError } from '../llm-provider.js';

export class MyProvider implements LLMProvider {
  async generate(prompt: string): Promise<string> {
    // 调用 LLM API
  }

  getName(): string {
    return 'my-provider';
  }

  getModel(): string {
    return this.model;
  }
}
```

2. 注册到 CLI：

```typescript
// src/cli/commands/ai-generate.ts
function createProvider(name: string): LLMProvider {
  if (name === 'my-provider') {
    return new MyProvider();
  }
  // ...
}
```

## Few-shot 示例管理

Few-shot 示例存储在 `prompts/few-shot-examples.jsonl`：

```jsonl
{"description": "Add two numbers", "code": "To add with a: Number, b: Number, produce Number:\n  Return a + b."}
{"description": "Check if list is empty", "code": "To is_empty with items: List of Any, produce Bool:\n  Return List.length(items) == 0."}
```

**添加自定义示例**：

```bash
# 追加新示例
echo '{"description": "My example", "code": "..."}' >> prompts/few-shot-examples.jsonl
```

## 最佳实践

### 描述编写技巧

✅ **好的描述**：
- 具体明确：`Calculate total price with 8% tax rate`
- 包含输入输出：`Take a list of items and return the sum of prices`
- 指定业务规则：`Apply 10% discount if order exceeds $100`

❌ **避免的描述**：
- 过于模糊：`Do something with data`
- 缺少上下文：`Process it`
- 多个不相关任务：`Calculate tax, send email, and update database`

### 迭代优化

1. 先生成基础版本
2. 检查验证结果
3. 调整描述细节
4. 使用 `--no-cache` 重新生成

### 安全考虑

- 生成的代码应经过人工审查后再部署
- 敏感业务逻辑建议手动编写
- 定期检查来源追踪信息

## 故障排除

### API Key 错误

```
❌ 創建 LLM Provider 失敗
請設置環境變量: export OPENAI_API_KEY=your-api-key
```

**解决**：确保 API Key 已正确设置且有效。

### Rate Limit 错误

```
❌ 429 Too Many Requests
```

**解决**：
1. 等待几分钟后重试
2. 降低并发请求数
3. 使用缓存减少 API 调用

### 验证失败

```
⚠️ 验证失败: Type mismatch
```

**解决**：
1. 调整描述使其更具体
2. 参考 Few-shot 示例格式
3. 手动修复生成的代码

## 相关文档

- [AI 代码生成架构](/docs/ai-generation-architecture.md)
- [CNL 语法参考](/docs/guide/language-overview.md)
- [PII 合规指南](/docs/guide/pii-compliance.md)
- [类型系统参考](/docs/reference/types.md)

---

**注意**：AI 生成的代码应视为初稿，建议在生产环境使用前进行人工审查和测试。
