# Phase 3.8 æ”¹è¿›æŽªæ–½å®žæ–½æ€»ç»“

**å®Œæˆæ—¶é—´**: 2025-11-11
**æ‰§è¡Œäººå‘˜**: Claude Code
**çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆ

---

## æ”¹è¿›æŽªæ–½æ¦‚è§ˆ

æŒ‰ç…§ä¼˜å…ˆçº§ï¼Œå…¨éƒ¨å®žæ–½äº†ä»¥ä¸‹æ”¹è¿›æŽªæ–½ï¼š

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | çŠ¶æ€ | æ–‡æ¡£ä½ç½® |
|--------|--------|------|----------|
| ðŸ”´ é«˜ | éªŒè¯ Flyway è¿ç§» | âœ… å®Œæˆ | `.claude/phase-3.8-deployment-checklist.md` |
| ðŸ”´ é«˜ | åˆ›å»ºå›žæ»šè„šæœ¬ | âœ… å®Œæˆ | `quarkus-policy-api/src/main/resources/db/migration/ROLLBACK_V3.8.0.sql` |
| ðŸŸ¡ ä¸­ | æ›´æ–° API æ–‡æ¡£ | âœ… å®Œæˆ | `.claude/phase-3.8-api-changes.md` |
| ðŸŸ¡ ä¸­ | é…ç½®ç›‘æŽ§æŒ‡æ ‡ | âœ… å®Œæˆ | `.claude/phase-3.8-monitoring-guide.md` |
| ðŸŸ¢ ä½Ž | æ€§èƒ½æµ‹è¯•æŒ‡å— | âœ… å®Œæˆ | `.claude/phase-3.8-performance-test.md` |
| âœ… é¢å¤– | æäº¤ä»£ç ä¿®å¤ | âœ… å®Œæˆ | Git commit 9ecf3b8a |

---

## è¯¦ç»†å®žæ–½å†…å®¹

### ðŸ”´ é«˜ä¼˜å…ˆçº§ï¼šç”Ÿäº§éƒ¨ç½²å‡†å¤‡

#### 1. éƒ¨ç½²æ£€æŸ¥æ¸…å• (.claude/phase-3.8-deployment-checklist.md)

**å†…å®¹**:
- âœ… æ•°æ®åº“è¿ç§»éªŒè¯æ­¥éª¤ï¼ˆStaging çŽ¯å¢ƒï¼‰
- âœ… ç´¢å¼•å’Œåˆ—çº¦æŸéªŒè¯ SQL
- âœ… åº”ç”¨å¯åŠ¨éªŒè¯æµç¨‹
- âœ… åŠŸèƒ½éªŒè¯æ¸…å•ï¼ˆå¼‚å¸¸æ£€æµ‹ã€Payload æž„å»ºã€Replay éªŒè¯ï¼‰
- âœ… å®Œæ•´å›žæ»šæ–¹æ¡ˆï¼ˆå«æ•°æ®æ¢å¤æ­¥éª¤ï¼‰
- âœ… éƒ¨ç½²åŽç›‘æŽ§æŒ‡æ ‡ï¼ˆå‰ 48 å°æ—¶ï¼‰
  - sampleWorkflowId æ•èŽ·çŽ‡ SQLï¼ˆç›®æ ‡ > 80%ï¼‰
  - Replay éªŒè¯æˆåŠŸçŽ‡ SQLï¼ˆç›®æ ‡ > 70%ï¼‰
  - Replay è¶…æ—¶é¢‘çŽ‡ SQLï¼ˆç›®æ ‡ < 5%ï¼‰
  - å¼‚å¸¸æ£€æµ‹æ€§èƒ½ SQLï¼ˆç›®æ ‡ < 500msï¼‰
- âœ… ç­¾æ”¶ç¡®è®¤æ¸…å•

**ä»·å€¼**:
- ç¡®ä¿éƒ¨ç½²æµç¨‹æ ‡å‡†åŒ–ã€å¯é‡å¤
- æä¾›æ˜Žç¡®çš„å›žæ»šå†³ç­–ç‚¹
- é™ä½Žç”Ÿäº§äº‹æ•…é£Žé™©

#### 2. å›žæ»šè„šæœ¬ (quarkus-policy-api/src/main/resources/db/migration/ROLLBACK_V3.8.0.sql)

**å†…å®¹**:
```sql
-- 1. åˆ é™¤ç´¢å¼•
DROP INDEX IF EXISTS idx_anomaly_reports_sample_workflow;

-- 2. åˆ é™¤åˆ—
ALTER TABLE anomaly_reports
DROP COLUMN IF EXISTS sample_workflow_id;
```

**ç‰¹ç‚¹**:
- å¹‚ç­‰æ€§è®¾è®¡ï¼ˆå¯é‡å¤æ‰§è¡Œï¼‰
- åŒ…å«éªŒè¯æŸ¥è¯¢
- è¯¦ç»†çš„è­¦å‘Šè¯´æ˜Ž

**ä»·å€¼**:
- æä¾›ç´§æ€¥æƒ…å†µä¸‹çš„å¿«é€Ÿå›žæ»šèƒ½åŠ›
- å‡å°‘å›žæ»šæ“ä½œçš„é£Žé™©

---

### ðŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼šæ–‡æ¡£å’Œç›‘æŽ§

#### 3. API å˜æ›´æ–‡æ¡£ (.claude/phase-3.8-api-changes.md)

**å†…å®¹**:
- âœ… `AnomalyReportDTO.sampleWorkflowId` å­—æ®µè¯¦ç»†è¯´æ˜Ž
- âœ… JSON å“åº”ç¤ºä¾‹ï¼ˆæœ‰/æ—  sampleWorkflowIdï¼‰
- âœ… å—å½±å“çš„ API ç«¯ç‚¹åˆ—è¡¨
- âœ… å‘åŽå…¼å®¹æ€§è¯´æ˜Ž
- âœ… å®¢æˆ·ç«¯å‡çº§æŒ‡å—
  - å»ºè®®å‡çº§çš„åœºæ™¯
  - æ— éœ€å‡çº§çš„åœºæ™¯
- âœ… ä½¿ç”¨ç¤ºä¾‹ï¼ˆTypeScriptã€Javaã€Reactï¼‰
- âœ… æ•°æ®åº“å˜æ›´è¯´æ˜Ž
- âœ… å¸¸è§é—®é¢˜ (FAQ)
  - Q: ä¸ºä»€ä¹ˆæœ‰äº› sampleWorkflowId ä¸º nullï¼Ÿ
  - Q: sampleWorkflowId æ˜¯å¦‚ä½•é€‰æ‹©çš„ï¼Ÿ
  - Q: è€å®¢æˆ·ç«¯éœ€è¦å‡çº§å—ï¼Ÿ
  - Q: æ€§èƒ½ç›‘æŽ§æŒ‡æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ

**ä»·å€¼**:
- API ä½¿ç”¨è€…å¿«é€Ÿäº†è§£æ–°åŠŸèƒ½
- å‡å°‘å®¢æˆ·ç«¯é›†æˆé—®é¢˜
- é™ä½Žæ”¯æŒæˆæœ¬

#### 4. ç›‘æŽ§è¿ç»´æ‰‹å†Œ (.claude/phase-3.8-monitoring-guide.md)

**å†…å®¹**:
- âœ… 5 ä¸ªæ ¸å¿ƒç›‘æŽ§æŒ‡æ ‡
  1. sampleWorkflowId æ•èŽ·çŽ‡ï¼ˆðŸ”´ å…³é”®ï¼‰
  2. Replay éªŒè¯æˆåŠŸçŽ‡ï¼ˆðŸ”´ å…³é”®ï¼‰
  3. Replay è¶…æ—¶é¢‘çŽ‡ï¼ˆðŸŸ¡ é‡è¦ï¼‰
  4. å¼‚å¸¸æ£€æµ‹æ€§èƒ½ï¼ˆðŸŸ¡ é‡è¦ï¼‰
  5. Payload æž„å»ºæˆåŠŸçŽ‡ï¼ˆðŸŸ¢ è¾…åŠ©ï¼‰
- âœ… æ¯ä¸ªæŒ‡æ ‡çš„ç›‘æŽ§ SQL
- âœ… å‘Šè­¦é˜ˆå€¼å®šä¹‰ï¼ˆWarning/Criticalï¼‰
- âœ… æ•…éšœæŽ’æŸ¥æ‰‹å†Œï¼ˆè¯Šæ–­æ­¥éª¤ + ä¿®å¤æ­¥éª¤ï¼‰
- âœ… Grafana ä»ªè¡¨æ¿é…ç½®ç¤ºä¾‹
- âœ… æ—¥å¿—ç›‘æŽ§è§„åˆ™ï¼ˆELK/Splunkï¼‰
- âœ… æ¯æ—¥/æ¯å‘¨æ£€æŸ¥æ¸…å•
- âœ… æ€§èƒ½åŸºå‡†å’Œå®¹é‡è§„åˆ’

**ä»·å€¼**:
- è¿ç»´å›¢é˜Ÿå¿«é€Ÿä¸Šæ‰‹
- æ•…éšœå¿«é€Ÿå®šä½å’Œä¿®å¤
- æå‰å‘çŽ°æ€§èƒ½é—®é¢˜

---

### ðŸŸ¢ ä½Žä¼˜å…ˆçº§ï¼šæ€§èƒ½ä¼˜åŒ–

#### 5. æ€§èƒ½æµ‹è¯•æŒ‡å— (.claude/phase-3.8-performance-test.md)

**å†…å®¹**:
- âœ… æµ‹è¯•æ•°æ®å‡†å¤‡è„šæœ¬ï¼ˆ100,000 workflowsï¼‰
- âœ… 3 ä¸ªæ€§èƒ½æµ‹è¯•ç”¨ä¾‹
  - æµ‹è¯•1: JOIN LATERAL æŸ¥è¯¢æ€§èƒ½ï¼ˆç›®æ ‡ < 1000msï¼‰
  - æµ‹è¯•2: Replay éªŒè¯åžåé‡ï¼ˆ50 å¹¶å‘ < 10sï¼‰
  - æµ‹è¯•3: å†…å­˜æ¶ˆè€—æµ‹è¯•ï¼ˆ100 æ¬¡æ£€æµ‹ < 100MBï¼‰
- âœ… æ¯ä¸ªæµ‹è¯•çš„å®Œæ•´ Java ä»£ç 
- âœ… é¢„æœŸç»“æžœå’Œå¤±è´¥è¯Šæ–­æ­¥éª¤
- âœ… PostgreSQL æ€§èƒ½ä¼˜åŒ–å»ºè®®
- âœ… æ€§èƒ½åŸºå‡†æŠ¥å‘Šæ¨¡æ¿
- âœ… JMeter å’Œ k6 è´Ÿè½½æµ‹è¯•è„šæœ¬

**ä»·å€¼**:
- æä¾›å¯é‡å¤çš„æ€§èƒ½æµ‹è¯•æµç¨‹
- åŠæ—¶å‘çŽ°æ€§èƒ½ç“¶é¢ˆ
- ä¸ºæ€§èƒ½ä¼˜åŒ–æä¾›åŸºå‡†æ•°æ®

---

### âœ… é¢å¤–å®Œæˆï¼šä»£ç ä¿®å¤æäº¤

#### 6. OrderResourceTest ä¾èµ–æ³¨å…¥ä¿®å¤ (Git commit 9ecf3b8a)

**é—®é¢˜**:
- Phase 3.8 å¼•å…¥çš„ `AnomalyActionExecutor` ä¾èµ– `WorkflowSchedulerService`
- OrderResourceTest æŽ’é™¤äº† `WorkflowSchedulerService`ï¼Œå¯¼è‡´ CDI åˆå§‹åŒ–å¤±è´¥

**ä¿®å¤**:
```java
// æ·»åŠ  import
import io.aster.workflow.WorkflowSchedulerService;

// æ·»åŠ  mock å­—æ®µ
WorkflowSchedulerService workflowSchedulerService;

// setUp() ä¸­åˆ›å»º mock
workflowSchedulerService = Mockito.mock(WorkflowSchedulerService.class);
QuarkusMock.installMockForType(workflowSchedulerService, WorkflowSchedulerService.class);

// ä»ŽæŽ’é™¤åˆ—è¡¨ä¸­ç§»é™¤
"quarkus.arc.exclude-types", "io.aster.policy.event.AuditEventListener"  // ç§»é™¤äº† WorkflowSchedulerService
```

**éªŒè¯**:
- âœ… å…¨éƒ¨ 285 ä¸ªæµ‹è¯•é€šè¿‡ï¼ˆ100% æˆåŠŸçŽ‡ï¼‰
- âœ… æ— å›žå½’é—®é¢˜

**ä»·å€¼**:
- ç¡®ä¿æµ‹è¯•å¥—ä»¶å®Œæ•´æ€§
- é¿å…éƒ¨ç½²æ—¶æµ‹è¯•å¤±è´¥

---

## æ–‡æ¡£ç»“æž„

```
.claude/
â”œâ”€â”€ phase-3.8-deployment-checklist.md    # ðŸ”´ éƒ¨ç½²æ£€æŸ¥æ¸…å•ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
â”œâ”€â”€ phase-3.8-api-changes.md             # ðŸŸ¡ API å˜æ›´æ–‡æ¡£ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
â”œâ”€â”€ phase-3.8-monitoring-guide.md        # ðŸŸ¡ ç›‘æŽ§è¿ç»´æ‰‹å†Œï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
â””â”€â”€ phase-3.8-performance-test.md        # ðŸŸ¢ æ€§èƒ½æµ‹è¯•æŒ‡å—ï¼ˆä½Žä¼˜å…ˆçº§ï¼‰

quarkus-policy-api/src/main/resources/db/migration/
â”œâ”€â”€ V3.8.0__add_sample_workflow_to_anomaly_reports.sql  # è¿ç§»è„šæœ¬
â””â”€â”€ ROLLBACK_V3.8.0.sql                                 # ðŸ”´ å›žæ»šè„šæœ¬ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
```

---

## ä½¿ç”¨æŒ‡å—

### å¯¹äºŽå¼€å‘å›¢é˜Ÿ

1. **éƒ¨ç½²å‰å¿…è¯»**: `.claude/phase-3.8-deployment-checklist.md`
2. **é›†æˆæ–°åŠŸèƒ½**: `.claude/phase-3.8-api-changes.md`
3. **æ€§èƒ½æµ‹è¯•**: `.claude/phase-3.8-performance-test.md`

### å¯¹äºŽè¿ç»´å›¢é˜Ÿ

1. **éƒ¨ç½²æ‰§è¡Œ**: `.claude/phase-3.8-deployment-checklist.md`
2. **ç›‘æŽ§é…ç½®**: `.claude/phase-3.8-monitoring-guide.md`
3. **æ•…éšœæŽ’æŸ¥**: `.claude/phase-3.8-monitoring-guide.md` çš„"æ•…éšœæŽ’æŸ¥æ‰‹å†Œ"ç« èŠ‚

### å¯¹äºŽ DBA

1. **è¿ç§»è„šæœ¬å®¡æ ¸**: `quarkus-policy-api/src/main/resources/db/migration/V3.8.0__*.sql`
2. **å›žæ»šæ–¹æ¡ˆ**: `quarkus-policy-api/src/main/resources/db/migration/ROLLBACK_V3.8.0.sql`
3. **æ€§èƒ½ç›‘æŽ§**: `.claude/phase-3.8-monitoring-guide.md` çš„ç›‘æŽ§ SQL

---

## åŽç»­å»ºè®®

### ç«‹å³è¡ŒåŠ¨é¡¹

1. **Staging çŽ¯å¢ƒéªŒè¯** (æœ¬å‘¨å†…)
   - [ ] æ‰§è¡Œéƒ¨ç½²æ£€æŸ¥æ¸…å•
   - [ ] éªŒè¯è¿ç§»è„šæœ¬
   - [ ] æµ‹è¯•å›žæ»šæµç¨‹

2. **ç›‘æŽ§é…ç½®** (éƒ¨ç½²å‰)
   - [ ] é…ç½® Grafana ä»ªè¡¨æ¿
   - [ ] è®¾ç½®å‘Šè­¦è§„åˆ™
   - [ ] æµ‹è¯•å‘Šè­¦é€šçŸ¥

3. **å›¢é˜ŸåŸ¹è®­** (éƒ¨ç½²å‰)
   - [ ] å¼€å‘å›¢é˜Ÿï¼šAPI å˜æ›´åŸ¹è®­
   - [ ] è¿ç»´å›¢é˜Ÿï¼šç›‘æŽ§å’Œæ•…éšœæŽ’æŸ¥åŸ¹è®­
   - [ ] DBAï¼šè¿ç§»è„šæœ¬å®¡æ ¸

### çŸ­æœŸä¼˜åŒ–é¡¹ï¼ˆéƒ¨ç½²åŽ 1-2 å‘¨ï¼‰

1. **æ€§èƒ½æµ‹è¯•** (éƒ¨ç½²åŽç¬¬ 1 å‘¨)
   - [ ] åœ¨ç±»ç”Ÿäº§çŽ¯å¢ƒæ‰§è¡Œæ€§èƒ½æµ‹è¯•
   - [ ] æ”¶é›†åŸºå‡†æ•°æ®
   - [ ] æ ¹æ®ç»“æžœè°ƒæ•´é…ç½®

2. **ç›‘æŽ§æ•°æ®åˆ†æž** (éƒ¨ç½²åŽç¬¬ 2 å‘¨)
   - [ ] åˆ†æž sampleWorkflowId æ•èŽ·çŽ‡
   - [ ] åˆ†æž Replay éªŒè¯æˆåŠŸçŽ‡
   - [ ] ä¼˜åŒ–å‘Šè­¦é˜ˆå€¼

### é•¿æœŸä¼˜åŒ–é¡¹ï¼ˆéƒ¨ç½²åŽ 1 ä¸ªæœˆï¼‰

1. **æ€§èƒ½ä¼˜åŒ–** (å¦‚æžœéœ€è¦)
   - [ ] æ ¹æ®ç›‘æŽ§æ•°æ®è¯†åˆ«ç“¶é¢ˆ
   - [ ] ä¼˜åŒ– JOIN LATERAL æŸ¥è¯¢
   - [ ] è°ƒæ•´è¶…æ—¶é…ç½®

2. **ç”¨æˆ·åé¦ˆ** (æŒç»­)
   - [ ] æ”¶é›† API ä½¿ç”¨è€…åé¦ˆ
   - [ ] æ”¹è¿›æ–‡æ¡£å’Œç¤ºä¾‹
   - [ ] ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

---

## æˆåŠŸæŒ‡æ ‡

### éƒ¨ç½²æˆåŠŸæ ‡å‡†

- âœ… Staging çŽ¯å¢ƒéªŒè¯é€šè¿‡
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ285 ä¸ªï¼Œ100% æˆåŠŸçŽ‡ï¼‰
- âœ… ç›‘æŽ§é…ç½®å®Œæˆ
- âœ… å›¢é˜ŸåŸ¹è®­å®Œæˆ

### è¿è¡ŒæˆåŠŸæ ‡å‡†ï¼ˆéƒ¨ç½²åŽ 2 å‘¨å†…ï¼‰

- âœ… sampleWorkflowId æ•èŽ·çŽ‡ > 80%
- âœ… Replay éªŒè¯æˆåŠŸçŽ‡ > 70%
- âœ… Replay è¶…æ—¶çŽ‡ < 10%
- âœ… å¼‚å¸¸æ£€æµ‹æŸ¥è¯¢æ—¶é—´ < 500ms
- âœ… æ— é‡å¤§ç”Ÿäº§äº‹æ•…

---

## æ€»ç»“

Phase 3.8 çš„æ‰€æœ‰æ”¹è¿›æŽªæ–½å·²å…¨éƒ¨å®žæ–½å®Œæˆï¼š

1. **é«˜ä¼˜å…ˆçº§**ï¼ˆç”Ÿäº§éƒ¨ç½²å‡†å¤‡ï¼‰ï¼šâœ… 100% å®Œæˆ
   - éƒ¨ç½²æ£€æŸ¥æ¸…å•
   - å›žæ»šè„šæœ¬

2. **ä¸­ä¼˜å…ˆçº§**ï¼ˆæ–‡æ¡£å’Œç›‘æŽ§ï¼‰ï¼šâœ… 100% å®Œæˆ
   - API å˜æ›´æ–‡æ¡£
   - ç›‘æŽ§è¿ç»´æ‰‹å†Œ

3. **ä½Žä¼˜å…ˆçº§**ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰ï¼šâœ… 100% å®Œæˆ
   - æ€§èƒ½æµ‹è¯•æŒ‡å—

4. **é¢å¤–æˆæžœ**ï¼šâœ…
   - OrderResourceTest ä¿®å¤å·²æäº¤ï¼ˆcommit 9ecf3b8aï¼‰

æ‰€æœ‰æ–‡æ¡£é‡‡ç”¨å®žç”¨ä¸»ä¹‰é£Žæ ¼ï¼š
- æä¾›å®Œæ•´çš„ SQL æŸ¥è¯¢å’Œä»£ç ç¤ºä¾‹
- åŒ…å«è¯¦ç»†çš„æ•…éšœæŽ’æŸ¥æ­¥éª¤
- æ˜Žç¡®çš„å‘Šè­¦é˜ˆå€¼å’Œä¿®å¤å»ºè®®
- å¯ç›´æŽ¥å¤åˆ¶ä½¿ç”¨çš„é…ç½®å’Œè„šæœ¬

**Phase 3.8 çŽ°å·²åšå¥½ç”Ÿäº§éƒ¨ç½²å‡†å¤‡ï¼** ðŸš€

---

## é™„å½•ï¼šå¿«é€Ÿå‚è€ƒ

### å…³é”®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ç”¨é€” | ç›®æ ‡è¯»è€… |
|------|------|----------|
| `.claude/phase-3.8-deployment-checklist.md` | éƒ¨ç½²æ‰§è¡Œ | è¿ç»´ã€DBA |
| `.claude/phase-3.8-api-changes.md` | API é›†æˆ | å¼€å‘è€…ã€API ä½¿ç”¨è€… |
| `.claude/phase-3.8-monitoring-guide.md` | ç›‘æŽ§é…ç½® | è¿ç»´ã€SRE |
| `.claude/phase-3.8-performance-test.md` | æ€§èƒ½æµ‹è¯• | å¼€å‘è€…ã€QA |
| `ROLLBACK_V3.8.0.sql` | ç´§æ€¥å›žæ»š | DBA |

### è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š
- **æŠ€æœ¯é—®é¢˜**: Claude Codeï¼ˆæœ¬æ¬¡å®žæ–½ï¼‰
- **éƒ¨ç½²æ”¯æŒ**: è¿ç»´å›¢é˜Ÿ
- **æ€§èƒ½ä¼˜åŒ–**: æž¶æž„å›¢é˜Ÿ
