# encoding: UTF-8
# This file is encoded in UTF-8 to support Chinese comments
# Test Configuration - External PostgreSQL (podman)

# Database 配置：使用 localhost:5433 PostgreSQL
quarkus.datasource.db-kind=postgresql
quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5433/postgres
quarkus.datasource.username=postgres
quarkus.datasource.password=postgres
quarkus.datasource.reactive.url=postgresql://localhost:5433/postgres
quarkus.datasource.jdbc.max-size=50
quarkus.datasource.reactive.max-size=50

# 连接超时配置
quarkus.datasource.jdbc.acquisition-timeout=10

# Hibernate
quarkus.hibernate-orm.database.generation=none
quarkus.hibernate-orm.log.sql=true
quarkus.hibernate-orm.sql-load-script=no-file

# Flyway Migration（指向 PostgreSQL 脚本）
quarkus.flyway.migrate-at-start=true
quarkus.flyway.baseline-on-migrate=true
quarkus.flyway.baseline-version=0
quarkus.flyway.locations=classpath:db/migration
quarkus.flyway.clean-at-start=true

# Cache - Use both Caffeine (local) and Redis (distributed) via Testcontainers
quarkus.cache.caffeine."policy-results".expire-after-write=3M
# Redis configuration will be provided by RedisTestResource
# 修复：使用正确的缓存值类型（PolicyEvaluationResult 而非 EvaluationResponse）
quarkus.cache.redis.policy-results.value-type=io.aster.policy.api.model.PolicyEvaluationResult
quarkus.redis.max-pool-size=50
quarkus.redis.max-pool-waiting=128
# 禁用 Redis：默认测试不使用 Redis，仅在 @RedisEnabledTest 时由 RedisTestResource 动态启用
quarkus.redis.hosts=redis://localhost:6379
quarkus.redis.client-type=standalone
# 配置 Redis 客户端为非阻塞模式，连接失败时立即返回而不是阻塞
quarkus.redis.timeout=1s

# 禁用调度器以避免测试并行触发 Timer 导致重复事件
quarkus.scheduler.enabled=false

# Enable Redis Testcontainer for all tests
quarkus.test.integration-test-profile=redis-enabled

# Log Level
quarkus.log.level=INFO
quarkus.log.category."io.aster".level=DEBUG
quarkus.log.category."org.flywaydb".level=DEBUG

# PII 保护配置（默认禁用）
aster.pii.enforce=false
