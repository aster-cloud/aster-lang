// ========================================
// HIPAA Compliance Demo: PHI Validation & Access Control
// §164.312 - Access Control & Audit Controls
// ========================================

This module is examples.compliance.hipaa_validation_demo.

// HIPAA 访问控制级别（服务端定义，不可客户端伪造）
Define AccessLevel with
  level: Text,
  can_view_demographics: Bool,
  can_view_medical: Bool,
  can_view_financial: Bool,
  can_modify: Bool.

// PHI 数据分类
Define PHICategory with
  category: Text,
  sensitivity: Text,
  requires_consent: Bool,
  retention_years: Int.

// 访问请求
Define PHIAccessRequest with
  user_id: Text,
  user_role: Text,
  phi_category_name: Text,
  purpose: Text,
  has_consent: Bool.

// HIPAA 验证结果
Define HIPAAValidation with
  is_compliant: Bool,
  passed_count: Int,
  failed_count: Int,
  message: Text.

// 定义访问级别（服务端权威函数）
To get_access_level with role: Text, produce AccessLevel:
  If =(role, "physician"),:
    Return AccessLevel with level = "FULL", can_view_demographics = true, can_view_medical = true, can_view_financial = false, can_modify = true.
  If =(role, "nurse"),:
    Return AccessLevel with level = "CLINICAL", can_view_demographics = true, can_view_medical = true, can_view_financial = false, can_modify = false.
  If =(role, "billing"),:
    Return AccessLevel with level = "BILLING", can_view_demographics = true, can_view_medical = false, can_view_financial = true, can_modify = false.
  If =(role, "admin"),:
    Return AccessLevel with level = "ADMIN", can_view_demographics = true, can_view_medical = false, can_view_financial = false, can_modify = false.
  Return AccessLevel with level = "NONE", can_view_demographics = false, can_view_medical = false, can_view_financial = false, can_modify = false.

// 定义 PHI 类别
To get_phi_category with category_name: Text, produce PHICategory:
  If =(category_name, "demographics"),:
    Return PHICategory with category = "DEMOGRAPHICS", sensitivity = "L2", requires_consent = false, retention_years = 6.
  If =(category_name, "medical"),:
    Return PHICategory with category = "MEDICAL", sensitivity = "L3", requires_consent = true, retention_years = 10.
  If =(category_name, "financial"),:
    Return PHICategory with category = "FINANCIAL", sensitivity = "L2", requires_consent = false, retention_years = 7.
  If =(category_name, "psychotherapy"),:
    Return PHICategory with category = "PSYCHOTHERAPY", sensitivity = "L3", requires_consent = true, retention_years = 10.
  Return PHICategory with category = "UNKNOWN", sensitivity = "L3", requires_consent = true, retention_years = 10.

// HIPAA §164.312(a) - 访问控制验证
To validate_access_control with request: PHIAccessRequest, produce Result of Text:
  Let level be get_access_level(request.user_role).
  Let category be get_phi_category(request.phi_category_name).
  If =(category.category, "MEDICAL"),:
    If =(level.can_view_medical, false),:
      Return err of Text.concat("HIPAA: Role ", request.user_role, " cannot access medical records").
  If =(category.category, "FINANCIAL"),:
    If =(level.can_view_financial, false),:
      Return err of Text.concat("HIPAA: Role ", request.user_role, " cannot access financial records").
  If =(category.category, "PSYCHOTHERAPY"),:
    If =(level.can_view_medical, false),:
      Return err of Text.concat("HIPAA: Role ", request.user_role, " cannot access psychotherapy notes").
  Return ok of Text.concat("Access validated for role: ", request.user_role).

// HIPAA §164.508 - 同意验证
To validate_consent with request: PHIAccessRequest, produce Result of Text:
  Let category be get_phi_category(request.phi_category_name).
  If category.requires_consent,:
    If =(request.has_consent, false),:
      Return err of Text.concat("HIPAA: Consent required for ", category.category).
  Return ok of "Consent validated".

// HIPAA §164.512 - 使用目的验证
To validate_purpose with request: PHIAccessRequest, produce Result of Text:
  If =(request.purpose, "treatment"),:
    Return ok of "Purpose validated".
  If =(request.purpose, "payment"),:
    Return ok of "Purpose validated".
  If =(request.purpose, "healthcare_operations"),:
    Return ok of "Purpose validated".
  Return err of Text.concat("HIPAA: Purpose ", request.purpose, " is not permitted").

// 完整 HIPAA 合规验证（简化版 - 仅检查访问控制）
To validate_hipaa_compliance with request: PHIAccessRequest, produce HIPAAValidation:
  Let access_result be validate_access_control(request).
  Let consent_result be validate_consent(request).
  Let purpose_result be validate_purpose(request).
  If Result.isOk(access_result),:
    If Result.isOk(consent_result),:
      If Result.isOk(purpose_result),:
        Return HIPAAValidation with is_compliant = true, passed_count = 3, failed_count = 0, message = "All HIPAA checks passed".
  Return HIPAAValidation with is_compliant = false, passed_count = 0, failed_count = 1, message = "HIPAA compliance failed".

// 生成 HIPAA 合规报告
To generate_hipaa_report with user_id: Text, validation: HIPAAValidation, produce Text:
  If validation.is_compliant,:
    Return Text.concat("HIPAA COMPLIANCE: PASSED for ", user_id).
  Otherwise,:
    Return Text.concat("HIPAA COMPLIANCE: FAILED for ", user_id, ". Failed checks: ", Int.toString(validation.failed_count)).

// 示例：医生访问医疗记录（合规）
To demo_compliant_access, produce HIPAAValidation:
  Let request be PHIAccessRequest with user_id = "DR-001", user_role = "physician", phi_category_name = "medical", purpose = "treatment", has_consent = true.
  Return validate_hipaa_compliance(request).

// 示例：账单人员访问医疗记录（不合规）
To demo_non_compliant_access, produce HIPAAValidation:
  Let request be PHIAccessRequest with user_id = "BILL-001", user_role = "billing", phi_category_name = "medical", purpose = "payment", has_consent = false.
  Return validate_hipaa_compliance(request).

// 示例：攻击者尝试伪造权限
To demo_spoofed_access_blocked, produce HIPAAValidation:
  Let request be PHIAccessRequest with user_id = "ATTACKER-001", user_role = "admin", phi_category_name = "medical", purpose = "curiosity", has_consent = false.
  Return validate_hipaa_compliance(request).
