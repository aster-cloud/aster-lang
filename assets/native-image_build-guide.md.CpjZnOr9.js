import{_ as i,c as a,o as l,aj as n}from"./chunks/framework.Bz2R-749.js";const o=JSON.parse('{"title":"Aster Native Image 详细构建指南","description":"","frontmatter":{},"headers":[],"relativePath":"native-image/build-guide.md","filePath":"native-image/build-guide.md"}'),e={name:"native-image/build-guide.md"};function t(h,s,p,k,r,d){return l(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="aster-native-image-详细构建指南" tabindex="-1">Aster Native Image 详细构建指南 <a class="header-anchor" href="#aster-native-image-详细构建指南" aria-label="Permalink to “Aster Native Image 详细构建指南”">​</a></h1><p>本文档提供 Aster Native Image 的详细编译步骤、高级配置选项和最佳实践。</p><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to “目录”">​</a></h2><ul><li><a href="#环境准备">环境准备</a></li><li><a href="#编译模式">编译模式</a></li><li><a href="#高级配置选项">高级配置选项</a></li><li><a href="#构建优化技巧">构建优化技巧</a></li><li><a href="#cicd-集成">CI/CD 集成</a></li><li><a href="#故障排查">故障排查</a></li></ul><h2 id="环境准备" tabindex="-1">环境准备 <a class="header-anchor" href="#环境准备" aria-label="Permalink to “环境准备”">​</a></h2><h3 id="_1-安装-graalvm" tabindex="-1">1. 安装 GraalVM <a class="header-anchor" href="#_1-安装-graalvm" aria-label="Permalink to “1. 安装 GraalVM”">​</a></h3><p><strong>方式 1: SDKMAN (推荐 - Linux/macOS)</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 安装 SDKMAN</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;https://get.sdkman.io&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 安装 GraalVM</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sdk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> java</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 25-graal</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 设置为默认 JDK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sdk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> java</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 25-graal</span></span></code></pre></div><p><strong>方式 2: 手动下载</strong></p><ol><li>访问 <a href="https://www.graalvm.org/downloads/" target="_blank" rel="noreferrer">GraalVM Downloads</a></li><li>下载 GraalVM 25.0.0 或更高版本</li><li>解压并设置环境变量:<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JAVA_HOME</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/path/to/graalvm</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$JAVA_HOME/bin:$PATH</span></span></code></pre></div></li></ol><h3 id="_2-安装-native-image" tabindex="-1">2. 安装 Native Image <a class="header-anchor" href="#_2-安装-native-image" aria-label="Permalink to “2. 安装 Native Image”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 检查是否已安装</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">native-image</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --version</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 如果未安装,使用 gu (GraalVM Updater) 安装</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gu</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> native-image</span></span></code></pre></div><h3 id="_3-平台特定要求" tabindex="-1">3. 平台特定要求 <a class="header-anchor" href="#_3-平台特定要求" aria-label="Permalink to “3. 平台特定要求”">​</a></h3><p><strong>macOS</strong>:</p><ul><li>Xcode Command Line Tools: <code>xcode-select --install</code></li><li>确认 C 编译器可用: <code>cc --version</code></li></ul><p><strong>Linux</strong>:</p><ul><li>GCC/G++ 编译器: <code>sudo apt-get install build-essential</code> (Debian/Ubuntu)</li><li>Zlib 开发库: <code>sudo apt-get install zlib1g-dev</code></li></ul><p><strong>Windows</strong>:</p><ul><li>Visual Studio 2019 或更高版本 (需要 C++ 工作负载)</li><li>或使用 Microsoft Visual C++ Build Tools</li></ul><h3 id="_4-验证环境" tabindex="-1">4. 验证环境 <a class="header-anchor" href="#_4-验证环境" aria-label="Permalink to “4. 验证环境”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 验证 Java 版本</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -version</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 输出应包含: Oracle GraalVM 25+37.1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 验证 native-image</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">native-image</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --version</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 输出应包含: native-image 25.0.0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 验证 C 编译器</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --version</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># macOS: Apple clang 或 GCC</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Linux: GCC</span></span></code></pre></div><h2 id="编译模式" tabindex="-1">编译模式 <a class="header-anchor" href="#编译模式" aria-label="Permalink to “编译模式”">​</a></h2><p>Aster Native Image 支持三种编译模式:</p><h3 id="模式-1-baseline-标准编译" tabindex="-1">模式 1: Baseline (标准编译) <a class="header-anchor" href="#模式-1-baseline-标准编译" aria-label="Permalink to “模式 1: Baseline (标准编译)”">​</a></h3><p><strong>适用场景</strong>: 快速开发、测试、简单部署</p><p><strong>命令</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --no-configuration-cache</span></span></code></pre></div><p><strong>特点</strong>:</p><ul><li>✅ 编译时间: 2-5 分钟</li><li>✅ 二进制大小: ~37 MB</li><li>✅ 启动时间: ~20ms</li><li>✅ 无需额外步骤</li></ul><p><strong>输出位置</strong>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>aster-truffle/build/native/nativeCompile/aster</span></span></code></pre></div><h3 id="模式-2-pgo-profile-guided-optimization-推荐" tabindex="-1">模式 2: PGO (Profile-Guided Optimization) - 推荐 <a class="header-anchor" href="#模式-2-pgo-profile-guided-optimization-推荐" aria-label="Permalink to “模式 2: PGO (Profile-Guided Optimization) - 推荐”">​</a></h3><p><strong>适用场景</strong>: 生产部署、容器化环境、追求最小二进制大小</p><p><strong>步骤</strong>:</p><p><strong>Step 1: Instrumented Build</strong> (编译带性能剖析的版本)</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clean</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -PpgoMode=instrument</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --no-configuration-cache</span></span></code></pre></div><ul><li>编译时间: ~1分16秒</li><li>二进制大小: ~98 MB (包含剖析代码)</li></ul><p><strong>Step 2: Profile Collection</strong> (收集性能数据)</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 运行代表性工作负载</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benchmarks/core/fibonacci_20_core.json</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benchmarks/core/list_map_1000_core.json</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benchmarks/core/quicksort_core.json</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benchmarks/core/factorial_20_core.json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 其他自定义工作负载...</span></span></code></pre></div><ul><li>Profile 数据自动保存到 <code>default.iprof</code></li><li>文件大小: ~7.2 MB</li></ul><p><strong>Step 3: Optimized Build</strong> (使用 profile 重新编译)</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -PpgoMode=$(pwd)/default.iprof</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --no-configuration-cache</span></span></code></pre></div><p><strong>重要</strong>: 必须使用绝对路径,因为 Native Image 编译器从项目根目录执行。</p><p><strong>特点</strong>:</p><ul><li>✅ 编译时间: ~38秒 (Step 3)</li><li>✅ 二进制大小: <strong>23 MB</strong> (-37.6% vs baseline)</li><li>✅ 代码区域优化: -74.2% (40.80MB → 10.51MB)</li><li>✅ 镜像堆优化: -75.6% (56.16MB → 13.70MB)</li><li>⚠️ 启动时间: ~32ms (略慢于 baseline,但仍 &lt; 50ms 目标)</li></ul><h3 id="模式-3-pgo-size-optimization-极限优化" tabindex="-1">模式 3: PGO + Size Optimization (极限优化) <a class="header-anchor" href="#模式-3-pgo-size-optimization-极限优化" aria-label="Permalink to “模式 3: PGO + Size Optimization (极限优化)”">​</a></h3><p><strong>适用场景</strong>: 嵌入式设备、极端带宽限制、ROM 空间受限</p><p><strong>命令</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -PpgoMode=$(pwd)/default.iprof</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -PsizeOptimization=true</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --no-configuration-cache</span></span></code></pre></div><p><strong>特点</strong>:</p><ul><li>✅ 二进制大小: ~20-21 MB (估计,再减少 5-10%)</li><li>❌ 调试信息: 已移除 (影响堆栈跟踪)</li><li>❌ 字符集: 仅包含必需字符集 (可能影响某些字符处理)</li><li>⚠️ 风险: 中等,仅在极端场景使用</li></ul><p><strong>不推荐原因</strong>:</p><ul><li>边际收益有限 (23MB → 20MB,仅节省 3MB)</li><li>移除调试信息影响生产问题诊断</li><li>字符集限制可能破坏某些功能</li></ul><h2 id="高级配置选项" tabindex="-1">高级配置选项 <a class="header-anchor" href="#高级配置选项" aria-label="Permalink to “高级配置选项”">​</a></h2><h3 id="gradle-参数说明" tabindex="-1">Gradle 参数说明 <a class="header-anchor" href="#gradle-参数说明" aria-label="Permalink to “Gradle 参数说明”">​</a></h3><p><strong>1. <code>-PpgoMode</code> (Profile-Guided Optimization)</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Instrumented build (收集 profile)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PpgoMode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">instrument</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Optimized build (使用 profile)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PpgoMode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/absolute/path/to/profile.iprof</span></span></code></pre></div><p><strong>2. <code>-PsizeOptimization</code> (极限大小优化)</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 启用额外优化标志</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PsizeOptimization</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">true</span></span></code></pre></div><p>启用的优化:</p><ul><li><code>-O3</code>: 最高优化级别 (注: 默认已是 O3)</li><li><code>--gc=serial</code>: Serial GC (注: 默认已是 serial)</li><li><code>-H:+StripDebugInfo</code>: 移除调试信息</li><li><code>-H:-AddAllCharsets</code>: 仅包含必需字符集</li><li><code>-H:+RemoveUnusedSymbols</code>: 移除未使用符号</li></ul><p><strong>3. <code>--no-configuration-cache</code></strong></p><p>禁用 Gradle 配置缓存,确保编译参数正确应用。</p><p><strong>4. <code>--rerun-tasks</code></strong></p><p>强制重新执行所有任务,即使 Gradle 认为它们是最新的。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --rerun-tasks</span></span></code></pre></div><h3 id="native-image-高级参数" tabindex="-1">Native Image 高级参数 <a class="header-anchor" href="#native-image-高级参数" aria-label="Permalink to “Native Image 高级参数”">​</a></h3><p>如需手动添加 Native Image 参数,可以修改 <code>aster-truffle/build.gradle.kts</code>:</p><div class="language-kotlin"><button title="Copy Code" class="copy"></button><span class="lang">kotlin</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--verbose&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 详细输出</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-H:+PrintAnalysisStatistics&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 打印分析统计</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-march=native&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)          </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// CPU 特定优化 (牺牲可移植性)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-H:+ReportUnsupportedElementsAtRuntime&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 运行时报告不支持的元素</span></span></code></pre></div><h2 id="构建优化技巧" tabindex="-1">构建优化技巧 <a class="header-anchor" href="#构建优化技巧" aria-label="Permalink to “构建优化技巧”">​</a></h2><h3 id="_1-增量编译" tabindex="-1">1. 增量编译 <a class="header-anchor" href="#_1-增量编译" aria-label="Permalink to “1. 增量编译”">​</a></h3><p>Native Image 支持增量编译,但需要保持 <code>build/</code> 目录:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 首次编译 (慢)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 仅修改少量代码后 (快)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span></span></code></pre></div><h3 id="_2-并行编译" tabindex="-1">2. 并行编译 <a class="header-anchor" href="#_2-并行编译" aria-label="Permalink to “2. 并行编译”">​</a></h3><p>GraalVM Native Image 自动使用多核并行编译:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 默认使用 100% 可用处理器核心</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 编译日志显示: 10 thread(s) (100.0% of 10 available processor(s))</span></span></code></pre></div><p>如需限制核心数:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-J-XX:ActiveProcessorCount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 使用 4 个核心</span></span></code></pre></div><h3 id="_3-内存调优" tabindex="-1">3. 内存调优 <a class="header-anchor" href="#_3-内存调优" aria-label="Permalink to “3. 内存调优”">​</a></h3><p>默认 Native Image 使用 80% 可用 RAM:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 编译日志显示: 22.27GB of memory (32.4% of system memory)</span></span></code></pre></div><p>如遇内存不足,可以增加 JVM 堆:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JAVA_OPTS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-Xmx8g&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 最大 8GB 堆内存</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span></span></code></pre></div><h3 id="_4-快速构建模式-开发" tabindex="-1">4. 快速构建模式 (开发) <a class="header-anchor" href="#_4-快速构建模式-开发" aria-label="Permalink to “4. 快速构建模式 (开发)”">​</a></h3><p>使用 <code>-Ob</code> (quick build mode) 加速开发时的编译:</p><div class="language-kotlin"><button title="Copy Code" class="copy"></button><span class="lang">kotlin</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 在 build.gradle.kts 中添加</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-Ob&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Quick build mode</span></span></code></pre></div><p><strong>注意</strong>: 牺牲运行时性能,仅用于开发测试。</p><h2 id="ci-cd-集成" tabindex="-1">CI/CD 集成 <a class="header-anchor" href="#ci-cd-集成" aria-label="Permalink to “CI/CD 集成”">​</a></h2><h3 id="github-actions-示例" tabindex="-1">GitHub Actions 示例 <a class="header-anchor" href="#github-actions-示例" aria-label="Permalink to “GitHub Actions 示例”">​</a></h3><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Build Native Image</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pull_request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">jobs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    runs-on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ubuntu-latest</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    steps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">uses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">actions/checkout@v3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Setup GraalVM</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      uses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">graalvm/setup-graalvm@v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        java-version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;25&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        distribution</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;graalvm&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        github-token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\${{ secrets.GITHUB_TOKEN }}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        native-image-job-reports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;true&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Build Native Image (Baseline)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        ./gradlew :aster-truffle:nativeCompile --no-configuration-cache</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Test Native Image</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        ./aster-truffle/build/native/nativeCompile/aster benchmarks/core/fibonacci_20_core.json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Upload Binary</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      uses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">actions/upload-artifact@v3</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">aster-native</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">aster-truffle/build/native/nativeCompile/aster</span></span></code></pre></div><h3 id="docker-构建示例" tabindex="-1">Docker 构建示例 <a class="header-anchor" href="#docker-构建示例" aria-label="Permalink to “Docker 构建示例”">​</a></h3><div class="language-dockerfile"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ghcr.io/graalvm/graalvm-ce:ol9-java25</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 安装依赖</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> microdnf install -y gcc gcc-c++ zlib-devel</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 复制项目</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> . /app</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 编译 Native Image</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ./gradlew :aster-truffle:nativeCompile --no-configuration-cache</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 最小化最终镜像</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> registry.access.redhat.com/ubi9/ubi-minimal:9.0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --from=0 /app/aster-truffle/build/native/nativeCompile/aster /usr/local/bin/aster</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENTRYPOINT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;aster&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><h2 id="故障排查" tabindex="-1">故障排查 <a class="header-anchor" href="#故障排查" aria-label="Permalink to “故障排查”">​</a></h2><h3 id="常见问题" tabindex="-1">常见问题 <a class="header-anchor" href="#常见问题" aria-label="Permalink to “常见问题”">​</a></h3><p><strong>1. <code>ClassNotFoundException</code> 或 <code>NoSuchMethodException</code></strong></p><p><strong>原因</strong>: 反射配置不完整</p><p><strong>解决方法</strong>:</p><ul><li>检查 <code>META-INF/native-image/reflect-config.json</code></li><li>使用 Native Image Agent 重新生成配置:<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -agentlib:native-image-agent=config-output-dir=META-INF/native-image</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster-truffle.jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> your-program.aster</span></span></code></pre></div></li></ul><p><strong>2. 资源文件找不到</strong></p><p><strong>原因</strong>: 资源配置缺失</p><p><strong>解决方法</strong>:</p><ul><li>检查 <code>META-INF/native-image/resource-config.json</code></li><li>确保资源文件在 <code>resources/</code> 目录下</li></ul><p><strong>3. 编译时间过长 (&gt; 10分钟)</strong></p><p><strong>可能原因</strong>:</p><ul><li>内存不足导致 GC 频繁</li><li>CPU 性能限制</li></ul><p><strong>解决方法</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 检查编译日志中的 GC 时间</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 正常: 2.6s (6.8% of total time) in 546 GCs</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 异常: &gt; 20% 时间在 GC</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 增加堆内存</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JAVA_OPTS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-Xmx16g&quot;</span></span></code></pre></div><p><strong>4. Profile 文件路径错误</strong></p><p><strong>错误信息</strong>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Error: Cannot load profile default.iprof (reason: java.io.FileNotFoundException)</span></span></code></pre></div><p><strong>解决方法</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用绝对路径</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PpgoMode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pwd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/default.iprof</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 或</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PpgoMode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/Users/your-username/project/default.iprof</span></span></code></pre></div><p><strong>5. 编译失败: &quot;Unsupported features&quot;</strong></p><p><strong>原因</strong>: 使用了 Native Image 不支持的 Java 特性</p><p><strong>解决方法</strong>:</p><ul><li>检查错误日志中的不支持特性</li><li>添加 fallback 或替代实现</li><li>使用 <code>-H:+ReportUnsupportedElementsAtRuntime</code> 推迟到运行时报告</li></ul><p>更多故障排查信息,请查看 <a href="./troubleshooting.html">troubleshooting.md</a>。</p><h2 id="性能基准" tabindex="-1">性能基准 <a class="header-anchor" href="#性能基准" aria-label="Permalink to “性能基准”">​</a></h2><h3 id="编译时间对比" tabindex="-1">编译时间对比 <a class="header-anchor" href="#编译时间对比" aria-label="Permalink to “编译时间对比”">​</a></h3><table tabindex="0"><thead><tr><th>模式</th><th>编译时间</th><th>增量编译</th></tr></thead><tbody><tr><td>Baseline</td><td>2-5 分钟</td><td>~1 分钟</td></tr><tr><td>PGO Instrumented</td><td>~1分16秒</td><td>~40秒</td></tr><tr><td>PGO Optimized</td><td>~38秒</td><td>~20秒</td></tr></tbody></table><h3 id="二进制大小对比" tabindex="-1">二进制大小对比 <a class="header-anchor" href="#二进制大小对比" aria-label="Permalink to “二进制大小对比”">​</a></h3><table tabindex="0"><thead><tr><th>模式</th><th>大小</th><th>vs Baseline</th></tr></thead><tbody><tr><td>Baseline</td><td>36.88 MB</td><td>-</td></tr><tr><td>PGO Instrumented</td><td>97.99 MB</td><td>+165%</td></tr><tr><td>PGO Optimized</td><td><strong>23 MB</strong></td><td><strong>-37.6%</strong></td></tr><tr><td>PGO + Size Opt</td><td>~20-21 MB (估计)</td><td>~-43%</td></tr></tbody></table><h3 id="启动时间对比" tabindex="-1">启动时间对比 <a class="header-anchor" href="#启动时间对比" aria-label="Permalink to “启动时间对比”">​</a></h3><table tabindex="0"><thead><tr><th>模式</th><th>启动时间</th><th>vs JVM</th></tr></thead><tbody><tr><td>JVM</td><td>5-10s</td><td>-</td></tr><tr><td>Native Baseline</td><td>~20ms</td><td><strong>250-500x</strong></td></tr><tr><td>Native PGO</td><td>~32ms</td><td><strong>156-312x</strong></td></tr></tbody></table><h2 id="最佳实践" tabindex="-1">最佳实践 <a class="header-anchor" href="#最佳实践" aria-label="Permalink to “最佳实践”">​</a></h2><h3 id="_1-选择合适的编译模式" tabindex="-1">1. 选择合适的编译模式 <a class="header-anchor" href="#_1-选择合适的编译模式" aria-label="Permalink to “1. 选择合适的编译模式”">​</a></h3><ul><li><strong>开发/测试</strong>: Baseline (快速编译)</li><li><strong>生产部署</strong>: PGO (最小二进制,降低带宽和存储成本)</li><li><strong>极端场景</strong>: PGO + Size Opt (嵌入式设备,慎用)</li></ul><h3 id="_2-profile-数据管理" tabindex="-1">2. Profile 数据管理 <a class="header-anchor" href="#_2-profile-数据管理" aria-label="Permalink to “2. Profile 数据管理”">​</a></h3><ul><li>使用<strong>真实生产负载</strong>收集 profile (而非测试用例)</li><li>定期更新 profile 数据 (每季度或主要功能变更后)</li><li>保存 profile 文件到版本控制 (可复现构建)</li></ul><h3 id="_3-ci-cd-构建策略" tabindex="-1">3. CI/CD 构建策略 <a class="header-anchor" href="#_3-ci-cd-构建策略" aria-label="Permalink to “3. CI/CD 构建策略”">​</a></h3><ul><li><strong>开发分支</strong>: Baseline (快速反馈)</li><li><strong>主分支/发布</strong>: PGO (生产质量)</li><li><strong>缓存 Gradle 和 Native Image 构建缓存</strong>: 加速 CI</li></ul><h3 id="_4-监控编译指标" tabindex="-1">4. 监控编译指标 <a class="header-anchor" href="#_4-监控编译指标" aria-label="Permalink to “4. 监控编译指标”">​</a></h3><p>关键指标:</p><ul><li>编译时间: 应 &lt; 5 分钟 (Baseline) 或 &lt; 2 分钟 (PGO)</li><li>二进制大小: 应 &lt; 50 MB</li><li>Peak RSS: 应 &lt; 5 GB</li></ul><h3 id="_5-版本控制" tabindex="-1">5. 版本控制 <a class="header-anchor" href="#_5-版本控制" aria-label="Permalink to “5. 版本控制”">​</a></h3><p>提交到版本控制的文件:</p><ul><li>✅ <code>META-INF/native-image/*.json</code> (配置文件)</li><li>✅ <code>default.iprof</code> (如果稳定)</li><li>❌ <code>build/</code> 目录</li><li>❌ 编译后的二进制文件</li></ul><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to “参考资料”">​</a></h2><ul><li><a href="https://www.graalvm.org/latest/reference-manual/native-image/" target="_blank" rel="noreferrer">GraalVM Native Image 官方文档</a></li><li><a href="https://www.graalvm.org/latest/reference-manual/native-image/optimizations-and-performance/PGO/" target="_blank" rel="noreferrer">Profile-Guided Optimization 指南</a></li><li><a href="https://www.graalvm.org/latest/graalvm-as-a-platform/language-implementation-framework/" target="_blank" rel="noreferrer">Truffle 语言实现框架</a></li></ul><h2 id="下一步" tabindex="-1">下一步 <a class="header-anchor" href="#下一步" aria-label="Permalink to “下一步”">​</a></h2><ul><li><strong>性能对比</strong>: 查看 <a href="./performance-comparison.html">performance-comparison.md</a></li><li><strong>故障排查</strong>: 查看 <a href="./troubleshooting.html">troubleshooting.md</a></li><li><strong>限制说明</strong>: 查看 <a href="./limitations.html">limitations.md</a></li></ul>`,141)])])}const c=i(e,[["render",t]]);export{o as __pageData,c as default};
