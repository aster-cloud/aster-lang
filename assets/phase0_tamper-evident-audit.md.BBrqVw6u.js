import{_ as i,c as a,o as n,aj as t}from"./chunks/framework.Bz2R-749.js";const c=JSON.parse('{"title":"防篡改审计日志","description":"","frontmatter":{},"headers":[],"relativePath":"phase0/tamper-evident-audit.md","filePath":"phase0/tamper-evident-audit.md"}'),e={name:"phase0/tamper-evident-audit.md"};function l(h,s,p,k,d,r){return n(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="防篡改审计日志" tabindex="-1">防篡改审计日志 <a class="header-anchor" href="#防篡改审计日志" aria-label="Permalink to “防篡改审计日志”">​</a></h1><blockquote><p>更新时间：2025-11-15 21:29 NZST · 执行者：Codex</p></blockquote><h2 id="工作原理" tabindex="-1">工作原理 <a class="header-anchor" href="#工作原理" aria-label="Permalink to “工作原理”">​</a></h2><p>AuditEventListener 在持久化 <code>AuditLog</code> 时会根据租户维度构建哈希链：</p><ol><li><strong>Genesis Block</strong>：同一租户的第一条记录 <code>prev_hash=null</code>；之后每条记录的 <code>prev_hash</code> 指向上一条记录的 <code>current_hash</code>。</li><li><strong>哈希构建</strong>：使用 <code>DigestUtils.sha256Hex()</code> 计算 <code>current_hash</code>。输入字段顺序固定，任何字符级别的变动都能被检测。</li><li><strong>租户隔离</strong>：<code>AuditLog.findLatestHash(tenantId)</code> 仅返回当前租户最末尾的 hash，避免跨租户竞争。</li></ol><p>当链路异常（插入、删除或篡改）时，验证器会立即发现 <code>prev_hash mismatch</code> 或 <code>current_hash tampered</code>，并返回断点时间戳。</p><h2 id="哈希计算规则" tabindex="-1">哈希计算规则 <a class="header-anchor" href="#哈希计算规则" aria-label="Permalink to “哈希计算规则”">​</a></h2><p>字段拼接顺序必须与 <code>AuditEventListener.computeHashChain()</code> 一致：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>content = prevHash</span></span>
<span class="line"><span>        + eventType</span></span>
<span class="line"><span>        + timestamp</span></span>
<span class="line"><span>        + tenantId</span></span>
<span class="line"><span>        + policyModule</span></span>
<span class="line"><span>        + policyFunction</span></span>
<span class="line"><span>        + success</span></span>
<span class="line"><span>currentHash = SHA256(content)</span></span></code></pre></div><p>注意事项：</p><ul><li><code>prevHash</code> 允许为 <code>null</code>（Genesis Block），其他字段遇到 <code>null</code> 会降级为空字符串。</li><li>timestamp 采用 ISO-8601 字符串，比较时请保持时区一致。</li><li><code>success</code> 转换为 <code>Boolean#toString()</code>，因此 <code>true</code> / <code>false</code> 均为小写。</li></ul><h2 id="api-使用示例" tabindex="-1">API 使用示例 <a class="header-anchor" href="#api-使用示例" aria-label="Permalink to “API 使用示例”">​</a></h2><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 正确示例：分页校验链路并在失败时中断发布</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.aster.audit.chain.AuditChainVerifier;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.aster.audit.chain.ChainVerificationResult;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jakarta.enterprise.context.ApplicationScoped;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jakarta.inject.Inject;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.Instant;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.temporal.ChronoUnit;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ApplicationScoped</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AuditChainGuard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Inject</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    AuditChainVerifier verifier;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> verifyBeforeExport</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tenantId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ChainVerificationResult result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> verifier.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">verifyChainPaginated</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            tenantId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Instant.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">minus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">14</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ChronoUnit.DAYS),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Instant.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            500</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 分页大小</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        );</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isValid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IllegalStateException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                &quot;审计链断裂，位置=&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getBrokenAt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;, 原因=&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getReason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误示例：查询全量数据且忽略验证结果</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AuditChainGuardLegacy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Inject</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    AuditChainVerifier verifier;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> verifyAllTenants</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ChainVerificationResult result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> verifier.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">verifyChain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;tenant-a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Instant.EPOCH, Instant.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 忽略 result.isValid() 会让下游误以为链路可靠，同时全表扫描 Instant.EPOCH -&gt; Now 会触发慢查询</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="验证流程" tabindex="-1">验证流程 <a class="header-anchor" href="#验证流程" aria-label="Permalink to “验证流程”">​</a></h2><ol><li><strong>确定查询窗口</strong>：根据审计需求选择时间范围与租户 ID。推荐按天或按周滑窗。</li><li><strong>获取记录</strong>：<code>verifyChain</code> 会按 <code>timestamp ASC, id ASC</code> 加载记录，并跳过旧的无哈希数据。</li><li><strong>比对 prevHash</strong>：若 <code>log.prevHash</code> 与 <code>expectedPrevHash</code> 不相等，则断定为链断裂（记录被删除或插入）。</li><li><strong>重算 currentHash</strong>：使用相同顺序重算 SHA256 并与存量比较，检测字段被修改。</li><li><strong>返回结果</strong>：若全部记录通过，返回 <code>ChainVerificationResult.valid(records)</code>；否则返回 <code>invalid</code>，携带断点和原因。</li></ol><h2 id="性能建议" tabindex="-1">性能建议 <a class="header-anchor" href="#性能建议" aria-label="Permalink to “性能建议”">​</a></h2><ul><li><strong>分页验证</strong>：日志量超过 1000 条时使用 <code>verifyChainPaginated</code>，逐页推进 <code>expectedPrevHash</code>，避免一次性加载超大结果。</li><li><strong>限制时间范围</strong>：为每次验证设定最大窗口（如 24 小时），多天数据可按天循环，降低数据库 I/O。</li><li><strong>跳过遗留记录</strong>：旧版本没有哈希字段时会自动跳过，可通过 <code>Log.debugf(&quot;Skipping legacy record...&quot;)</code> 观察迁移进度。</li><li><strong>异步批处理</strong>：长区间验证可交给批处理任务，通过 <code>CompletableFuture</code> 并发校验多个租户。</li></ul><h2 id="故障排查" tabindex="-1">故障排查 <a class="header-anchor" href="#故障排查" aria-label="Permalink to “故障排查”">​</a></h2><table tabindex="0"><thead><tr><th>现象</th><th>常见原因</th><th>解决建议</th></tr></thead><tbody><tr><td><code>prev_hash mismatch</code></td><td>中间记录被删除、插入或 out-of-order 插入</td><td>检查数据库审计表是否存在手工操作；合并排序条件为 <code>timestamp ASC, id ASC</code>；通过 <code>pgAudit</code> 查明来源</td></tr><tr><td><code>current_hash tampered</code></td><td>字段被修改或未应用 PIIRedactor 导致值变化</td><td>对比 <code>AuditLog</code> 旧值与现值，结合 <code>AuditLogger</code> 输出确认是否存在补写流程</td></tr><tr><td>验证时间过长</td><td>查询窗口过大或缺少索引</td><td>在 <code>tenant_id, timestamp</code> 上确认索引存在；使用 <code>verifyChainPaginated</code> 分段处理</td></tr><tr><td>结果为 valid 但业务方仍怀疑被改</td><td>可能在窗口外或未涵盖全部租户</td><td>扩大时间窗口并在 <code>ChainVerificationResult.recordsVerified</code> 基础上校对期望条数</td></tr></tbody></table>`,19)])])}const E=i(e,[["render",l]]);export{c as __pageData,E as default};
