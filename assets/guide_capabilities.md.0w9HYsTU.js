import{_ as s,c as e,o as a,aj as t}from"./chunks/framework.Bz2R-749.js";const k=JSON.parse('{"title":"Capabilities & Effects","description":"","frontmatter":{},"headers":[],"relativePath":"guide/capabilities.md","filePath":"guide/capabilities.md"}'),n={name:"guide/capabilities.md"};function l(o,i,h,p,c,d){return a(),e("div",null,[...i[0]||(i[0]=[t(`<h1 id="capabilities-effects" tabindex="-1">Capabilities &amp; Effects <a class="header-anchor" href="#capabilities-effects" aria-label="Permalink to “Capabilities &amp; Effects”">​</a></h1><p>This guide explains how to enforce declared effects against a capability manifest at typecheck-time and in the LSP.</p><h2 id="effects-in-function-headers" tabindex="-1">Effects in function headers <a class="header-anchor" href="#effects-in-function-headers" aria-label="Permalink to “Effects in function headers”">​</a></h2><p>Use the header clause to declare effects:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>To hello with name: Text, produce Text. It performs IO:</span></span>
<span class="line"><span>  Return Text.concat(&quot;Hello, &quot;, name).</span></span></code></pre></div><p>Supported effects:</p><ul><li><code>IO</code></li><li><code>CPU</code></li></ul><h2 id="effect-inference-configuration" tabindex="-1">Effect Inference Configuration <a class="header-anchor" href="#effect-inference-configuration" aria-label="Permalink to “Effect Inference Configuration”">​</a></h2><p>The effect inference system automatically detects effects based on function call prefixes. You can customize which prefixes trigger which effects.</p><h3 id="default-configuration" tabindex="-1">Default Configuration <a class="header-anchor" href="#default-configuration" aria-label="Permalink to “Default Configuration”">​</a></h3><p>By default, the following prefixes are recognized:</p><p><strong>IO Effects:</strong></p><ul><li><code>IO.</code> - General I/O operations</li><li><code>Http.</code> - HTTP requests</li><li><code>Db.</code> - Database operations</li><li><code>AuthRepo.</code>, <code>ProfileSvc.</code>, <code>FeedSvc.</code> - Service calls</li><li><code>UUID.randomUUID</code> - Random generation (secrets)</li></ul><p><strong>CPU Effects:</strong></p><ul><li>Currently empty (effects propagate through call chains)</li></ul><h3 id="custom-configuration" tabindex="-1">Custom Configuration <a class="header-anchor" href="#custom-configuration" aria-label="Permalink to “Custom Configuration”">​</a></h3><p>Create a <code>.aster/effects.json</code> file in your project root to customize effect inference:</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;patterns&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;io&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;http&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Http.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MyHttpClient.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;fetch.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;sql&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Db.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MyORM.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Sql.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;files&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Files.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Fs.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;secrets&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UUID.randomUUID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Secrets.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;vault.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;time&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Time.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Date.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Clock.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;cpu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Math.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;crypto.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;ai&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;AI.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;OpenAI.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Fine-grained categorization:</strong></p><ul><li><code>io.http</code> - HTTP/network operations</li><li><code>io.sql</code> - Database queries</li><li><code>io.files</code> - File system access</li><li><code>io.secrets</code> - Secret/credential access</li><li><code>io.time</code> - Time-dependent operations</li></ul><h3 id="environment-variable" tabindex="-1">Environment Variable <a class="header-anchor" href="#environment-variable" aria-label="Permalink to “Environment Variable”">​</a></h3><p>Override the default config location using <code>ASTER_EFFECT_CONFIG</code>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ASTER_EFFECT_CONFIG</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/path/to/custom-effects.json</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tsx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scripts/typecheck-cli.ts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> myfile.aster</span></span></code></pre></div><h3 id="configuration-fallback" tabindex="-1">Configuration Fallback <a class="header-anchor" href="#configuration-fallback" aria-label="Permalink to “Configuration Fallback”">​</a></h3><p>If the config file doesn&#39;t exist or fails to load, the system falls back to the default configuration silently. This ensures backward compatibility.</p><h3 id="example-custom-http-client" tabindex="-1">Example: Custom HTTP Client <a class="header-anchor" href="#example-custom-http-client" aria-label="Permalink to “Example: Custom HTTP Client”">​</a></h3><p>If your project uses a custom HTTP client library:</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;patterns&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;io&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;http&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MyApi.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;HttpService.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Then functions calling <code>MyApi.get()</code> will automatically be inferred as requiring <code>@io</code> effect:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>To fetch_data, produce Text:</span></span>
<span class="line"><span>  Return MyApi.get(&quot;/users&quot;).  // Inferred as IO</span></span></code></pre></div><p>Without declaring <code>It performs io</code>, this will trigger a typecheck error.</p><h2 id="capability-manifest" tabindex="-1">Capability manifest <a class="header-anchor" href="#capability-manifest" aria-label="Permalink to “Capability manifest”">​</a></h2><p>Enable checks by setting <code>ASTER_CAPS</code> to a JSON manifest file.</p><p>Environment examples:</p><ul><li>CLI: <code>ASTER_CAPS=test/cnl/examples/capabilities.json node dist/scripts/typecheck-cli.js test/cnl/examples/capdemo.aster</code></li><li>LSP: <code>ASTER_CAPS=test/cnl/examples/capabilities.json npm run lsp</code></li></ul><p>Manifest schema (JSON):</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>{</span></span>
<span class="line"><span>  &quot;allow&quot;: { &quot;io&quot;: [&quot;module.*&quot;, &quot;module.func&quot;], &quot;cpu&quot;: [&quot;*&quot;] },</span></span>
<span class="line"><span>  &quot;deny&quot;:  { &quot;io&quot;: [&quot;module.bad*&quot;], &quot;cpu&quot;: [] }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>Rules:</p><ul><li><code>deny</code> takes precedence over <code>allow</code> when specified.</li><li>Patterns supported: <code>*</code>, <code>module</code>, <code>module.*</code>, <code>module.func</code>, and suffix wildcard <code>module.func*</code>.</li></ul><p>Examples:</p><ul><li>Allow all IO in a module: <code>{ &quot;allow&quot;: { &quot;io&quot;: [&quot;demo.capdemo.*&quot;] } }</code></li><li>Allow all but a specific function (deny precedence): <code>{ &quot;allow&quot;: { &quot;io&quot;: [&quot;demo.capdemo.*&quot;] }, &quot;deny&quot;: { &quot;io&quot;: [&quot;demo.capdemo.hello&quot;] } }</code></li></ul><h2 id="diagnostics" tabindex="-1">Diagnostics <a class="header-anchor" href="#diagnostics" aria-label="Permalink to “Diagnostics”">​</a></h2><h3 id="effect-enforcement-note" tabindex="-1">Effect enforcement note <a class="header-anchor" href="#effect-enforcement-note" aria-label="Permalink to “Effect enforcement note”">​</a></h3><ul><li>Effect declarations are enforced at compile-time.</li><li>Minimal lattice: ∅ ⊑ CPU ⊑ IO[*] (declaring @io satisfies CPU work).</li><li>Superfluous @io when only CPU-like work is detected is reported as info; superfluous @cpu with no CPU-like work is a warning.</li></ul><p>When a function declares an effect that is not allowed by the manifest, the typechecker emits an error like:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>ERROR: Function &#39;hello&#39; declares @io but capability manifest does not allow it for module &#39;demo.capdemo&#39;.</span></span></code></pre></div><p>These diagnostics also appear in the LSP if <code>ASTER_CAPS</code> is set.</p><h2 id="quick-fixes-lsp" tabindex="-1">Quick Fixes (LSP) <a class="header-anchor" href="#quick-fixes-lsp" aria-label="Permalink to “Quick Fixes (LSP)”">​</a></h2><p>When using the VS Code extension with the language server:</p><ul><li>Missing effect on a function header shows a quick-fix “Add It performs IO/CPU …”.</li><li>Superfluous effect shows “Remove It performs IO/CPU …”.</li><li>Capability violation offers manifest edits (when <code>ASTER_CAPS</code> is set): <ul><li>Allow for the specific function FQN (e.g., <code>demo.capdemo.hello</code>).</li><li>Allow for the entire module (<code>demo.capdemo.*</code>).</li><li>If <code>module.*</code> is already present, “Narrow” to <code>module.func</code>.</li><li>If <code>module.func</code> is present, “Broaden” to <code>module.*</code>.</li></ul></li></ul><h3 id="debugging-code-actions" tabindex="-1">Debugging code actions <a class="header-anchor" href="#debugging-code-actions" aria-label="Permalink to “Debugging code actions”">​</a></h3><p>You can use the smoke scripts to exercise the server and print available actions:</p><ul><li><code>node dist/scripts/lsp-codeaction-smoke.js --debug</code></li><li><code>node dist/scripts/lsp-capmanifest-codeaction-smoke.js --debug</code></li></ul><p>These will dump diagnostics and code action titles to the console to help debug.</p><h2 id="golden-tests" tabindex="-1">Golden tests <a class="header-anchor" href="#golden-tests" aria-label="Permalink to “Golden tests”">​</a></h2><p>Two example goldens are included to validate behavior:</p><ul><li><code>capabilities_deny.json</code> denies all IO/CPU: both IO functions in <code>capdemo.aster</code> report errors.</li><li><code>capabilities_mixed.json</code> allows the module but denies a specific function: only that function reports an error.</li></ul><p>Run: <code>npm run test:golden</code></p><h2 id="editor-support" tabindex="-1">Editor support <a class="header-anchor" href="#editor-support" aria-label="Permalink to “Editor support”">​</a></h2><p>When launching the VS Code extension, set <code>ASTER_CAPS=...</code> in the environment so the language server reads the manifest and produces capability diagnostics.</p><blockquote><p>Screenshot placeholders:</p><ul><li>Diagnostics panel showing capability errors for <code>hello</code>.</li><li>Hover or Problems list highlighting denied effect usage.</li></ul></blockquote>`,61)])])}const u=s(n,[["render",l]]);export{k as __pageData,u as default};
