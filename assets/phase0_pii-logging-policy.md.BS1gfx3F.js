import{_ as n,c as l,o as t,j as i,aj as e,a as s}from"./chunks/framework.Bz2R-749.js";const E=JSON.parse('{"title":"PII 敏感信息日志策略","description":"","frontmatter":{},"headers":[],"relativePath":"phase0/pii-logging-policy.md","filePath":"phase0/pii-logging-policy.md"}'),h={name:"phase0/pii-logging-policy.md"};function p(k,a,d,r,o,g){return t(),l("div",null,[...a[0]||(a[0]=[i("h1",{id:"pii-敏感信息日志策略",tabindex:"-1"},[s("PII 敏感信息日志策略 "),i("a",{class:"header-anchor",href:"#pii-敏感信息日志策略","aria-label":"Permalink to “PII 敏感信息日志策略”"},"​")],-1),i("blockquote",null,[i("p",null,"更新时间：2025-11-15 21:29 NZST · 执行者：Codex")],-1),i("h2",{id:"支持的-pii-类型与正则",tabindex:"-1"},[s("支持的 PII 类型与正则 "),i("a",{class:"header-anchor",href:"#支持的-pii-类型与正则","aria-label":"Permalink to “支持的 PII 类型与正则”"},"​")],-1),i("table",{tabindex:"0"},[i("thead",null,[i("tr",null,[i("th",null,"类型"),i("th",null,[s("正则（摘自 "),i("code",null,"PIIRedactor.java"),s("）")]),i("th",null,"占位符")])]),i("tbody",null,[i("tr",null,[i("td",null,"SSN"),i("td",null,[i("code",null,"\\\\b\\\\d{3}-?\\\\d{2}-?\\\\d{4}\\\\b")]),i("td",null,[i("code",null,"***-**-****")])]),i("tr",null,[i("td",null,"Email"),i("td",null,[i("code",null,"\\\\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\\\.[a-zA-Z]{2,}\\\\b")]),i("td",null,[i("code",null,"***@***.***")])]),i("tr",null,[i("td",null,"Phone"),i("td",{4:""},"`\\(\\d{3}\\)\\s*\\d{3}[-.]?\\d"),i("td",null,"\\b\\d{3}[-.]\\d{3}[-.]\\d{4}\\b")]),i("tr",null,[i("td",null,"CreditCard"),i("td",null,[i("code",null,"\\\\b(?:\\\\d{4}[-\\\\s]?){3}\\\\d{4}(?:\\\\d{3})?\\\\b")]),i("td",null,[i("code",null,"****-****-****-****")])]),i("tr",null,[i("td",null,"IP"),i("td",null,[i("code",null,"\\\\b(?:\\\\d{1,3}\\\\.){3}\\\\d{1,3}\\\\b")]),i("td",null,[i("code",null,"***.***.***.***")])])])],-1),e(`<p><code>PIIRedactor.redact()</code> 会按上述顺序执行 <code>replaceAll</code>，因此最终输出永远不会包含原始 PII。</p><h2 id="集成点" tabindex="-1">集成点 <a class="header-anchor" href="#集成点" aria-label="Permalink to “集成点”">​</a></h2><ol><li><strong>全局应用日志</strong>：<code>AuditLogger.toJson()</code> 遍历所有字符串字段并调用 <code>PIIRedactor.redact()</code>，确保 INFO 日志中不泄漏敏感信息。</li><li><strong>审计事件持久化</strong>：<code>AuditEventListener</code> 在写入 <code>AuditLog</code> 时对 <code>tenantId</code>、<code>policyModule</code>、<code>reason</code>、<code>metadata</code> 等字段进行脱敏（包括异步事件 metadata）。</li><li><strong>自定义 Logger</strong>：业务代码可直接持有 <code>PIIRedactor</code> 或其 <code>Builder</code>（可配置性更高）实现额外日志线路的脱敏。</li></ol><h2 id="使用示例" tabindex="-1">使用示例 <a class="header-anchor" href="#使用示例" aria-label="Permalink to “使用示例”">​</a></h2><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 正确示例：在日志写入前调用 PIIRedactor</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.wontlost.aster.policy.PIIRedactor;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.jboss.logging.Logger;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LoginLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Logger LOG </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LoginLogger.class);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PIIRedactor REDACTOR </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PIIRedactor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> logLogin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ssn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        String raw </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;login email=%s ssn=%s ip=%s&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">formatted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(email, ssn, ip);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        LOG.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(REDACTOR.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">redact</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(raw)); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 输出中只有掩码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误示例：直接输出原始 PII，违反日志策略与合规要求</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LoginLoggerLegacy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Logger LOG </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LoginLoggerLegacy.class);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> logLogin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ssn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        LOG.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">infof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;login email=%s ssn=%s ip=%s&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, email, ssn, ip);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 该日志将被合规扫描立即阻断，并触发 ArchUnit 附加检查</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="扩展方法" tabindex="-1">扩展方法 <a class="header-anchor" href="#扩展方法" aria-label="Permalink to “扩展方法”">​</a></h2><ol><li><strong>添加正则</strong>：在 <code>PIIRedactor</code> 中新增 <code>Pattern</code> 常量（例如护照号），并在 <code>redact()</code> / <code>containsPII()</code> 中插入相同顺序的替换逻辑。</li><li><strong>Builder 支持</strong>：更新 <code>PIIRedactor.Builder</code> 增加新的布尔开关，使调用方可以开启/关闭该类型。</li><li><strong>集成验证</strong>：为新类型添加至少 1 条 <code>PIIRedactionIntegrationTest</code> 用例，并根据需要扩展 <code>AuditLogger</code> / <code>AuditEventListener</code> 的字段脱敏。</li><li><strong>渐进发布</strong>：如需暂时禁用，可通过 <code>new PIIRedactor(false, true, true, true, true)</code> 局部关闭部分类型。</li></ol><h2 id="合规性" tabindex="-1">合规性 <a class="header-anchor" href="#合规性" aria-label="Permalink to “合规性”">​</a></h2><ul><li><strong>GDPR</strong>：所有日志输出都不可包含 “可识别个人信息”，PIIRedactor 确保默认掩码，若需要删除数据可直接删除日志行而无需额外清洗。</li><li><strong>CCPA</strong>：支持在导出审计日志前通过 <code>AuditChainVerifier</code> 验证链路，再将掩码后的数据提供给合规团队，减少个人信息暴露。</li><li><strong>审计留痕</strong>：AuditLogger/AuditEventListener 将掩码后的值写入数据库，数据库备份中不会出现原始 PII，降低数据脱敏成本。</li></ul><h2 id="测试验证" tabindex="-1">测试验证 <a class="header-anchor" href="#测试验证" aria-label="Permalink to “测试验证”">​</a></h2><ol><li>运行 <code>SKIP_GENERATE_ASTER_JAR=true ./gradlew :quarkus-policy-api:test --tests PIIRedactionIntegrationTest</code>，确保 6 个用例（SSN、Email、Phone、CreditCard、IP、组合）全部通过。</li><li>若新增 PII 类型，需增加对应测试并确认 <code>containsPII()</code> 能立即识别原始值。</li><li>在本地调试日志输出时，可使用 <code>piiRedactor.containsPII(raw)</code> 快速检测输入是否含敏感内容，避免未脱敏字符串被输出。</li></ol>`,11)])])}const y=n(h,[["render",p]]);export{E as __pageData,y as default};
