import{_ as i,c as a,o as n,aj as t}from"./chunks/framework.Bz2R-749.js";const g=JSON.parse('{"title":"Workflow 确定性合约","description":"","frontmatter":{},"headers":[],"relativePath":"runtime/determinism-contract.md","filePath":"runtime/determinism-contract.md"}'),l={name:"runtime/determinism-contract.md"};function h(e,s,k,p,r,d){return n(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="workflow-确定性合约" tabindex="-1">Workflow 确定性合约 <a class="header-anchor" href="#workflow-确定性合约" aria-label="Permalink to “Workflow 确定性合约”">​</a></h1><p>本文档说明 Aster Workflow Runtime 的确定性保证、API 使用规范、重放语义与限制，帮助开发者正确编写可重放的 workflow 代码。</p><hr><h2 id="_1-确定性保证承诺" tabindex="-1">1. 确定性保证承诺 <a class="header-anchor" href="#_1-确定性保证承诺" aria-label="Permalink to “1. 确定性保证承诺”">​</a></h2><p>Aster Workflow 提供<strong>确定性执行（Deterministic Execution）</strong>保证：</p><blockquote><p><strong>相同的输入和事件序列，无论执行多少次，都会产生完全相同的状态转换和输出结果。</strong></p></blockquote><h3 id="_1-1-保证范围" tabindex="-1">1.1 保证范围 <a class="header-anchor" href="#_1-1-保证范围" aria-label="Permalink to “1.1 保证范围”">​</a></h3><p>✅ <strong>已保证</strong>：</p><ul><li>Workflow 执行产生的所有决策（分支选择、循环次数、任务调度顺序）</li><li>时间相关操作（当前时间、延迟触发）</li><li>随机数生成</li><li>UUID 生成</li><li>任务完成顺序和状态转换</li></ul><p>❌ <strong>不保证</strong>：</p><ul><li>外部服务调用的响应内容（需通过 idempotent API 设计保证）</li><li>物理资源状态（CPU 负载、内存使用）</li><li>非确定性系统调用（文件 I/O、网络延迟）</li></ul><h3 id="_1-2-应用场景" tabindex="-1">1.2 应用场景 <a class="header-anchor" href="#_1-2-应用场景" aria-label="Permalink to “1.2 应用场景”">​</a></h3><p>确定性保证支持以下关键场景：</p><ol><li><strong>崩溃恢复（Crash Recovery）</strong>：进程崩溃后从最近快照恢复，继续执行产生相同结果</li><li><strong>调试与复现（Debugging）</strong>：使用相同事件流重放 workflow，精确复现问题</li><li><strong>审计与合规（Auditing）</strong>：证明 workflow 执行结果的可验证性和一致性</li><li><strong>测试与验证（Testing）</strong>：编写确定性测试，消除随机性导致的不稳定</li></ol><hr><h2 id="_2-determinismcontext-api-使用指南" tabindex="-1">2. DeterminismContext API 使用指南 <a class="header-anchor" href="#_2-determinismcontext-api-使用指南" aria-label="Permalink to “2. DeterminismContext API 使用指南”">​</a></h2><p><code>DeterminismContext</code> 提供三个核心 API 用于确定性决策：</p><h3 id="_2-1-确定性时钟-deterministic-clock" tabindex="-1">2.1 确定性时钟（Deterministic Clock） <a class="header-anchor" href="#_2-1-确定性时钟-deterministic-clock" aria-label="Permalink to “2.1 确定性时钟（Deterministic Clock）”">​</a></h3><p><strong>正确用法</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DeterminismContext ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DeterminismContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 正确：使用确定性时钟</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Instant now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentMillis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> now.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toEpochMilli</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 正确：计算相对时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Instant future </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">plusSeconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>错误用法</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误：使用系统时钟（非确定性）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Instant now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Instant.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentMillis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentTimeMillis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><p><strong>重放行为</strong>：</p><ul><li>记录模式：<code>clock().now()</code> 记录调用时的真实系统时间</li><li>重放模式：<code>clock().now()</code> 返回记录的时间序列，按调用顺序依次返回</li></ul><h3 id="_2-2-确定性-uuid-生成" tabindex="-1">2.2 确定性 UUID 生成 <a class="header-anchor" href="#_2-2-确定性-uuid-生成" aria-label="Permalink to “2.2 确定性 UUID 生成”">​</a></h3><p><strong>正确用法</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 正确：使用确定性 UUID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">UUID id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uuid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">String workflowId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><p><strong>错误用法</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误：使用标准 UUID（非确定性）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">UUID id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UUID.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><p><strong>重放行为</strong>：</p><ul><li>记录模式：生成新的随机 UUID 并记录</li><li>重放模式：返回记录的 UUID 序列</li></ul><h3 id="_2-3-确定性随机数生成" tabindex="-1">2.3 确定性随机数生成 <a class="header-anchor" href="#_2-3-确定性随机数生成" aria-label="Permalink to “2.3 确定性随机数生成”">​</a></h3><p><strong>正确用法</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 正确：使用确定性随机数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> choice </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextInt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> probability </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 正确：随机选择（带 source 标识）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">String selectedItem </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> items.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextInt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;item-selector&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, items.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()));</span></span></code></pre></div><p><strong>错误用法</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误：使用全局 Random（非确定性）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Random rand </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Random</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> choice </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rand.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextInt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误：使用 Math.random()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> probability </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><p><strong>重放行为</strong>：</p><ul><li>记录模式：生成新的随机数并按 source 分组记录</li><li>重放模式：返回对应 source 的记录序列</li></ul><h3 id="_2-4-完整示例" tabindex="-1">2.4 完整示例 <a class="header-anchor" href="#_2-4-完整示例" aria-label="Permalink to “2.4 完整示例”">​</a></h3><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DeterministicWorkflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DeterminismContext ctx;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DeterministicWorkflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(DeterminismContext </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 确定性时间判断</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Instant start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (start.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEpochSecond</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            executePathA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            executePathB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 确定性随机决策</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            retryTask</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 确定性 ID 生成</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        String taskId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uuid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        scheduleTask</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(taskId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="_3-确定性操作清单" tabindex="-1">3. 确定性操作清单 <a class="header-anchor" href="#_3-确定性操作清单" aria-label="Permalink to “3. 确定性操作清单”">​</a></h2><h3 id="_3-1-安全操作-safe" tabindex="-1">3.1 安全操作（Safe） <a class="header-anchor" href="#_3-1-安全操作-safe" aria-label="Permalink to “3.1 安全操作（Safe）”">​</a></h3><p>以下操作在 workflow 中是确定性的，可安全使用：</p><table tabindex="0"><thead><tr><th>操作类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>纯函数计算</td><td><code>Math.max(a, b)</code>, <code>String.format()</code></td><td>无副作用的计算</td></tr><tr><td>DeterminismContext API</td><td><code>ctx.clock().now()</code>, <code>ctx.random().nextInt()</code></td><td>确定性决策 API</td></tr><tr><td>不可变数据结构</td><td><code>List.of()</code>, <code>Map.copyOf()</code></td><td>只读数据结构</td></tr><tr><td>确定性排序</td><td><code>list.sort(Comparator.naturalOrder())</code></td><td>明确排序规则</td></tr><tr><td>局部变量操作</td><td><code>int x = a + b;</code></td><td>方法内局部状态</td></tr></tbody></table><h3 id="_3-2-不安全操作-unsafe" tabindex="-1">3.2 不安全操作（Unsafe） <a class="header-anchor" href="#_3-2-不安全操作-unsafe" aria-label="Permalink to “3.2 不安全操作（Unsafe）”">​</a></h3><p>以下操作是非确定性的，禁止在 workflow 代码中使用：</p><table tabindex="0"><thead><tr><th>操作类型</th><th>错误示例</th><th>替代方案</th></tr></thead><tbody><tr><td>系统时钟</td><td><code>System.currentTimeMillis()</code></td><td><code>ctx.clock().now()</code></td></tr><tr><td>标准 UUID</td><td><code>UUID.randomUUID()</code></td><td><code>ctx.uuid().randomUUID()</code></td></tr><tr><td>标准随机数</td><td><code>Math.random()</code>, <code>new Random()</code></td><td><code>ctx.random().nextInt()</code></td></tr><tr><td>环境变量</td><td><code>System.getenv(&quot;PATH&quot;)</code></td><td>配置注入或启动时读取</td></tr><tr><td>系统属性</td><td><code>System.getProperty(&quot;os.name&quot;)</code></td><td>配置注入</td></tr><tr><td>文件 I/O</td><td><code>Files.readAllBytes(path)</code></td><td>通过外部服务抽象</td></tr><tr><td>网络调用</td><td><code>HttpClient.send()</code></td><td>使用 idempotent API + 重试</td></tr><tr><td>线程 ID</td><td><code>Thread.currentThread().getId()</code></td><td>使用逻辑 ID</td></tr><tr><td>HashMap 迭代顺序</td><td><code>map.keySet().forEach()</code></td><td>使用 <code>LinkedHashMap</code> 或排序</td></tr></tbody></table><h3 id="_3-3-外部服务调用规范" tabindex="-1">3.3 外部服务调用规范 <a class="header-anchor" href="#_3-3-外部服务调用规范" aria-label="Permalink to “3.3 外部服务调用规范”">​</a></h3><p>外部服务（数据库、REST API、消息队列）本身不是确定性的，但可通过以下模式保证幂等性：</p><p><strong>推荐模式</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 使用 idempotency key 保证幂等性</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">String idempotencyKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uuid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PaymentResult result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> paymentService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">charge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(amount, idempotencyKey);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 将外部调用结果记录为事件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">eventStore.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">appendEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workflowId, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;PaymentCompleted&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Map.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;result&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, result,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;idempotencyKey&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, idempotencyKey</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre></div><p><strong>反模式</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 无幂等性保证，重放时可能重复扣款</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PaymentResult result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> paymentService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">charge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(amount);</span></span></code></pre></div><hr><h2 id="_4-重放语义说明" tabindex="-1">4. 重放语义说明 <a class="header-anchor" href="#_4-重放语义说明" aria-label="Permalink to “4. 重放语义说明”">​</a></h2><h3 id="_4-1-决策序列记录" tabindex="-1">4.1 决策序列记录 <a class="header-anchor" href="#_4-1-决策序列记录" aria-label="Permalink to “4.1 决策序列记录”">​</a></h3><p>Workflow 执行时，所有确定性决策调用（clock、uuid、random）会被记录到 <code>DeterminismSnapshot</code>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;clockTimes&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;2025-11-18T03:30:00Z&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;2025-11-18T03:30:05Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;uuids&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;a1b2c3d4-e5f6-4789-a0b1-c2d3e4f5a6b7&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;f8e7d6c5-b4a3-4210-9f8e-7d6c5b4a3210&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;randoms&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;default&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.7234</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.1245</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.9876</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;item-selector&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_4-2-持久化机制" tabindex="-1">4.2 持久化机制 <a class="header-anchor" href="#_4-2-持久化机制" aria-label="Permalink to “4.2 持久化机制”">​</a></h3><p>决策序列通过以下两种方式持久化：</p><ol><li><p><strong>周期性快照</strong>（每 100 个事件或 5 分钟）：</p><ul><li>触发时机：<code>PostgresEventStore.saveSnapshot()</code></li><li>存储位置：<code>workflow_state.clock_times</code> (JSONB 字段)</li></ul></li><li><p><strong>Workflow 完成时</strong>：</p><ul><li>触发时机：<code>completeWorkflow()</code> / <code>failWorkflow()</code></li><li>存储位置：<code>workflow_state.clock_times</code></li></ul></li></ol><h3 id="_4-3-重放流程" tabindex="-1">4.3 重放流程 <a class="header-anchor" href="#_4-3-重放流程" aria-label="Permalink to “4.3 重放流程”">​</a></h3><p>崩溃恢复时的重放流程：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>1. 加载最近的快照 → 获取 DeterminismSnapshot</span></span>
<span class="line"><span>2. 进入重放模式 → ctx.clock().enterReplayMode(clockTimes)</span></span>
<span class="line"><span>                   ctx.uuid().enterReplayMode(uuids)</span></span>
<span class="line"><span>                   ctx.random().enterReplayMode(randoms)</span></span>
<span class="line"><span>3. 从快照点重放事件 → 重新执行 workflow 逻辑</span></span>
<span class="line"><span>4. 确定性 API 返回记录值 → 产生相同的决策序列</span></span>
<span class="line"><span>5. 继续执行新逻辑 → 切换回记录模式</span></span></code></pre></div><p><strong>示例</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 恢复 workflow</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DeterminismContext ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DeterminismContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DeterminismSnapshot snapshot </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> loadSnapshotFromDatabase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workflowId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 进入重放模式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enterReplayMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(snapshot.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getClockTimes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uuid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enterReplayMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(snapshot.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUuids</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enterReplayMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(snapshot.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getRandoms</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 重放 workflow（将产生相同的决策）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replay</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx);</span></span></code></pre></div><hr><h2 id="_5-限制与注意事项" tabindex="-1">5. 限制与注意事项 <a class="header-anchor" href="#_5-限制与注意事项" aria-label="Permalink to “5. 限制与注意事项”">​</a></h2><h3 id="_5-1-决策序列上限" tabindex="-1">5.1 决策序列上限 <a class="header-anchor" href="#_5-1-决策序列上限" aria-label="Permalink to “5.1 决策序列上限”">​</a></h3><p>为防止内存溢出，每个决策源设置了上限：</p><table tabindex="0"><thead><tr><th>决策类型</th><th>上限</th><th>超限行为</th></tr></thead><tbody><tr><td>Clock times</td><td>500 次调用</td><td>抛出 <code>IllegalStateException</code></td></tr><tr><td>UUIDs</td><td>500 次调用</td><td>抛出 <code>IllegalStateException</code></td></tr><tr><td>Random (per source)</td><td>500 次调用/source</td><td>抛出 <code>IllegalStateException</code></td></tr></tbody></table><p><strong>建议</strong>：</p><ul><li>避免在循环中频繁调用确定性 API</li><li>使用批量操作减少调用次数</li><li>将决策逻辑前置到 workflow 启动时</li></ul><p><strong>错误示例</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误：循环中 1000 次调用（超过上限）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UUID id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uuid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 第 501 次调用抛异常</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>改进方案</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 正确：批量生成后缓存</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArrayList&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(taskCount, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ids.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uuid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 使用缓存的 ID</span></span></code></pre></div><h3 id="_5-2-重放模式限制" tabindex="-1">5.2 重放模式限制 <a class="header-anchor" href="#_5-2-重放模式限制" aria-label="Permalink to “5.2 重放模式限制”">​</a></h3><p>重放模式下的限制：</p><ol><li><p><strong>序列耗尽</strong>：重放时调用次数超过记录序列长度</p><ul><li><strong>错误</strong>：<code>IllegalStateException: Replay sequence exhausted</code></li><li><strong>原因</strong>：代码逻辑变更导致调用次数增加</li><li><strong>解决</strong>：确保代码逻辑与原始执行一致，或清理快照重新执行</li></ul></li><li><p><strong>顺序不匹配</strong>：重放时调用顺序与记录不一致</p><ul><li><strong>原因</strong>：if/else 分支变更、循环逻辑修改</li><li><strong>解决</strong>：保持 workflow 代码版本一致，避免重放时修改逻辑</li></ul></li></ol><h3 id="_5-3-性能考量" tabindex="-1">5.3 性能考量 <a class="header-anchor" href="#_5-3-性能考量" aria-label="Permalink to “5.3 性能考量”">​</a></h3><p>决策日志对性能的影响：</p><table tabindex="0"><thead><tr><th>操作</th><th>开销</th><th>优化建议</th></tr></thead><tbody><tr><td><code>ctx.clock().now()</code></td><td>10-20 ns</td><td>可忽略</td></tr><tr><td><code>ctx.uuid().randomUUID()</code></td><td>50-100 ns</td><td>批量生成</td></tr><tr><td><code>ctx.random().nextInt()</code></td><td>30-50 ns</td><td>合理使用</td></tr><tr><td>快照序列化</td><td>1-5 ms (500 条记录)</td><td>周期性触发，影响小</td></tr><tr><td>快照持久化</td><td>10-50 ms (JSONB 写入)</td><td>异步执行</td></tr></tbody></table><p><strong>性能最佳实践</strong>：</p><ul><li>减少不必要的确定性 API 调用</li><li>将随机数生成前置到 workflow 初始化阶段</li><li>避免在热路径中频繁调用 <code>ctx.clock().now()</code></li></ul><hr><h2 id="_6-故障排查指南" tabindex="-1">6. 故障排查指南 <a class="header-anchor" href="#_6-故障排查指南" aria-label="Permalink to “6. 故障排查指南”">​</a></h2><h3 id="_6-1-常见错误" tabindex="-1">6.1 常见错误 <a class="header-anchor" href="#_6-1-常见错误" aria-label="Permalink to “6.1 常见错误”">​</a></h3><h4 id="错误-1-illegalstateexception-replay-sequence-exhausted" tabindex="-1">错误 1：IllegalStateException: Replay sequence exhausted <a class="header-anchor" href="#错误-1-illegalstateexception-replay-sequence-exhausted" aria-label="Permalink to “错误 1：IllegalStateException: Replay sequence exhausted”">​</a></h4><p><strong>完整错误</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>java.lang.IllegalStateException: Replay sequence exhausted for clock times</span></span>
<span class="line"><span>at aster.runtime.workflow.ReplayDeterministicClock.now()</span></span></code></pre></div><p><strong>原因</strong>：</p><ul><li>重放时 <code>ctx.clock().now()</code> 调用次数超过记录的序列长度</li><li>代码逻辑变更导致新增了时钟调用</li></ul><p><strong>排查步骤</strong>：</p><ol><li>检查快照中记录的 <code>clockTimes</code> 长度</li><li>比对原始代码与当前代码的差异</li><li>确认是否在重放期间修改了 workflow 代码</li></ol><p><strong>解决方案</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 方案 1：清理快照，从头执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">eventStore.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">saveSnapshot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workflowId, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 方案 2：检查代码版本一致性</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 确保 workflow 代码与快照记录时的版本一致</span></span></code></pre></div><h4 id="错误-2-random-sequence-exhausted-for-source-xxx" tabindex="-1">错误 2：Random sequence exhausted for source &#39;xxx&#39; <a class="header-anchor" href="#错误-2-random-sequence-exhausted-for-source-xxx" aria-label="Permalink to “错误 2：Random sequence exhausted for source &#39;xxx&#39;”">​</a></h4><p><strong>完整错误</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>java.lang.IllegalStateException: Random sequence exhausted for source &#39;item-selector&#39;</span></span></code></pre></div><p><strong>原因</strong>：</p><ul><li>某个 random source 的调用次数超过记录序列</li><li>循环次数变化或条件分支变更</li></ul><p><strong>解决方案</strong>：</p><ul><li>检查该 source 的使用位置</li><li>确认循环次数或分支逻辑是否一致</li></ul><h4 id="错误-3-超过-500-次调用限制" tabindex="-1">错误 3：超过 500 次调用限制 <a class="header-anchor" href="#错误-3-超过-500-次调用限制" aria-label="Permalink to “错误 3：超过 500 次调用限制”">​</a></h4><p><strong>完整错误</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>java.lang.IllegalStateException: Exceeded maximum clock records (500)</span></span></code></pre></div><p><strong>原因</strong>：</p><ul><li>单个 workflow 执行中调用 <code>ctx.clock().now()</code> 超过 500 次</li><li>通常发生在循环或递归逻辑中</li></ul><p><strong>解决方案</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误：循环中频繁调用</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Task task </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tasks) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Instant start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 每次循环都调用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    processTask</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(task);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 改进：缓存时间或减少调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Instant batchStart </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 循环外调用一次</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Task task </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tasks) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    processTask</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(task, batchStart); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 传递缓存的时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_6-2-调试技巧" tabindex="-1">6.2 调试技巧 <a class="header-anchor" href="#_6-2-调试技巧" aria-label="Permalink to “6.2 调试技巧”">​</a></h3><p><strong>1. 启用决策日志记录</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 记录所有确定性决策到日志</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DeterminismContext ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DeterminismContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setDebugMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setDebugMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uuid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setDebugMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p><strong>2. 比对两次执行的决策序列</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 第一次执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DeterminismSnapshot snap1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> recordExecution</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workflow);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 第二次执行（重放）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DeterminismSnapshot snap2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> recordExecution</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workflow);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 比对差异</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Clock calls: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> snap1.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getClockTimes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot; vs &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> snap2.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getClockTimes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span></code></pre></div><p><strong>3. 使用混沌测试验证确定性</strong></p><p>参考 <code>ChaosSchedulerTest.testDeterministicReplay()</code> 示例：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 运行两次相同 workflow</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ChaosScenarioResult run1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> executeWorkflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(seed);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ChaosScenarioResult run2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> executeWorkflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(seed); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 相同种子</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 验证结果一致</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">assertEquals</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(run1.completionOrder, run2.completionOrder);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">assertEquals</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(run1.failingTaskId, run2.failingTaskId);</span></span></code></pre></div><hr><h2 id="_7-进阶主题" tabindex="-1">7. 进阶主题 <a class="header-anchor" href="#_7-进阶主题" aria-label="Permalink to “7. 进阶主题”">​</a></h2><h3 id="_7-1-多线程-workflow" tabindex="-1">7.1 多线程 Workflow <a class="header-anchor" href="#_7-1-多线程-workflow" aria-label="Permalink to “7.1 多线程 Workflow”">​</a></h3><p>DeterminismContext 使用 <code>ThreadLocal</code> 隔离不同 workflow 的决策序列：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Workflow A（线程 1）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DeterminismContext ctxA </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DeterminismContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">workflowA.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctxA); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 独立的决策序列</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Workflow B（线程 2）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DeterminismContext ctxB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DeterminismContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">workflowB.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctxB); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 不与 A 冲突</span></span></code></pre></div><h3 id="_7-2-部分确定性" tabindex="-1">7.2 部分确定性 <a class="header-anchor" href="#_7-2-部分确定性" aria-label="Permalink to “7.2 部分确定性”">​</a></h3><p>某些场景下可能需要部分使用确定性 API：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 确定性部分：核心业务逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextDouble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    executeCriticalPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 非确定性部分：性能监控（可选）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> actualTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentTimeMillis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 允许使用非确定性 API</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">metricsCollector.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;execution_time&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, actualTime);</span></span></code></pre></div><p><strong>注意</strong>：非确定性操作不应影响 workflow 的状态转换。</p><h3 id="_7-3-版本兼容性" tabindex="-1">7.3 版本兼容性 <a class="header-anchor" href="#_7-3-版本兼容性" aria-label="Permalink to “7.3 版本兼容性”">​</a></h3><p>Workflow 代码升级时需注意向后兼容：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 兼容：新增可选参数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(DeterminismContext ctx, Optional</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Config</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> config) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 旧版本传 Optional.empty()，新版本传实际值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 不兼容：修改决策逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(DeterminismContext ctx) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 旧版：if (ctx.random().nextDouble() &gt; 0.5)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 新版：if (ctx.random().nextDouble() &gt; 0.8)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 重放失败！</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="_8-参考资料" tabindex="-1">8. 参考资料 <a class="header-anchor" href="#_8-参考资料" aria-label="Permalink to “8. 参考资料”">​</a></h2><h3 id="_8-1-相关-api-文档" tabindex="-1">8.1 相关 API 文档 <a class="header-anchor" href="#_8-1-相关-api-文档" aria-label="Permalink to “8.1 相关 API 文档”">​</a></h3><ul><li><code>aster.runtime.workflow.DeterminismContext</code></li><li><code>aster.runtime.workflow.ReplayDeterministicClock</code></li><li><code>aster.runtime.workflow.ReplayDeterministicRandom</code></li><li><code>aster.runtime.workflow.ReplayDeterministicUuid</code></li><li><code>quarkus-policy-api/.../DeterminismSnapshot</code></li></ul><h3 id="_8-2-相关文档" tabindex="-1">8.2 相关文档 <a class="header-anchor" href="#_8-2-相关文档" aria-label="Permalink to “8.2 相关文档”">​</a></h3><ul><li><a href="./retry-semantics.html">Workflow 重试语义</a></li><li><a href="./../language/workflow.html">事件溯源与快照</a></li></ul><h3 id="_8-3-测试用例" tabindex="-1">8.3 测试用例 <a class="header-anchor" href="#_8-3-测试用例" aria-label="Permalink to “8.3 测试用例”">​</a></h3><p>参考以下测试了解确定性保证的实际应用：</p><ul><li><code>ChaosSchedulerTest.testDeterministicReplay()</code> - 确定性重放验证</li><li><code>RetryExecutionTest</code> - 确定性时钟在重试中的应用</li><li><code>DelayedTaskTest</code> - 确定性时钟在延迟任务中的应用</li></ul><hr><p><strong>最后更新</strong>：2025-11-18 <strong>维护者</strong>：Aster Workflow Runtime Team</p>`,143)])])}const o=i(l,[["render",h]]);export{g as __pageData,o as default};
