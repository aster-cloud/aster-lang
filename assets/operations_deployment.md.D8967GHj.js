import{_ as s,c as a,o as e,aj as l}from"./chunks/framework.Bz2R-749.js";const r=JSON.parse('{"title":"部署指南","description":"","frontmatter":{},"headers":[],"relativePath":"operations/deployment.md","filePath":"operations/deployment.md"}'),t={name:"operations/deployment.md"};function h(n,i,d,k,p,o){return e(),a("div",null,[...i[0]||(i[0]=[l(`<blockquote><p>更新时间：2025-10-08 14:57（NZDT）<br> 执行者：Codex</p></blockquote><h1 id="部署指南" tabindex="-1">部署指南 <a class="header-anchor" href="#部署指南" aria-label="Permalink to “部署指南”">​</a></h1><h2 id="_1-环境要求" tabindex="-1">1. 环境要求 <a class="header-anchor" href="#_1-环境要求" aria-label="Permalink to “1. 环境要求”">​</a></h2><ul><li>Node.js ≥ 22.0.0（<code>package.json:engines</code> 指定，CI 统一使用 Node 22）</li><li>npm ≥ 10，支持 <code>npm ci</code> 与 workspaces 缓存</li><li>Java 21（推荐安装 GraalVM 21，GitHub Actions release/canary 流程使用该版本）</li><li>操作系统：Ubuntu 22.04 LTS 或 macOS 14+（CI 运行在 Ubuntu，兼容 Linux 部署；macOS 验证本地开发）</li><li>内存：≥ 8 GB（CI 跑满 <code>npm run ci</code>、Gradle/Truffle 测试时需要额外缓冲）</li><li>磁盘空间：≥ 5 GB（包含 <code>node_modules</code>、<code>dist</code>、Gradle 缓存与构建产物）</li></ul><blockquote><p><strong>提示</strong>：Java 需要设置 <code>JAVA_HOME</code>，Gradle 相关脚本会自动回退到 <code>~/.gradle</code>，若使用容器部署建议将缓存挂载到单独卷。</p></blockquote><h2 id="_2-依赖安装步骤" tabindex="-1">2. 依赖安装步骤 <a class="header-anchor" href="#_2-依赖安装步骤" aria-label="Permalink to “2. 依赖安装步骤”">​</a></h2><ol><li>同步仓库代码并切换到目标 tag 或 commit。</li><li>安装 Node 依赖（保持 lockfile 一致）：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ci</span></span></code></pre></div></li><li>可选：若在离线环境或需重新生成 lockfile，可执行 <code>npm install --include=optional</code>（与 docs 工作流一致）。</li><li>构建 TypeScript 与 PEG 语法产物：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span></code></pre></div></li><li>运行能力/安全相关基线检查：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> audit</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 依赖安全扫描</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> typecheck</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 编译期类型校验</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       # Golden + property + LSP 测试</span></span></code></pre></div></li></ol><h2 id="_3-构建流程说明" tabindex="-1">3. 构建流程说明 <a class="header-anchor" href="#_3-构建流程说明" aria-label="Permalink to “3. 构建流程说明”">​</a></h2><ol><li><code>npm run build</code>：执行 <code>tsc</code>，生成 <code>dist</code> 目录（含 CLI、LSP、脚本）并运行 <code>dist/scripts/build-peg.js</code> 构建语法文件。</li><li>可选 <code>npm run docs:build</code>：构建 VitePress 文档（GitHub Pages 同步使用该命令）。</li><li>若需要 JVM 产物，可执行：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> emit:class</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test/cnl/examples/greet.aster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> javap:verify</span></span></code></pre></div></li><li>确认能力校验默认开启：<code>src/config/runtime.ts</code> 将 <code>ASTER_CAP_EFFECTS_ENFORCE</code> 视作默认 true，仅当值为 <code>0</code> 时关闭。</li><li>结构化日志：运行 CLI/LSP 时自动输出 JSON 日志，<code>LOG_LEVEL</code> 默认为 <code>INFO</code>。</li></ol><h2 id="_4-发布流程" tabindex="-1">4. 发布流程 <a class="header-anchor" href="#_4-发布流程" aria-label="Permalink to “4. 发布流程”">​</a></h2><h3 id="_4-1-ci-驱动-推荐" tabindex="-1">4.1 CI 驱动（推荐） <a class="header-anchor" href="#_4-1-ci-驱动-推荐" aria-label="Permalink to “4.1 CI 驱动（推荐）”">​</a></h3><ul><li><code>main</code> 分支合并后，<code>.github/workflows/release.yml</code> 自动运行： <ol><li>安装 Node 22 + GraalVM 21。</li><li><code>npm run build</code> 与 <code>npm run ci</code>（非阻断）。</li><li>使用 Changesets 生成 “Version PR”。</li></ol></li><li>标签发布：<code>github-release.yml</code> 会在 <code>v*</code> tag 或 <code>Release published</code> 事件下生成 GitHub Release。</li></ul><h3 id="_4-2-手动发布" tabindex="-1">4.2 手动发布 <a class="header-anchor" href="#_4-2-手动发布" aria-label="Permalink to “4.2 手动发布”">​</a></h3><ol><li>运行预发布校验：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prepublishOnly</span></span></code></pre></div></li><li>版本提升（若需要）：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> version-packages</span></span></code></pre></div></li><li>发布到 npm（需要 <code>NPM_TOKEN</code>，并在环境变量中导出 <code>NODE_AUTH_TOKEN</code>）：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> release</span></span></code></pre></div></li><li>推送 tag 并触发 GitHub Release：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v0.x.y</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> push</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> origin</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v0.x.y</span></span></code></pre></div></li></ol><h2 id="_5-健康检查与上线验证" tabindex="-1">5. 健康检查与上线验证 <a class="header-anchor" href="#_5-健康检查与上线验证" aria-label="Permalink to “5. 健康检查与上线验证”">​</a></h2><ol><li>运行脚本：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NODE_ENV</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">production</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scripts/health-check.ts</span></span></code></pre></div></li><li>期望输出：<div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;status&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ok&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;details&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;NODE_ENV&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;production&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;missingRequired&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;warnings&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>若 <code>ASTER_CAP_EFFECTS_ENFORCE</code> 被设为 <code>0</code>，脚本会给出警告，请在生产环境恢复默认。</li></ul></li><li>执行 <code>npm run ci</code> 验证核心流程。</li><li>验证结构化日志与错误 ID：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LOG_LEVEL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">DEBUG</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist/scripts/cli.js</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test/cnl/examples/greet.aster</span></span></code></pre></div><ul><li>输出的 JSON 日志会包含 <code>timestamp</code>、<code>component</code>、<code>message</code> 等字段。</li></ul></li></ol><h2 id="_6-生产部署-checklist" tabindex="-1">6. 生产部署 Checklist <a class="header-anchor" href="#_6-生产部署-checklist" aria-label="Permalink to “6. 生产部署 Checklist”">​</a></h2><ul><li>[ ] 已设置 <code>NODE_ENV=production</code>、<code>JAVA_HOME</code> 指向 Java 21、<code>ASTER_CAP_EFFECTS_ENFORCE</code> 未设为 <code>0</code></li><li>[ ] <code>npm run build</code>、<code>npm run ci</code>、<code>npm run audit</code> 都已通过</li><li>[ ] 确认 <code>docs/operations/configuration.md</code> 中所有必需环境变量已配置</li><li>[ ] 检查结构化日志采集管道（<code>LOG_LEVEL</code> 设为 <code>INFO</code> 或更高；若需调试再临时降级）</li><li>[ ] 确认错误 ID 指标告警已配置（<code>src/utils/errors.ts</code> 中 <code>E1xxx/E2xxx...</code>）</li><li>[ ] 依赖安全扫描（<code>npm run audit</code> / <code>npx audit-ci --high</code>）无高危漏洞</li><li>[ ] 更新 capability manifest 并确保 <code>ASTER_CAPS</code> 指向最新版本</li><li>[ ] GitHub Actions Release/Docs 工作流均处于绿色状态</li></ul>`,18)])])}const g=s(t,[["render",h]]);export{r as __pageData,g as default};
