import{_ as s,c as a,o as l,aj as t}from"./chunks/framework.Bz2R-749.js";const o=JSON.parse('{"title":"回滚指南","description":"","frontmatter":{},"headers":[],"relativePath":"operations/rollback.md","filePath":"operations/rollback.md"}'),e={name:"operations/rollback.md"};function h(n,i,k,p,r,d){return l(),a("div",null,[...i[0]||(i[0]=[t(`<blockquote><p>更新时间：2025-10-08 14:57（NZDT）<br> 执行者：Codex</p></blockquote><h1 id="回滚指南" tabindex="-1">回滚指南 <a class="header-anchor" href="#回滚指南" aria-label="Permalink to “回滚指南”">​</a></h1><h2 id="_1-版本兼容性" tabindex="-1">1. 版本兼容性 <a class="header-anchor" href="#_1-版本兼容性" aria-label="Permalink to “1. 版本兼容性”">​</a></h2><ul><li>npm 包版本与 Git tag 一一对应（遵循 Changesets 流程），建议以最新 <code>v*</code> tag 作为回滚锚点。</li><li>TypeScript 产物与 CLI/LSP 共享同一 <code>dist</code> 目录，回滚时必须同时替换 <code>dist</code> 与 <code>package.json</code>。</li><li>JVM/Gradle 示例依赖 GraalVM 21；若回滚到较旧版本，确保 <code>JAVA_HOME</code> 指向兼容 JDK（仍建议保持 21）。</li><li>能力 manifest 与错误 ID 系统（<code>src/utils/errors.ts</code>）在近期迭代中有新增枚举，回滚旧版本后需同步更新监控/文档。</li></ul><h2 id="_2-回滚步骤" tabindex="-1">2. 回滚步骤 <a class="header-anchor" href="#_2-回滚步骤" aria-label="Permalink to “2. 回滚步骤”">​</a></h2><ol><li><strong>锁定目标版本</strong><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fetch</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --tags</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> checkout</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v0.x.y</span></span></code></pre></div></li><li><strong>恢复依赖与产物</strong><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ci</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span></code></pre></div></li><li><strong>清理旧缓存</strong>（确保无混合构建）：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -rf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node_modules/.cache</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ci</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span></code></pre></div></li><li><strong>同步配置</strong>：验证 <code>docs/operations/configuration.md</code> 中列出的环境变量与 manifest 是否与目标版本匹配。</li><li><strong>发布回滚版本（如需重新发布 npm）</strong><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prepublishOnly</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> publish</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --tag</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> latest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --access</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> public</span></span></code></pre></div><blockquote><p>若需撤销最新 npm 版本，可联系 npm 支持或使用 <code>npm dist-tag add</code> 将旧版本重新标记为 <code>latest</code>。</p></blockquote></li></ol><h2 id="_3-数据与状态注意事项" tabindex="-1">3. 数据与状态注意事项 <a class="header-anchor" href="#_3-数据与状态注意事项" aria-label="Permalink to “3. 数据与状态注意事项”">​</a></h2><ul><li>项目本身不持久化业务数据，但会生成以下临时产物： <ul><li><code>dist/</code>：TypeScript 编译结果，必须随回滚版本重新生成。</li><li><code>build/jvm-*</code>：JVM/ASM 产物，如需调试旧版本，应删除后重新执行对应脚本。</li></ul></li><li>能力 manifest、配置文件等部署层资源不自动回滚，需手动恢复到与目标版本匹配的快照。</li><li>结构化日志与错误 ID 可能在不同版本之间新增字段，回滚后需通知日志消费方更新解析规则。</li></ul><h2 id="_4-回滚后的验证" tabindex="-1">4. 回滚后的验证 <a class="header-anchor" href="#_4-回滚后的验证" aria-label="Permalink to “4. 回滚后的验证”">​</a></h2><ol><li><strong>健康检查</strong><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NODE_ENV</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">production</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scripts/health-check.ts</span></span></code></pre></div></li><li><strong>能力校验</strong><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ASTER_CAP_EFFECTS_ENFORCE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> typecheck</span></span></code></pre></div><ul><li>确认关键错误 ID（如 <code>E1001</code> 能力违规）仍按预期触发。</li></ul></li><li><strong>核心测试</strong><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ci</span></span></code></pre></div></li><li><strong>CLI/LSP 烟雾测试</strong><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist/scripts/cli.js</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test/cnl/examples/greet.aster</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/greet.json</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lsp:workspace-diags:smoke</span></span></code></pre></div></li><li><strong>依赖安全</strong><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> audit</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> audit-ci</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --high</span></span></code></pre></div></li></ol><h2 id="_5-紧急回滚流程-生产环境" tabindex="-1">5. 紧急回滚流程（生产环境） <a class="header-anchor" href="#_5-紧急回滚流程-生产环境" aria-label="Permalink to “5. 紧急回滚流程（生产环境）”">​</a></h2><ol><li><strong>触发条件</strong>：部署后出现生产级故障（编译错误、能力误判、结构化日志异常）。</li><li><strong>执行路径</strong>： <ul><li>立即切换到最近的稳定 tag（如 <code>v0.x.(y-1)</code>），执行上述步骤 2。</li><li>在 CD 系统中将部署 artifact 切换至旧版本（容器镜像或 npm 包）。</li></ul></li><li><strong>公告与监控</strong>： <ul><li>在运维渠道同步回滚时间、影响范围、使用的错误 ID/日志。</li><li>监控告警恢复后，再评估重新上线新版本的时间窗口。</li></ul></li><li><strong>后续动作</strong>： <ul><li>建议在 <code>.claude/workstreams/&lt;task&gt;/operations-log</code> 记录回滚原因。</li><li>主动对比新旧版本的 capability manifest、错误 ID 定义差异，定位根因。</li></ul></li></ol>`,12)])])}const c=s(e,[["render",h]]);export{o as __pageData,c as default};
