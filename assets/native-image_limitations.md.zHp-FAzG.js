import{_ as i,c as s,o as t,aj as e}from"./chunks/framework.Bz2R-749.js";const g=JSON.parse('{"title":"Aster Native Image 限制说明","description":"","frontmatter":{},"headers":[],"relativePath":"native-image/limitations.md","filePath":"native-image/limitations.md"}'),l={name:"native-image/limitations.md"};function n(r,a,h,p,k,d){return t(),s("div",null,[...a[0]||(a[0]=[e(`<h1 id="aster-native-image-限制说明" tabindex="-1">Aster Native Image 限制说明 <a class="header-anchor" href="#aster-native-image-限制说明" aria-label="Permalink to “Aster Native Image 限制说明”">​</a></h1><p>本文档列出 Aster Native Image 当前的限制、不支持的特性和已知问题。</p><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to “目录”">​</a></h2><ul><li><a href="#javagramlvm-平台限制">Java/GraalVM 平台限制</a></li><li><a href="#truffle-runtime-限制">Truffle Runtime 限制</a></li><li><a href="#aster-语言特性支持">Aster 语言特性支持</a></li><li><a href="#性能限制">性能限制</a></li><li><a href="#部署限制">部署限制</a></li><li><a href="#已知问题">已知问题</a></li><li><a href="#未来改进计划">未来改进计划</a></li></ul><h2 id="java-graalvm-平台限制" tabindex="-1">Java/GraalVM 平台限制 <a class="header-anchor" href="#java-graalvm-平台限制" aria-label="Permalink to “Java/GraalVM 平台限制”">​</a></h2><h3 id="❌-不支持的-java-特性" tabindex="-1">❌ 不支持的 Java 特性 <a class="header-anchor" href="#❌-不支持的-java-特性" aria-label="Permalink to “❌ 不支持的 Java 特性”">​</a></h3><h4 id="_1-动态类加载" tabindex="-1">1. 动态类加载 <a class="header-anchor" href="#_1-动态类加载" aria-label="Permalink to “1. 动态类加载”">​</a></h4><p><strong>限制</strong>: 无法在运行时动态加载未在编译时声明的类。</p><p><strong>原因</strong>: Native Image 采用闭世界假设 (Closed World Assumption),所有代码必须在编译时可达。</p><p><strong>影响</strong>:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 不支持:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Class&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; clazz </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Class.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(userInput);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 运行时类名</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 支持:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Class&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; clazz </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MyKnownClass.class;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 编译时已知</span></span></code></pre></div><p><strong>解决方法</strong>: 在反射配置中预先声明所有可能的类:</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;com.example.PossibleClass&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;allDeclaredConstructors&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_2-运行时反射-未配置" tabindex="-1">2. 运行时反射 (未配置) <a class="header-anchor" href="#_2-运行时反射-未配置" aria-label="Permalink to “2. 运行时反射 (未配置)”">​</a></h4><p><strong>限制</strong>: 反射访问必须在编译时通过配置声明。</p><p><strong>原因</strong>: Native Image 需要在编译时确定所有反射目标以生成元数据。</p><p><strong>影响</strong>:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 未配置的反射会失败:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Method method </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> clazz.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDeclaredMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;methodName&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 配置后可用</span></span></code></pre></div><p><strong>解决方法</strong>: 使用 Native Image Agent 生成配置或手动添加:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> generateNativeConfig</span></span></code></pre></div><h4 id="_3-java-agent-jvmti" tabindex="-1">3. Java Agent / JVMTI <a class="header-anchor" href="#_3-java-agent-jvmti" aria-label="Permalink to “3. Java Agent / JVMTI”">​</a></h4><p><strong>限制</strong>: 不支持 Java Agent,包括:</p><ul><li>APM 工具 (如 New Relic, DataDog Agent)</li><li>字节码增强工具</li><li>动态插桩</li></ul><p><strong>影响</strong>: 无法使用基于 Agent 的监控和调试工具。</p><p><strong>解决方法</strong>: 使用原生监控方案 (如 Prometheus + JMX Exporter 的静态配置)。</p><h4 id="_4-jmx-java-management-extensions" tabindex="-1">4. JMX (Java Management Extensions) <a class="header-anchor" href="#_4-jmx-java-management-extensions" aria-label="Permalink to “4. JMX (Java Management Extensions)”">​</a></h4><p><strong>限制</strong>: JMX MBeans 支持有限,部分功能不可用。</p><p><strong>影响</strong>: 无法使用 JConsole、VisualVM 等 JMX 工具连接到 Native Image 进程。</p><p><strong>解决方法</strong>: 使用自定义 HTTP 端点暴露监控指标。</p><h4 id="_5-securitymanager" tabindex="-1">5. SecurityManager <a class="header-anchor" href="#_5-securitymanager" aria-label="Permalink to “5. SecurityManager”">​</a></h4><p><strong>限制</strong>: SecurityManager 已在 Java 17+ 弃用,Native Image 不支持。</p><p><strong>影响</strong>: 无法使用 Java 安全策略限制代码权限。</p><p><strong>解决方法</strong>: 使用操作系统级别的沙箱 (如 Docker, seccomp)。</p><h3 id="⚠️-部分支持的特性" tabindex="-1">⚠️ 部分支持的特性 <a class="header-anchor" href="#⚠️-部分支持的特性" aria-label="Permalink to “⚠️ 部分支持的特性”">​</a></h3><h4 id="_1-serialization" tabindex="-1">1. Serialization <a class="header-anchor" href="#_1-serialization" aria-label="Permalink to “1. Serialization”">​</a></h4><p><strong>限制</strong>: Java 序列化需要显式配置。</p><p><strong>配置方法</strong>:</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;com.example.SerializableClass&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;serialization&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_2-资源文件" tabindex="-1">2. 资源文件 <a class="header-anchor" href="#_2-资源文件" aria-label="Permalink to “2. 资源文件”">​</a></h4><p><strong>限制</strong>: 资源文件必须在 <code>resource-config.json</code> 中声明。</p><p><strong>示例</strong>:</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;resources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;includes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;pattern&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;config/.*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.json&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_3-proxy-类" tabindex="-1">3. Proxy 类 <a class="header-anchor" href="#_3-proxy-类" aria-label="Permalink to “3. Proxy 类”">​</a></h4><p><strong>限制</strong>: 动态代理类必须在 <code>proxy-config.json</code> 中声明。</p><p><strong>示例</strong>:</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;interfaces&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;com.example.MyInterface&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;java.io.Serializable&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="truffle-runtime-限制" tabindex="-1">Truffle Runtime 限制 <a class="header-anchor" href="#truffle-runtime-限制" aria-label="Permalink to “Truffle Runtime 限制”">​</a></h2><h3 id="❌-当前使用-truffle-fallback-runtime" tabindex="-1">❌ 当前使用 Truffle Fallback Runtime <a class="header-anchor" href="#❌-当前使用-truffle-fallback-runtime" aria-label="Permalink to “❌ 当前使用 Truffle Fallback Runtime”">​</a></h3><p><strong>状态</strong>: Aster Native Image 当前运行在 Truffle fallback runtime (解释器模式)。</p><p><strong>表现</strong>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>[engine] WARNING: The polyglot engine uses a fallback runtime that does not support</span></span>
<span class="line"><span>runtime compilation to native code.</span></span></code></pre></div><p><strong>影响</strong>:</p><table tabindex="0"><thead><tr><th>特性</th><th>Fallback Runtime</th><th>完整 Runtime (目标)</th></tr></thead><tbody><tr><td>启动速度</td><td>✅ 快 (20-32ms)</td><td>✅ 快 (20-32ms)</td></tr><tr><td>内存占用</td><td>✅ 低 (&lt; 50MB)</td><td>✅ 低 (&lt; 50MB)</td></tr><tr><td>峰值性能</td><td>❌ 低 (解释器)</td><td>✅ 高 (JIT 编译)</td></tr><tr><td>PGO 性能优化</td><td>❌ 无效</td><td>✅ 有效 (+20-30%)</td></tr></tbody></table><p><strong>适用场景</strong>:</p><ul><li>✅ 短生命周期任务 (&lt; 1分钟): CLI 工具、脚本、Serverless</li><li>❌ 长时间运行任务 (&gt; 5分钟): 计算密集型服务</li></ul><p><strong>解决计划</strong>: 修复 Truffle runtime 配置以启用 Graal JIT 编译器 (见&quot;未来改进计划&quot;)。</p><h2 id="aster-语言特性支持" tabindex="-1">Aster 语言特性支持 <a class="header-anchor" href="#aster-语言特性支持" aria-label="Permalink to “Aster 语言特性支持”">​</a></h2><h3 id="✅-完全支持的特性" tabindex="-1">✅ 完全支持的特性 <a class="header-anchor" href="#✅-完全支持的特性" aria-label="Permalink to “✅ 完全支持的特性”">​</a></h3><p>所有 Aster 语言特性在 Native Image 版本中均<strong>完全支持</strong>:</p><ul><li>✅ 基本数据类型 (Integer, Float, Boolean, String)</li><li>✅ 复合类型 (List, Map)</li><li>✅ 函数定义与调用</li><li>✅ Lambda 表达式与闭包</li><li>✅ 高阶函数 (map, filter, reduce)</li><li>✅ 模式匹配</li><li>✅ 递归调用</li><li>✅ 尾递归优化</li><li>✅ 内置函数库</li><li>✅ 错误处理</li></ul><p><strong>验证方法</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 所有语言特性测试通过</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benchmarks/core/fibonacci_20_core.json</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benchmarks/core/factorial_20_core.json</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benchmarks/core/list_map_1000_core.json</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benchmarks/core/quicksort_core.json</span></span></code></pre></div><h3 id="❌-不支持的扩展特性" tabindex="-1">❌ 不支持的扩展特性 <a class="header-anchor" href="#❌-不支持的扩展特性" aria-label="Permalink to “❌ 不支持的扩展特性”">​</a></h3><p>以下特性在 JVM 和 Native Image 版本中<strong>均不支持</strong> (非 Aster 核心语言):</p><ul><li>❌ FFI (Foreign Function Interface) - 调用 C/C++ 库</li><li>❌ 多线程 / 并发原语</li><li>❌ 网络 I/O</li><li>❌ 文件系统访问 (除标准输入输出)</li><li>❌ GUI 库绑定</li></ul><h2 id="性能限制" tabindex="-1">性能限制 <a class="header-anchor" href="#性能限制" aria-label="Permalink to “性能限制”">​</a></h2><h3 id="_1-峰值吞吐量低于-jvm" tabindex="-1">1. 峰值吞吐量低于 JVM <a class="header-anchor" href="#_1-峰值吞吐量低于-jvm" aria-label="Permalink to “1. 峰值吞吐量低于 JVM”">​</a></h3><p><strong>当前状态</strong>:</p><ul><li>Native Image (Fallback Runtime): ~5x 慢于 JVM (计算密集任务)</li><li>JVM (Graal JIT): 高峰值性能 (预热后)</li></ul><p><strong>基准数据</strong> (Fibonacci(20)):</p><ul><li>JVM (预热后): ~10ms</li><li>Native Image: ~50ms</li></ul><p><strong>使用建议</strong>:</p><ul><li>短任务 (&lt; 1分钟): 使用 Native Image (启动速度优势)</li><li>长任务 (&gt; 5分钟): 使用 JVM (吞吐量优势)</li></ul><h3 id="_2-pgo-性能优化受限" tabindex="-1">2. PGO 性能优化受限 <a class="header-anchor" href="#_2-pgo-性能优化受限" aria-label="Permalink to “2. PGO 性能优化受限”">​</a></h3><p><strong>当前状态</strong>:</p><ul><li>PGO 主要优化二进制大小 (36.88MB → 23MB, -37.6%)</li><li>PGO 对执行性能提升有限 (解释器模式限制)</li></ul><p><strong>预期</strong> (修复 Truffle Runtime 后):</p><ul><li>PGO 将同时优化大小和性能 (+20-30% 吞吐量)</li></ul><h3 id="_3-冷启动性能" tabindex="-1">3. 冷启动性能 <a class="header-anchor" href="#_3-冷启动性能" aria-label="Permalink to “3. 冷启动性能”">​</a></h3><p><strong>观察</strong>: PGO 版本首次运行可能比后续运行慢:</p><ul><li>Run 1: 66ms (冷启动)</li><li>Run 2-3: 16ms (热启动)</li><li>平均: 32ms</li></ul><p><strong>原因</strong>: PGO 优化热路径,冷路径可能被去优化。</p><p><strong>影响</strong>: 仅影响首次运行,后续运行稳定在 16ms。</p><h2 id="部署限制" tabindex="-1">部署限制 <a class="header-anchor" href="#部署限制" aria-label="Permalink to “部署限制”">​</a></h2><h3 id="_1-平台特定二进制" tabindex="-1">1. 平台特定二进制 <a class="header-anchor" href="#_1-平台特定二进制" aria-label="Permalink to “1. 平台特定二进制”">​</a></h3><p><strong>限制</strong>: Native Image 二进制文件是平台特定的,无法跨平台运行。</p><p><strong>示例</strong>:</p><ul><li>macOS ARM64 编译的二进制无法在 Linux x86_64 运行</li><li>Windows 编译的二进制无法在 macOS 运行</li></ul><p><strong>解决方法</strong>: 为每个目标平台分别编译:</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># GitHub Actions 示例</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">jobs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    strategy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      matrix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        os</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ubuntu-latest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">macos-latest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">windows-latest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    runs-on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\${{ matrix.os }}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    steps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Build Native Image</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">./gradlew :aster-truffle:nativeCompile</span></span></code></pre></div><h3 id="_2-二进制大小" tabindex="-1">2. 二进制大小 <a class="header-anchor" href="#_2-二进制大小" aria-label="Permalink to “2. 二进制大小”">​</a></h3><p><strong>当前大小</strong>:</p><ul><li>Baseline: 36.88 MB</li><li>PGO Optimized: 23 MB</li></ul><p><strong>对比</strong>:</p><ul><li>Go 编译的二进制: 通常 5-20 MB</li><li>Rust 编译的二进制: 通常 2-10 MB</li></ul><p><strong>原因</strong>: Native Image 包含完整的 Truffle runtime 和 GC。</p><p><strong>影响</strong>: 仍远小于 JVM + JAR (200+ MB),适合容器化部署。</p><h3 id="_3-编译时间" tabindex="-1">3. 编译时间 <a class="header-anchor" href="#_3-编译时间" aria-label="Permalink to “3. 编译时间”">​</a></h3><p><strong>编译时间</strong>:</p><ul><li>Baseline: 2-5 分钟 (首次)</li><li>PGO Instrumented: ~1分16秒</li><li>PGO Optimized: ~38秒</li></ul><p><strong>对比</strong>:</p><ul><li>Java 编译 JAR: 通常 &lt; 30秒</li><li>Go 编译: 通常 &lt; 10秒</li></ul><p><strong>影响</strong>: CI/CD 流水线需要更长时间,建议缓存 Gradle 构建。</p><h3 id="_4-编译内存需求" tabindex="-1">4. 编译内存需求 <a class="header-anchor" href="#_4-编译内存需求" aria-label="Permalink to “4. 编译内存需求”">​</a></h3><p><strong>内存占用</strong>:</p><ul><li>Peak RSS: 2.5-5 GB (PGO Instrumented 最高)</li></ul><p><strong>建议</strong>:</p><ul><li>CI 环境: 至少 8 GB RAM</li><li>本地开发: 至少 16 GB RAM</li></ul><h2 id="已知问题" tabindex="-1">已知问题 <a class="header-anchor" href="#已知问题" aria-label="Permalink to “已知问题”">​</a></h2><h3 id="_1-truffle-fallback-runtime-警告" tabindex="-1">1. Truffle Fallback Runtime 警告 <a class="header-anchor" href="#_1-truffle-fallback-runtime-警告" aria-label="Permalink to “1. Truffle Fallback Runtime 警告”">​</a></h3><p><strong>问题</strong>: 每次运行都会打印警告信息。</p><p><strong>状态</strong>: 已知限制,不影响功能。</p><p><strong>计划</strong>: 修复 Truffle runtime 配置后警告消失。</p><h3 id="_2-pgo-profile-路径必须绝对" tabindex="-1">2. PGO Profile 路径必须绝对 <a class="header-anchor" href="#_2-pgo-profile-路径必须绝对" aria-label="Permalink to “2. PGO Profile 路径必须绝对”">​</a></h3><p><strong>问题</strong>: 相对路径会导致编译失败。</p><p><strong>解决方法</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ❌ 错误:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PpgoMode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default.iprof</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ✅ 正确:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-PpgoMode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pwd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/default.iprof</span></span></code></pre></div><p><strong>原因</strong>: Native Image 编译器从项目根目录执行。</p><h3 id="_3-某些-jackson-反射配置缺失" tabindex="-1">3. 某些 Jackson 反射配置缺失 <a class="header-anchor" href="#_3-某些-jackson-反射配置缺失" aria-label="Permalink to “3. 某些 Jackson 反射配置缺失”">​</a></h3><p><strong>问题</strong>: 使用自定义 Jackson 注解可能需要手动配置。</p><p><strong>解决方法</strong>: 使用 Native Image Agent 重新生成配置:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> generateNativeConfig</span></span></code></pre></div><h2 id="未来改进计划" tabindex="-1">未来改进计划 <a class="header-anchor" href="#未来改进计划" aria-label="Permalink to “未来改进计划”">​</a></h2><h3 id="短期-phase-2" tabindex="-1">短期 (Phase 2) <a class="header-anchor" href="#短期-phase-2" aria-label="Permalink to “短期 (Phase 2)”">​</a></h3><h4 id="_1-修复-truffle-runtime-配置" tabindex="-1">1. 修复 Truffle Runtime 配置 <a class="header-anchor" href="#_1-修复-truffle-runtime-配置" aria-label="Permalink to “1. 修复 Truffle Runtime 配置”">​</a></h4><p><strong>目标</strong>: 启用 Graal JIT 编译器,移除 fallback runtime 限制。</p><p><strong>预期收益</strong>:</p><ul><li>峰值性能提升至接近 JVM 水平</li><li>PGO 性能优化生效 (+20-30% 吞吐量)</li></ul><p><strong>实施步骤</strong>:</p><ol><li>移除 <code>-Dtruffle.TruffleRuntime</code> 显式配置</li><li>验证 Graal Compiler 可用</li><li>重新测试性能基准</li></ol><h4 id="_2-优化-pgo-流程" tabindex="-1">2. 优化 PGO 流程 <a class="header-anchor" href="#_2-优化-pgo-流程" aria-label="Permalink to “2. 优化 PGO 流程”">​</a></h4><p><strong>目标</strong>: 简化 PGO 工作流,提供预设 profile。</p><p><strong>计划</strong>:</p><ul><li>提供官方推荐的 profile 文件 (基于生产负载)</li><li>自动化 3 步骤流程 (单命令执行)</li><li>CI/CD 集成示例</li></ul><h3 id="中期-phase-3" tabindex="-1">中期 (Phase 3+) <a class="header-anchor" href="#中期-phase-3" aria-label="Permalink to “中期 (Phase 3+)”">​</a></h3><h4 id="_3-减少二进制大小" tabindex="-1">3. 减少二进制大小 <a class="header-anchor" href="#_3-减少二进制大小" aria-label="Permalink to “3. 减少二进制大小”">​</a></h4><p><strong>目标</strong>: 进一步减少至 15-20 MB。</p><p><strong>方法</strong>:</p><ul><li>使用 <code>--static</code> 链接模式 (Linux)</li><li>移除未使用的 Truffle 组件</li><li>探索 <code>-march=native</code> CPU 特定优化</li></ul><h4 id="_4-增量编译支持" tabindex="-1">4. 增量编译支持 <a class="header-anchor" href="#_4-增量编译支持" aria-label="Permalink to “4. 增量编译支持”">​</a></h4><p><strong>目标</strong>: 减少重新编译时间至 &lt; 30秒。</p><p><strong>方法</strong>:</p><ul><li>保留编译缓存</li><li>仅重新编译变更的模块</li></ul><h3 id="长期" tabindex="-1">长期 <a class="header-anchor" href="#长期" aria-label="Permalink to “长期”">​</a></h3><h4 id="_5-多平台预编译二进制" tabindex="-1">5. 多平台预编译二进制 <a class="header-anchor" href="#_5-多平台预编译二进制" aria-label="Permalink to “5. 多平台预编译二进制”">​</a></h4><p><strong>目标</strong>: 提供官方预编译二进制下载。</p><p><strong>平台</strong>:</p><ul><li>Linux x86_64</li><li>macOS ARM64 (M1/M2)</li><li>macOS x86_64 (Intel)</li><li>Windows x86_64</li></ul><h4 id="_6-docker-官方镜像" tabindex="-1">6. Docker 官方镜像 <a class="header-anchor" href="#_6-docker-官方镜像" aria-label="Permalink to “6. Docker 官方镜像”">​</a></h4><p><strong>目标</strong>: 提供最小化 Docker 镜像 (&lt; 50 MB)。</p><p><strong>示例</strong>:</p><div class="language-dockerfile"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> scratch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> aster /usr/local/bin/aster</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENTRYPOINT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/usr/local/bin/aster&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><h2 id="对比-jvm-vs-native-image" tabindex="-1">对比: JVM vs Native Image <a class="header-anchor" href="#对比-jvm-vs-native-image" aria-label="Permalink to “对比: JVM vs Native Image”">​</a></h2><h3 id="何时使用-jvm-版本" tabindex="-1">何时使用 JVM 版本 <a class="header-anchor" href="#何时使用-jvm-版本" aria-label="Permalink to “何时使用 JVM 版本”">​</a></h3><table tabindex="0"><thead><tr><th>场景</th><th>JVM</th><th>Native Image</th></tr></thead><tbody><tr><td>长时间运行服务 (&gt; 5分钟)</td><td>✅</td><td>❌</td></tr><tr><td>计算密集型任务</td><td>✅</td><td>❌</td></tr><tr><td>需要 JIT 优化</td><td>✅</td><td>❌</td></tr><tr><td>需要 JMX 监控</td><td>✅</td><td>❌</td></tr><tr><td>开发和调试</td><td>✅</td><td>⚠️</td></tr></tbody></table><h3 id="何时使用-native-image-版本" tabindex="-1">何时使用 Native Image 版本 <a class="header-anchor" href="#何时使用-native-image-版本" aria-label="Permalink to “何时使用 Native Image 版本”">​</a></h3><table tabindex="0"><thead><tr><th>场景</th><th>JVM</th><th>Native Image</th></tr></thead><tbody><tr><td>CLI 工具</td><td>❌</td><td>✅</td></tr><tr><td>短生命周期脚本 (&lt; 1分钟)</td><td>❌</td><td>✅</td></tr><tr><td>Serverless / Lambda</td><td>❌</td><td>✅</td></tr><tr><td>容器化部署 (K8s, Docker)</td><td>⚠️</td><td>✅</td></tr><tr><td>资源受限环境</td><td>❌</td><td>✅</td></tr><tr><td>CI/CD 流水线</td><td>❌</td><td>✅</td></tr></tbody></table><h3 id="混合部署策略" tabindex="-1">混合部署策略 <a class="header-anchor" href="#混合部署策略" aria-label="Permalink to “混合部署策略”">​</a></h3><p><strong>推荐</strong>: 根据场景选择合适版本:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># CLI 工具: Native Image</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">alias</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> aster</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./aster-truffle/build/native/nativeCompile/aster&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 后台服务: JVM</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster-truffle/build/libs/aster-truffle.jar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --server</span></span></code></pre></div><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to “参考资料”">​</a></h2><ul><li><a href="https://www.graalvm.org/latest/reference-manual/native-image/metadata/Compatibility/" target="_blank" rel="noreferrer">GraalVM Native Image 限制文档</a></li><li><a href="https://www.graalvm.org/latest/graalvm-as-a-platform/language-implementation-framework/" target="_blank" rel="noreferrer">Truffle 语言实现指南</a></li><li><a href="./README.html">快速开始</a></li><li><a href="./build-guide.html">详细构建指南</a></li><li><a href="./performance-comparison.html">性能对比</a></li><li><a href="./troubleshooting.html">故障排查</a></li></ul>`,162)])])}const c=i(l,[["render",n]]);export{g as __pageData,c as default};
