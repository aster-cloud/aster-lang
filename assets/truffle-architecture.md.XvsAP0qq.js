import{_ as i,c as a,o as t,aj as e}from"./chunks/framework.Bz2R-749.js";const c=JSON.parse('{"title":"Aster Truffle 架构文档","description":"","frontmatter":{},"headers":[],"relativePath":"truffle-architecture.md","filePath":"truffle-architecture.md"}'),n={name:"truffle-architecture.md"};function l(h,s,d,r,k,p){return t(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="aster-truffle-架构文档" tabindex="-1">Aster Truffle 架构文档 <a class="header-anchor" href="#aster-truffle-架构文档" aria-label="Permalink to “Aster Truffle 架构文档”">​</a></h1><p><strong>版本</strong>: 0.2.0 <strong>日期</strong>: 2025-11-05 <strong>状态</strong>: Phase 0 完成</p><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to “目录”">​</a></h2><ol><li><a href="#概述">概述</a></li><li><a href="#架构设计">架构设计</a></li><li><a href="#核心组件">核心组件</a></li><li><a href="#节点映射">节点映射</a></li><li><a href="#内置函数系统">内置函数系统</a></li><li><a href="#性能特性">性能特性</a></li><li><a href="#api-参考">API 参考</a></li><li><a href="#快速开始">快速开始</a></li><li><a href="#已知限制">已知限制</a></li></ol><hr><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to “概述”">​</a></h2><h3 id="什么是-aster-truffle" tabindex="-1">什么是 Aster Truffle <a class="header-anchor" href="#什么是-aster-truffle" aria-label="Permalink to “什么是 Aster Truffle”">​</a></h3><p>Aster Truffle 是 Aster 语言的第二个后端实现,基于 GraalVM Truffle 框架构建。Truffle 是一个用于实现高性能语言解释器的框架,通过 AST 解释执行并利用 GraalVM 的 JIT 编译器实现运行时优化。</p><h3 id="为什么选择-truffle" tabindex="-1">为什么选择 Truffle <a class="header-anchor" href="#为什么选择-truffle" aria-label="Permalink to “为什么选择 Truffle”">​</a></h3><p>与已有的 ASM Emitter 后端相比,Truffle 实现具有以下优势:</p><table tabindex="0"><thead><tr><th>特性</th><th>ASM Emitter</th><th>Truffle</th></tr></thead><tbody><tr><td><strong>实现方式</strong></td><td>直接生成 JVM 字节码</td><td>AST 解释器 + JIT 编译</td></tr><tr><td><strong>开发效率</strong></td><td>需要手动管理字节码生成</td><td>高层 API,Truffle DSL 自动优化</td></tr><tr><td><strong>运行时优化</strong></td><td>依赖 JVM JIT</td><td>GraalVM Graal 编译器深度优化</td></tr><tr><td><strong>启动时间</strong></td><td>较快（直接字节码）</td><td>中等（解释执行 → JIT）</td></tr><tr><td><strong>峰值性能</strong></td><td>优秀</td><td>卓越（JIT 优化后超越 ASM）</td></tr><tr><td><strong>原生镜像</strong></td><td>不支持</td><td>完整支持（36MB 独立二进制）</td></tr><tr><td><strong>可维护性</strong></td><td>复杂（字节码级）</td><td>简洁（AST 级）</td></tr></tbody></table><p><strong>关键指标</strong>（基于 Phase 0 测试）:</p><ul><li><strong>Core IR 覆盖率</strong>: 93.75% (30/32 节点)</li><li><strong>测试通过率</strong>: 100% (27/27 测试)</li><li><strong>原生镜像大小</strong>: 36.26MB</li><li><strong>原生镜像启动</strong>: ~44ms</li><li><strong>JIT 峰值性能</strong>: 超越 ASM Emitter 约 20-30%</li></ul><hr><h2 id="架构设计" tabindex="-1">架构设计 <a class="header-anchor" href="#架构设计" aria-label="Permalink to “架构设计”">​</a></h2><h3 id="设计理念" tabindex="-1">设计理念 <a class="header-anchor" href="#设计理念" aria-label="Permalink to “设计理念”">​</a></h3><p>Aster Truffle 实现遵循以下设计原则:</p><ol><li><strong>直接映射</strong>: Core IR 节点一对一映射到 Truffle 节点,保持语义一致性</li><li><strong>最小侵入</strong>: 不修改 Core IR 定义,完全基于现有规范实现</li><li><strong>渐进优化</strong>: 从简单解释执行开始,通过 Truffle DSL 专门化实现性能优化</li><li><strong>类型透明</strong>: 支持动态类型,通过 Truffle 类型系统实现高效的类型特化</li></ol><h3 id="执行流程" tabindex="-1">执行流程 <a class="header-anchor" href="#执行流程" aria-label="Permalink to “执行流程”">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Core IR JSON 文件</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>   Loader (解析)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>  CoreModel (IR 对象)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>  Builder (构建 AST)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Truffle 节点树 (AsterRootNode)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span> GraalVM 执行引擎</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>  解释执行 → JIT 编译 → 优化代码</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>     结果输出</span></span></code></pre></div><p><strong>阶段说明</strong>:</p><ol><li><strong>解析阶段</strong>: <code>Loader</code> 读取 Core IR JSON 文件,使用 Jackson 解析为 <code>CoreModel</code> 对象</li><li><strong>构建阶段</strong>: 遍历 Core IR 树,为每个节点创建对应的 Truffle 节点</li><li><strong>执行阶段</strong>: Truffle 引擎执行 AST,初期为解释执行</li><li><strong>优化阶段</strong>: GraalVM Graal 编译器识别热点代码,进行 JIT 编译和深度优化</li></ol><hr><h2 id="核心组件" tabindex="-1">核心组件 <a class="header-anchor" href="#核心组件" aria-label="Permalink to “核心组件”">​</a></h2><h3 id="_1-asterlanguage" tabindex="-1">1. AsterLanguage <a class="header-anchor" href="#_1-asterlanguage" aria-label="Permalink to “1. AsterLanguage”">​</a></h3><p><strong>文件</strong>: <code>aster-truffle/src/main/java/aster/truffle/AsterLanguage.java</code></p><p><strong>职责</strong>: Truffle 语言实现的入口点,定义语言元数据和运行时上下文的创建。</p><p><strong>关键特性</strong>:</p><ul><li><code>@TruffleLanguage.Registration</code> 注解注册语言</li><li>语言 ID: <code>&quot;aster&quot;</code></li><li>创建和管理 <code>AsterContext</code> 实例</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TruffleLanguage.Registration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;aster&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Aster&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;0.2.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    defaultMimeType</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;application/x-aster&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    characterMimeTypes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;application/x-aster&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AsterLanguage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TruffleLanguage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AsterContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> AsterContext </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Env </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AsterContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, env);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2-astercontext" tabindex="-1">2. AsterContext <a class="header-anchor" href="#_2-astercontext" aria-label="Permalink to “2. AsterContext”">​</a></h3><p><strong>文件</strong>: <code>aster-truffle/src/main/java/aster/truffle/AsterContext.java</code></p><p><strong>职责</strong>: 运行时上下文,管理全局状态、内置函数和异步任务。</p><p><strong>核心功能</strong>:</p><ul><li><strong>内置函数注册</strong>: 通过 <code>Builtins</code> 类注册所有内置函数</li><li><strong>异步任务管理</strong>: 通过 <code>AsyncTaskRegistry</code> 管理 <code>start</code>/<code>await</code> 任务</li><li><strong>环境管理</strong>: 持有 Truffle <code>Env</code> 对象,访问 I/O 和其他运行时服务</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AsterContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> AsterLanguage language;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Env env;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Builtins builtins;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> AsyncTaskRegistry asyncTasks;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lookupBuiltin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builtins.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lookup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3-runner" tabindex="-1">3. Runner <a class="header-anchor" href="#_3-runner" aria-label="Permalink to “3. Runner”">​</a></h3><p><strong>文件</strong>: <code>aster-truffle/src/main/java/aster/truffle/Runner.java</code></p><p><strong>职责</strong>: 命令行入口,负责加载 Core IR、构建 AST 并执行。</p><p><strong>执行流程</strong>:</p><ol><li>解析命令行参数（Core IR 文件路径、函数名、参数）</li><li>通过 <code>Loader</code> 加载 Core IR JSON</li><li>查找指定的函数声明</li><li>构建 Truffle <code>CallTarget</code></li><li>执行并输出结果</li></ol><p><strong>使用方式</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># JVM 模式</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster-truffle.jar</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core-ir-fil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --func=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">function-name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">args..</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Native 模式</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core-ir-fil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --func=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">function-name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">args..</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><h3 id="_4-loader" tabindex="-1">4. Loader <a class="header-anchor" href="#_4-loader" aria-label="Permalink to “4. Loader”">​</a></h3><p><strong>文件</strong>: <code>aster-truffle/src/main/java/aster/truffle/Loader.java</code></p><p><strong>职责</strong>: 加载并解析 Core IR JSON 文件为 <code>CoreModel</code> 对象。</p><p><strong>技术实现</strong>:</p><ul><li>使用 Jackson ObjectMapper 解析 JSON</li><li>支持 Core IR 规范定义的所有节点类型</li><li>提供错误处理和验证</li></ul><h3 id="_5-节点基类" tabindex="-1">5. 节点基类 <a class="header-anchor" href="#_5-节点基类" aria-label="Permalink to “5. 节点基类”">​</a></h3><p><strong>AsterExpressionNode</strong>: 所有表达式节点的基类</p><ul><li><strong>文件</strong>: <code>aster-truffle/src/main/java/aster/truffle/nodes/AsterExpressionNode.java</code></li><li><strong>返回值</strong>: 执行后返回 <code>Object</code> 类型的值</li><li><strong>执行方法</strong>: <code>public abstract Object executeGeneric(VirtualFrame frame)</code></li></ul><p><strong>关键设计</strong>:</p><ul><li>继承自 Truffle <code>Node</code>,自动获得树结构支持</li><li>使用 Truffle DSL <code>@Specialization</code> 注解实现类型特化</li></ul><hr><h2 id="节点映射" tabindex="-1">节点映射 <a class="header-anchor" href="#节点映射" aria-label="Permalink to “节点映射”">​</a></h2><h3 id="覆盖率总览" tabindex="-1">覆盖率总览 <a class="header-anchor" href="#覆盖率总览" aria-label="Permalink to “覆盖率总览”">​</a></h3><table tabindex="0"><thead><tr><th>类别</th><th>总数</th><th>已实现</th><th>覆盖率</th><th>状态</th></tr></thead><tbody><tr><td><strong>表达式 (Expressions)</strong></td><td>15</td><td>15</td><td>100%</td><td>✅ 完整</td></tr><tr><td><strong>语句 (Statements)</strong></td><td>9</td><td>9</td><td>100%</td><td>✅ 完整</td></tr><tr><td><strong>模式 (Patterns)</strong></td><td>4</td><td>4</td><td>100%</td><td>✅ 完整</td></tr><tr><td><strong>声明 (Declarations)</strong></td><td>4</td><td>2</td><td>50%</td><td>⚠️ 部分</td></tr><tr><td><strong>总计</strong></td><td>32</td><td>30</td><td>93.75%</td><td>✅ Phase 0 达标</td></tr></tbody></table><h3 id="表达式节点-15-15-✅" tabindex="-1">表达式节点 (15/15) ✅ <a class="header-anchor" href="#表达式节点-15-15-✅" aria-label="Permalink to “表达式节点 (15/15) ✅”">​</a></h3><table tabindex="0"><thead><tr><th>Core IR 类型</th><th>Truffle 节点</th><th>文件路径</th><th>说明</th></tr></thead><tbody><tr><td><code>Name</code></td><td><code>NameNode</code></td><td><code>nodes/NameNode.java</code></td><td>变量引用,从 frame 或环境查找</td></tr><tr><td><code>Literal</code></td><td><code>LiteralNode</code></td><td><code>nodes/LiteralNode.java</code></td><td>字面量(null, boolean, number, string)</td></tr><tr><td><code>Lambda</code></td><td><code>LambdaNode</code></td><td><code>nodes/LambdaNode.java</code></td><td>Lambda 表达式,创建 <code>LambdaValue</code> 闭包</td></tr><tr><td><code>Call</code></td><td><code>CallNode</code></td><td><code>nodes/CallNode.java</code></td><td>函数调用,支持内置函数和 Lambda</td></tr><tr><td><code>Construct</code></td><td><code>ConstructNode</code></td><td><code>nodes/ConstructNode.java</code></td><td>构造 Map,支持键值对</td></tr><tr><td><code>If</code></td><td><code>IfNode</code></td><td><code>nodes/IfNode.java</code></td><td>条件表达式,三元运算</td></tr><tr><td><code>Match</code></td><td><code>MatchNode</code></td><td><code>nodes/MatchNode.java</code></td><td>模式匹配,支持多分支</td></tr><tr><td><code>Block</code></td><td><code>BlockNode</code></td><td><code>nodes/BlockNode.java</code></td><td>语句块,顺序执行多个语句</td></tr><tr><td><code>Ok</code></td><td><code>ResultNodes.OkNode</code></td><td><code>nodes/ResultNodes.java</code></td><td>Result 类型的 Ok 变体</td></tr><tr><td><code>Err</code></td><td><code>ResultNodes.ErrNode</code></td><td><code>nodes/ResultNodes.java</code></td><td>Result 类型的 Err 变体</td></tr><tr><td><code>Some</code></td><td><code>ResultNodes.SomeNode</code></td><td><code>nodes/ResultNodes.java</code></td><td>Option 类型的 Some 变体</td></tr><tr><td><code>None</code></td><td><code>ResultNodes.NoneNode</code></td><td><code>nodes/ResultNodes.java</code></td><td>Option 类型的 None 变体</td></tr><tr><td><code>Start</code></td><td><code>StartNode</code></td><td><code>nodes/StartNode.java</code></td><td>启动异步任务,返回任务 ID</td></tr><tr><td><code>Await</code></td><td><code>AwaitNode</code></td><td><code>nodes/AwaitNode.java</code></td><td>等待异步任务完成</td></tr><tr><td><code>Wait</code></td><td><code>WaitNode</code></td><td><code>nodes/WaitNode.java</code></td><td>等待多个异步任务</td></tr></tbody></table><h3 id="语句节点-9-9-✅" tabindex="-1">语句节点 (9/9) ✅ <a class="header-anchor" href="#语句节点-9-9-✅" aria-label="Permalink to “语句节点 (9/9) ✅”">​</a></h3><table tabindex="0"><thead><tr><th>Core IR 类型</th><th>Truffle 节点</th><th>文件路径</th><th>说明</th></tr></thead><tbody><tr><td><code>Let</code></td><td><code>LetNode</code></td><td><code>nodes/LetNode.java</code></td><td>局部变量绑定（不可变）</td></tr><tr><td><code>Set</code></td><td><code>SetNode</code></td><td><code>nodes/SetNode.java</code></td><td>变量赋值（可变）</td></tr><tr><td><code>Return</code></td><td><code>ReturnNode</code></td><td><code>nodes/ReturnNode.java</code></td><td>提前返回,抛出 <code>ControlFlowException</code></td></tr><tr><td><code>Exec</code></td><td><code>Exec.ExecExpressionStatement</code></td><td><code>nodes/Exec.java</code></td><td>表达式语句,执行但丢弃返回值</td></tr><tr><td><code>If</code> (作为语句)</td><td><code>IfNode</code></td><td><code>nodes/IfNode.java</code></td><td>条件语句（与表达式共用节点）</td></tr><tr><td><code>Match</code> (作为语句)</td><td><code>MatchNode</code></td><td><code>nodes/MatchNode.java</code></td><td>模式匹配语句（与表达式共用）</td></tr><tr><td><code>Block</code></td><td><code>BlockNode</code></td><td><code>nodes/BlockNode.java</code></td><td>语句块（与表达式共用）</td></tr><tr><td><code>Start</code> (作为语句)</td><td><code>StartNode</code></td><td><code>nodes/StartNode.java</code></td><td>异步任务启动语句</td></tr><tr><td><code>Wait</code> (作为语句)</td><td><code>WaitNode</code></td><td><code>nodes/WaitNode.java</code></td><td>等待语句</td></tr></tbody></table><h3 id="模式节点-4-4-✅" tabindex="-1">模式节点 (4/4) ✅ <a class="header-anchor" href="#模式节点-4-4-✅" aria-label="Permalink to “模式节点 (4/4) ✅”">​</a></h3><p>模式节点通过 <code>MatchNode</code> 内部的模式匹配逻辑实现,支持:</p><table tabindex="0"><thead><tr><th>Core IR 类型</th><th>实现方式</th><th>说明</th></tr></thead><tbody><tr><td><code>PName</code></td><td><code>MatchNode</code> 内部逻辑</td><td>绑定模式,将值绑定到变量</td></tr><tr><td><code>PLiteral</code></td><td><code>MatchNode</code> 内部逻辑</td><td>字面量模式,精确匹配</td></tr><tr><td><code>PConstruct</code></td><td><code>MatchNode</code> 内部逻辑</td><td>构造模式,匹配 Map 结构</td></tr><tr><td><code>PWildcard</code></td><td><code>MatchNode</code> 内部逻辑</td><td>通配符模式,匹配任意值</td></tr></tbody></table><h3 id="声明节点-2-4-⚠️" tabindex="-1">声明节点 (2/4) ⚠️ <a class="header-anchor" href="#声明节点-2-4-⚠️" aria-label="Permalink to “声明节点 (2/4) ⚠️”">​</a></h3><table tabindex="0"><thead><tr><th>Core IR 类型</th><th>Truffle 节点</th><th>文件路径</th><th>状态</th></tr></thead><tbody><tr><td><code>Function</code></td><td><code>AsterRootNode</code> + <code>LambdaRootNode</code></td><td><code>nodes/AsterRootNode.java</code></td><td>✅ 已实现</td></tr><tr><td><code>Let</code> (顶层)</td><td><code>LetNode</code></td><td><code>nodes/LetNode.java</code></td><td>✅ 已实现</td></tr><tr><td><code>Data</code></td><td>-</td><td>-</td><td>❌ 未实现（Phase 1）</td></tr><tr><td><code>Import</code></td><td>-</td><td>-</td><td>❌ 未实现（Phase 1）</td></tr></tbody></table><p><strong>说明</strong>:</p><ul><li><strong>Data</strong>: 自定义数据类型声明,计划在 Phase 1 实现</li><li><strong>Import</strong>: 模块导入,计划在 Phase 1 实现</li><li>当前实现足以支持 Core IR 基本功能测试</li></ul><hr><h2 id="内置函数系统" tabindex="-1">内置函数系统 <a class="header-anchor" href="#内置函数系统" aria-label="Permalink to “内置函数系统”">​</a></h2><p><strong>文件</strong>: <code>aster-truffle/src/main/java/aster/truffle/runtime/Builtins.java</code></p><p>Aster Truffle 通过 <code>Builtins</code> 类提供内置函数支持。内置函数在 <code>AsterContext</code> 创建时注册,通过 <code>CallNode</code> 调用。</p><h3 id="内置函数列表" tabindex="-1">内置函数列表 <a class="header-anchor" href="#内置函数列表" aria-label="Permalink to “内置函数列表”">​</a></h3><table tabindex="0"><thead><tr><th>函数名</th><th>签名</th><th>说明</th><th>实现方式</th></tr></thead><tbody><tr><td><code>print</code></td><td><code>(value: any) -&gt; null</code></td><td>打印值到标准输出</td><td>直接 Java 实现</td></tr><tr><td><code>println</code></td><td><code>(value: any) -&gt; null</code></td><td>打印值并换行</td><td>直接 Java 实现</td></tr><tr><td><code>toString</code></td><td><code>(value: any) -&gt; string</code></td><td>转换为字符串</td><td>直接 Java 实现</td></tr><tr><td><code>toNumber</code></td><td><code>(value: any) -&gt; number</code></td><td>转换为数字</td><td>直接 Java 实现</td></tr><tr><td><code>listOf</code></td><td><code>(...values) -&gt; list</code></td><td>创建列表</td><td>直接 Java 实现</td></tr><tr><td><code>mapOf</code></td><td><code>(...pairs) -&gt; map</code></td><td>创建 Map</td><td>直接 Java 实现</td></tr></tbody></table><h3 id="扩展内置函数" tabindex="-1">扩展内置函数 <a class="header-anchor" href="#扩展内置函数" aria-label="Permalink to “扩展内置函数”">​</a></h3><p>添加新的内置函数需要:</p><ol><li>在 <code>Builtins.java</code> 中实现函数逻辑</li><li>在 <code>AsterContext</code> 构造函数中注册函数名</li><li>确保函数签名与 Core IR 规范一致</li></ol><p><strong>示例</strong>（添加 <code>Math.sqrt</code> 函数）:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 在 Builtins.java 中</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SqrtBuiltin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Object... </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (args.length </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IllegalArgumentException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sqrt expects 1 argument&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        double</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((Number) args[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doubleValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sqrt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 在 AsterContext 中注册</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">builtins.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">register</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Math.sqrt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Builtins.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SqrtBuiltin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span></code></pre></div><hr><h2 id="性能特性" tabindex="-1">性能特性 <a class="header-anchor" href="#性能特性" aria-label="Permalink to “性能特性”">​</a></h2><h3 id="graalvm-jit-优化" tabindex="-1">GraalVM JIT 优化 <a class="header-anchor" href="#graalvm-jit-优化" aria-label="Permalink to “GraalVM JIT 优化”">​</a></h3><p>Truffle 通过 GraalVM Graal 编译器实现以下优化:</p><ol><li><strong>类型特化 (Type Specialization)</strong>: 通过 <code>@Specialization</code> 注解自动生成针对特定类型的优化代码</li><li><strong>内联 (Inlining)</strong>: 热点函数自动内联,减少调用开销</li><li><strong>部分求值 (Partial Evaluation)</strong>: 编译时常量折叠和死代码消除</li><li><strong>逃逸分析 (Escape Analysis)</strong>: 栈上分配对象,减少 GC 压力</li></ol><p><strong>性能数据</strong>（基于 fibonacci(35) 测试）:</p><table tabindex="0"><thead><tr><th>模式</th><th>执行时间</th><th>相对性能</th></tr></thead><tbody><tr><td>Truffle 解释执行（冷启动）</td><td>~5000ms</td><td>1x (基准)</td></tr><tr><td>Truffle JIT 优化（热点）</td><td>~150ms</td><td><strong>33x</strong></td></tr><tr><td>ASM Emitter</td><td>~200ms</td><td>25x</td></tr><tr><td>Pure Java</td><td>~180ms</td><td>27x</td></tr></tbody></table><p><strong>结论</strong>: JIT 优化后的 Truffle 实现超越 ASM Emitter 约 <strong>25-30%</strong>。</p><h3 id="native-image" tabindex="-1">Native Image <a class="header-anchor" href="#native-image" aria-label="Permalink to “Native Image”">​</a></h3><p>通过 GraalVM Native Image 可以将 Truffle 解释器编译为独立的原生二进制文件。</p><p><strong>优势</strong>:</p><ul><li><strong>快速启动</strong>: ~44ms (vs JVM 模式 ~2s)</li><li><strong>低内存占用</strong>: 无 JVM 开销</li><li><strong>独立部署</strong>: 单一可执行文件,无需 JRE</li></ul><p><strong>编译命令</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span></span></code></pre></div><p><strong>输出</strong>:</p><ul><li>文件: <code>aster-truffle/build/native/nativeCompile/aster</code></li><li>大小: 36.26MB</li><li>包含: Truffle 解释器 + GraalVM 运行时 + 所有依赖</li></ul><p><strong>性能特性</strong>:</p><ul><li>启动时间: ~44ms</li><li>峰值性能: 略低于 JIT 模式（无运行时编译）</li><li>适用场景: CLI 工具、短生命周期任务</li></ul><hr><h2 id="api-参考" tabindex="-1">API 参考 <a class="header-anchor" href="#api-参考" aria-label="Permalink to “API 参考”">​</a></h2><h3 id="命令行接口" tabindex="-1">命令行接口 <a class="header-anchor" href="#命令行接口" aria-label="Permalink to “命令行接口”">​</a></h3><p><strong>语法</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">aster</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core-ir-fil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --func=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">function-name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">arg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">1&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">arg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">2&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ...</span></span></code></pre></div><p><strong>参数说明</strong>:</p><ul><li><code>&lt;core-ir-file&gt;</code>: Core IR JSON 文件路径</li><li><code>--func=&lt;function-name&gt;</code>: 要执行的函数名称</li><li><code>-- &lt;args&gt;</code>: 函数参数（在 <code>--</code> 后传递）</li></ul><p><strong>示例</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 执行 fibonacci(20)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benchmarks/core/fibonacci_20_core.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --func=fibonacci</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 执行 quickSort([3,1,4,1,5])</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benchmarks/core/quicksort_core.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --func=quickSort</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [3,1,4,1,5]</span></span></code></pre></div><h3 id="程序化-api" tabindex="-1">程序化 API <a class="header-anchor" href="#程序化-api" aria-label="Permalink to “程序化 API”">​</a></h3><p><strong>通过 Truffle Polyglot API 调用</strong>:</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.graalvm.polyglot.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AsterExample</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 创建 Polyglot 上下文</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Context context </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;aster&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 加载 Core IR 文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Source source </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Source.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;aster&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;fibonacci.json&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 评估并执行</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Value result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(source);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Result: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="扩展节点类型" tabindex="-1">扩展节点类型 <a class="header-anchor" href="#扩展节点类型" aria-label="Permalink to “扩展节点类型”">​</a></h3><p><strong>添加新的 Core IR 节点实现</strong>:</p><ol><li><strong>创建节点类</strong>（继承 <code>AsterExpressionNode</code>）:</li></ol><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> aster.truffle.nodes;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.oracle.truffle.api.frame.VirtualFrame;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.oracle.truffle.api.dsl.Specialization;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> abstract</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyCustomNode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AsterExpressionNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Child</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> AsterExpressionNode argument;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyCustomNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(AsterExpressionNode </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">argument</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.argument </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> argument;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Specialization</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doExecute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(VirtualFrame </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">frame</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Object value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> argument.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">executeGeneric</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(frame);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 实现自定义逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">processValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Object </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ol start="2"><li><strong>在 Builder 中添加映射</strong>（修改 <code>Loader.java</code>）:</li></ol><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MyCustom&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> buildMyCustomNode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(expr);</span></span></code></pre></div><hr><h2 id="快速开始" tabindex="-1">快速开始 <a class="header-anchor" href="#快速开始" aria-label="Permalink to “快速开始”">​</a></h2><h3 id="环境要求" tabindex="-1">环境要求 <a class="header-anchor" href="#环境要求" aria-label="Permalink to “环境要求”">​</a></h3><ul><li><strong>JDK</strong>: 25+ (推荐 GraalVM 25+)</li><li><strong>Gradle</strong>: 9.0+</li><li><strong>操作系统</strong>: macOS, Linux, Windows</li></ul><h3 id="构建项目" tabindex="-1">构建项目 <a class="header-anchor" href="#构建项目" aria-label="Permalink to “构建项目”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Clone 仓库</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/wontlost-ltd/aster-lang.git</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster-lang</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 构建 Truffle 模块</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:build</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 构建 Native Image（需要 GraalVM）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span></span></code></pre></div><h3 id="运行测试" tabindex="-1">运行测试 <a class="header-anchor" href="#运行测试" aria-label="Permalink to “运行测试”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 运行所有测试</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:test</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 运行性能测试</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:test</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --tests</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;GraalVMJitBenchmark&quot;</span></span></code></pre></div><h3 id="执行示例" tabindex="-1">执行示例 <a class="header-anchor" href="#执行示例" aria-label="Permalink to “执行示例”">​</a></h3><p><strong>JVM 模式</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用 Gradle 运行</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --args=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;benchmarks/core/fibonacci_20_core.json --func=fibonacci -- 20&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 或使用 JAR</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster-truffle/build/libs/aster-truffle.jar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  benchmarks/core/fibonacci_20_core.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --func=fibonacci</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span></span></code></pre></div><p><strong>Native Image 模式</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  benchmarks/core/fibonacci_20_core.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --func=fibonacci</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span></span></code></pre></div><h3 id="docker-部署" tabindex="-1">Docker 部署 <a class="header-anchor" href="#docker-部署" aria-label="Permalink to “Docker 部署”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 构建 Docker 镜像</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Dockerfile.truffle</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster/truffle:latest</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 运行容器</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pwd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/benchmarks:/benchmarks</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster/truffle:latest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  /benchmarks/core/fibonacci_20_core.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --func=fibonacci</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span></span></code></pre></div><hr><h2 id="已知限制" tabindex="-1">已知限制 <a class="header-anchor" href="#已知限制" aria-label="Permalink to “已知限制”">​</a></h2><h3 id="phase-0-未实现功能" tabindex="-1">Phase 0 未实现功能 <a class="header-anchor" href="#phase-0-未实现功能" aria-label="Permalink to “Phase 0 未实现功能”">​</a></h3><ol><li><strong>Data 声明</strong>: 自定义数据类型定义（计划 Phase 1）</li><li><strong>Import 声明</strong>: 模块导入系统（计划 Phase 1）</li></ol><h3 id="性能考虑" tabindex="-1">性能考虑 <a class="header-anchor" href="#性能考虑" aria-label="Permalink to “性能考虑”">​</a></h3><ol><li><strong>冷启动性能</strong>: 解释执行阶段性能较低,需要热身达到峰值性能</li><li><strong>Native Image 限制</strong>: 原生镜像无运行时 JIT,峰值性能略低于 JVM 模式</li><li><strong>内存占用</strong>: 解释执行期间内存占用高于 ASM Emitter</li></ol><h3 id="开发建议" tabindex="-1">开发建议 <a class="header-anchor" href="#开发建议" aria-label="Permalink to “开发建议”">​</a></h3><ol><li><strong>类型注解</strong>: 尽可能使用 <code>@Specialization</code> 提供类型信息,帮助 Truffle 优化</li><li><strong>避免多态</strong>: 减少动态调用和多态方法,有利于 JIT 内联</li><li><strong>基准测试</strong>: 使用 <code>GraalVMJitBenchmark</code> 验证性能优化效果</li></ol><hr><h2 id="贡献指南" tabindex="-1">贡献指南 <a class="header-anchor" href="#贡献指南" aria-label="Permalink to “贡献指南”">​</a></h2><h3 id="添加新节点类型" tabindex="-1">添加新节点类型 <a class="header-anchor" href="#添加新节点类型" aria-label="Permalink to “添加新节点类型”">​</a></h3><ol><li>在 <code>aster-truffle/src/main/java/aster/truffle/nodes/</code> 创建节点类</li><li>继承 <code>AsterExpressionNode</code> 或 <code>AsterStatementNode</code></li><li>使用 Truffle DSL <code>@Specialization</code> 实现类型特化</li><li>在 <code>Loader.java</code> 添加节点构建逻辑</li><li>添加单元测试验证功能</li></ol><h3 id="优化现有节点" tabindex="-1">优化现有节点 <a class="header-anchor" href="#优化现有节点" aria-label="Permalink to “优化现有节点”">​</a></h3><ol><li>分析性能瓶颈（使用 <code>--vm.Dgraal.TraceTruffleCompilation=true</code>）</li><li>添加 <code>@Specialization</code> 注解覆盖常见类型</li><li>使用 <code>@Cached</code> 缓存中间结果</li><li>验证优化效果（使用 JMH 基准测试）</li></ol><h3 id="测试覆盖" tabindex="-1">测试覆盖 <a class="header-anchor" href="#测试覆盖" aria-label="Permalink to “测试覆盖”">​</a></h3><ul><li>单元测试: <code>aster-truffle/src/test/java/</code></li><li>黄金测试: 复用 <code>test/golden/</code> 测试用例</li><li>性能测试: <code>GraalVMJitBenchmark.java</code></li></ul><hr><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to “参考资料”">​</a></h2><ul><li><a href="https://www.graalvm.org/latest/docs/" target="_blank" rel="noreferrer">GraalVM 官方文档</a></li><li><a href="https://www.graalvm.org/latest/graalvm-as-a-platform/language-implementation-framework/" target="_blank" rel="noreferrer">Truffle 语言实现指南</a></li><li><a href="https://www.graalvm.org/truffle/javadoc/com/oracle/truffle/api/dsl/package-summary.html" target="_blank" rel="noreferrer">Truffle DSL 参考</a></li><li><a href="./core-ir-specification.html">Aster Core IR 规范</a></li></ul><hr><p><strong>维护者</strong>: Aster Lang Team <strong>许可证</strong>: Apache 2.0 <strong>版本</strong>: 0.2.0 (Phase 0 完成)</p>`,151)])])}const g=i(n,[["render",l]]);export{c as __pageData,g as default};
