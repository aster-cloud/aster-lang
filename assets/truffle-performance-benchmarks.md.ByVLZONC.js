import{_ as a,c as s,o as l,aj as t}from"./chunks/framework.Bz2R-749.js";const c=JSON.parse('{"title":"Truffle 性能基准测试文档","description":"","frontmatter":{},"headers":[],"relativePath":"truffle-performance-benchmarks.md","filePath":"truffle-performance-benchmarks.md"}'),e={name:"truffle-performance-benchmarks.md"};function n(h,i,r,k,d,p){return l(),s("div",null,[...i[0]||(i[0]=[t(`<h1 id="truffle-性能基准测试文档" tabindex="-1">Truffle 性能基准测试文档 <a class="header-anchor" href="#truffle-性能基准测试文档" aria-label="Permalink to “Truffle 性能基准测试文档”">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to “概述”">​</a></h2><p>本文档描述 Aster Lang Truffle 后端的性能基准测试套件，用于验证 Truffle JIT 编译器的优化效果和检测性能退化。</p><h2 id="测试方法论" tabindex="-1">测试方法论 <a class="header-anchor" href="#测试方法论" aria-label="Permalink to “测试方法论”">​</a></h2><h3 id="三阶段测试" tabindex="-1">三阶段测试 <a class="header-anchor" href="#三阶段测试" aria-label="Permalink to “三阶段测试”">​</a></h3><p>每个基准测试遵循标准的三阶段测试流程：</p><ol><li><strong>Warmup 阶段</strong>：重复执行代码，让 Truffle JIT 编译器有机会优化热点路径</li><li><strong>测量阶段</strong>：多次迭代执行并测量平均执行时间</li><li><strong>验证阶段</strong>：确保性能指标在可接受的阈值范围内</li></ol><h3 id="测试环境说明" tabindex="-1">测试环境说明 <a class="header-anchor" href="#测试环境说明" aria-label="Permalink to “测试环境说明”">​</a></h3><ul><li><strong>JIT 状态</strong>：测试在解释模式下运行（无 GraalVM JIT 编译器）</li><li><strong>性能基线</strong>：阈值设置考虑了解释模式的额外开销</li><li><strong>CI/CD 集成</strong>：基准测试作为标准测试套件的一部分，在每次 PR 中运行</li></ul><h2 id="当前基准测试" tabindex="-1">当前基准测试 <a class="header-anchor" href="#当前基准测试" aria-label="Permalink to “当前基准测试”">​</a></h2><h3 id="_1-简单算术计算-benchmarkarithmetic" tabindex="-1">1. 简单算术计算 (<code>benchmarkArithmetic</code>) <a class="header-anchor" href="#_1-简单算术计算-benchmarkarithmetic" aria-label="Permalink to “1. 简单算术计算 (benchmarkArithmetic)”">​</a></h3><p><strong>测试目标</strong>：验证 Builtin 函数调用优化</p><p><strong>测试场景</strong>：</p><div class="language-aster"><button title="Copy Code" class="copy"></button><span class="lang">aster</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">func </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">compute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x: Int): Int {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>性能指标</strong>：</p><ul><li>迭代次数：10,000 次</li><li>性能阈值：&lt; 1 ms/iteration</li><li>典型性能：~0.002 ms/iteration</li></ul><p><strong>关键优化点</strong>：</p><ul><li>Builtin 函数内联</li><li>简单算术运算优化</li><li>参数传递开销</li></ul><h3 id="_2-递归阶乘计算-benchmarkfactorial" tabindex="-1">2. 递归阶乘计算 (<code>benchmarkFactorial</code>) <a class="header-anchor" href="#_2-递归阶乘计算-benchmarkfactorial" aria-label="Permalink to “2. 递归阶乘计算 (benchmarkFactorial)”">​</a></h3><p><strong>测试目标</strong>：验证递归函数调用优化</p><p><strong>测试场景</strong>：</p><div class="language-aster"><button title="Copy Code" class="copy"></button><span class="lang">aster</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">func </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">factorial</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n: Int): Int {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> factorial</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">factorial</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// = 3,628,800</span></span></code></pre></div><p><strong>性能指标</strong>：</p><ul><li>Warmup：100 次迭代</li><li>测试迭代次数：1,000 次</li><li>性能阈值：&lt; 10 ms/iteration</li><li>典型性能：~0.026 ms/iteration</li></ul><p><strong>关键优化点</strong>：</p><ul><li>递归调用内联</li><li>条件分支预测</li><li>Frame 栈管理</li></ul><h3 id="_3-递归斐波那契数列-benchmarkfibonacci" tabindex="-1">3. 递归斐波那契数列 (<code>benchmarkFibonacci</code>) <a class="header-anchor" href="#_3-递归斐波那契数列-benchmarkfibonacci" aria-label="Permalink to “3. 递归斐波那契数列 (benchmarkFibonacci)”">​</a></h3><p><strong>测试目标</strong>：验证重复递归调用优化（最密集的递归测试）</p><p><strong>测试场景</strong>：</p><div class="language-aster"><button title="Copy Code" class="copy"></button><span class="lang">aster</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">func </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fib</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n: Int): Int {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> n</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fib</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fib</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(n </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fib</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">15</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// = 610</span></span></code></pre></div><p><strong>性能指标</strong>：</p><ul><li>Warmup：50 次迭代</li><li>测试迭代次数：100 次</li><li>性能阈值：&lt; 50 ms/iteration</li><li>典型性能：~2.2 ms/iteration</li></ul><p><strong>关键优化点</strong>：</p><ul><li>多重递归调用优化</li><li>重复计算处理</li><li>函数调用缓存</li></ul><p><strong>注意事项</strong>：</p><ul><li>fib(15) 产生 1,219 次函数调用</li><li>指数级递归复杂度 O(2^n)</li><li>对 JIT 编译器压力测试最大</li></ul><h2 id="规划中的基准测试-待实现" tabindex="-1">规划中的基准测试（待实现） <a class="header-anchor" href="#规划中的基准测试-待实现" aria-label="Permalink to “规划中的基准测试（待实现）”">​</a></h2><p>以下基准测试已编写但暂时禁用，等待 Core IR JSON 格式完善：</p><h3 id="_4-lambda-高阶函数-benchmarklambdacall-禁用" tabindex="-1">4. Lambda 高阶函数 (<code>benchmarkLambdaCall</code>) [禁用] <a class="header-anchor" href="#_4-lambda-高阶函数-benchmarklambdacall-禁用" aria-label="Permalink to “4. Lambda 高阶函数 (benchmarkLambdaCall) [禁用]”">​</a></h3><p><strong>测试目标</strong>：Lambda 创建和调用开销</p><p><strong>状态</strong>：等待修复 Lambda JSON 格式（需要 <code>ret</code>, <code>captures</code> 字段）</p><p><strong>性能目标</strong>：&lt; 5 ms/iteration (1000 iterations)</p><h3 id="_5-闭包捕获-benchmarkclosurecapture-禁用" tabindex="-1">5. 闭包捕获 (<code>benchmarkClosureCapture</code>) [禁用] <a class="header-anchor" href="#_5-闭包捕获-benchmarkclosurecapture-禁用" aria-label="Permalink to “5. 闭包捕获 (benchmarkClosureCapture) [禁用]”">​</a></h3><p><strong>测试目标</strong>：闭包变量捕获和访问性能</p><p><strong>状态</strong>：等待修复 Lambda JSON 格式</p><p><strong>性能目标</strong>：&lt; 15 ms/iteration (500 iterations)</p><h3 id="_6-模式匹配-benchmarkpatternmatching-禁用" tabindex="-1">6. 模式匹配 (<code>benchmarkPatternMatching</code>) [禁用] <a class="header-anchor" href="#_6-模式匹配-benchmarkpatternmatching-禁用" aria-label="Permalink to “6. 模式匹配 (benchmarkPatternMatching) [禁用]”">​</a></h3><p><strong>测试目标</strong>：Match 表达式性能</p><p><strong>状态</strong>：等待修复 Match JSON 格式（使用 <code>expr</code> 而非 <code>scrutinee</code>，Case body 不应包装在 Block 中）</p><p><strong>性能目标</strong>：&lt; 2 ms/iteration (5000 iterations)</p><h2 id="运行基准测试" tabindex="-1">运行基准测试 <a class="header-anchor" href="#运行基准测试" aria-label="Permalink to “运行基准测试”">​</a></h2><h3 id="单独运行基准测试" tabindex="-1">单独运行基准测试 <a class="header-anchor" href="#单独运行基准测试" aria-label="Permalink to “单独运行基准测试”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:test</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --tests</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;BenchmarkTest&quot;</span></span></code></pre></div><h3 id="运行特定基准" tabindex="-1">运行特定基准 <a class="header-anchor" href="#运行特定基准" aria-label="Permalink to “运行特定基准”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:test</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --tests</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;BenchmarkTest.benchmarkFactorial&quot;</span></span></code></pre></div><h3 id="完整测试套件-包括基准测试" tabindex="-1">完整测试套件（包括基准测试） <a class="header-anchor" href="#完整测试套件-包括基准测试" aria-label="Permalink to “完整测试套件（包括基准测试）”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:test</span></span></code></pre></div><h2 id="性能分析" tabindex="-1">性能分析 <a class="header-anchor" href="#性能分析" aria-label="Permalink to “性能分析”">​</a></h2><h3 id="当前性能特征" tabindex="-1">当前性能特征 <a class="header-anchor" href="#当前性能特征" aria-label="Permalink to “当前性能特征”">​</a></h3><ol><li><strong>简单操作非常快速</strong>：算术计算在 0.002 ms/iteration</li><li><strong>递归性能良好</strong>：阶乘 10 在 0.026 ms，fib(15) 在 2.2 ms</li><li><strong>解释模式限制</strong>：所有测试在无 GraalVM JIT 的环境下运行</li></ol><h3 id="性能优化建议" tabindex="-1">性能优化建议 <a class="header-anchor" href="#性能优化建议" aria-label="Permalink to “性能优化建议”">​</a></h3><ol><li><strong>启用 GraalVM</strong>：使用 GraalVM JDK 可大幅提升性能（预计 10-100x）</li><li><strong>Frame 优化</strong>：已实现 Frame slot tracking 优化变量访问</li><li><strong>DSL 类型特化</strong>：已为 NameNode/LetNode/SetNode 启用 Truffle DSL</li></ol><h3 id="性能退化检测" tabindex="-1">性能退化检测 <a class="header-anchor" href="#性能退化检测" aria-label="Permalink to “性能退化检测”">​</a></h3><p>基准测试在 CI 中运行，如果性能超过阈值会导致测试失败：</p><ul><li>✅ <code>benchmarkArithmetic</code>: 0.002 ms &lt; 1.0 ms (通过)</li><li>✅ <code>benchmarkFactorial</code>: 0.027 ms &lt; 10.0 ms (通过)</li><li>✅ <code>benchmarkFibonacci</code>: 2.21 ms &lt; 50.0 ms (通过)</li></ul><h2 id="与其他后端的性能对比" tabindex="-1">与其他后端的性能对比 <a class="header-anchor" href="#与其他后端的性能对比" aria-label="Permalink to “与其他后端的性能对比”">​</a></h2><table tabindex="0"><thead><tr><th>后端</th><th>阶乘(10)</th><th>斐波那契(15)</th><th>算术</th><th>备注</th></tr></thead><tbody><tr><td>Truffle (解释)</td><td>0.026 ms</td><td>2.2 ms</td><td>0.002 ms</td><td>当前实现</td></tr><tr><td>TypeScript</td><td>TBD</td><td>TBD</td><td>TBD</td><td>待测量</td></tr><tr><td>Java</td><td>TBD</td><td>TBD</td><td>TBD</td><td>待测量</td></tr><tr><td>Truffle (GraalVM)</td><td>预计 0.003 ms</td><td>预计 0.2 ms</td><td>预计 0.0002 ms</td><td>理论值</td></tr></tbody></table><h2 id="基准测试代码位置" tabindex="-1">基准测试代码位置 <a class="header-anchor" href="#基准测试代码位置" aria-label="Permalink to “基准测试代码位置”">​</a></h2><ul><li><strong>测试文件</strong>：<code>aster-truffle/src/test/java/aster/truffle/BenchmarkTest.java</code></li><li><strong>文档</strong>：<code>docs/truffle-performance-benchmarks.md</code></li><li><strong>CI 集成</strong>：<code>package.json</code> - <code>npm run ci</code> 包含 <code>npm run truffle:test</code></li></ul><h2 id="未来工作" tabindex="-1">未来工作 <a class="header-anchor" href="#未来工作" aria-label="Permalink to “未来工作”">​</a></h2><h3 id="短期目标" tabindex="-1">短期目标 <a class="header-anchor" href="#短期目标" aria-label="Permalink to “短期目标”">​</a></h3><ol><li>✅ 建立基础基准测试（已完成）</li><li>⏳ 修复 Lambda/Closure/Match 基准测试的 JSON 格式</li><li>⏳ 添加更多场景覆盖： <ul><li>数据结构操作（Map/List 访问）</li><li>字符串操作</li><li>异常处理性能</li></ul></li></ol><h3 id="长期目标" tabindex="-1">长期目标 <a class="header-anchor" href="#长期目标" aria-label="Permalink to “长期目标”">​</a></h3><ol><li>启用 GraalVM 原生编译的基准测试</li><li>建立性能回归追踪系统</li><li>与其他语言/后端的性能对比</li><li>优化热点路径（基于 profiler 数据）</li></ol><h2 id="相关文档" tabindex="-1">相关文档 <a class="header-anchor" href="#相关文档" aria-label="Permalink to “相关文档”">​</a></h2><ul><li><a href="./truffle-backend-limitations.html">Truffle Backend Limitations</a> - Truffle 后端功能限制</li><li><a href="./testing.html">Testing Guide</a> - 完整测试指南</li></ul><h2 id="更新日志" tabindex="-1">更新日志 <a class="header-anchor" href="#更新日志" aria-label="Permalink to “更新日志”">​</a></h2><ul><li><strong>2025-11-03</strong>: 初始版本，包含 3 个活跃基准测试 <ul><li>简单算术计算</li><li>递归阶乘</li><li>递归斐波那契</li></ul></li><li><strong>2025-11-03</strong>: 添加 3 个禁用的基准测试（待 JSON 格式修复） <ul><li>Lambda 调用</li><li>闭包捕获</li><li>模式匹配</li></ul></li></ul>`,78)])])}const g=a(e,[["render",n]]);export{c as __pageData,g as default};
