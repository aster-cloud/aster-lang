import{_ as i,c as a,o as n,aj as t}from"./chunks/framework.Bz2R-749.js";const o=JSON.parse('{"title":"Aster Native Image 故障排查指南","description":"","frontmatter":{},"headers":[],"relativePath":"native-image/troubleshooting.md","filePath":"native-image/troubleshooting.md"}'),l={name:"native-image/troubleshooting.md"};function e(h,s,p,k,r,g){return n(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="aster-native-image-故障排查指南" tabindex="-1">Aster Native Image 故障排查指南 <a class="header-anchor" href="#aster-native-image-故障排查指南" aria-label="Permalink to “Aster Native Image 故障排查指南”">​</a></h1><p>本文档提供 Aster Native Image 常见问题的诊断和解决方案。</p><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to “目录”">​</a></h2><ul><li><a href="#编译问题">编译问题</a></li><li><a href="#运行时问题">运行时问题</a></li><li><a href="#性能问题">性能问题</a></li><li><a href="#pgo-相关问题">PGO 相关问题</a></li><li><a href="#调试技巧">调试技巧</a></li></ul><h2 id="编译问题" tabindex="-1">编译问题 <a class="header-anchor" href="#编译问题" aria-label="Permalink to “编译问题”">​</a></h2><h3 id="_1-classnotfoundexception-或-nosuchmethodexception" tabindex="-1">1. ClassNotFoundException 或 NoSuchMethodException <a class="header-anchor" href="#_1-classnotfoundexception-或-nosuchmethodexception" aria-label="Permalink to “1. ClassNotFoundException 或 NoSuchMethodException”">​</a></h3><p><strong>症状</strong>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Error: Class com.example.SomeClass not found</span></span>
<span class="line"><span>或</span></span>
<span class="line"><span>Error: Method &#39;methodName&#39; not found</span></span></code></pre></div><p><strong>原因</strong>: 反射配置不完整,Native Image 在构建时无法发现通过反射访问的类或方法。</p><p><strong>解决方法</strong>:</p><p><strong>步骤 1</strong>: 检查反射配置文件</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster-truffle/src/main/resources/META-INF/native-image/reflect-config.json</span></span></code></pre></div><p><strong>步骤 2</strong>: 使用 Native Image Agent 重新生成配置</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 运行代表性工作负载以收集元数据</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> generateNativeConfig</span></span></code></pre></div><p>这会自动执行:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -agentlib:native-image-agent=config-output-dir=aster-truffle/src/main/resources/META-INF/native-image</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster-truffle/build/libs/aster-truffle.jar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  benchmarks/core/fibonacci_20_core.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  benchmarks/core/factorial_12_core.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  benchmarks/core/list_map_1000_core.json</span></span></code></pre></div><p><strong>步骤 3</strong>: 手动添加缺失的类 (如果 Agent 未检测到)</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;com.example.SomeClass&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;allDeclaredConstructors&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;allPublicConstructors&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;allDeclaredMethods&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;allPublicMethods&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;allDeclaredFields&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;allPublicFields&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>步骤 4</strong>: 重新编译</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --no-configuration-cache</span></span></code></pre></div><h3 id="_2-资源文件找不到" tabindex="-1">2. 资源文件找不到 <a class="header-anchor" href="#_2-资源文件找不到" aria-label="Permalink to “2. 资源文件找不到”">​</a></h3><p><strong>症状</strong>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Error: Resource &#39;config/settings.json&#39; not found</span></span>
<span class="line"><span>或</span></span>
<span class="line"><span>java.io.FileNotFoundException: /path/to/resource</span></span></code></pre></div><p><strong>原因</strong>: 资源配置缺失,Native Image 默认不包含所有资源文件。</p><p><strong>解决方法</strong>:</p><p><strong>步骤 1</strong>: 检查资源配置</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster-truffle/src/main/resources/META-INF/native-image/resource-config.json</span></span></code></pre></div><p><strong>步骤 2</strong>: 添加缺失的资源模式</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;resources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;includes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;pattern&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;config/.*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.json&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;pattern&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;templates/.*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.aster&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;pattern&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;META-INF/.*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>步骤 3</strong>: 确保资源在 <code>src/main/resources/</code> 目录下</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -R</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster-truffle/src/main/resources/</span></span></code></pre></div><p><strong>步骤 4</strong>: 重新编译并验证</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --no-configuration-cache</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> your-test.json</span></span></code></pre></div><h3 id="_3-编译时间过长-10分钟" tabindex="-1">3. 编译时间过长 (&gt; 10分钟) <a class="header-anchor" href="#_3-编译时间过长-10分钟" aria-label="Permalink to “3. 编译时间过长 (&gt; 10分钟)”">​</a></h3><p><strong>症状</strong>: 编译超过 10 分钟仍未完成。</p><p><strong>正常编译时间</strong>:</p><ul><li>Baseline: 2-5 分钟</li><li>PGO Instrumented: 1-2 分钟</li><li>PGO Optimized: &lt; 1 分钟</li></ul><p><strong>可能原因</strong>:</p><p><strong>原因 1: 内存不足导致 GC 频繁</strong></p><p>检查编译日志中的 GC 时间:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 正常: GC 时间 &lt; 10% 总时间</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 示例: 2.6s (6.8% of total time) in 546 GCs</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 异常: GC 时间 &gt; 20% 总时间</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 示例: 45.2s (35.4% of total time) in 2341 GCs</span></span></code></pre></div><p><strong>解决方法</strong>: 增加 JVM 堆内存</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JAVA_OPTS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-Xmx16g&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --no-configuration-cache</span></span></code></pre></div><p><strong>原因 2: CPU 性能限制</strong></p><p>Native Image 编译默认使用所有可用 CPU 核心:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 编译日志显示:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 10 thread(s) (100.0% of 10 available processor(s))</span></span></code></pre></div><p><strong>解决方法</strong>: 限制核心数以释放资源</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 在 build.gradle.kts 中添加:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">buildArgs.add(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;-J-XX:ActiveProcessorCount=4&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><strong>原因 3: 磁盘 I/O 瓶颈</strong></p><p><strong>解决方法</strong>: 将 <code>build/</code> 目录移至 SSD</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 创建符号链接到 SSD</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /path/to/ssd/aster-build</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ln</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /path/to/ssd/aster-build</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster-truffle/build</span></span></code></pre></div><h3 id="_4-编译失败-unsupported-features" tabindex="-1">4. 编译失败: &quot;Unsupported features&quot; <a class="header-anchor" href="#_4-编译失败-unsupported-features" aria-label="Permalink to “4. 编译失败: &quot;Unsupported features&quot;”">​</a></h3><p><strong>症状</strong>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Error: Unsupported features in 3 methods</span></span>
<span class="line"><span>Detailed message:</span></span>
<span class="line"><span>Error: Detected a MBean server in the image heap...</span></span></code></pre></div><p><strong>原因</strong>: 使用了 Native Image 不支持的 Java 特性。</p><p><strong>常见不支持特性</strong>:</p><ul><li>动态类加载 (<code>Class.forName</code> 未配置)</li><li>JMX / MBeans</li><li>JVMTI / Agent</li><li>InvokeDynamic (部分场景)</li></ul><p><strong>解决方法</strong>:</p><p><strong>步骤 1</strong>: 检查错误日志获取具体类和方法</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看完整错误信息</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -100</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/native-image-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.log</span></span></code></pre></div><p><strong>步骤 2</strong>: 选择解决策略</p><p><strong>策略 A: 添加到反射配置</strong> (如果是反射问题)</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;com.example.ProblematicClass&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;allDeclaredConstructors&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>策略 B: 推迟到运行时报告</strong> (如果特性不影响核心功能)</p><div class="language-kotlin"><button title="Copy Code" class="copy"></button><span class="lang">kotlin</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 在 build.gradle.kts 中添加:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-H:+ReportUnsupportedElementsAtRuntime&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><strong>策略 C: 移除或替换不支持的代码</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 避免:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Class&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; clazz </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Class.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dynamicClassName);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 改为:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Class&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; clazz </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KnownClass.class;</span></span></code></pre></div><h3 id="_5-pgo-profile-文件路径错误" tabindex="-1">5. PGO Profile 文件路径错误 <a class="header-anchor" href="#_5-pgo-profile-文件路径错误" aria-label="Permalink to “5. PGO Profile 文件路径错误”">​</a></h3><p><strong>症状</strong>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Error: Cannot load profile default.iprof</span></span>
<span class="line"><span>(reason: java.io.FileNotFoundException: default.iprof (No such file or directory))</span></span></code></pre></div><p><strong>原因</strong>: 使用了相对路径,但 Native Image 编译器从项目根目录执行。</p><p><strong>解决方法</strong>:</p><p><strong>使用绝对路径</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 错误:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -PpgoMode=default.iprof</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 正确:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -PpgoMode=/Users/your-username/aster-lang/default.iprof</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 或使用 $(pwd):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -PpgoMode=$(pwd)/default.iprof</span></span></code></pre></div><p><strong>验证文件存在</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -lh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default.iprof</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 应显示: -rw-r--r--  7.2M  default.iprof</span></span></code></pre></div><h2 id="运行时问题" tabindex="-1">运行时问题 <a class="header-anchor" href="#运行时问题" aria-label="Permalink to “运行时问题”">​</a></h2><h3 id="_6-truffle-fallback-runtime-警告" tabindex="-1">6. Truffle Fallback Runtime 警告 <a class="header-anchor" href="#_6-truffle-fallback-runtime-警告" aria-label="Permalink to “6. Truffle Fallback Runtime 警告”">​</a></h3><p><strong>症状</strong>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>[engine] WARNING: The polyglot engine uses a fallback runtime that does not support</span></span>
<span class="line"><span>runtime compilation to native code.</span></span>
<span class="line"><span>The fallback runtime was explicitly selected using the -Dtruffle.TruffleRuntime option.</span></span></code></pre></div><p><strong>影响</strong>:</p><ul><li>✅ 程序可以正常运行</li><li>❌ 峰值性能低于 JVM (解释器 vs JIT)</li><li>❌ PGO 无法优化执行性能</li></ul><p><strong>当前状态</strong>: 已知限制,需要修复 Truffle runtime 配置。</p><p><strong>临时解决方法</strong>: 无需处理,功能完整,仅影响长时间运行的计算密集任务。</p><p><strong>长期解决方法</strong> (待实施):</p><ol><li>移除显式 <code>-Dtruffle.TruffleRuntime</code> 配置</li><li>确保 Graal Compiler 可用</li><li>重新编译并验证性能提升</li></ol><h3 id="_7-启动时崩溃-segmentation-fault" tabindex="-1">7. 启动时崩溃: Segmentation Fault <a class="header-anchor" href="#_7-启动时崩溃-segmentation-fault" aria-label="Permalink to “7. 启动时崩溃: Segmentation Fault”">​</a></h3><p><strong>症状</strong>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Segmentation fault (core dumped)</span></span>
<span class="line"><span>或</span></span>
<span class="line"><span>Bus error</span></span></code></pre></div><p><strong>可能原因</strong>:</p><p><strong>原因 1: 静态初始化器问题</strong></p><p>某些类在 build-time 初始化,但依赖 runtime 状态。</p><p><strong>解决方法</strong>: 调整初始化时机</p><div class="language-kotlin"><button title="Copy Code" class="copy"></button><span class="lang">kotlin</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 在 build.gradle.kts 中修改:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--initialize-at-build-time=&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 默认 runtime 初始化</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--initialize-at-build-time=com.safe.package&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 仅安全的包</span></span></code></pre></div><p><strong>原因 2: 本地库 (JNI) 不兼容</strong></p><p><strong>解决方法</strong>: 检查是否使用了本地库</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查找 JNI 依赖</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;System.loadLibrary&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster-truffle/src/</span></span></code></pre></div><h3 id="_8-outofmemoryerror-在运行时" tabindex="-1">8. OutOfMemoryError 在运行时 <a class="header-anchor" href="#_8-outofmemoryerror-在运行时" aria-label="Permalink to “8. OutOfMemoryError 在运行时”">​</a></h3><p><strong>症状</strong>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space</span></span></code></pre></div><p><strong>原因</strong>: Native Image 堆内存配置不足 (默认自动调整,但某些场景可能不足)。</p><p><strong>解决方法</strong>:</p><p><strong>步骤 1</strong>: 检查当前内存使用</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/bin/time</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -l</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> your-program.json</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看: maximum resident set size</span></span></code></pre></div><p><strong>步骤 2</strong>: 增加堆内存 (如果确实需要)</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Native Image 运行时参数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -XX:MaxHeapSize=512m</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  your-program.json</span></span></code></pre></div><p><strong>步骤 3</strong>: 优化程序避免内存泄漏</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用 profiler 分析</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -Daster.profiler.enabled=true</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  your-program.json</span></span></code></pre></div><h2 id="性能问题" tabindex="-1">性能问题 <a class="header-anchor" href="#性能问题" aria-label="Permalink to “性能问题”">​</a></h2><h3 id="_9-启动时间超过-50ms" tabindex="-1">9. 启动时间超过 50ms <a class="header-anchor" href="#_9-启动时间超过-50ms" aria-label="Permalink to “9. 启动时间超过 50ms”">​</a></h3><p><strong>症状</strong>: 启动时间 &gt; 50ms,不符合预期。</p><p><strong>正常启动时间</strong>:</p><ul><li>Baseline: ~20ms</li><li>PGO: ~32ms (第一次运行可能 ~66ms)</li></ul><p><strong>诊断步骤</strong>:</p><p><strong>步骤 1</strong>: 多次测试排除系统开销</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1..5}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ./aster-truffle/build/native/nativeCompile/aster benchmarks/core/fibonacci_20_core.json</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span></code></pre></div><p><strong>步骤 2</strong>: 检查文件 I/O</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用 strace (Linux) 或 dtruss (macOS) 分析系统调用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strace</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> your-program.json</span></span></code></pre></div><p><strong>步骤 3</strong>: 检查是否有静态初始化器</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 在编译日志中查找:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;clinit&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/native-image-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.log</span></span></code></pre></div><p><strong>解决方法</strong>: 移动耗时初始化到懒加载。</p><h3 id="_10-峰值性能低于-jvm" tabindex="-1">10. 峰值性能低于 JVM <a class="header-anchor" href="#_10-峰值性能低于-jvm" aria-label="Permalink to “10. 峰值性能低于 JVM”">​</a></h3><p><strong>症状</strong>: 长时间运行的计算任务比 JVM 慢 5-10x。</p><p><strong>原因</strong>: 当前运行在 Truffle fallback runtime (解释器模式)。</p><p><strong>预期行为</strong>:</p><ul><li>Native Image 优势: 启动速度、内存占用</li><li>JVM 优势: 峰值吞吐量 (JIT 优化)</li></ul><p><strong>适用场景</strong>:</p><ul><li>✅ Native Image: 短生命周期任务 (&lt; 1分钟)</li><li>✅ JVM: 长时间运行任务 (&gt; 5分钟)</li></ul><p><strong>解决方法</strong>: 根据场景选择合适版本</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 短任务: 使用 Native Image</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> script.json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 长任务: 使用 JVM</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">java</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aster-truffle/build/libs/aster-truffle.jar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> script.json</span></span></code></pre></div><h2 id="pgo-相关问题" tabindex="-1">PGO 相关问题 <a class="header-anchor" href="#pgo-相关问题" aria-label="Permalink to “PGO 相关问题”">​</a></h2><h3 id="_11-pgo-profile-数据不完整" tabindex="-1">11. PGO Profile 数据不完整 <a class="header-anchor" href="#_11-pgo-profile-数据不完整" aria-label="Permalink to “11. PGO Profile 数据不完整”">​</a></h3><p><strong>症状</strong>: PGO 优化效果不明显,或二进制大小没有显著减少。</p><p><strong>原因</strong>: Profile 收集时未覆盖关键代码路径。</p><p><strong>解决方法</strong>:</p><p><strong>步骤 1</strong>: 使用生产负载收集 Profile</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 不仅仅是基准测试</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> real-world-workload-1.json</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> real-world-workload-2.json</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> real-world-workload-3.json</span></span></code></pre></div><p><strong>步骤 2</strong>: 检查 Profile 文件大小</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -lh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default.iprof</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 应为 5-10 MB,如果 &lt; 1MB 说明数据不足</span></span></code></pre></div><p><strong>步骤 3</strong>: 合并多个 Profile</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># GraalVM Native Image 自动合并同名 .iprof 文件</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 只需多次运行 instrumented 版本</span></span></code></pre></div><h3 id="_12-pgo-编译后性能反而下降" tabindex="-1">12. PGO 编译后性能反而下降 <a class="header-anchor" href="#_12-pgo-编译后性能反而下降" aria-label="Permalink to “12. PGO 编译后性能反而下降”">​</a></h3><p><strong>症状</strong>: PGO 优化版本比 baseline 慢。</p><p><strong>可能原因</strong>:</p><p><strong>原因 1: Profile 数据不匹配实际工作负载</strong></p><p>PGO 基于 profile 优化热路径,但如果实际工作负载不同,可能误优化。</p><p><strong>解决方法</strong>: 使用匹配的 profile 数据</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 删除旧 profile</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default.iprof</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用实际工作负载重新收集</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -PpgoMode=instrument</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --no-configuration-cache</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> actual-workload.json</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -PpgoMode=$(pwd)/default.iprof</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --no-configuration-cache</span></span></code></pre></div><p><strong>原因 2: Truffle fallback runtime 限制</strong></p><p>当前 PGO 主要优化二进制大小,性能优化受限于解释器模式。</p><p><strong>解决方法</strong>: 接受当前限制,等待 Truffle runtime 修复。</p><h2 id="调试技巧" tabindex="-1">调试技巧 <a class="header-anchor" href="#调试技巧" aria-label="Permalink to “调试技巧”">​</a></h2><h3 id="启用详细日志" tabindex="-1">启用详细日志 <a class="header-anchor" href="#启用详细日志" aria-label="Permalink to “启用详细日志”">​</a></h3><p><strong>编译时详细输出</strong>:</p><div class="language-kotlin"><button title="Copy Code" class="copy"></button><span class="lang">kotlin</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 在 build.gradle.kts 中添加:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--verbose&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-H:+PrintAnalysisStatistics&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-H:+PrintImageObjectTree&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><strong>运行时调试</strong>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Truffle 日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --log.level=FINE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  your-program.json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># GC 日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./aster-truffle/build/native/nativeCompile/aster</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -XX:+PrintGC</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -XX:+VerboseGC</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  your-program.json</span></span></code></pre></div><h3 id="生成诊断报告" tabindex="-1">生成诊断报告 <a class="header-anchor" href="#生成诊断报告" aria-label="Permalink to “生成诊断报告”">​</a></h3><p><strong>Build Report</strong>:</p><div class="language-kotlin"><button title="Copy Code" class="copy"></button><span class="lang">kotlin</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 在 build.gradle.kts 中添加:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-H:+BuildReport&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buildArgs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-H:BuildReportFile=/tmp/build-report.html&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>查看报告:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">open</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/build-report.html</span></span></code></pre></div><h3 id="使用-gdb-调试-linux" tabindex="-1">使用 GDB 调试 (Linux) <a class="header-anchor" href="#使用-gdb-调试-linux" aria-label="Permalink to “使用 GDB 调试 (Linux)”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 编译带调试信息的版本</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-truffle:nativeCompile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -PbuildArgs=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-g&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --no-configuration-cache</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用 GDB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gdb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./aster-truffle/build/native/nativeCompile/aster</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gdb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benchmarks/core/fibonacci_20_core.json</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gdb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bt</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 查看堆栈</span></span></code></pre></div><h3 id="使用-lldb-调试-macos" tabindex="-1">使用 LLDB 调试 (macOS) <a class="header-anchor" href="#使用-lldb-调试-macos" aria-label="Permalink to “使用 LLDB 调试 (macOS)”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lldb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./aster-truffle/build/native/nativeCompile/aster</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lldb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benchmarks/core/fibonacci_20_core.json</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lldb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bt</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 查看堆栈</span></span></code></pre></div><h2 id="获取帮助" tabindex="-1">获取帮助 <a class="header-anchor" href="#获取帮助" aria-label="Permalink to “获取帮助”">​</a></h2><p>如果以上方法无法解决问题:</p><ol><li><strong>检查 GraalVM 官方文档</strong>: <a href="https://www.graalvm.org/latest/reference-manual/native-image/" target="_blank" rel="noreferrer">https://www.graalvm.org/latest/reference-manual/native-image/</a></li><li><strong>查看编译日志</strong>: <code>/tmp/native-image-*.log</code></li><li><strong>提交 Issue</strong>: 包含完整错误信息、编译日志和复现步骤</li><li><strong>GraalVM Slack</strong>: <a href="https://graalvm.slack.com/" target="_blank" rel="noreferrer">https://graalvm.slack.com/</a> (#native-image 频道)</li></ol><h2 id="相关文档" tabindex="-1">相关文档 <a class="header-anchor" href="#相关文档" aria-label="Permalink to “相关文档”">​</a></h2><ul><li><a href="./README.html">快速开始</a></li><li><a href="./build-guide.html">详细构建指南</a></li><li><a href="./performance-comparison.html">性能对比</a></li><li><a href="./limitations.html">限制说明</a></li></ul>`,171)])])}const c=i(l,[["render",e]]);export{o as __pageData,c as default};
