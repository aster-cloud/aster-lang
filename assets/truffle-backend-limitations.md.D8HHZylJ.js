import{_ as a,c as s,o as t,aj as e}from"./chunks/framework.Bz2R-749.js";const g=JSON.parse('{"title":"Truffle 后端限制说明","description":"","frontmatter":{},"headers":[],"relativePath":"truffle-backend-limitations.md","filePath":"truffle-backend-limitations.md"}'),l={name:"truffle-backend-limitations.md"};function r(n,i,h,p,d,o){return t(),s("div",null,[...i[0]||(i[0]=[e(`<h1 id="truffle-后端限制说明" tabindex="-1">Truffle 后端限制说明 <a class="header-anchor" href="#truffle-后端限制说明" aria-label="Permalink to “Truffle 后端限制说明”">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to “概述”">​</a></h2><p>Aster 语言的 Truffle 后端（<code>aster-truffle</code>）是基于 GraalVM Truffle 框架实现的高性能解释器，专注于 JIT 编译优化和原生性能。由于 Truffle AST interpreter 的架构特性，某些语言特性在该后端中不可用或受限。</p><h2 id="异步操作限制" tabindex="-1">异步操作限制 <a class="header-anchor" href="#异步操作限制" aria-label="Permalink to “异步操作限制”">​</a></h2><h3 id="不支持的特性" tabindex="-1">不支持的特性 <a class="header-anchor" href="#不支持的特性" aria-label="Permalink to “不支持的特性”">​</a></h3><p>Truffle 后端<strong>不支持</strong>以下异步操作：</p><ol><li><p><strong>Await 表达式</strong></p><div class="language-aster"><button title="Copy Code" class="copy"></button><span class="lang">aster</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Let result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Await </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">someAsyncFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 不支持</span></span></code></pre></div></li><li><p><strong>Start 语句</strong>（启动异步任务）</p><div class="language-aster"><button title="Copy Code" class="copy"></button><span class="lang">aster</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Start task </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 不支持</span></span></code></pre></div></li><li><p><strong>Wait 语句</strong>（等待异步任务）</p><div class="language-aster"><button title="Copy Code" class="copy"></button><span class="lang">aster</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Wait for task  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 不支持</span></span></code></pre></div></li></ol><h3 id="错误信息" tabindex="-1">错误信息 <a class="header-anchor" href="#错误信息" aria-label="Permalink to “错误信息”">​</a></h3><p>尝试执行包含异步操作的代码时，Truffle 后端会抛出 <code>UnsupportedOperationException</code>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>java.lang.UnsupportedOperationException: 异步操作 (await/start/wait) 在 Truffle 后端尚未支持。</span></span>
<span class="line"><span>请使用 Java 或 TypeScript 后端运行异步代码。</span></span></code></pre></div><h3 id="技术原因" tabindex="-1">技术原因 <a class="header-anchor" href="#技术原因" aria-label="Permalink to “技术原因”">​</a></h3><h4 id="_1-ast-interpreter-架构限制" tabindex="-1">1. AST Interpreter 架构限制 <a class="header-anchor" href="#_1-ast-interpreter-架构限制" aria-label="Permalink to “1. AST Interpreter 架构限制”">​</a></h4><p>Truffle 使用 AST interpreter，节点的 <code>execute()</code> 方法是同步的：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(VirtualFrame frame) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 必须同步返回结果，无法暂停/恢复</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>阻塞等待异步结果会：</p><ul><li>破坏 Truffle 的执行模型</li><li>触发 JIT 去优化（deoptimization）</li><li>严重影响性能</li></ul><h4 id="_2-continuation-支持限制" tabindex="-1">2. Continuation 支持限制 <a class="header-anchor" href="#_2-continuation-支持限制" aria-label="Permalink to “2. Continuation 支持限制”">​</a></h4><p>GraalVM Truffle 提供的 Continuation 支持（类似协程）仅在 <strong>Bytecode DSL</strong> 中可用：</p><ul><li>aster-truffle 使用 <strong>AST interpreter</strong>，不是 Bytecode DSL</li><li>重构为 Bytecode DSL 工作量巨大（需要完全重写）</li></ul><h4 id="_3-virtual-threads-不支持" tabindex="-1">3. Virtual Threads 不支持 <a class="header-anchor" href="#_3-virtual-threads-不支持" aria-label="Permalink to “3. Virtual Threads 不支持”">​</a></h4><p>Java 21+ 的虚拟线程在 native-image + JIT 模式下不可用：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>UnsupportedOperationException: Virtual threads are not supported together</span></span>
<span class="line"><span>with Truffle JIT compilation.</span></span></code></pre></div><h3 id="替代方案" tabindex="-1">替代方案 <a class="header-anchor" href="#替代方案" aria-label="Permalink to “替代方案”">​</a></h3><p>如果你的 Aster 代码需要异步操作，请使用以下后端：</p><h4 id="✅-java-后端-推荐用于生产" tabindex="-1">✅ Java 后端（推荐用于生产） <a class="header-anchor" href="#✅-java-后端-推荐用于生产" aria-label="Permalink to “✅ Java 后端（推荐用于生产）”">​</a></h4><p>使用 <code>aster-runtime</code> 的 CompletableFuture 实现：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ASTER_COMPILER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">java</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ./aster-lang-cli/build/install/aster-lang-cli/bin/aster-lang-cli</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> compile</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">file.jso</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p><strong>特点</strong>：</p><ul><li>完整支持 async/await 语义</li><li>使用线程池实现真正的并发</li><li>适合 I/O 密集型任务</li></ul><h4 id="✅-typescript-后端-推荐用于开发" tabindex="-1">✅ TypeScript 后端（推荐用于开发） <a class="header-anchor" href="#✅-typescript-后端-推荐用于开发" aria-label="Permalink to “✅ TypeScript 后端（推荐用于开发）”">​</a></h4><p>使用 JavaScript 原生 async/await：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ASTER_COMPILER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">typescript</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ./aster-lang-cli/build/install/aster-lang-cli/bin/aster-lang-cli</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> compile</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">file.jso</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p><strong>特点</strong>：</p><ul><li>完整支持 async/await 语义</li><li>使用 event loop 实现非阻塞 I/O</li><li>快速原型开发</li></ul><h3 id="truffle-后端的优势" tabindex="-1">Truffle 后端的优势 <a class="header-anchor" href="#truffle-后端的优势" aria-label="Permalink to “Truffle 后端的优势”">​</a></h3><p>虽然 Truffle 后端不支持异步，但它在以下场景中表现出色：</p><ol><li><p><strong>CPU 密集型计算</strong></p><ul><li>JIT 编译优化</li><li>接近原生代码性能</li><li>适合数值计算、算法实现</li></ul></li><li><p><strong>性能基准测试</strong></p><ul><li>验证语言核心性能</li><li>测试 JIT 优化效果</li><li>性能瓶颈分析</li></ul></li><li><p><strong>原生集成</strong></p><ul><li>GraalVM native-image 支持</li><li>快速启动时间</li><li>低内存占用</li></ul></li></ol><h3 id="未来展望" tabindex="-1">未来展望 <a class="header-anchor" href="#未来展望" aria-label="Permalink to “未来展望”">​</a></h3><p>真正支持异步需要以下工作：</p><ol><li><p><strong>重构为 Bytecode DSL</strong>（长期计划）</p><ul><li>完全重写解释器架构</li><li>使用 Truffle Bytecode DSL API</li><li>支持 Continuation 和 yield/resume</li></ul></li><li><p><strong>等待 Truffle 虚拟线程支持</strong>（依赖上游）</p><ul><li>GraalVM 需要解除 native-image + JIT 的虚拟线程限制</li><li>预计在未来版本中支持</li></ul></li></ol><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to “总结”">​</a></h2><table tabindex="0"><thead><tr><th>特性</th><th>Java 后端</th><th>TypeScript 后端</th><th>Truffle 后端</th></tr></thead><tbody><tr><td>async/await</td><td>✅ 完整支持</td><td>✅ 完整支持</td><td>❌ 不支持</td></tr><tr><td>CPU 密集计算</td><td>⭐⭐⭐</td><td>⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>I/O 密集任务</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>❌</td></tr><tr><td>启动速度</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td></tr><tr><td>原生镜像</td><td>⭐⭐⭐</td><td>❌</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table><p><strong>建议</strong>：</p><ul><li>开发阶段使用 TypeScript 后端</li><li>生产部署根据场景选择 Java（异步）或 Truffle（CPU密集）</li><li>性能测试使用 Truffle 后端</li></ul><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to “参考资料”">​</a></h2><ul><li><a href="https://www.graalvm.org/latest/graalvm-as-a-platform/language-implementation-framework/" target="_blank" rel="noreferrer">GraalVM Truffle Documentation</a></li><li><a href="https://www.graalvm.org/latest/graalvm-as-a-platform/language-implementation-framework/Safepoint/" target="_blank" rel="noreferrer">Truffle Safepoint Tutorial</a></li><li><a href="https://www.graalvm.org/truffle/javadoc/com/oracle/truffle/api/bytecode/ContinuationRootNode.html" target="_blank" rel="noreferrer">Bytecode DSL Continuation API</a></li></ul>`,46)])])}const c=a(l,[["render",r]]);export{g as __pageData,c as default};
