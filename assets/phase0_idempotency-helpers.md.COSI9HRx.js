import{_ as i,c as a,o as n,aj as e}from"./chunks/framework.Bz2R-749.js";const o=JSON.parse('{"title":"幂等性辅助工具","description":"","frontmatter":{},"headers":[],"relativePath":"phase0/idempotency-helpers.md","filePath":"phase0/idempotency-helpers.md"}'),l={name:"phase0/idempotency-helpers.md"};function t(p,s,h,k,r,d){return n(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="幂等性辅助工具" tabindex="-1">幂等性辅助工具 <a class="header-anchor" href="#幂等性辅助工具" aria-label="Permalink to “幂等性辅助工具”">​</a></h1><blockquote><p>更新时间：2025-11-15 21:29 NZST · 执行者：Codex</p></blockquote><h2 id="核心概念" tabindex="-1">核心概念 <a class="header-anchor" href="#核心概念" aria-label="Permalink to “核心概念”">​</a></h2><p><code>IdempotencyKeyManager</code> 负责在高并发环境中原子获取幂等性键，确保同一业务键仅被一个实体处理：</p><ul><li>CDI 场景使用 Quarkus Caffeine Cache（<code>@CacheName(&quot;idempotency-keys&quot;)</code>），操作异步但 <code>tryAcquire</code> 会同步等待结果；</li><li>非 CDI / 测试场景自动退化为 <code>ConcurrentHashMap</code>，保证线程安全；</li><li><code>release()</code> 可在任务提前结束时清理缓存，减少 TTL 等待。</li></ul><h2 id="tryacquire-语义" tabindex="-1">tryAcquire 语义 <a class="header-anchor" href="#tryacquire-语义" aria-label="Permalink to “tryAcquire 语义”">​</a></h2><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Optional</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">String</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tryAcquire</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String key, String entityId, Duration ttl)</span></span></code></pre></div><ul><li><code>Optional.empty()</code>：当前 entity 成功占用幂等性键；</li><li><code>Optional.of(existingEntityId)</code>：键已被其他 entity 占用，调用方应立即返回已有结果或排队；</li><li>参数校验会拒绝 null/负数 TTL，并抛出 <code>IllegalArgumentException</code>。</li></ul><h2 id="ttl-配置" tabindex="-1">TTL 配置 <a class="header-anchor" href="#ttl-配置" aria-label="Permalink to “TTL 配置”">​</a></h2><p>默认值读取自 <code>quarkus-policy-api/src/main/resources/application.properties</code>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>quarkus.cache.caffeine.&quot;idempotency-keys&quot;.maximum-size=10000</span></span>
<span class="line"><span>quarkus.cache.caffeine.&quot;idempotency-keys&quot;.expire-after-write=1h</span></span>
<span class="line"><span>quarkus.cache.redis.idempotency-keys.value-type=java.lang.String</span></span></code></pre></div><ul><li>Caffeine 本地缓存 1 小时自动过期，并限制 10k 个键；</li><li>若启用 Redis 扩展，可通过 <code>quarkus.cache.redis.*</code> 在跨实例间共享幂等性状态；</li><li>TTL 参数传给 <code>tryAcquire</code> 仅用于语义表达（例如 API 返回 <code>Retry-After</code>），实际过期仍由缓存配置控制。</li></ul><h2 id="使用场景" tabindex="-1">使用场景 <a class="header-anchor" href="#使用场景" aria-label="Permalink to “使用场景”">​</a></h2><ol><li><strong>API 幂等性</strong>：REST 请求传入 <code>Idempotency-Key</code> 请求头，使用 <code>workflowId</code> 或 <code>entityId</code> 作为 value，确保重复请求读取同一结果。</li><li><strong>Workflow 去重</strong>：<code>PostgresWorkflowRuntime.schedule()</code> 在写入 <code>WorkflowStarted</code> 事件前调用 <code>tryAcquire</code>，防止同一 workflowId 多次插入。</li><li><strong>分布式锁轻量替代</strong>：短期互斥操作（如避免重复生成报告）可以直接使用幂等性键取代完整的锁组件。</li></ol><h2 id="完整示例" tabindex="-1">完整示例 <a class="header-anchor" href="#完整示例" aria-label="Permalink to “完整示例”">​</a></h2><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 正确示例：结合配置与代码完整使用</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// application.properties</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// quarkus.cache.caffeine.&quot;idempotency-keys&quot;.expire-after-write=30m</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// quarkus.cache.caffeine.&quot;idempotency-keys&quot;.maximum-size=20000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.aster.workflow.IdempotencyKeyManager;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jakarta.enterprise.context.ApplicationScoped;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jakarta.inject.Inject;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.Duration;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.Optional;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ApplicationScoped</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReportGenerator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Inject</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    IdempotencyKeyManager keyManager;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">generate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">idempotencyKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">workflowId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Optional&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; occupied </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> keyManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tryAcquire</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(idempotencyKey, workflowId, Duration.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ofMinutes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (occupied.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isPresent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;报告已由 workflow=&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> occupied.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot; 生成&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // …执行耗时逻辑…</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;生成完成&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            keyManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">release</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(idempotencyKey); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 防止键长时间占用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误示例：忽略 tryAcquire 返回值且从不释放</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReportGeneratorLegacy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Inject</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    IdempotencyKeyManager keyManager;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> generate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">idempotencyKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">workflowId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        keyManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tryAcquire</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(idempotencyKey, workflowId, Duration.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ofMinutes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 未检查 Optional 直接执行，会允许多个 workflow 并行，同步写入状态</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 未调用 release 可能导致键一直等到 expire-after-write 才释放，引发堆积</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="性能特性-caffeine-cache" tabindex="-1">性能特性（Caffeine Cache） <a class="header-anchor" href="#性能特性-caffeine-cache" aria-label="Permalink to “性能特性（Caffeine Cache）”">​</a></h2><ul><li><strong>O(1) 原子获取</strong>：<code>cache.get(key, mappingFunction)</code> 在 Caffeine 内部保证并发安全，只有首个线程会执行映射函数，其余线程获得相同结果。</li><li><strong>写入延迟低</strong>：本地内存缓存无需远程 RTT，是处理高频 API 的首选；可根据需要启用 Redis 作为共享层。</li><li><strong>自动淘汰</strong>：<code>maximum-size</code> 与 <code>expire-after-write</code> 双重限制可避免无界增长；Telemetry 可结合 <code>CacheStatisticsRecorder</code> 观察命中率。</li><li><strong>Fallback 安全</strong>：在单元测试或 CLI 工具中没有 CDI 环境时，<code>ConcurrentHashMap</code> 仍可提供线程安全的幂等性语义，只是缺少 TTL，需要显式 <code>release</code>。</li></ul>`,18)])])}const E=i(l,[["render",t]]);export{o as __pageData,E as default};
