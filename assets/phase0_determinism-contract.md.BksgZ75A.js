import{_ as i,c as a,o as n,aj as e}from"./chunks/framework.Bz2R-749.js";const c=JSON.parse('{"title":"确定性契约","description":"","frontmatter":{},"headers":[],"relativePath":"phase0/determinism-contract.md","filePath":"phase0/determinism-contract.md"}'),t={name:"phase0/determinism-contract.md"};function l(h,s,k,p,r,d){return n(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="确定性契约" tabindex="-1">确定性契约 <a class="header-anchor" href="#确定性契约" aria-label="Permalink to “确定性契约”">​</a></h1><blockquote><p>更新时间：2025-11-15 21:29 NZST · 执行者：Codex</p></blockquote><h2 id="背景" tabindex="-1">背景 <a class="header-anchor" href="#背景" aria-label="Permalink to “背景”">​</a></h2><p>Workflow 引擎需要支持 <strong>Workflow Replay</strong> 与 <strong>故障恢复</strong>：当执行失败或重放历史事件时，系统必须保证所有时间、UUID、随机数决策完全一致，以便：</p><ul><li>重放历史事件时生成的结果与原执行一致，便于调试与回放；</li><li>Crash 恢复后可以继续执行剩余步骤，而不会因为新的 UUID、Random 值导致状态漂移；</li><li>多租户环境中，通过 ThreadLocal 隔离避免不同 Workflow 互相污染确定性轨迹。</li></ul><h2 id="facade-模式实现" tabindex="-1">Facade 模式实现 <a class="header-anchor" href="#facade-模式实现" aria-label="Permalink to “Facade 模式实现”">​</a></h2><p><code>DeterminismContext</code> 封装了 <code>ReplayDeterministicClock</code>、<code>ReplayDeterministicUuid</code>、<code>ReplayDeterministicRandom</code> 三个门面：</p><ul><li><strong>clock()</strong>：记录 <code>Instant</code> 序列并在 replay 模式下回放，超过记录数量会报错。</li><li><strong>uuid()</strong>：ThreadLocal 缓存 + 500 条上限，记录 <code>UUID</code> 序列并支持 <code>enterReplayMode()</code>。</li><li><strong>random()</strong>：按 source 名称划分序列，任何随机行为都必须标记 source，避免交叉干扰。</li></ul><p>Workflow 必须只依赖 <code>DeterminismContext</code> 暴露的 API（由运行时注入），禁止直接访问 <code>Instant.now()</code>、<code>UUID.randomUUID()</code> 或 <code>new Random()</code>。</p><h2 id="archunit-自动验证" tabindex="-1">ArchUnit 自动验证 <a class="header-anchor" href="#archunit-自动验证" aria-label="Permalink to “ArchUnit 自动验证”">​</a></h2><p><code>quarkus-policy-api/src/test/java/io/aster/workflow/DeterminismArchTest.java</code> 定义了三条强制规则：</p><ol><li>Workflow 包下的类除 <code>ReplayDeterministicClock</code> 外禁止调用 <code>Instant.now()</code>；</li><li>同理禁止调用 <code>UUID.randomUUID()</code>（排除 <code>ReplayDeterministicUuid</code>）；</li><li>禁止直接构造 <code>java.util.Random</code>，必须通过 <code>DeterminismContext.random()</code> 获取。</li></ol><p>运行 <code>./gradlew :quarkus-policy-api:test --tests DeterminismArchTest</code> 即可捕获违规类与方法行号。</p><h2 id="threadlocal-隔离" tabindex="-1">ThreadLocal 隔离 <a class="header-anchor" href="#threadlocal-隔离" aria-label="Permalink to “ThreadLocal 隔离”">​</a></h2><p><code>PostgresWorkflowRuntime</code> 在调度时会：</p><ul><li>将当前 <code>workflowId</code> 与新的 <code>DeterminismContext</code> 绑定到 <code>ThreadLocal</code>（<code>setCurrentWorkflowId</code>、<code>setDeterminismContext</code>）；</li><li>在 <code>completeWorkflow</code> / <code>failWorkflow</code> 中调用 <code>persistDeterminismSnapshot</code> 将 <code>clock/uuid/random</code> 序列序列化到数据库（JSONB），便于 replay；</li><li>无论成功或失败都会 <code>clearDeterminismContext</code> 与 <code>clearCurrentWorkflowId</code>，避免线程复用时泄漏；</li><li>读取确定性 API 时若 ThreadLocal 尚未绑定，会退化到 <code>globalDeterminismContext</code>，保障调度线程安全。</li></ul><h2 id="使用示例" tabindex="-1">使用示例 <a class="header-anchor" href="#使用示例" aria-label="Permalink to “使用示例”">​</a></h2><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 正确示例：所有非确定性 API 均走 DeterminismContext</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.aster.workflow.DeterminismContext;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.aster.workflow.PostgresWorkflowRuntime;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jakarta.enterprise.context.ApplicationScoped;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jakarta.inject.Inject;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.Instant;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.UUID;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ApplicationScoped</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InvoiceWorkflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Inject</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    PostgresWorkflowRuntime runtime;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        DeterminismContext ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> runtime.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDeterminismContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Instant now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();                  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 记录并可重放</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        UUID requestId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uuid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 记录 UUID 序列</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> shuffle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">random</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextLong</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;routing&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 以 source 名称隔离随机数</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 使用 now/requestId/shuffle 执行业务逻辑……</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 错误示例：直接调用系统时钟与 UUID，ArchUnit 会拦截</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.Instant;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.UUID;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InvoiceWorkflowLegacy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Instant now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Instant.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();          </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 非确定性</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        UUID requestId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UUID.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 非确定性</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 运行时 replay 将无法重现</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="常见陷阱" tabindex="-1">常见陷阱 <a class="header-anchor" href="#常见陷阱" aria-label="Permalink to “常见陷阱”">​</a></h2><table tabindex="0"><thead><tr><th>场景</th><th>问题</th><th>规避方式</th></tr></thead><tbody><tr><td>将 <code>DeterminismContext</code> 缓存为静态字段</td><td>ThreadLocal 会被绕过，导致跨租户污染</td><td>始终从运行时请求上下文 (<code>runtime.getDeterminismContext()</code>)</td></tr><tr><td>在构造函数记录时间</td><td>构造时尚未绑定 ThreadLocal，导致记录落入全局上下文</td><td>将非确定性调用延迟到 <code>execute()</code> 等生命周期内</td></tr><tr><td>未持久化 Determinism 快照</td><td>Crash 后无法 replay 原时间线</td><td>确保调用 <code>PostgresWorkflowRuntime.completeWorkflow/ failWorkflow</code>，内部会持久化序列</td></tr><tr><td>手动清理 ThreadLocal</td><td>误删运行时在 finally 中清理的上下文，导致下一步读取为 null</td><td>除非自定义运行器，否则无需显式调用 <code>clearDeterminismContext</code></td></tr></tbody></table>`,20)])])}const E=i(t,[["render",l]]);export{c as __pageData,E as default};
