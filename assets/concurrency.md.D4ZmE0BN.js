import{_ as i,c as a,o as n,aj as l}from"./chunks/framework.Bz2R-749.js";const g=JSON.parse('{"title":"Workflow 并发执行模型","description":"","frontmatter":{},"headers":[],"relativePath":"concurrency.md","filePath":"concurrency.md"}'),t={name:"concurrency.md"};function e(h,s,p,k,r,d){return n(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="workflow-并发执行模型" tabindex="-1">Workflow 并发执行模型 <a class="header-anchor" href="#workflow-并发执行模型" aria-label="Permalink to “Workflow 并发执行模型”">​</a></h1><p><em>最后更新：2025-11-10 · Phase 2.5 完成</em></p><p>本文档详细说明 Aster Language workflow 的并发执行机制、补偿策略、事件模型和性能考虑。</p><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to “目录”">​</a></h2><ul><li><a href="#并发执行模型">并发执行模型</a></li><li><a href="#补偿策略">补偿策略</a></li><li><a href="#事件模型">事件模型</a></li><li><a href="#性能考虑">性能考虑</a></li><li><a href="#最佳实践">最佳实践</a></li></ul><h2 id="并发执行模型" tabindex="-1">并发执行模型 <a class="header-anchor" href="#并发执行模型" aria-label="Permalink to “并发执行模型”">​</a></h2><h3 id="dag-调度原理" tabindex="-1">DAG 调度原理 <a class="header-anchor" href="#dag-调度原理" aria-label="Permalink to “DAG 调度原理”">​</a></h3><p>Workflow 步骤之间通过 <code>depends on</code> 语法构建有向无环图（DAG），运行时调度器根据依赖关系并发执行所有就绪的步骤。</p><p><strong>依赖图构建流程</strong>：</p><ol><li><strong>编译期</strong>：Parser 解析 <code>depends on [&quot;step_a&quot;, &quot;step_b&quot;]</code> 并写入 Core IR</li><li><strong>运行期</strong>：<code>AsyncTaskRegistry</code> 构建内部 <code>DependencyGraph</code></li><li><strong>调度期</strong>：<code>WorkflowScheduler</code> 批量提交所有就绪任务到线程池</li></ol><p><strong>示例</strong>：</p><div class="language-aster"><button title="Copy Code" class="copy"></button><span class="lang">aster</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">workflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  step </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check_stock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;checked&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  step order_supplier_a depends on [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;check_stock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ordered from A&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  step order_supplier_b depends on [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;check_stock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ordered from B&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  step update_inventory depends on [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order_supplier_a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order_supplier_b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;inventory updated&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span></code></pre></div><p><strong>执行流程</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>check_stock (串行)</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>    ├─→ order_supplier_a ─┐</span></span>
<span class="line"><span>    └─→ order_supplier_b ─┤ (并发执行)</span></span>
<span class="line"><span>                          ↓</span></span>
<span class="line"><span>                   update_inventory (等待两者完成)</span></span></code></pre></div><h3 id="线程池配置" tabindex="-1">线程池配置 <a class="header-anchor" href="#线程池配置" aria-label="Permalink to “线程池配置”">​</a></h3><p><strong>默认配置</strong>：</p><ul><li>线程池大小 = <code>Runtime.getRuntime().availableProcessors()</code> (CPU 核数)</li><li>最小线程数 = 1（确保单核环境可用）</li><li>线程池类型 = <code>Executors.newFixedThreadPool()</code></li></ul><p><strong>单线程模式</strong>：</p><ul><li>当线程池大小为 1 时，调度器自动退化为串行执行</li><li>无 <code>depends on</code> 的旧 workflow 与 Phase 2.0 行为保持一致</li></ul><h3 id="循环检测" tabindex="-1">循环检测 <a class="header-anchor" href="#循环检测" aria-label="Permalink to “循环检测”">​</a></h3><p><strong>编译期检测</strong>：</p><ul><li>TypeChecker 在 workflow 类型检查阶段执行 DFS 检测循环依赖</li><li>检测到循环时报告 <code>WORKFLOW_CIRCULAR_DEPENDENCY</code> 错误</li></ul><p><strong>运行期检测</strong>：</p><ul><li><code>DependencyGraph.addTask()</code> 执行 DFS 验证</li><li>发现循环时抛出 <code>IllegalArgumentException(&quot;Circular dependency detected ...&quot;)</code></li></ul><p><strong>死锁检测</strong>：</p><ul><li>若所有任务未完成但没有就绪节点，判定为死锁</li><li>抛出 <code>IllegalStateException(&quot;Deadlock detected&quot;)</code></li></ul><h3 id="向后兼容" tabindex="-1">向后兼容 <a class="header-anchor" href="#向后兼容" aria-label="Permalink to “向后兼容”">​</a></h3><p><strong>隐式依赖推导</strong>：</p><ul><li>缺省 <code>depends on</code> 时，编译器自动为 step 添加对前一步骤的依赖</li><li>保持 Phase 2.0 的串行执行语义</li></ul><p><strong>串行兼容示例</strong>：</p><div class="language-aster"><button title="Copy Code" class="copy"></button><span class="lang">aster</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">workflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  step </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">first</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;one&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  step </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">second</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 自动依赖 &quot;first&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;two&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  step </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">third</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 自动依赖 &quot;second&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;three&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span></code></pre></div><h2 id="补偿策略" tabindex="-1">补偿策略 <a class="header-anchor" href="#补偿策略" aria-label="Permalink to “补偿策略”">​</a></h2><h3 id="lifo-原则" tabindex="-1">LIFO 原则 <a class="header-anchor" href="#lifo-原则" aria-label="Permalink to “LIFO 原则”">​</a></h3><p>Workflow 失败时，已完成的步骤按 <strong>LIFO（Last In, First Out）</strong> 顺序执行补偿，确保最新的副作用最先被撤销。</p><p><strong>补偿堆栈</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>执行顺序：A → B → C → (D 失败)</span></span>
<span class="line"><span>补偿顺序：C → B → A  (LIFO)</span></span></code></pre></div><h3 id="并发步骤的补偿顺序" tabindex="-1">并发步骤的补偿顺序 <a class="header-anchor" href="#并发步骤的补偿顺序" aria-label="Permalink to “并发步骤的补偿顺序”">​</a></h3><p>并发步骤的补偿顺序由 <code>completedAt</code> 时间戳决定：</p><p><strong>规则</strong>：</p><ul><li>按 <code>completedAt</code> <strong>降序</strong>排序（最晚完成的最先补偿）</li><li>同一批次的步骤完成顺序由线程池执行顺序决定</li><li>补偿顺序与真实提交顺序一致，无需显式声明优先级</li></ul><p><strong>示例</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>并发执行：</span></span>
<span class="line"><span>  - step_b 完成于 T1 (早)</span></span>
<span class="line"><span>  - step_c 完成于 T2 (晚)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>补偿顺序：step_c → step_b  (T2 &gt; T1，后完成先补偿)</span></span></code></pre></div><h3 id="补偿失败处理" tabindex="-1">补偿失败处理 <a class="header-anchor" href="#补偿失败处理" aria-label="Permalink to “补偿失败处理”">​</a></h3><p><strong>重试机制</strong>：</p><ul><li>补偿失败时不会自动重试</li><li>Workflow 状态标记为 <code>COMPENSATION_FAILED</code></li><li>需要人工介入或外部重试逻辑</li></ul><p><strong>幂等性要求</strong>：</p><ul><li>补偿逻辑必须设计为幂等操作</li><li>支持 WorkflowScheduler 在重试/重放时安全执行</li></ul><h2 id="事件模型" tabindex="-1">事件模型 <a class="header-anchor" href="#事件模型" aria-label="Permalink to “事件模型”">​</a></h2><h3 id="workflow-事件类型" tabindex="-1">Workflow 事件类型 <a class="header-anchor" href="#workflow-事件类型" aria-label="Permalink to “Workflow 事件类型”">​</a></h3><p>所有 workflow 状态变更通过事件存储持久化：</p><table tabindex="0"><thead><tr><th>事件类型</th><th>触发时机</th><th>Payload 字段</th></tr></thead><tbody><tr><td><code>WORKFLOW_STARTED</code></td><td>workflow 开始执行</td><td><code>workflowId</code>, <code>metadata</code></td></tr><tr><td><code>STEP_STARTED</code></td><td>步骤开始执行</td><td><code>stepId</code>, <code>dependencies</code>, <code>startedAt</code></td></tr><tr><td><code>STEP_COMPLETED</code></td><td>步骤成功完成</td><td><code>stepId</code>, <code>result</code>, <code>completedAt</code>, <code>hasCompensation</code></td></tr><tr><td><code>STEP_FAILED</code></td><td>步骤执行失败</td><td><code>stepId</code>, <code>error</code>, <code>completedAt</code></td></tr><tr><td><code>COMPENSATION_SCHEDULED</code></td><td>补偿已调度</td><td><code>stepId</code>, <code>scheduledAt</code></td></tr><tr><td><code>COMPENSATION_COMPLETED</code></td><td>补偿成功完成</td><td><code>stepId</code>, <code>completedAt</code></td></tr><tr><td><code>WORKFLOW_COMPLETED</code></td><td>workflow 成功完成</td><td><code>result</code></td></tr><tr><td><code>WORKFLOW_FAILED</code></td><td>workflow 执行失败</td><td><code>error</code></td></tr><tr><td><code>WORKFLOW_COMPENSATED</code></td><td>workflow 补偿完成</td><td><code>compensatedSteps</code></td></tr></tbody></table><h3 id="dependencies-字段" tabindex="-1">Dependencies 字段 <a class="header-anchor" href="#dependencies-字段" aria-label="Permalink to “Dependencies 字段”">​</a></h3><p><strong>Phase 2.5 新增</strong>：所有 step 事件的 payload 包含 <code>dependencies</code> 字段，记录该步骤的依赖列表。</p><p><strong>JSON Schema</strong>：</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;stepId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order_supplier_a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;dependencies&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;check_stock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;status&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;COMPLETED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;completedAt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-11-10T06:48:59.522Z&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;result&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ordered from A&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;hasCompensation&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="事件序列完整性" tabindex="-1">事件序列完整性 <a class="header-anchor" href="#事件序列完整性" aria-label="Permalink to “事件序列完整性”">​</a></h3><p><strong>并发写入安全</strong>：</p><ul><li>使用数据库 <code>BIGSERIAL</code> 生成全局递增的 <code>sequence</code> 序列号</li><li>保证并发 step 事件写入时 sequence 连续且唯一</li><li>无跳号、无乱序</li></ul><p><strong>序列验证</strong>：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sequence</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workflow_events</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workflow_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ?</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ORDER BY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sequence</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 验证：sequence[i] = sequence[i-1] + 1</span></span></code></pre></div><h2 id="性能考虑" tabindex="-1">性能考虑 <a class="header-anchor" href="#性能考虑" aria-label="Permalink to “性能考虑”">​</a></h2><h3 id="线程池大小" tabindex="-1">线程池大小 <a class="header-anchor" href="#线程池大小" aria-label="Permalink to “线程池大小”">​</a></h3><p><strong>推荐配置</strong>：</p><ul><li><strong>默认</strong>：等于 CPU 核数（适合 CPU 密集型任务）</li><li><strong>I/O 密集型</strong>：可增加至 2-4 倍 CPU 核数</li><li><strong>低并发场景</strong>：减少至 1-2 个线程降低上下文切换开销</li></ul><p><strong>调整方式</strong>：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 自定义线程池大小</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AsyncTaskRegistry registry </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AsyncTaskRegistry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">registry.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setThreadPoolSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h3 id="dag-复杂度限制" tabindex="-1">DAG 复杂度限制 <a class="header-anchor" href="#dag-复杂度限制" aria-label="Permalink to “DAG 复杂度限制”">​</a></h3><p><strong>建议</strong>：</p><ul><li>单个 workflow 的步骤数不超过 <strong>20 个</strong></li><li>DAG 深度不超过 <strong>5 层</strong></li><li>单个步骤的依赖数不超过 <strong>10 个</strong></li></ul><p><strong>复杂度过高的影响</strong>：</p><ul><li>依赖图构建耗时增加</li><li>调度开销增大</li><li>事件存储压力增加</li></ul><p><strong>解决方案</strong>：</p><ul><li>拆分为多个子 workflow</li><li>使用消息队列解耦步骤</li></ul><h3 id="并发窗口优化" tabindex="-1">并发窗口优化 <a class="header-anchor" href="#并发窗口优化" aria-label="Permalink to “并发窗口优化”">​</a></h3><p><strong>最佳实践</strong>：</p><ul><li>将慢速 I/O 操作（HTTP 调用、数据库查询）放在独立的步骤中</li><li>使用 <code>depends on</code> 显式声明依赖，最大化并发机会</li><li>避免过度并行化短时 CPU 任务（线程切换开销 &gt; 并行收益）</li></ul><p><strong>反模式</strong>：</p><div class="language-aster"><button title="Copy Code" class="copy"></button><span class="lang">aster</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 避免：过度并行化</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">workflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  step </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;fast&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 10ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  step b depends on [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;fast&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 10ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  step c depends on [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;fast&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 10ms</span></span></code></pre></div><p><strong>优化后</strong>：</p><div class="language-aster"><button title="Copy Code" class="copy"></button><span class="lang">aster</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 推荐：合并快速步骤</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">workflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  step </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Let result_a be ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;fast&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Let result_b be ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;fast&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Let result_c be ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;fast&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result_c.</span></span></code></pre></div><h3 id="补偿性能" tabindex="-1">补偿性能 <a class="header-anchor" href="#补偿性能" aria-label="Permalink to “补偿性能”">​</a></h3><p><strong>补偿执行特点</strong>：</p><ul><li>补偿按 LIFO 顺序<strong>串行执行</strong>（避免并发回滚冲突）</li><li>每个补偿步骤独立提交到线程池</li><li>补偿总耗时 = Σ(单步补偿耗时)</li></ul><p><strong>优化建议</strong>：</p><ul><li>设计轻量级补偿逻辑（&lt; 100ms）</li><li>避免补偿中执行复杂业务逻辑</li><li>使用异步消息队列延迟处理非紧急补偿</li></ul><h2 id="最佳实践" tabindex="-1">最佳实践 <a class="header-anchor" href="#最佳实践" aria-label="Permalink to “最佳实践”">​</a></h2><h3 id="并发模式选择" tabindex="-1">并发模式选择 <a class="header-anchor" href="#并发模式选择" aria-label="Permalink to “并发模式选择”">​</a></h3><p><strong>Fan-out 模式</strong>：</p><ul><li><strong>适用</strong>：多个独立任务依赖同一前置步骤</li><li><strong>示例</strong>：库存检查后并发调用多个供应商</li><li><strong>优势</strong>：最大化并发度</li></ul><p><strong>Diamond 模式</strong>：</p><ul><li><strong>适用</strong>：两条并行分支汇聚到同一后续步骤</li><li><strong>示例</strong>：风险评分 + 优惠查询 → 汇总决策</li><li><strong>优势</strong>：清晰的数据流</li></ul><p><strong>Serial 模式</strong>：</p><ul><li><strong>适用</strong>：步骤间有强依赖关系</li><li><strong>示例</strong>：验证 → 预留 → 扣款 → 确认</li><li><strong>优势</strong>：简单可靠</li></ul><h3 id="依赖声明原则" tabindex="-1">依赖声明原则 <a class="header-anchor" href="#依赖声明原则" aria-label="Permalink to “依赖声明原则”">​</a></h3><p><strong>显式优于隐式</strong>：</p><div class="language-aster"><button title="Copy Code" class="copy"></button><span class="lang">aster</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 推荐：显式声明依赖</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">step merge depends on [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;branch_a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;branch_b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 避免：依赖隐式顺序</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">step </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 隐式依赖 branch_b</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ...</span></span></code></pre></div><p><strong>最小化依赖</strong>：</p><div class="language-aster"><button title="Copy Code" class="copy"></button><span class="lang">aster</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅ 推荐：只依赖直接前驱</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">step finalize depends on [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;step_c&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌ 避免：过度声明传递依赖</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">step finalize depends on [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;step_a&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;step_b&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;step_c&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ...</span></span></code></pre></div><h3 id="错误处理" tabindex="-1">错误处理 <a class="header-anchor" href="#错误处理" aria-label="Permalink to “错误处理”">​</a></h3><p><strong>快速失败</strong>：</p><ul><li>任意步骤失败立即终止 workflow</li><li>未执行的步骤自动标记为 <code>CANCELLED</code></li><li>触发 LIFO 补偿链</li></ul><p><strong>补偿设计</strong>：</p><ul><li>每个有副作用的步骤必须提供 <code>compensate</code> 块</li><li>补偿逻辑应保证幂等性</li><li>记录补偿失败原因以便人工介入</li></ul><h3 id="监控与调试" tabindex="-1">监控与调试 <a class="header-anchor" href="#监控与调试" aria-label="Permalink to “监控与调试”">​</a></h3><p><strong>关键指标</strong>：</p><ul><li>Workflow 执行时长</li><li>步骤并发度（峰值并发任务数）</li><li>补偿触发频率</li><li>事件序列完整性</li></ul><p><strong>调试工具</strong>：</p><ul><li>事件存储查询（按 <code>sequence</code> 排序）</li><li>依赖图可视化（GraphViz）</li><li>线程池监控（活跃线程数、队列长度）</li></ul><hr><p><strong>相关文档</strong>：</p><ul><li><a href="./language/workflow.html">Workflow 语法指南</a></li><li><a href="./architecture/event-store.html">Event Store 设计</a></li><li><a href="./api/async-task-registry.html">AsyncTaskRegistry API</a></li></ul>`,111)])])}const E=i(t,[["render",e]]);export{g as __pageData,E as default};
