import{_ as a,c as i,o as l,aj as t}from"./chunks/framework.Bz2R-749.js";const p=JSON.parse('{"title":"Aster Native 应用构建指南","description":"","frontmatter":{},"headers":[],"relativePath":"native-build-guide.md","filePath":"native-build-guide.md"}'),c={name:"native-build-guide.md"};function o(s,e,d,r,n,h){return l(),i("div",null,[...e[0]||(e[0]=[t('<h1 id="aster-native-应用构建指南" tabindex="-1">Aster Native 应用构建指南 <a class="header-anchor" href="#aster-native-应用构建指南" aria-label="Permalink to “Aster Native 应用构建指南”">​</a></h1><ul><li>日期：2025-10-25 17:34 NZST</li><li>执行者：Codex</li></ul><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to “概述”">​</a></h2><ul><li>功能介绍：<code>aster native</code> 命令基于 GraalVM Native Image 将 CNL 程序与 CLI 封装为独立可执行文件，消除 JVM 启动成本并缩短冷启动延迟。</li><li>支持的编译器后端：默认 TypeScript 后端（<code>ASTER_COMPILER=typescript</code>）与 Java 后端（<code>ASTER_COMPILER=java</code>）均可生成原生映像，内部通过统一 Core IR 管道共享。</li><li>GraalVM 要求：需要 GraalVM JDK 25 或更新版本，并安装 <code>native-image</code> 组件；命令行环境需在 PATH 中优先使用 GraalVM 可执行文件。</li></ul><h2 id="快速开始" tabindex="-1">快速开始 <a class="header-anchor" href="#快速开始" aria-label="Permalink to “快速开始”">​</a></h2><h3 id="前置条件" tabindex="-1">前置条件 <a class="header-anchor" href="#前置条件" aria-label="Permalink to “前置条件”">​</a></h3><ul><li>安装 GraalVM JDK 25+，建议使用 <code>gu install native-image</code> 启用原生工具链。</li><li>确保 <code>JAVA_HOME</code> 指向 GraalVM，<code>native-image --version</code> 可以正确输出版本信息。</li><li>若要启用 Java 后端，请设置 <code>ASTER_COMPILER=java</code> 并提前构建 CLI 依赖。</li></ul><h3 id="构建-cli-native-可执行文件" tabindex="-1">构建 CLI Native 可执行文件 <a class="header-anchor" href="#构建-cli-native-可执行文件" aria-label="Permalink to “构建 CLI Native 可执行文件”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gradlew</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :aster-lang-cli:nativeCompile</span></span></code></pre></div><ul><li>该任务会自动收集所有模块产物，生成位于 <code>aster-lang-cli/build/native/nativeCompile/aster-lang-cli</code> 的可执行文件。</li><li>构建期间会应用 Phase A~C 产出的反射、资源与 funcHints 配置，确保 CLI 在原生环境下可运行。</li></ul><h3 id="构建用户程序-native-可执行文件" tabindex="-1">构建用户程序 Native 可执行文件 <a class="header-anchor" href="#构建用户程序-native-可执行文件" aria-label="Permalink to “构建用户程序 Native 可执行文件”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">aster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> native</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> myapp.cnl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --output</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> myapp</span></span></code></pre></div><ul><li>命令默认使用 TypeScript 编译器后端；若需切换 Java 后端，设置 <code>ASTER_COMPILER=java aster native ...</code>。</li><li>CLI 会在内部完成 parse → lower → compile → jar → native-image 流程，产出与源文件同名的可执行文件。</li></ul><h2 id="架构说明" tabindex="-1">架构说明 <a class="header-anchor" href="#架构说明" aria-label="Permalink to “架构说明”">​</a></h2><h3 id="phase-a-配置收集" tabindex="-1">Phase A: 配置收集 <a class="header-anchor" href="#phase-a-配置收集" aria-label="Permalink to “Phase A: 配置收集”">​</a></h3><ul><li><code>reflect-config.json</code>：通过 GraalVM agent 多轮采集累计 90 条命中记录，经过筛选后最终保留 36 条核心反射条目，覆盖 <code>aster.core.*</code>、<code>aster.cli.*</code> 与 <code>com.fasterxml.jackson.*</code>。</li><li><code>resource-config.json</code>：定义 5 类资源模式，包括 <code>package.json</code>、<code>package-lock.json</code>、<code>scripts/**</code>、<code>dist/scripts/**</code> 以及 <code>META-INF/services/**</code>。</li><li>配置来源：借助 <code>native-image-agent</code> 捕捉 CLI 常用操作（help/version/compile），结合手工审查剔除 Gradle 噪声项，仅保留运行期必需条目。</li></ul><h3 id="phase-b-funchints-优化" tabindex="-1">Phase B: funcHints 优化 <a class="header-anchor" href="#phase-b-funchints-优化" aria-label="Permalink to “Phase B: funcHints 优化”">​</a></h3><ul><li>基于 Core IR 的类型提示：<code>JavaCompilerBackend.buildFuncHints</code> 会扫描 Core 模块中的函数返回类型，为 ASM emitter 提供 JVM 原始类型提示。</li><li>支持的原始类型：<code>Int → I</code>、<code>Long → J</code>、<code>Double/Float → D</code>、<code>Bool/Boolean → Z</code>，其余类型自动回落为引用类型。</li><li>性能优化原理：提前传递 funcHints 使 ASM emitter 生成更紧凑的字节码，避免运行时装箱拆箱，提高 native-image 在热点函数上的性能表现。</li></ul><h3 id="phase-c-native-image-配置" tabindex="-1">Phase C: Native-Image 配置 <a class="header-anchor" href="#phase-c-native-image-配置" aria-label="Permalink to “Phase C: Native-Image 配置”">​</a></h3><ul><li>反射配置详解：保留 AST/Core IR 数据类和 Jackson 扩展实现，剔除 Gradle Daemon 相关条目，保证镜像体积与初始化时间。</li><li>资源配置详解：通过通配符注入 NPM 产物与 ServiceLoader 资源，确保 CLI 在无文件系统访问权限的环境下依旧可以加载脚本。</li><li>为什么不需要代理配置：原生 CLI 全链路未使用 JDK 动态代理；agent 捕获的 Gradle 代理仅在构建期出现，因此未纳入运行时配置。</li></ul><h3 id="phase-d-aster-native-命令" tabindex="-1">Phase D: aster native 命令 <a class="header-anchor" href="#phase-d-aster-native-命令" aria-label="Permalink to “Phase D: aster native 命令”">​</a></h3><ul><li>命令用法：<code>aster native &lt;source.cnl&gt; [--output &lt;path&gt;] [--main &lt;Class&gt;] [--emit-dir &lt;dir&gt;]</code>。</li><li>选项说明： <ul><li><code>--output/-o</code>：指定生成的可执行文件路径。</li><li><code>--compiler</code>：显式选择后端（等价于设置环境变量）。</li><li><code>--emit-dir</code>：复用已有 JVM 字节码产物，跳过编译阶段。</li></ul></li><li>构建流程：解析参数 → 生成 Core IR → 通过 funcHints 优化字节码 → 调用 <code>native-image</code> 应用 Phase A~C 的配置 → 产出可执行文件并写入报告。</li></ul><h2 id="已知限制" tabindex="-1">已知限制 <a class="header-anchor" href="#已知限制" aria-label="Permalink to “已知限制”">​</a></h2><ul><li><code>JarHotSwapRunner</code> 无法在 native 模式下工作（GraalVM 不支持运行时动态类加载）。</li><li><code>aster run --watch</code> 在 native 可执行文件内不可用，原因同上。</li><li>构建过程依赖 GraalVM 工具链与本地 C/C++ 链接器，CI 需提前准备环境。</li><li><code>./gradlew build</code> 仍依赖缺失的 <code>test/cnl/stdlib/finance/*.aster</code> 样例；native 流程不受影响，但全量构建会失败。</li></ul><h2 id="故障排除" tabindex="-1">故障排除 <a class="header-anchor" href="#故障排除" aria-label="Permalink to “故障排除”">​</a></h2><ul><li>常见错误： <ul><li><code>native-image</code> 未找到 → 确认 GraalVM 已安装并在 PATH 中，运行 <code>gu list</code> 检查 <code>native-image</code> 组件。</li><li>缺少反射条目导致启动失败 → 检查 <code>META-INF/native-image/reflect-config.json</code> 是否遗漏新增数据结构，可参考 Phase A agent 流程重新采集。</li><li>构建失败提示缺失 <code>test/cnl/stdlib/...</code> → 当前仓库未提供该策略资产，可临时跳过 <code>:quarkus-policy-api:generateAsterJar</code> 或补充测试资源。</li></ul></li><li>性能调优建议： <ul><li>添加 <code>--initialize-at-build-time</code> 到自定义模块，减少运行时初始化开销。</li><li>使用 <code>-H:+ReportExceptionStackTraces</code> 排查 native 运行期异常，便于定位缺失配置。</li></ul></li></ul><h2 id="实现细节" tabindex="-1">实现细节 <a class="header-anchor" href="#实现细节" aria-label="Permalink to “实现细节”">​</a></h2><ul><li>修改文件清单： <ul><li><code>aster-lang-cli/src/main/java/aster/cli/compiler/JavaCompilerBackend.java</code>：添加 Phase B <code>funcHints</code> 构建逻辑。</li><li><code>aster-lang-cli/src/main/resources/META-INF/native-image/reflect-config.json</code>：更新精简后的反射条目。</li><li><code>aster-lang-cli/src/main/resources/META-INF/native-image/resource-config.json</code>：加入 <code>package-lock.json</code>、<code>dist/scripts/**</code> 等资源模式。</li><li><code>docs/workstreams/native-cli/operations-log.md</code>：记录 Phase A~E 的执行日志。</li></ul></li><li>关键代码说明： <ul><li><code>buildFuncHints</code> 根据 Core IR 函数返回类型生成 JVM 原生类型映射，生成包级 Hint 表并传递给 ASM emitter。</li><li>CLI native 任务通过 Gradle <code>nativeCompile</code> 连接 <code>native-image</code>，自动引用上述配置文件。</li></ul></li><li>测试覆盖：<code>ASTER_COMPILER=java ./gradlew :aster-lang-cli:test</code> 与默认后端测试均通过；<code>./gradlew build</code> 仍受缺失示例阻塞，需人工补齐资源或跳过任务。</li></ul><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to “参考资料”">​</a></h2><ul><li>GraalVM Native Image 官方文档：<a href="https://www.graalvm.org/latest/reference-manual/native-image/" target="_blank" rel="noreferrer">https://www.graalvm.org/latest/reference-manual/native-image/</a></li><li>阶段报告：<code>.claude/phase-a-agent-report.md</code>、<code>.claude/phase-b-status-report.md</code>、<code>.claude/phase-c-config-report.md</code></li><li>指南配套操作日志：<code>docs/workstreams/native-cli/operations-log.md</code></li></ul>',30)])])}const g=a(c,[["render",o]]);export{p as __pageData,g as default};
