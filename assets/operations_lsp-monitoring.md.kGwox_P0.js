import{_ as i,c as a,o as t,aj as n}from"./chunks/framework.Bz2R-749.js";const g=JSON.parse('{"title":"LSP 监控与运维指南","description":"","frontmatter":{},"headers":[],"relativePath":"operations/lsp-monitoring.md","filePath":"operations/lsp-monitoring.md"}'),h={name:"operations/lsp-monitoring.md"};function l(e,s,p,k,d,r){return t(),a("div",null,[...s[0]||(s[0]=[n(`<blockquote><p>更新时间：2025-11-27 14:55（NZDT） 执行者：Claude Code</p></blockquote><h1 id="lsp-监控与运维指南" tabindex="-1">LSP 监控与运维指南 <a class="header-anchor" href="#lsp-监控与运维指南" aria-label="Permalink to “LSP 监控与运维指南”">​</a></h1><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to “概述”">​</a></h2><p>Aster Language Server 提供健康检查和资源监控 API，用于生产环境部署和故障诊断。本文档描述如何使用监控 API、解读指标、设置告警以及排查常见故障。</p><h2 id="访问方式" tabindex="-1">访问方式 <a class="header-anchor" href="#访问方式" aria-label="Permalink to “访问方式”">​</a></h2><p>Health Check API 通过以下方式访问：</p><h3 id="_1-websocket-json-rpc-当前支持" tabindex="-1">1. WebSocket JSON-RPC（当前支持） <a class="header-anchor" href="#_1-websocket-json-rpc-当前支持" aria-label="Permalink to “1. WebSocket JSON-RPC（当前支持）”">​</a></h3><p>Policy Editor 前端通过 WebSocket 连接到 <code>/ws/lsp</code> 端点，使用 JSON-RPC 2.0 协议调用 <code>aster/health</code> 方法。这是<strong>当前唯一支持的访问方式</strong>。</p><p><strong>前端状态指示器</strong>：Policy Editor Monaco 编辑器组件内置 LSP 状态指示器，自动每 5 秒轮询健康状态并在 UI 显示。</p><p><strong>浏览器控制台调试</strong>：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 在 Policy Editor 页面的浏览器控制台执行</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 获取 LSP 客户端实例并调用健康检查</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> editor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;monaco-editor-component&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> health</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> editor.lspClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;LSP Health:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, health);</span></span></code></pre></div><h3 id="_2-rest-api-计划中-p2" tabindex="-1">2. REST API（计划中 - P2） <a class="header-anchor" href="#_2-rest-api-计划中-p2" aria-label="Permalink to “2. REST API（计划中 - P2）”">​</a></h3><p>未来计划添加 REST 代理端点 <code>/api/lsp/health</code>，允许外部监控系统直接通过 HTTP 访问健康状态。当前此端点<strong>尚未实现</strong>。</p><h3 id="_3-cli-直连测试" tabindex="-1">3. CLI 直连测试 <a class="header-anchor" href="#_3-cli-直连测试" aria-label="Permalink to “3. CLI 直连测试”">​</a></h3><p>开发和调试时，可以通过 stdio 直接测试 LSP 健康检查：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 启动 LSP 服务器并发送健康检查请求</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;method&quot;:&quot;aster/health&quot;,&quot;params&quot;:{}}&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist/src/lsp/server.js</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --stdio</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> 2&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/dev/null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  head</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> jq</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;.result&#39;</span></span></code></pre></div><h2 id="health-check-api" tabindex="-1">Health Check API <a class="header-anchor" href="#health-check-api" aria-label="Permalink to “Health Check API”">​</a></h2><h3 id="端点信息" tabindex="-1">端点信息 <a class="header-anchor" href="#端点信息" aria-label="Permalink to “端点信息”">​</a></h3><table tabindex="0"><thead><tr><th>属性</th><th>值</th></tr></thead><tbody><tr><td>协议</td><td>JSON-RPC 2.0 (over WebSocket)</td></tr><tr><td>WebSocket 路径</td><td><code>/ws/lsp</code></td></tr><tr><td>方法</td><td><code>aster/health</code></td></tr><tr><td>参数</td><td><code>{}</code> (空对象)</td></tr></tbody></table><h3 id="请求格式" tabindex="-1">请求格式 <a class="header-anchor" href="#请求格式" aria-label="Permalink to “请求格式”">​</a></h3><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;jsonrpc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;method&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;aster/health&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;params&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="响应格式" tabindex="-1">响应格式 <a class="header-anchor" href="#响应格式" aria-label="Permalink to “响应格式”">​</a></h3><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;jsonrpc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;result&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;watchers&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;capability&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;registered&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;mode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dynamic&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;isRunning&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;trackedFiles&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">150</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;files&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">869</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;modules&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">236</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;queue&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;pending&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;running&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;completed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">42</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;failed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;total&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">43</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;process&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;pid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12345</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;uptime&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3600</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;memory&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;rss&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">150</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;heapUsed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;heapTotal&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">120</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;cpu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;percent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5.2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;metadata&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;startTime&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-11-27T07:30:00.000Z&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;restartCount&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="指标说明" tabindex="-1">指标说明 <a class="header-anchor" href="#指标说明" aria-label="Permalink to “指标说明”">​</a></h2><h3 id="进程资源指标-process" tabindex="-1">进程资源指标 (process) <a class="header-anchor" href="#进程资源指标-process" aria-label="Permalink to “进程资源指标 (process)”">​</a></h3><table tabindex="0"><thead><tr><th>指标路径</th><th>类型</th><th>单位</th><th>说明</th><th>正常范围</th></tr></thead><tbody><tr><td><code>process.pid</code></td><td>number</td><td>-</td><td>进程 ID</td><td>&gt; 0</td></tr><tr><td><code>process.uptime</code></td><td>number</td><td>秒</td><td>进程运行时间</td><td>递增，无上限</td></tr><tr><td><code>process.memory.rss</code></td><td>number</td><td>MB</td><td>常驻集大小（物理内存）</td><td>&lt; 500</td></tr><tr><td><code>process.memory.heapUsed</code></td><td>number</td><td>MB</td><td>已使用堆内存</td><td>&lt; heapTotal × 0.8</td></tr><tr><td><code>process.memory.heapTotal</code></td><td>number</td><td>MB</td><td>堆内存总量</td><td>根据 Node.js 配置</td></tr><tr><td><code>process.cpu.percent</code></td><td>number</td><td>%</td><td>CPU 使用率（采样间隔计算）</td><td>&lt; 50</td></tr></tbody></table><h3 id="元数据指标-metadata" tabindex="-1">元数据指标 (metadata) <a class="header-anchor" href="#元数据指标-metadata" aria-label="Permalink to “元数据指标 (metadata)”">​</a></h3><table tabindex="0"><thead><tr><th>指标路径</th><th>类型</th><th>格式</th><th>说明</th></tr></thead><tbody><tr><td><code>metadata.startTime</code></td><td>string</td><td>ISO 8601</td><td>服务器启动时间</td></tr><tr><td><code>metadata.restartCount</code></td><td>number</td><td>整数</td><td>历史累计重启次数</td></tr></tbody></table><h3 id="索引指标-index" tabindex="-1">索引指标 (index) <a class="header-anchor" href="#索引指标-index" aria-label="Permalink to “索引指标 (index)”">​</a></h3><table tabindex="0"><thead><tr><th>指标路径</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>index.files</code></td><td>number</td><td>已索引的文件数量</td></tr><tr><td><code>index.modules</code></td><td>number</td><td>已解析的模块数量</td></tr></tbody></table><h3 id="队列指标-queue" tabindex="-1">队列指标 (queue) <a class="header-anchor" href="#队列指标-queue" aria-label="Permalink to “队列指标 (queue)”">​</a></h3><table tabindex="0"><thead><tr><th>指标路径</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>queue.pending</code></td><td>number</td><td>等待处理的任务数</td></tr><tr><td><code>queue.running</code></td><td>number</td><td>正在执行的任务数</td></tr><tr><td><code>queue.completed</code></td><td>number</td><td>已完成的任务数</td></tr><tr><td><code>queue.failed</code></td><td>number</td><td>失败的任务数</td></tr><tr><td><code>queue.total</code></td><td>number</td><td>任务总数</td></tr></tbody></table><h3 id="文件监视器指标-watchers" tabindex="-1">文件监视器指标 (watchers) <a class="header-anchor" href="#文件监视器指标-watchers" aria-label="Permalink to “文件监视器指标 (watchers)”">​</a></h3><table tabindex="0"><thead><tr><th>指标路径</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>watchers.capability</code></td><td>boolean</td><td>客户端是否支持文件监视</td></tr><tr><td><code>watchers.registered</code></td><td>boolean</td><td>监视器是否已注册</td></tr><tr><td><code>watchers.mode</code></td><td>string</td><td>监视模式 (dynamic/static)</td></tr><tr><td><code>watchers.isRunning</code></td><td>boolean</td><td>监视器是否正在运行</td></tr><tr><td><code>watchers.trackedFiles</code></td><td>number</td><td>正在监视的文件数量</td></tr></tbody></table><h2 id="告警阈值建议" tabindex="-1">告警阈值建议 <a class="header-anchor" href="#告警阈值建议" aria-label="Permalink to “告警阈值建议”">​</a></h2><h3 id="警告级别-warning" tabindex="-1">警告级别 (WARNING) <a class="header-anchor" href="#警告级别-warning" aria-label="Permalink to “警告级别 (WARNING)”">​</a></h3><table tabindex="0"><thead><tr><th>条件</th><th>说明</th><th>建议操作</th></tr></thead><tbody><tr><td><code>memory.rss &gt; 500 MB</code></td><td>内存使用偏高</td><td>观察趋势，准备重启</td></tr><tr><td><code>cpu.percent &gt; 50%</code></td><td>CPU 使用偏高</td><td>检查是否有大量文件变更</td></tr><tr><td><code>restartCount</code> 增长 &gt; 5 次/小时</td><td>频繁重启</td><td>检查错误日志</td></tr><tr><td><code>queue.pending &gt; 100</code></td><td>任务积压</td><td>检查 LSP 是否过载</td></tr><tr><td><code>queue.failed &gt; 10</code></td><td>任务失败较多</td><td>检查失败原因</td></tr></tbody></table><h3 id="严重级别-critical" tabindex="-1">严重级别 (CRITICAL) <a class="header-anchor" href="#严重级别-critical" aria-label="Permalink to “严重级别 (CRITICAL)”">​</a></h3><table tabindex="0"><thead><tr><th>条件</th><th>说明</th><th>建议操作</th></tr></thead><tbody><tr><td><code>memory.rss &gt; 1 GB</code></td><td>内存严重超标</td><td>立即重启，排查泄漏</td></tr><tr><td><code>cpu.percent &gt; 80%</code> 持续 5 分钟</td><td>CPU 持续高负载</td><td>检查死循环或性能瓶颈</td></tr><tr><td>Health check 无响应超过 30 秒</td><td>服务可能卡死</td><td>强制重启，收集诊断信息</td></tr><tr><td><code>uptime &lt; 60</code> 且 <code>restartCount</code> 递增</td><td>启动失败循环</td><td>检查配置和依赖</td></tr></tbody></table><h2 id="常见故障排查" tabindex="-1">常见故障排查 <a class="header-anchor" href="#常见故障排查" aria-label="Permalink to “常见故障排查”">​</a></h2><h3 id="_1-lsp-连接失败" tabindex="-1">1. LSP 连接失败 <a class="header-anchor" href="#_1-lsp-连接失败" aria-label="Permalink to “1. LSP 连接失败”">​</a></h3><p><strong>症状</strong>: Policy Editor 无法连接到 LSP，状态显示 &quot;error&quot; 或 &quot;disconnected&quot;</p><p><strong>排查步骤</strong>:</p><ol><li><p>检查 LSP 服务器文件是否存在：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -lh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist/src/lsp/server.js</span></span></code></pre></div></li><li><p>检查 Node.js 版本（需要 &gt;= 22）：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">node</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --version</span></span></code></pre></div></li><li><p>手动测试 LSP 启动：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist/src/lsp/server.js</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --stdio</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 应该等待输入，无立即报错</span></span></code></pre></div></li><li><p>检查 Policy Editor 日志：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Quarkus 日志</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/log/policy-editor/application.log</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 或使用 journalctl</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">journalctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> policy-editor</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span></span></code></pre></div></li><li><p>检查 WebSocket 端点状态：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:8080/ws/lsp</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 应该返回 400 Bad Request（WebSocket 升级失败）</span></span></code></pre></div></li></ol><h3 id="_2-内存持续增长" tabindex="-1">2. 内存持续增长 <a class="header-anchor" href="#_2-内存持续增长" aria-label="Permalink to “2. 内存持续增长”">​</a></h3><p><strong>症状</strong>: <code>process.memory.rss</code> 持续增长，超过 500 MB 或更高</p><p><strong>排查步骤</strong>:</p><ol><li><p>通过浏览器控制台记录内存趋势：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 在 Policy Editor 页面执行</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> editor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;monaco-editor-component&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> health</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> editor.lspClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Memory:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, health.process?.memory);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div></li><li><p>检查索引文件数量（通过 UI 状态指示器或控制台）：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> editor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;monaco-editor-component&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> health</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> editor.lspClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Index files:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, health.index?.files);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 如果 &gt; 1000，考虑缩小工作区范围</span></span></code></pre></div></li><li><p>检查队列积压：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> editor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;monaco-editor-component&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> health</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> editor.lspClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Queue:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, health.queue);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// pending 持续增长可能导致内存增长</span></span></code></pre></div></li><li><p>临时解决方案 - 重启 LSP：</p><ul><li>关闭并重新打开 Policy Editor</li><li>或通过 WebSocket 重新连接</li></ul></li><li><p>长期解决方案：</p><ul><li>配置定期重启（建议 uptime &gt; 24h 时重启）</li><li>缩小工作区文件范围</li><li>增加服务器内存</li></ul></li></ol><h3 id="_3-连接数达到上限" tabindex="-1">3. 连接数达到上限 <a class="header-anchor" href="#_3-连接数达到上限" aria-label="Permalink to “3. 连接数达到上限”">​</a></h3><p><strong>症状</strong>: 新用户无法打开 Policy Editor，WebSocket 连接被拒绝（CloseReason 1013: TRY_AGAIN_LATER）</p><p><strong>排查步骤</strong>:</p><ol><li><p>检查当前活跃连接数：</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 在 Policy Editor 后端日志中查看，或通过 JMX/调试器访问</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// LSPWebSocketEndpoint.getActiveConnectionCount()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 日志示例: &quot;LSP WebSocket 已连接: xxx, 活跃连接数: 3/10&quot;</span></span></code></pre></div><p>也可在 Quarkus Dev UI（开发模式）或应用日志中查看连接状态。</p></li><li><p>查看配置的最大连接数：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;lsp.max.concurrent.connections&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> application.properties</span></span></code></pre></div></li><li><p>排查僵尸连接：</p><ul><li>检查是否有浏览器标签页未正确关闭</li><li>检查网络中断后连接未释放</li></ul></li><li><p>调整连接限制（如有必要）：</p><div class="language-properties"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># application.properties</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">lsp.max.concurrent.connections</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=20</span></span></code></pre></div></li><li><p>强制清理（紧急情况）：</p><ul><li>重启 Policy Editor 服务</li><li>所有连接将被优雅关闭</li></ul></li></ol><h3 id="_4-lsp-响应缓慢" tabindex="-1">4. LSP 响应缓慢 <a class="header-anchor" href="#_4-lsp-响应缓慢" aria-label="Permalink to “4. LSP 响应缓慢”">​</a></h3><p><strong>症状</strong>: 编辑器操作（补全、跳转、格式化）响应延迟超过 2 秒</p><p><strong>排查步骤</strong>:</p><ol><li><p>检查 CPU 使用率（通过浏览器控制台）：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> editor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;monaco-editor-component&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> health</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> editor.lspClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;CPU:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, health.process?.cpu?.percent, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 如果 &gt; 80%，可能有性能瓶颈</span></span></code></pre></div></li><li><p>检查队列状态：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> editor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;monaco-editor-component&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> health</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> editor.lspClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Queue:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, health.queue);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// running &gt; 1 表示有并发处理</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// pending &gt; 10 表示请求积压</span></span></code></pre></div></li><li><p>检查索引大小：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> editor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">querySelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;monaco-editor-component&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> health</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> editor.lspClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Index:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, health.index);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// files &gt; 1000 可能影响性能</span></span></code></pre></div></li><li><p>临时解决方案：</p><ul><li>关闭不必要的编辑器标签页</li><li>减少同时编辑的文件数量</li></ul></li><li><p>长期优化：</p><ul><li>限制工作区范围</li><li>增加服务器 CPU/内存资源</li><li>优化 LSP 索引配置</li></ul></li></ol><h3 id="_5-重启计数器异常增长" tabindex="-1">5. 重启计数器异常增长 <a class="header-anchor" href="#_5-重启计数器异常增长" aria-label="Permalink to “5. 重启计数器异常增长”">​</a></h3><p><strong>症状</strong>: <code>metadata.restartCount</code> 快速增长，表明 LSP 进程频繁崩溃</p><p><strong>排查步骤</strong>:</p><ol><li><p>查看重启计数趋势：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看重启计数器文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/lsp-restart-count.txt</span></span></code></pre></div></li><li><p>检查 LSP 进程退出原因：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看 Policy Editor 日志中的 LSP stderr</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;LSP stderr&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/log/policy-editor/application.log</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -20</span></span></code></pre></div></li><li><p>常见崩溃原因：</p><ul><li>内存不足 (OOM)</li><li>未处理的异常</li><li>Node.js 版本不兼容</li></ul></li><li><p>解决方案：</p><ul><li>增加 Node.js 内存限制：<code>NODE_OPTIONS=&quot;--max-old-space-size=4096&quot;</code></li><li>更新到最新的 LSP 服务器版本</li><li>检查并修复触发崩溃的特定文件</li></ul></li></ol><h2 id="配置参数" tabindex="-1">配置参数 <a class="header-anchor" href="#配置参数" aria-label="Permalink to “配置参数”">​</a></h2><h3 id="backend-配置-application-properties" tabindex="-1">Backend 配置 (application.properties) <a class="header-anchor" href="#backend-配置-application-properties" aria-label="Permalink to “Backend 配置 (application.properties)”">​</a></h3><div class="language-properties"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># LSP 最大并发连接数</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 默认值: 10</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 建议: 4核8GB=10, 8核16GB=20</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">lsp.max.concurrent.connections</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=10</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># LSP 关闭超时时间（秒）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 默认值: 30</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 说明: shutdown 请求后等待进程退出的最长时间</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">lsp.shutdown.timeout.seconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=30</span></span></code></pre></div><h3 id="环境变量" tabindex="-1">环境变量 <a class="header-anchor" href="#环境变量" aria-label="Permalink to “环境变量”">​</a></h3><table tabindex="0"><thead><tr><th>变量</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>LSP_RESTART_COUNTER_FILE</code></td><td><code>/tmp/lsp-restart-count.txt</code></td><td>重启计数器持久化文件路径</td></tr><tr><td><code>NODE_OPTIONS</code></td><td>-</td><td>Node.js 运行时选项，如 <code>--max-old-space-size=4096</code></td></tr></tbody></table><h3 id="frontend-lsp-配置" tabindex="-1">Frontend LSP 配置 <a class="header-anchor" href="#frontend-lsp-配置" aria-label="Permalink to “Frontend LSP 配置”">​</a></h3><p>Frontend 状态指示器默认配置：</p><ul><li>健康检查间隔: 5 秒（带节流）</li><li>重连延迟: 指数退避，最大 30 秒</li><li>状态显示: 连接/正在连接/断开/错误</li></ul><h2 id="监控集成" tabindex="-1">监控集成 <a class="header-anchor" href="#监控集成" aria-label="Permalink to “监控集成”">​</a></h2><h3 id="当前监控方式" tabindex="-1">当前监控方式 <a class="header-anchor" href="#当前监控方式" aria-label="Permalink to “当前监控方式”">​</a></h3><p>由于 Health Check API 当前仅支持 WebSocket JSON-RPC 访问，外部监控系统有以下选择：</p><ol><li><strong>应用日志监控</strong>：解析 Policy Editor 日志中的连接状态信息</li><li><strong>前端 UI 观察</strong>：通过 LSP 状态指示器直接查看</li><li><strong>Quarkus Dev UI</strong>：开发模式下查看应用状态</li></ol><h3 id="cli-健康检查脚本示例" tabindex="-1">CLI 健康检查脚本示例 <a class="header-anchor" href="#cli-健康检查脚本示例" aria-label="Permalink to “CLI 健康检查脚本示例”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># lsp-health-check.sh</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 通过 stdio 直接测试 LSP 服务器健康状态</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ALERT_THRESHOLD_MEMORY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">500</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ALERT_THRESHOLD_CPU</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">80</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 发送健康检查请求并获取响应</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">response</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;method&quot;:&quot;aster/health&quot;,&quot;params&quot;:{}}&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  timeout</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist/src/lsp/server.js</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --stdio</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> 2&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/dev/null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  head</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-z</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$response</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;CRITICAL: LSP health check timeout or failed to start&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 解析响应</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">memory</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$response</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> jq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;.result.process.memory.rss // 0&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cpu</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$response</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> jq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;.result.process.cpu.percent // 0&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (( $(echo </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$memory</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &gt; </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ALERT_THRESHOLD_MEMORY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">l) )); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;WARNING: Memory usage high: \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">memory</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}MB&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (( $(echo </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$cpu</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &gt; </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ALERT_THRESHOLD_CPU</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">l) )); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;WARNING: CPU usage high: \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cpu</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}%&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;OK: Memory=\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">memory</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}MB, CPU=\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cpu</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}%&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><blockquote><p><strong>注意</strong>: 此脚本启动独立的 LSP 进程进行测试，不反映 Policy Editor 中运行的 LSP 实例状态。 生产环境监控应等待 REST API 代理实现（P2 计划）。</p></blockquote><h3 id="prometheus-导出-未来计划-p2" tabindex="-1">Prometheus 导出（未来计划 - P2） <a class="header-anchor" href="#prometheus-导出-未来计划-p2" aria-label="Permalink to “Prometheus 导出（未来计划 - P2）”">​</a></h3><p>计划添加 <code>/metrics</code> 端点，导出 Prometheus 格式指标：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span># HELP lsp_process_uptime_seconds LSP server uptime in seconds</span></span>
<span class="line"><span># TYPE lsp_process_uptime_seconds gauge</span></span>
<span class="line"><span>lsp_process_uptime_seconds 3600</span></span>
<span class="line"><span></span></span>
<span class="line"><span># HELP lsp_process_memory_bytes LSP server memory usage</span></span>
<span class="line"><span># TYPE lsp_process_memory_bytes gauge</span></span>
<span class="line"><span>lsp_process_memory_bytes{type=&quot;rss&quot;} 157286400</span></span>
<span class="line"><span>lsp_process_memory_bytes{type=&quot;heapUsed&quot;} 83886080</span></span>
<span class="line"><span>lsp_process_memory_bytes{type=&quot;heapTotal&quot;} 125829120</span></span>
<span class="line"><span></span></span>
<span class="line"><span># HELP lsp_process_cpu_percent LSP server CPU usage percentage</span></span>
<span class="line"><span># TYPE lsp_process_cpu_percent gauge</span></span>
<span class="line"><span>lsp_process_cpu_percent 5.2</span></span>
<span class="line"><span></span></span>
<span class="line"><span># HELP lsp_connections_active Current number of active WebSocket connections</span></span>
<span class="line"><span># TYPE lsp_connections_active gauge</span></span>
<span class="line"><span>lsp_connections_active 3</span></span>
<span class="line"><span></span></span>
<span class="line"><span># HELP lsp_restarts_total Total number of LSP server restarts</span></span>
<span class="line"><span># TYPE lsp_restarts_total counter</span></span>
<span class="line"><span>lsp_restarts_total 5</span></span></code></pre></div><h2 id="性能优化建议" tabindex="-1">性能优化建议 <a class="header-anchor" href="#性能优化建议" aria-label="Permalink to “性能优化建议”">​</a></h2><h3 id="内存优化" tabindex="-1">内存优化 <a class="header-anchor" href="#内存优化" aria-label="Permalink to “内存优化”">​</a></h3><ol><li><p><strong>定期重启长时间运行的 LSP 进程</strong></p><ul><li>建议: uptime &gt; 24 小时时安排重启</li><li>方式: 通过 shutdown/exit LSP 协议或重启 Policy Editor 服务</li></ul></li><li><p><strong>限制索引文件数量</strong></p><ul><li>建议: &lt; 1000 个 .aster 文件</li><li>配置: 使用 <code>.asterignore</code> 排除不需要索引的目录</li></ul></li><li><p><strong>调整 Node.js 内存限制</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NODE_OPTIONS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--max-old-space-size=2048&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 2GB</span></span></code></pre></div></li></ol><h3 id="并发优化" tabindex="-1">并发优化 <a class="header-anchor" href="#并发优化" aria-label="Permalink to “并发优化”">​</a></h3><ol><li><p><strong>根据服务器资源调整连接限制</strong></p><table tabindex="0"><thead><tr><th>服务器配置</th><th>建议连接数</th></tr></thead><tbody><tr><td>2 核 4GB</td><td>5</td></tr><tr><td>4 核 8GB</td><td>10</td></tr><tr><td>8 核 16GB</td><td>20</td></tr><tr><td>16 核 32GB</td><td>40</td></tr></tbody></table></li><li><p><strong>避免连接泄漏</strong></p><ul><li>确保浏览器关闭时 WebSocket 正确断开</li><li>网络异常时前端自动重连，后端超时清理</li></ul></li></ol><h3 id="监控频率" tabindex="-1">监控频率 <a class="header-anchor" href="#监控频率" aria-label="Permalink to “监控频率”">​</a></h3><table tabindex="0"><thead><tr><th>场景</th><th>建议间隔</th></tr></thead><tbody><tr><td>前端状态指示器</td><td>5 秒</td></tr><tr><td>外部健康检查</td><td>30 秒</td></tr><tr><td>指标采集 (Prometheus)</td><td>15 秒</td></tr><tr><td>告警评估</td><td>1 分钟</td></tr></tbody></table><h2 id="相关文档" tabindex="-1">相关文档 <a class="header-anchor" href="#相关文档" aria-label="Permalink to “相关文档”">​</a></h2><ul><li><a href="./../guide/formatting.html">LSP 格式化与 CLI 指南</a> - LSP 基本使用</li><li><a href="./troubleshooting.html">故障排查手册</a> - 通用故障排查</li><li><a href="./configuration.html">配置指南</a> - 完整配置参考</li><li><a href="./deployment.html">部署指南</a> - 生产环境部署</li></ul>`,87)])])}const c=i(h,[["render",l]]);export{g as __pageData,c as default};
