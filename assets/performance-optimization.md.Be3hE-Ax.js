import{_ as s,c as i,o as a,aj as e}from"./chunks/framework.Bz2R-749.js";const k=JSON.parse('{"title":"AI 代码生成性能优化指南","description":"","frontmatter":{},"headers":[],"relativePath":"performance-optimization.md","filePath":"performance-optimization.md"}'),d={name:"performance-optimization.md"};function n(l,t,r,h,o,p){return a(),i("div",null,[...t[0]||(t[0]=[e(`<h1 id="ai-代码生成性能优化指南" tabindex="-1">AI 代码生成性能优化指南 <a class="header-anchor" href="#ai-代码生成性能优化指南" aria-label="Permalink to “AI 代码生成性能优化指南”">​</a></h1><p>更新日期：2025-11-25 21:41 NZST · 执行者：Codex</p><h2 id="phase-3-4-成果摘要" tabindex="-1">Phase 3.4 成果摘要 <a class="header-anchor" href="#phase-3-4-成果摘要" aria-label="Permalink to “Phase 3.4 成果摘要”">​</a></h2><ul><li><strong>并发调度</strong>：<code>/tmp/run-systematic-tests.mjs</code> 将 <code>dev.jsonl</code> 16 个用例按并发=3 批量执行，缩短首轮耗时至约 1 分 30 秒。</li><li><strong>磁盘缓存</strong>：<code>GenerationCache</code> 在首轮生成 10 个缓存文件，二轮命中率 62.5%，命中请求平均耗时 &lt;1 秒。</li><li><strong>进度追踪</strong>：CLI 输出 <code>[passed/total]</code>、<code>✓/✗/⚠/⚡</code> 指标，帮助分析 rate limit 与缓存表现。</li><li><strong>准确率保持</strong>：10 个完成用例中 8 个通过（80.0%），与 Phase 3.3 的 81.3% 基线一致；剩余 6 个因 429 限流被标记为 ERROR。</li></ul><h2 id="性能指标对比" tabindex="-1">性能指标对比 <a class="header-anchor" href="#性能指标对比" aria-label="Permalink to “性能指标对比”">​</a></h2><table tabindex="0"><thead><tr><th>场景</th><th>Phase 3.3 (串行)</th><th>Phase 3.4 (并发+缓存)</th><th>提升</th></tr></thead><tbody><tr><td>首次运行（16 用例，无缓存）</td><td>16 × 30s ≈ 480s ≈ 8 分钟</td><td>16/3 × 30s ≈ 160s（实测 ~90s，未完成用例受限流影响）</td><td>≈66% 缩短</td></tr><tr><td>第二次运行（缓存命中）</td><td>16 × 30s ≈ 480s</td><td>16 × &lt;1s ≈ 16s（命中部分立即返回）</td><td>≈96% 缩短</td></tr><tr><td>报告生成 (<code>npm run ai:evaluate</code>)</td><td>手动整理日志</td><td>197 行脚本自动输出 Markdown，平均 &lt;1s</td><td>100% 自动化</td></tr></tbody></table><blockquote><p><strong>结论</strong>：只要描述一致，缓存即可将 LLM 调用成本降到几乎为零；并发机制在 rate limit 允许范围内提供 3× 加速。</p></blockquote><h2 id="缓存策略" tabindex="-1">缓存策略 <a class="header-anchor" href="#缓存策略" aria-label="Permalink to “缓存策略”">​</a></h2><ol><li><strong>适用场景</strong>： <ul><li>回归测试或演示同一需求。</li><li>Systematic testing 第二轮复现，确保结果一致。</li></ul></li><li><strong>命中条件</strong>：<code>description</code>、<code>provider</code>、<code>model</code>、<code>temperature</code>、<code>fewShotCount</code> 完全一致。任何空格或大小写差异都会导致 miss。</li><li><strong>目录布局</strong>：<code>.cache/ai-generation/&lt;key&gt;.json</code> 存储 <code>code/rawCode/validation/metadata/usage</code>，不含 <code>fromCache</code> 字段。</li><li><strong>维护建议</strong>：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 清空缓存</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -rf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .cache/ai-generation</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查看命中数量</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .cache/ai-generation</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> wc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -l</span></span></code></pre></div></li><li><strong>失效策略</strong>： <ul><li>Prompt、Few-shot 或模型升级后应删除缓存，以防旧结果造成误判。</li><li>可在 CI 设置 TTL（例如 7 天）或按分支命名子目录。</li></ul></li></ol><h2 id="rate-limit-应对方案" tabindex="-1">Rate Limit 应对方案 <a class="header-anchor" href="#rate-limit-应对方案" aria-label="Permalink to “Rate Limit 应对方案”">​</a></h2><table tabindex="0"><thead><tr><th>策略</th><th>操作</th><th>适用场景</th><th>备注</th></tr></thead><tbody><tr><td>降低并发</td><td>将 <code>CONCURRENCY</code> 从 3 调至 2 或 1</td><td>夜间/配额紧张</td><td>牺牲速度换稳定性。</td></tr><tr><td>重试与退避</td><td>捕获 429 后 <code>await sleep(waitTime)</code> 再次执行</td><td>长时间批量测试</td><td>可结合指数退避，避免雪崩。</td></tr><tr><td>分批执行</td><td>将 16 个用例分多轮运行，每轮间隔 60s</td><td>CI/CD、公共 API Key</td><td>减少瞬时 TPM 请求量。</td></tr><tr><td>缓存优先</td><td>先运行一轮获取缓存，再针对失败/新用例复测</td><td>日常开发</td><td>第二轮几乎全命中，显著降成本。</td></tr><tr><td>升级配额</td><td>向 OpenAI 申请更高 TPM</td><td>正式交付/高频运行</td><td>需业务批准。</td></tr></tbody></table><p>示例降并发代码（节选）：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> CONCURRENCY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AI_TEST_CONCURRENCY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ??</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>在 CI 中导出 <code>AI_TEST_CONCURRENCY=2</code> 即可动态配置。</p><h2 id="最佳实践建议" tabindex="-1">最佳实践建议 <a class="header-anchor" href="#最佳实践建议" aria-label="Permalink to “最佳实践建议”">​</a></h2><ol><li><strong>先构建再评估</strong>：始终 <code>npm run build</code>，确保 CLI 与提示模板同步。</li><li><strong>两轮运行</strong>：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> OPENAI_API_KEY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;...&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/run-systematic-tests.mjs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ai:evaluate</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/run-systematic-tests.mjs</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   # 验证缓存命中</span></span></code></pre></div></li><li><strong>关注失败类型</strong>：在 <code>.claude/evaluation-report.md</code> 中定位 <code>FAILED</code>（逻辑错误）与 <code>ERROR</code>（限流/环境）并分别处理。</li><li><strong>Prompt 版本化</strong>：更改 Few-shot 或 system prompt 时，记录版本号并清理缓存，避免旧数据影响准确率统计。</li><li><strong>日志留存</strong>：将 <code>/tmp/phase3.4-*.log</code>、测试 JSON、评估报告上传到 <code>docs/workstreams/&lt;TASK-ID&gt;/verification/</code>，方便追踪性能趋势。</li><li><strong>自动化触发</strong>：建议在 CI 新增步骤：<code>node /tmp/run-systematic-tests.mjs || true</code>，随后无论退出码如何均运行 <code>npm run ai:evaluate</code>，确保报告生成。</li></ol><h2 id="故障排查速查表" tabindex="-1">故障排查速查表 <a class="header-anchor" href="#故障排查速查表" aria-label="Permalink to “故障排查速查表”">​</a></h2><table tabindex="0"><thead><tr><th>症状</th><th>可能原因</th><th>处理建议</th></tr></thead><tbody><tr><td>第二轮仍耗时较长</td><td>描述或选项发生变化，缓存 miss</td><td>比较 CLI 参数，或使用 <code>AIGenerator.generate({ useCache: true })</code> 并确认输入一致。</td></tr><tr><td>准确率 &lt;80%</td><td>新增用例失败、验证器拦截</td><td>在评估报告 <code>失败与错误详情</code> 中查看 <code>reason</code>，对照 <code>dev.jsonl</code> 调整提示。</td></tr><tr><td>JSON 解析失败</td><td>系统测试输出被截断或包含颜色控制符</td><td>使用评估脚本中同款 <code>ANSI_PATTERN</code> 清洗日志，再写入 JSON；或重新运行测试生成干净输出。</td></tr><tr><td>缓存文件损坏</td><td>中断写入导致临时文件残留</td><td>删除 <code>.cache/ai-generation/*.tmp</code> 并重新生成。</td></tr></tbody></table><p>通过以上策略，可持续维持 Phase 3.4 的性能基线，并为后续 Phase 5 提升准确率奠定稳定、可观测的运行环境。</p>`,19)])])}const g=s(d,[["render",n]]);export{k as __pageData,g as default};
