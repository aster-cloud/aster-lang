import{_ as s,c as t,o as a,aj as e}from"./chunks/framework.Bz2R-749.js";const c=JSON.parse('{"title":"故障排查手册","description":"","frontmatter":{},"headers":[],"relativePath":"operations/troubleshooting.md","filePath":"operations/troubleshooting.md"}'),l={name:"operations/troubleshooting.md"};function h(d,i,n,o,k,r){return a(),t("div",null,[...i[0]||(i[0]=[e(`<blockquote><p>更新时间：2025-10-08 14:57（NZDT）<br> 执行者：Codex</p></blockquote><h1 id="故障排查手册" tabindex="-1">故障排查手册 <a class="header-anchor" href="#故障排查手册" aria-label="Permalink to “故障排查手册”">​</a></h1><h2 id="_1-常见错误与解决方案" tabindex="-1">1. 常见错误与解决方案 <a class="header-anchor" href="#_1-常见错误与解决方案" aria-label="Permalink to “1. 常见错误与解决方案”">​</a></h2><table tabindex="0"><thead><tr><th>错误 ID</th><th>触发场景</th><th>解决步骤</th></tr></thead><tbody><tr><td><code>E1001</code>（CAPABILITY_VIOLATION）</td><td>函数声明的能力与 manifest 不匹配</td><td>更新 manifest（<code>ASTER_CAPS</code>）允许对应模块/函数，或调整函数效果声明</td></tr><tr><td><code>E1003</code>（CAPABILITY_MISSING）</td><td>模块缺少必要能力声明</td><td>补充 <code>It performs IO/CPU</code>，或放宽 manifest</td></tr><tr><td><code>E2001</code>（TYPE_MISMATCH）</td><td>类型推断失败</td><td>检查 CNL 源代码类型一致性，必要时启用 <code>ASTER_DEBUG_TYPES=1</code> 获取解析日志</td></tr><tr><td><code>E3002</code>（EFFECT_SUPERFLUOUS）</td><td>声明了未使用的效应</td><td>移除冗余效果或加入实际 IO/CPU 调用</td></tr><tr><td><code>E4001</code>（PARSER_UNEXPECTED_TOKEN）</td><td>语法错误或缩进不对齐</td><td>使用 <code>npm run fmt:examples</code> 自动修正格式</td></tr><tr><td><code>E5002</code>（LEXER_INVALID_INDENTATION）</td><td>缩进混用 Tab</td><td>将文件转换为空格缩进，重新运行 CLI</td></tr><tr><td><code>E9001</code>（INTERNAL_UNEXPECTED_STATE）</td><td>理论上不应出现的内部错误</td><td>收集日志（含堆栈），开 issue 并附带触发输入</td></tr></tbody></table><blockquote><p>日志中会输出 <code>code</code>, <code>timestamp</code>, <code>component</code> 字段，便于跨系统检索。</p></blockquote><h2 id="_2-日志查看方法" tabindex="-1">2. 日志查看方法 <a class="header-anchor" href="#_2-日志查看方法" aria-label="Permalink to “2. 日志查看方法”">​</a></h2><ol><li>所有核心模块使用结构化 JSON 日志，默认最小级别 <code>INFO</code>。</li><li>本地调试：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LOG_LEVEL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">DEBUG</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist/scripts/cli.js</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test/cnl/examples/greet.aster</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> jq</span></span></code></pre></div></li><li>服务器排障： <ul><li>日志行均为单行 JSON，采集时按行分割即可。</li><li>关注字段：<code>level</code>、<code>component</code>、<code>message</code>、附加 <code>meta</code>（如 <code>duration_ms</code>）。</li></ul></li><li>性能日志：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">node</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;const { logPerformance } = require(&#39;./dist/utils/logger.js&#39;); logPerformance({ component: &#39;typecheck&#39;, operation: &#39;module&#39;, duration: 128 });&quot;</span></span></code></pre></div><ul><li>输出示例：<code>{&quot;level&quot;:&quot;INFO&quot;,&quot;timestamp&quot;:&quot;...&quot;,&quot;component&quot;:&quot;performance&quot;,&quot;message&quot;:&quot;module completed&quot;,&quot;duration_ms&quot;:128}</code>。</li></ul></li></ol><h2 id="_3-性能问题排查" tabindex="-1">3. 性能问题排查 <a class="header-anchor" href="#_3-性能问题排查" aria-label="Permalink to “3. 性能问题排查”">​</a></h2><ul><li><strong>构建缓慢</strong>：确认 <code>npm ci</code> 使用缓存（CI 已启用）；本地可开启 <code>npm run build -- --incremental</code>（TypeScript 会复用缓存）。</li><li><strong>Typecheck 卡顿</strong>：检查 manifest 是否包含过多通配符，可拆分细粒度 allow/deny；必要时提升机器内存。</li><li><strong>Benchmark 指标下降</strong>：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bench</span></span></code></pre></div><ul><li>对比 benchmark 输出与历史记录，若异常可通过 <code>git bisect</code> 定位。</li></ul></li><li><strong>Truffle 执行慢</strong>：关闭 <code>ASTER_TRUFFLE_DEBUG</code>，并检查 <code>JAVA_OPTS</code> 是否设置足够堆大小。</li></ul><h2 id="_4-安全相关问题" tabindex="-1">4. 安全相关问题 <a class="header-anchor" href="#_4-安全相关问题" aria-label="Permalink to “4. 安全相关问题”">​</a></h2><ul><li>依赖安全扫描：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> audit</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # audit-ci --moderate</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> audit-ci</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --high</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # CI security workflow 同步命令</span></span></code></pre></div></li><li>NPM 凭证： <ul><li>确认 <code>NODE_AUTH_TOKEN</code> 写入环境且未泄漏至日志。</li><li>发布失败时检查 npm token 权限是否为 <code>automation</code>。</li></ul></li><li>能力校验： <ul><li>确保 <code>ASTER_CAP_EFFECTS_ENFORCE</code> 未被关闭。</li><li>在日志管道中监控 <code>E1001/E1002</code> 频率，异常升高时提醒研发。</li></ul></li></ul><h2 id="_5-lsp-排障" tabindex="-1">5. LSP 排障 <a class="header-anchor" href="#_5-lsp-排障" aria-label="Permalink to “5. LSP 排障”">​</a></h2><ul><li><strong>LSP 无法启动</strong>：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist/src/lsp/server.js</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --stdio</span></span></code></pre></div><ul><li>观察日志是否有 <code>E</code> 级别条目。</li></ul></li><li><strong>能力提示缺失</strong>：确认启动前导出 <code>ASTER_CAPS=/path/to/manifest.json</code>。</li><li><strong>索引异常</strong>：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test:lsp-index</span></span></code></pre></div><ul><li>若失败，清理缓存目录 <code>~/.cache/aster-lsp</code>（如存在）。</li></ul></li><li><strong>VS Code 调试</strong>：使用扩展仓库 <code>aster-vscode</code>，启用 <code>CI_DEBUG=1</code> 运行 <code>npm run ci</code> 可保留详细输出。</li></ul><h2 id="_6-调试技巧" tabindex="-1">6. 调试技巧 <a class="header-anchor" href="#_6-调试技巧" aria-label="Permalink to “6. 调试技巧”">​</a></h2><ul><li>启用解析调试：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ASTER_DEBUG_TYPES</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist/scripts/cli.js</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test/cnl/examples/map.aster</span></span></code></pre></div></li><li>追踪特定函数的能力检查：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LOG_LEVEL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">DEBUG</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist/scripts/typecheck-cli.js</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test/cnl/examples/capdemo.aster</span></span></code></pre></div></li><li>Node Inspector：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">node</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --inspect-brk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dist/scripts/cli.js</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test/cnl/examples/greet.aster</span></span></code></pre></div></li><li>快速验证 manifest 变更：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ASTER_CAPS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/tmp/capabilities.json</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test:golden</span></span></code></pre></div></li><li>收集详细栈信息：使用 <code>LOG_LEVEL=DEBUG</code> 并确认 <code>error</code> 日志包含 <code>stack</code> 字段。</li></ul>`,15)])])}const g=s(l,[["render",h]]);export{c as __pageData,g as default};
