<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Aster 语言架构文档 | Aster Language</title>
    <meta name="description" content="A pragmatic, safe, fast language with a human CNL surface">
    <meta name="generator" content="VitePress v2.0.0-alpha.15">
    <link rel="preload stylesheet" href="/assets/style.G5Z68FhG.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.BexVkAOt.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.D0q-ibex.js">
    <link rel="modulepreload" href="/assets/chunks/framework.Bz2R-749.js">
    <link rel="modulepreload" href="/assets/architecture.md._DEGzzYu.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1df9f90f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-331ec75c></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-331ec75c>Skip to content</a><!--]--><!----><header class="VPNav" data-v-1df9f90f data-v-da52a441><div class="VPNavBar" data-v-da52a441 data-v-70946a35><div class="wrapper" data-v-70946a35><div class="container" data-v-70946a35><div class="title" data-v-70946a35><div class="VPNavBarTitle" data-v-70946a35 data-v-1e38c6bc><a class="title" href="/" data-v-1e38c6bc><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo.svg" alt data-v-8426fc1a><!--]--><span data-v-1e38c6bc>Aster Language</span><!--[--><!--]--></a></div></div><div class="content" data-v-70946a35><div class="content-body" data-v-70946a35><!--[--><!--]--><div class="VPNavBarSearch search" data-v-70946a35><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-70946a35 data-v-39714824><span id="main-nav-aria-label" class="visually-hidden" data-v-39714824> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/guide/getting-started.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Guide</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/guide/formatting.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Formatting</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/reference/syntax.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Reference</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/api/overview.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>API</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://github.com/wontlost-ltd/aster-lang" target="_blank" rel="noreferrer" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>GitHub</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-70946a35 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-70946a35 data-v-0394ad82 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/wontlost-ltd/aster-lang" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-70946a35 data-v-bf2fac68 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-42cb505d><span class="vpi-more-horizontal icon" data-v-42cb505d></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><!----><div class="group" data-v-bf2fac68><div class="item appearance" data-v-bf2fac68><p class="label" data-v-bf2fac68>Appearance</p><div class="appearance-action" data-v-bf2fac68><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bf2fac68 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bf2fac68><div class="item social-links" data-v-bf2fac68><div class="VPSocialLinks social-links-list" data-v-bf2fac68 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/wontlost-ltd/aster-lang" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-70946a35 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-70946a35><div class="divider-line" data-v-70946a35></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-1df9f90f data-v-db738f89><div class="container" data-v-db738f89><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-db738f89 data-v-0bf0e06f><button data-v-0bf0e06f>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-1df9f90f data-v-c87f25bf><div class="VPDoc has-aside" data-v-c87f25bf data-v-7011f0d8><!--[--><!--]--><div class="container" data-v-7011f0d8><div class="aside" data-v-7011f0d8><div class="aside-curtain" data-v-7011f0d8></div><div class="aside-container" data-v-7011f0d8><div class="aside-content" data-v-7011f0d8><div class="VPDocAside" data-v-7011f0d8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-60d5052e><div class="content" data-v-60d5052e><div class="outline-marker" data-v-60d5052e></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-60d5052e>On this page</div><ul class="VPDocOutlineItem root" data-v-60d5052e data-v-1ce71065><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7011f0d8><div class="content-container" data-v-7011f0d8><!--[--><!--]--><main class="main" data-v-7011f0d8><div style="position:relative;" class="vp-doc _architecture" data-v-7011f0d8><div><h1 id="aster-语言架构文档" tabindex="-1">Aster 语言架构文档 <a class="header-anchor" href="#aster-语言架构文档" aria-label="Permalink to “Aster 语言架构文档”">​</a></h1><blockquote><p>更新时间：2025-10-09 文档范围：编译器架构、LSP架构、数据流与核心模块</p></blockquote><hr><h2 id="概览" tabindex="-1">概览 <a class="header-anchor" href="#概览" aria-label="Permalink to “概览”">​</a></h2><p>Aster 是一种静态类型、面向对象的编程语言，编译到 JVM 字节码。系统架构分为三个主要部分：</p><ol><li><strong>编译管道</strong>（Compiler Pipeline）：源码 → 字节码</li><li><strong>LSP 服务器</strong>（Language Server Protocol）：IDE 支持</li><li><strong>运行时</strong>（Runtime）：JVM 执行环境</li></ol><hr><h2 id="编译管道架构" tabindex="-1">编译管道架构 <a class="header-anchor" href="#编译管道架构" aria-label="Permalink to “编译管道架构”">​</a></h2><h3 id="管道阶段" tabindex="-1">管道阶段 <a class="header-anchor" href="#管道阶段" aria-label="Permalink to “管道阶段”">​</a></h3><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart LR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Source[&quot;.aster 源文件&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Canon[&quot;canonicalize&lt;br/&gt;(Unicode 规范化)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Lex[&quot;lex&lt;br/&gt;(词法分析)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Parse[&quot;parse&lt;br/&gt;(语法分析)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Lower[&quot;lowerModule&lt;br/&gt;(AST → Core IR)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Typecheck[&quot;typecheck&lt;br/&gt;(类型检查)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Emit[&quot;emit&lt;br/&gt;(字节码生成)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Bytecode[&quot;.class 字节码&quot;]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Source --&gt; Canon --&gt; Lex --&gt; Parse --&gt; Lower --&gt; Typecheck --&gt; Emit --&gt; Bytecode</span></span></code></pre></div><h3 id="阶段详解" tabindex="-1">阶段详解 <a class="header-anchor" href="#阶段详解" aria-label="Permalink to “阶段详解”">​</a></h3><table tabindex="0"><thead><tr><th>阶段</th><th>模块</th><th>输入</th><th>输出</th><th>职责</th></tr></thead><tbody><tr><td><strong>Canonicalize</strong></td><td><code>src/canonicalizer.ts</code></td><td>原始文本</td><td>规范化文本</td><td>Unicode NFC 规范化，统一换行符</td></tr><tr><td><strong>Lex</strong></td><td><code>src/lexer.ts</code></td><td>规范化文本</td><td>Token 数组</td><td>词法分析，生成 Token 流</td></tr><tr><td><strong>Parse</strong></td><td><code>src/parser.ts</code></td><td>Token 数组</td><td>AST</td><td>语法分析，构建抽象语法树</td></tr><tr><td><strong>Lower</strong></td><td><code>src/lower_to_core.ts</code></td><td>AST</td><td>Core IR</td><td>降低到核心中间表示，简化后续分析</td></tr><tr><td><strong>Typecheck</strong></td><td><code>src/typecheck.ts</code></td><td>Core IR</td><td>类型标注的 Core IR</td><td>类型推导与检查，effect 验证</td></tr><tr><td><strong>Emit</strong></td><td><code>src/emit.ts</code></td><td>类型标注的 Core IR</td><td>JVM 字节码</td><td>代码生成，输出 .class 文件</td></tr></tbody></table><h3 id="数据结构演进" tabindex="-1">数据结构演进 <a class="header-anchor" href="#数据结构演进" aria-label="Permalink to “数据结构演进”">​</a></h3><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Text[&quot;字符串&lt;br/&gt;(String)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Tokens[&quot;Token 流&lt;br/&gt;(Token[])&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    AST[&quot;抽象语法树&lt;br/&gt;(Ast.Module)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CoreIR[&quot;核心IR&lt;br/&gt;(Core.Module)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Typed[&quot;类型标注IR&lt;br/&gt;(Core.Module + TypeEnv)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Bytecode[&quot;字节码&lt;br/&gt;(Buffer)&quot;]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Text --&gt;|canonicalize| Text2[&quot;规范化字符串&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Text2 --&gt;|lex| Tokens</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Tokens --&gt;|parse| AST</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    AST --&gt;|lowerModule| CoreIR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CoreIR --&gt;|typecheck| Typed</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Typed --&gt;|emit| Bytecode</span></span></code></pre></div><h3 id="cst-concrete-syntax-tree-模式" tabindex="-1">CST（Concrete Syntax Tree）模式 <a class="header-anchor" href="#cst-concrete-syntax-tree-模式" aria-label="Permalink to “CST（Concrete Syntax Tree）模式”">​</a></h3><p>对于格式化和保留注释的场景，使用 <strong>无损 CST</strong> 模式：</p><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart LR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Source[&quot;.aster 源文件&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CSTBuild[&quot;buildCstLossless&lt;br/&gt;(构建无损CST)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CST[&quot;CstModule&lt;br/&gt;(含trivia/comments)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Transform[&quot;transform&lt;br/&gt;(代码修改)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Print[&quot;printCNLFromCst&lt;br/&gt;(重建源码)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Output[&quot;格式化的.aster&quot;]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Source --&gt; CSTBuild --&gt; CST --&gt; Transform --&gt; Print --&gt; Output</span></span></code></pre></div><p><strong>CST 特性</strong>：</p><ul><li>保留所有空白（leading/trailing trivia）</li><li>保留所有注释（inlineComments）</li><li>保留原始文本（fullText）</li><li>支持完美重建（lossless round-trip）</li></ul><hr><h2 id="注释保留机制" tabindex="-1">注释保留机制 <a class="header-anchor" href="#注释保留机制" aria-label="Permalink to “注释保留机制”">​</a></h2><h3 id="设计目标" tabindex="-1">设计目标 <a class="header-anchor" href="#设计目标" aria-label="Permalink to “设计目标”">​</a></h3><p>Aster 语言支持完整的注释保留，确保格式化和重构工具不会丢失用户的注释。注释保留机制的核心设计目标：</p><ol><li><strong>无损保留</strong>：格式化后注释内容和位置完整保留</li><li><strong>类型区分</strong>：区分 inline 注释（代码行末尾）和 standalone 注释（独立行）</li><li><strong>透明处理</strong>：Parser 自动跳过注释，不影响语法分析</li><li><strong>灵活输出</strong>：格式化器可选择保留或移除注释</li></ol><h3 id="注释-token-结构" tabindex="-1">注释 Token 结构 <a class="header-anchor" href="#注释-token-结构" aria-label="Permalink to “注释 Token 结构”">​</a></h3><p>注释在词法分析阶段被识别为特殊的 Token，带有 <code>channel=&#39;trivia&#39;</code> 标记：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  kind</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TokenKind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">COMMENT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    raw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 原始文本（含前缀</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 或 #）</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;          </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 去除前缀的注释文本</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    trivia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;inline&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;standalone&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 注释类型分类</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  start</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Position</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 起始位置（行号、列号）</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  end</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Position</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 结束位置</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  channel</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;trivia&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 标记为 trivia channel</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p><strong>分类规则</strong>：</p><ul><li><strong>inline</strong>：注释前同一行有非空白代码</li><li><strong>standalone</strong>：注释前同一行只有空白或缩进</li></ul><h3 id="处理流程" tabindex="-1">处理流程 <a class="header-anchor" href="#处理流程" aria-label="Permalink to “处理流程”">​</a></h3><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Source[&quot;.aster 源文件&lt;br/&gt;(含注释)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Lex[&quot;lex(text)&lt;br/&gt;词法分析&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CommentToken[&quot;COMMENT Token&lt;br/&gt;(channel=trivia)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Parser[&quot;parse(tokens)&lt;br/&gt;语法分析&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SkipTrivia[&quot;skipTrivia()&lt;br/&gt;自动跳过注释&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    AST[&quot;AST&lt;br/&gt;(不含注释)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CST[&quot;CST&lt;br/&gt;(提取注释)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Format[&quot;formatCNL()&lt;br/&gt;格式化&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Reattach[&quot;reattachInlineComments()&lt;br/&gt;重新附加注释&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Output[&quot;格式化的.aster&lt;br/&gt;(保留注释)&quot;]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Source --&gt; Lex</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Lex --&gt; CommentToken</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CommentToken --&gt; Parser</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Parser --&gt; SkipTrivia</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SkipTrivia --&gt; AST</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CommentToken -.-&gt;|extractInlineComments| CST</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    AST --&gt; Format</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Format --&gt; Reattach</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CST --&gt; Reattach</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Reattach --&gt; Output</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    style CommentToken fill:#e1f5ff</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    style SkipTrivia fill:#fff4e1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    style CST fill:#e1f5ff</span></span></code></pre></div><h3 id="关键实现" tabindex="-1">关键实现 <a class="header-anchor" href="#关键实现" aria-label="Permalink to “关键实现”">​</a></h3><h4 id="_1-词法器-lexer" tabindex="-1">1. 词法器（Lexer） <a class="header-anchor" href="#_1-词法器-lexer" aria-label="Permalink to “1. 词法器（Lexer）”">​</a></h4><p><strong>文件</strong>: <code>src/lexer.ts</code> (lines 99-112)</p><p>词法器在扫描时检测注释并生成 COMMENT Token：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 识别 # 或</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // 注释</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> emitCommentToken</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">prefixLength</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> startPos</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { line, col };</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> raw </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 读取完整注释行</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prefixLength; j</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    raw </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> input.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isLineBreak</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">peek</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    raw </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> body</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> raw.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">slice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(prefixLength).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">^</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> prev</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> findPrevSignificantToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> trivia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev.end.line </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> startPos.line </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;inline&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;standalone&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TokenKind.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">COMMENT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { raw, text: body, trivia }, startPos, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;trivia&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p><strong>关键点</strong>：</p><ul><li>支持 <code>#</code> 和 <code>//</code> 两种注释前缀</li><li>通过 <code>findPrevSignificantToken()</code> 判断注释类型</li><li>设置 <code>channel=&#39;trivia&#39;</code> 标记为非语义 Token</li></ul><h4 id="_2-parser-语法分析器" tabindex="-1">2. Parser（语法分析器） <a class="header-anchor" href="#_2-parser-语法分析器" aria-label="Permalink to “2. Parser（语法分析器）”">​</a></h4><p><strong>文件</strong>: <code>src/parser.ts</code> (lines 43-92)</p><p>Parser 自动跳过 trivia channel 的 Token：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 跳过所有 trivia Token</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">skipTrivia</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ctx.index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.tokens.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tok</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.tokens[ctx.index]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (tok.channel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;trivia&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ctx.index</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// peek() 和 next() 自动调用 skipTrivia()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">peek</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">offset</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">peekToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(offset);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 内部自动跳过 trivia</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tok</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">peek</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ... 移动索引 ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">skipTrivia</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 消费后跳过后续 trivia</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tok;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>关键点</strong>：</p><ul><li>Parser 完全不感知注释的存在</li><li>AST 构建过程不包含注释节点</li><li>保持语法分析逻辑的简洁性</li></ul><h4 id="_3-cst-构建器" tabindex="-1">3. CST 构建器 <a class="header-anchor" href="#_3-cst-构建器" aria-label="Permalink to “3. CST 构建器”">​</a></h4><p><strong>文件</strong>: <code>src/cst_builder.ts</code> (lines 18-47)</p><p>CST 构建时从 Token 流中提取注释：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 从 Token 流提取注释</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> extractInlineComments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tokens</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> readonly</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InlineComment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> out</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InlineComment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tokens) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (t.channel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;trivia&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> t.kind </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;COMMENT&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> commentValue</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> t.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">raw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">trivia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;inline&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;standalone&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        line: t.start.line,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        text: commentValue.raw,         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 保留原始文本（含前缀）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        standalone: commentValue.trivia </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;standalone&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> out;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> buildCst</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">prelexed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> readonly</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CstModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> toks</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prelexed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(text);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cstTokens</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tokensToCstTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(text, toks);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> inlineComments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> extractInlineComments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(toks);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 提取注释</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ... 构建 CST ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, inlineComments };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>关键点</strong>：</p><ul><li><code>tokensToCstTokens</code> 跳过 trivia Token（line 19-21）</li><li><code>extractInlineComments</code> 专门提取注释 Token</li><li>CST 同时包含 tokens（不含注释）和 inlineComments（注释列表）</li></ul><h4 id="_4-格式化器-formatter" tabindex="-1">4. 格式化器（Formatter） <a class="header-anchor" href="#_4-格式化器-formatter" aria-label="Permalink to “4. 格式化器（Formatter）”">​</a></h4><p><strong>文件</strong>: <code>src/formatter.ts</code> (lines 43-75)</p><p>格式化时重新附加注释到输出：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> formatCNL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  preserveComments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  preserveStandaloneComments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> can</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> canonicalize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tokens </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(can);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> originalTokens;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 用于提取注释</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 当保留注释时，词法化原始文本以提取注释 Token</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (opts?.preserveComments) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      originalTokens </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(text);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 注意：使用原始文本而非 canonicalized 文本</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      originalTokens </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 使用 originalTokens 构建 CST 以获取注释</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cst</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> buildCst</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(text, originalTokens </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tokens);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ast</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tokens);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Parser 使用 canonicalized tokens</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> formatted </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> simpleFormatModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ast);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 重新附加注释</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (opts?.preserveComments) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    formatted </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> reattachInlineComments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(text, formatted, cst.inlineComments,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                                       !!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">opts?.preserveStandaloneComments);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> formatted;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>关键点</strong>：</p><ul><li>必须对原始文本（未经 canonicalize）词法化以保留注释</li><li>Parser 使用 canonicalized tokens 确保语法正确性</li><li>CST 使用 originalTokens 提取注释信息</li><li><code>reattachInlineComments</code> 将注释附加到格式化输出</li></ul><h3 id="注释重附加策略" tabindex="-1">注释重附加策略 <a class="header-anchor" href="#注释重附加策略" aria-label="Permalink to “注释重附加策略”">​</a></h3><p><strong>文件</strong>: <code>src/formatter.ts</code> (lines 75-120)</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> reattachInlineComments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  original</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  formatted</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  inline</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> readonly</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InlineComment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  includeStandalone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fmtLines</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> formatted.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">split</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 1. 提取 inline 注释</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> comments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inline?.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">c</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">c.standalone).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">c</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.text) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 2. 逐行附加 inline 注释到非空行</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ci </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fmtLines.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ci </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> comments.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> line</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fmtLines[i]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (line.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trim</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold;">\/\/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(line) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">^|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\s</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">)#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(line)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 避免重复</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fmtLines[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> line.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">[ \t]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;  &#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> comments[ci]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ci</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 3. 插入 standalone 注释（可选）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (includeStandalone) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> standalone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inline?.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">c</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.standalone).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">c</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.text) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> si </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 第一个 standalone 插入到顶部</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> firstNonEmpty</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fmtLines.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findIndex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">l</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> l.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trim</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (firstNonEmpty </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> si </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> standalone.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fmtLines.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">splice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(firstNonEmpty, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, standalone[si]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      si</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 中间的 standalone 插入到缩进行之后</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> firstIndented</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fmtLines.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">findIndex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">l</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">^</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\S</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(l));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (si </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> standalone.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> firstIndented </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fmtLines.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">splice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(firstIndented </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, standalone[si]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      si</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 最后一个 standalone 插入到末尾</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (si </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> standalone.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fmtLines.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(standalone[si]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fmtLines.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>重附加策略</strong>：</p><ol><li><strong>Inline 注释</strong>：按顺序附加到格式化后的非空行末尾</li><li><strong>Standalone 注释</strong>： <ul><li>第一个：插入到文件顶部（模块头之前）</li><li>中间的：插入到第一个缩进行之后（函数体内）</li><li>最后一个：插入到文件末尾</li></ul></li></ol><h3 id="示例" tabindex="-1">示例 <a class="header-anchor" href="#示例" aria-label="Permalink to “示例”">​</a></h3><h4 id="输入-含注释" tabindex="-1">输入（含注释） <a class="header-anchor" href="#输入-含注释" aria-label="Permalink to “输入（含注释）”">​</a></h4><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">This </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">module</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> is</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> demo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">comments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Standalone</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> comment</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> at</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> top</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">To</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> greet</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> with</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">produce</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// inline comment after header</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  Let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> be</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">concat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Hi, &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// say hi</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  Return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Standalone</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> comment</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> at</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bottom</span></span></code></pre></div><h4 id="处理流程-1" tabindex="-1">处理流程 <a class="header-anchor" href="#处理流程-1" aria-label="Permalink to “处理流程”">​</a></h4><ol><li><strong>词法分析</strong>：生成 3 个 COMMENT Token（2 个 standalone，1 个 inline）</li><li><strong>语法分析</strong>：跳过 COMMENT Token，构建 AST（不含注释）</li><li><strong>CST 构建</strong>：提取 3 个 InlineComment 对象</li><li><strong>格式化</strong>：重新排版代码</li><li><strong>重附加注释</strong>： <ul><li>Inline 注释附加到 <code>To greet...</code> 行</li><li>Standalone 注释插入到顶部和底部</li></ul></li></ol><h4 id="输出-保留注释" tabindex="-1">输出（保留注释） <a class="header-anchor" href="#输出-保留注释" aria-label="Permalink to “输出（保留注释）”">​</a></h4><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># Standalone comment at top</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">This </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">module</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> is</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> demo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">comments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">To</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> greet</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> with</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">produce</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// inline comment after header</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  Let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> be</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">concat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Hi, &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  Return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Standalone</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> comment</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> at</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bottom</span></span></code></pre></div><h3 id="相关文件" tabindex="-1">相关文件 <a class="header-anchor" href="#相关文件" aria-label="Permalink to “相关文件”">​</a></h3><ul><li><strong>词法器</strong>: <code>src/lexer.ts</code> - 注释 Token 生成</li><li><strong>Parser</strong>: <code>src/parser.ts</code> - 自动跳过 trivia</li><li><strong>CST 构建器</strong>: <code>src/cst_builder.ts</code> - 提取注释</li><li><strong>格式化器</strong>: <code>src/formatter.ts</code> - 重附加注释</li><li><strong>类型定义</strong>: <code>src/types.ts</code> - Token 和 InlineComment 类型</li><li><strong>测试</strong>: <code>test/property.test.ts</code> (lines 104-211) - 注释 Token 属性测试</li><li><strong>黄金测试</strong>: <code>test/comments/golden/</code> - 注释保留端到端测试</li><li><strong>测试脚本</strong>: <code>scripts/test-comments-golden.ts</code> - 黄金测试执行器</li></ul><h3 id="设计决策" tabindex="-1">设计决策 <a class="header-anchor" href="#设计决策" aria-label="Permalink to “设计决策”">​</a></h3><h4 id="为什么使用-trivia-channel" tabindex="-1">为什么使用 trivia channel？ <a class="header-anchor" href="#为什么使用-trivia-channel" aria-label="Permalink to “为什么使用 trivia channel？”">​</a></h4><p><strong>优点</strong>：</p><ul><li>Parser 逻辑简洁，完全不感知注释</li><li>注释不污染 AST 结构</li><li>符合编译器设计最佳实践（参考 Roslyn、TypeScript）</li></ul><p><strong>权衡</strong>：</p><ul><li>需要单独的注释提取逻辑</li><li>重附加策略可能不完美（best-effort）</li></ul><h4 id="为什么区分-inline-和-standalone" tabindex="-1">为什么区分 inline 和 standalone？ <a class="header-anchor" href="#为什么区分-inline-和-standalone" aria-label="Permalink to “为什么区分 inline 和 standalone？”">​</a></h4><p><strong>原因</strong>：</p><ul><li>Inline 注释通常是代码解释，应保持在对应行</li><li>Standalone 注释通常是章节分隔或大段说明，位置更灵活</li><li>不同类型的注释需要不同的重附加策略</li></ul><h4 id="为什么格式化器对原始文本词法化" tabindex="-1">为什么格式化器对原始文本词法化？ <a class="header-anchor" href="#为什么格式化器对原始文本词法化" aria-label="Permalink to “为什么格式化器对原始文本词法化？”">​</a></h4><p><strong>原因</strong>：</p><ul><li><code>canonicalize()</code> 会规范化文本，可能影响注释识别</li><li>必须从原始文本中提取注释以保证完整性</li><li>Parser 仍使用 canonicalized tokens 确保语法正确</li></ul><hr><h2 id="异步纪律检查" tabindex="-1">异步纪律检查 <a class="header-anchor" href="#异步纪律检查" aria-label="Permalink to “异步纪律检查”">​</a></h2><h3 id="设计目标-1" tabindex="-1">设计目标 <a class="header-anchor" href="#设计目标-1" aria-label="Permalink to “设计目标”">​</a></h3><p>Aster 语言的异步编程模型要求严格的任务管理纪律，确保所有异步任务正确启动和等待，避免悬挂任务、重复启动等常见错误。异步纪律检查的核心设计目标：</p><ol><li><strong>完整性保证</strong>：确保每个 <code>Start</code> 的任务都被 <code>Wait</code>，每个 <code>Wait</code> 的任务都已 <code>Start</code></li><li><strong>错误检测</strong>：在编译期检测重复启动、重复等待等错误模式</li><li><strong>清晰诊断</strong>：提供详细的错误信息，包含任务名称、出现次数和建议修复方式</li><li><strong>控制流分析</strong>：基于控制流图（CFG）分析所有可能执行路径</li></ol><h3 id="检查规则" tabindex="-1">检查规则 <a class="header-anchor" href="#检查规则" aria-label="Permalink to “检查规则”">​</a></h3><table tabindex="0"><thead><tr><th>错误类型</th><th>代码</th><th>严重级别</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td><strong>Start 未 Wait</strong></td><td><code>ASYNC_START_NOT_WAITED</code></td><td><code>error</code></td><td>启动的异步任务未被等待，可能导致悬挂任务</td><td><code>Start profile as async fetchProfile(id).</code> 但函数结束前未 <code>Wait for profile</code></td></tr><tr><td><strong>Wait 未 Start</strong></td><td><code>ASYNC_WAIT_NOT_STARTED</code></td><td><code>error</code></td><td>等待的任务从未启动，导致死锁</td><td><code>Wait for profile.</code> 但从未 <code>Start profile</code></td></tr><tr><td><strong>重复 Start</strong></td><td><code>ASYNC_DUPLICATE_START</code></td><td><code>error</code></td><td>同一任务被启动多次，导致资源泄漏</td><td><code>Start profile ...</code> 出现 2 次或以上</td></tr><tr><td><strong>重复 Wait</strong></td><td><code>ASYNC_DUPLICATE_WAIT</code></td><td><code>warning</code></td><td>同一任务被等待多次，虽然安全但通常是逻辑错误</td><td><code>Wait for profile.</code> 出现 2 次或以上</td></tr></tbody></table><p><strong>检查触发条件</strong>：</p><ul><li>函数包含至少一个 <code>Start</code> 或 <code>Wait</code> 语句</li><li>在类型检查阶段的 <code>collectAsync</code> 函数中执行</li></ul><h3 id="检查流程" tabindex="-1">检查流程 <a class="header-anchor" href="#检查流程" aria-label="Permalink to “检查流程”">​</a></h3><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Typecheck as typecheckModule</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant CollectAsync as collectAsync</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant CFG as 控制流分析</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Merge as 合并检查</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Typecheck-&gt;&gt;CollectAsync: checkFunction(func)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Note over CollectAsync: 第1步：收集异步语句</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CollectAsync-&gt;&gt;CollectAsync: 遍历函数体</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CollectAsync-&gt;&gt;CollectAsync: 记录每个 Start 语句</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CollectAsync-&gt;&gt;CollectAsync: 记录每个 Wait 语句</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Note over CollectAsync: 第2步：初始化统计</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CollectAsync-&gt;&gt;CollectAsync: started = new Map()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CollectAsync-&gt;&gt;CollectAsync: waited = new Map()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CollectAsync-&gt;&gt;CFG: 遍历语句记录统计</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    loop 每个 Start 语句</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        CFG-&gt;&gt;CFG: started.set(taskName, count++)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    loop 每个 Wait 语句</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        CFG-&gt;&gt;CFG: waited.set(taskName, count++)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Note over Merge: 第3步：错误检查</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CollectAsync-&gt;&gt;Merge: 检查 Start 未 Wait</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    loop started 中的任务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        alt 任务未在 waited 中</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Merge-&gt;&gt;Merge: 生成 ASYNC_START_NOT_WAITED error</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CollectAsync-&gt;&gt;Merge: 检查 Wait 未 Start</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    loop waited 中的任务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        alt 任务未在 started 中</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Merge-&gt;&gt;Merge: 生成 ASYNC_WAIT_NOT_STARTED error</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CollectAsync-&gt;&gt;Merge: 检查重复 Start</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    loop started 中的任务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        alt 出现次数 &gt; 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Merge-&gt;&gt;Merge: 生成 ASYNC_DUPLICATE_START error</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CollectAsync-&gt;&gt;Merge: 检查重复 Wait</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    loop waited 中的任务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        alt 出现次数 &gt; 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Merge-&gt;&gt;Merge: 生成 ASYNC_DUPLICATE_WAIT warning</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Merge--&gt;&gt;CollectAsync: 诊断列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CollectAsync--&gt;&gt;Typecheck: 返回诊断</span></span></code></pre></div><h3 id="关键实现-1" tabindex="-1">关键实现 <a class="header-anchor" href="#关键实现-1" aria-label="Permalink to “关键实现”">​</a></h3><h4 id="_1-collectasync-函数结构" tabindex="-1">1. collectAsync 函数结构 <a class="header-anchor" href="#_1-collectasync-函数结构" aria-label="Permalink to “1. collectAsync 函数结构”">​</a></h4><p><strong>文件</strong>: <code>src/typecheck.ts</code> (lines 1489-1606)</p><p><code>collectAsync</code> 函数负责收集异步语句并进行纪律检查：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> collectAsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  body</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Block</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TypeEnv</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  diags</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Diagnostic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AsyncInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> starts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AsyncStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> waits</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WaitExpr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 第1步：收集所有 Start 和 Wait 语句</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> visit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Stmt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (s.kind) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Start&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        starts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Wait&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        waits.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;If&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        s.thenBlock.statements.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(visit);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        s.elseBlock?.statements.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(visit);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Match&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        s.cases.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">c</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.body.statements.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(visit));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Block&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        s.statements.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(visit);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  body.statements.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(visit);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 第2步：统计每个任务的启动和等待次数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> started</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> waited</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> st</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> starts) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    started.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(st.name, (started.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(st.name) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> wt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> waits) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> wt.names) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      waited.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name, (waited.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 第3步：错误检查</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  checkAsyncDiscipline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(started, waited, starts, waits, diags);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { starts, waits };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>关键点</strong>：</p><ul><li>使用递归 <code>visit</code> 函数遍历所有控制流分支（If/Match/Block）</li><li>使用 <code>Map&lt;string, number&gt;</code> 统计每个任务名的出现次数</li><li>错误检查函数 <code>checkAsyncDiscipline</code> 集中处理所有 4 种错误类型</li></ul><h4 id="_2-错误检查逻辑" tabindex="-1">2. 错误检查逻辑 <a class="header-anchor" href="#_2-错误检查逻辑" aria-label="Permalink to “2. 错误检查逻辑”">​</a></h4><p><strong>文件</strong>: <code>src/typecheck.ts</code> (lines 1550-1606)</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> checkAsyncDiscipline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  started</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  waited</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  starts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AsyncStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  waits</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WaitExpr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  diags</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Diagnostic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 检查1：Start 未 Wait</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">_count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> started) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">waited.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> st</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> starts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">find</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s.name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      diags.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        severity: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        code: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ASYNC_START_NOT_WAITED&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        message: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`Async task &quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot; was started but not waited`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        span: st?.span,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 检查2：Wait 未 Start</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">_count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> waited) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">started.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> wt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> waits.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">find</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">w</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> w.names.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      diags.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        severity: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        code: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ASYNC_WAIT_NOT_STARTED&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        message: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`Async task &quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot; was never started`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        span: wt?.span,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 检查3：重复 Start（error）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> started) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      diags.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        severity: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        code: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ASYNC_DUPLICATE_START&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        message: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`Async task &quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot; was started multiple times (${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">count</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} times)`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 检查4：重复 Wait（warning）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> waited) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      diags.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        severity: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;warning&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        code: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ASYNC_DUPLICATE_WAIT&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        message: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`Async task &quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot; was waited multiple times (${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">count</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} times)`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>关键点</strong>：</p><ul><li>使用 <code>Map.has()</code> 检查任务是否存在于另一组</li><li>使用 <code>count &gt; 1</code> 检测重复操作</li><li>错误附带任务名称和出现次数，便于调试</li><li><code>span</code> 字段指向错误发生的源码位置</li></ul><h4 id="_3-控制流分支处理" tabindex="-1">3. 控制流分支处理 <a class="header-anchor" href="#_3-控制流分支处理" aria-label="Permalink to “3. 控制流分支处理”">​</a></h4><p><strong>支持的控制流结构</strong>：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// If 语句：检查两个分支</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;If&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  s.thenBlock.statements.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(visit);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  s.elseBlock?.statements.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(visit);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Match 表达式：检查所有 case 分支</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Match&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  s.cases.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">c</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.body.statements.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(visit));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Block：递归检查嵌套块</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Block&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  s.statements.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(visit);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p><strong>局限性</strong>：</p><ul><li>当前实现采用保守策略（union semantics）：任何分支的 Start/Wait 都计入统计</li><li>不区分分支执行的互斥性（例如 <code>if/else</code> 只执行一个分支）</li><li>未来改进方向：引入路径敏感分析（path-sensitive analysis）</li></ul><h3 id="示例-1" tabindex="-1">示例 <a class="header-anchor" href="#示例-1" aria-label="Permalink to “示例”">​</a></h3><h4 id="正常场景-单个-start-wait-对" tabindex="-1">正常场景：单个 Start-Wait 对 <a class="header-anchor" href="#正常场景-单个-start-wait-对" aria-label="Permalink to “正常场景：单个 Start-Wait 对”">​</a></h4><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">To fetchData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: User, produce Text. It performs </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">io</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Start profile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchProfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Wait for profile.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Return </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span></code></pre></div><p><strong>检查结果</strong>：</p><ul><li><code>started = { profile: 1 }</code></li><li><code>waited = { profile: 1 }</code></li><li>✅ 无错误</li></ul><h4 id="错误场景1-start-未-wait" tabindex="-1">错误场景1：Start 未 Wait <a class="header-anchor" href="#错误场景1-start-未-wait" aria-label="Permalink to “错误场景1：Start 未 Wait”">​</a></h4><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">To fetchData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: User, produce Text. It performs </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">io</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Start profile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchProfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Return </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 忘记 Wait</span></span></code></pre></div><p><strong>诊断输出</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>error[ASYNC_START_NOT_WAITED]: Async task &quot;profile&quot; was started but not waited</span></span>
<span class="line"><span>  --&gt; src/demo.aster:3:3</span></span>
<span class="line"><span>   |</span></span>
<span class="line"><span> 3 |   Start profile as async fetchProfile(u.id).</span></span>
<span class="line"><span>   |   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ task started here</span></span></code></pre></div><h4 id="错误场景2-wait-未-start" tabindex="-1">错误场景2：Wait 未 Start <a class="header-anchor" href="#错误场景2-wait-未-start" aria-label="Permalink to “错误场景2：Wait 未 Start”">​</a></h4><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">To fetchData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: User, produce Text. It performs </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">io</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Wait for profile.  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 从未 Start</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Return </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span></code></pre></div><p><strong>诊断输出</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>error[ASYNC_WAIT_NOT_STARTED]: Async task &quot;profile&quot; was never started</span></span>
<span class="line"><span>  --&gt; src/demo.aster:2:3</span></span>
<span class="line"><span>   |</span></span>
<span class="line"><span> 2 |   Wait for profile.</span></span>
<span class="line"><span>   |   ^^^^^^^^^^^^^^^^^ waiting for never-started task</span></span></code></pre></div><h4 id="错误场景3-重复-start" tabindex="-1">错误场景3：重复 Start <a class="header-anchor" href="#错误场景3-重复-start" aria-label="Permalink to “错误场景3：重复 Start”">​</a></h4><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">To fetchData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: User, produce Text. It performs </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">io</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Start profile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchProfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Start profile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchProfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 重复启动</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Wait for profile.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Return </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span></code></pre></div><p><strong>诊断输出</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>error[ASYNC_DUPLICATE_START]: Async task &quot;profile&quot; was started multiple times (2 times)</span></span>
<span class="line"><span>  --&gt; src/demo.aster:2:3</span></span></code></pre></div><h4 id="错误场景4-重复-wait-警告" tabindex="-1">错误场景4：重复 Wait（警告） <a class="header-anchor" href="#错误场景4-重复-wait-警告" aria-label="Permalink to “错误场景4：重复 Wait（警告）”">​</a></h4><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">To fetchData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: User, produce Text. It performs </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">io</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Start profile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchProfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Wait for profile.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Wait for profile.  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 重复等待</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Return </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span></code></pre></div><p><strong>诊断输出</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>warning[ASYNC_DUPLICATE_WAIT]: Async task &quot;profile&quot; was waited multiple times (2 times)</span></span>
<span class="line"><span>  --&gt; src/demo.aster:3:3</span></span></code></pre></div><h4 id="混合错误场景" tabindex="-1">混合错误场景 <a class="header-anchor" href="#混合错误场景" aria-label="Permalink to “混合错误场景”">​</a></h4><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">To fetchData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: User, produce Text. It performs </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">io</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Start profile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchProfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Start profile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchProfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 错误1：重复 Start</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Start timeline </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchTimeline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 错误2：未 Wait</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Wait for profile.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Wait for profile.  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 错误3：重复 Wait</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Wait for settings.  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 错误4：未 Start</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Return </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span></span></code></pre></div><p><strong>诊断输出</strong>（4 个错误）：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>error[ASYNC_START_NOT_WAITED]: Async task &quot;timeline&quot; was started but not waited</span></span>
<span class="line"><span>error[ASYNC_WAIT_NOT_STARTED]: Async task &quot;settings&quot; was never started</span></span>
<span class="line"><span>error[ASYNC_DUPLICATE_START]: Async task &quot;profile&quot; was started multiple times (2 times)</span></span>
<span class="line"><span>warning[ASYNC_DUPLICATE_WAIT]: Async task &quot;profile&quot; was waited multiple times (2 times)</span></span></code></pre></div><h3 id="相关文件-1" tabindex="-1">相关文件 <a class="header-anchor" href="#相关文件-1" aria-label="Permalink to “相关文件”">​</a></h3><ul><li><strong>类型检查器</strong>: <code>src/typecheck.ts</code> (lines 1489-1606) - <code>collectAsync</code> 函数与错误检查逻辑</li><li><strong>类型定义</strong>: <code>src/types.ts</code> - <code>AsyncInfo</code>、<code>AsyncStart</code>、<code>WaitExpr</code> 类型定义</li><li><strong>测试文件</strong>: <code>test/async-discipline.test.ts</code> - 12 个测试用例覆盖所有错误类型</li><li><strong>示例代码</strong>: <code>test/cnl/examples/</code> - 异步编程示例（未包含负例）</li></ul><h3 id="设计决策-1" tabindex="-1">设计决策 <a class="header-anchor" href="#设计决策-1" aria-label="Permalink to “设计决策”">​</a></h3><h4 id="为什么采用保守策略-union-semantics" tabindex="-1">为什么采用保守策略（union semantics）？ <a class="header-anchor" href="#为什么采用保守策略-union-semantics" aria-label="Permalink to “为什么采用保守策略（union semantics）？”">​</a></h4><p><strong>原因</strong>：</p><ul><li>简化实现，避免复杂的路径分析</li><li>保守策略安全：宁可误报（false positive）也不漏报（false negative）</li><li>适用于大多数实际场景（开发者通常不会在分支中启动同名任务）</li></ul><p><strong>权衡</strong>：</p><ul><li>可能产生误报，例如：<div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">If condition,:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Start task1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Otherwise,:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Start task2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Wait for task1 or task2.  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 当前实现会报错 task1 和 task2 都未等待</span></span></code></pre></div></li><li>未来可引入路径敏感分析改进</li></ul><h4 id="为什么重复-wait-是-warning-而非-error" tabindex="-1">为什么重复 Wait 是 warning 而非 error？ <a class="header-anchor" href="#为什么重复-wait-是-warning-而非-error" aria-label="Permalink to “为什么重复 Wait 是 warning 而非 error？”">​</a></h4><p><strong>原因</strong>：</p><ul><li>重复等待语义上安全（第二次 Wait 立即返回已完成的结果）</li><li>可能是合理的编程模式（例如在不同分支中等待）</li><li>但通常是逻辑错误（复制粘贴错误），值得警告</li></ul><p><strong>权衡</strong>：</p><ul><li>如果未来支持&quot;等待新结果&quot;语义，需要升级为 error</li></ul><h4 id="为什么在编译期检查而非运行时检查" tabindex="-1">为什么在编译期检查而非运行时检查？ <a class="header-anchor" href="#为什么在编译期检查而非运行时检查" aria-label="Permalink to “为什么在编译期检查而非运行时检查？”">​</a></h4><p><strong>原因</strong>：</p><ul><li>编译期检查成本为零，无运行时开销</li><li>及早发现错误，避免生产环境问题</li><li>提供更清晰的错误信息（源码位置、任务名称）</li></ul><p><strong>权衡</strong>：</p><ul><li>需要静态分析所有控制流路径</li><li>无法检测运行时动态生成的任务名</li></ul><h3 id="限制与未来改进" tabindex="-1">限制与未来改进 <a class="header-anchor" href="#限制与未来改进" aria-label="Permalink to “限制与未来改进”">​</a></h3><h4 id="当前限制" tabindex="-1">当前限制 <a class="header-anchor" href="#当前限制" aria-label="Permalink to “当前限制”">​</a></h4><ol><li><p><strong>不支持路径敏感分析</strong>：</p><ul><li>无法识别互斥分支（if/else）</li><li>无法识别必然执行路径</li></ul></li><li><p><strong>不支持循环内异步任务</strong>：</p><ul><li><code>For Each</code> 循环中的 Start/Wait 未正确分析</li><li>当前实现会计数所有迭代的累加</li></ul></li><li><p><strong>不支持动态任务名</strong>：</p><ul><li>任务名必须是字面量字符串</li><li>无法检查运行时构造的任务名</li></ul></li><li><p><strong>缺少跨函数分析</strong>：</p><ul><li>仅检查单个函数内的异步纪律</li><li>无法检测调用链中的任务传递</li></ul></li></ol><h4 id="未来改进方向" tabindex="-1">未来改进方向 <a class="header-anchor" href="#未来改进方向" aria-label="Permalink to “未来改进方向”">​</a></h4><ol><li><p><strong>路径敏感分析</strong>：</p><ul><li>引入控制流图（CFG）+ 数据流分析</li><li>区分必然执行路径和可能执行路径</li><li>参考 Rust 的借用检查器（borrow checker）</li></ul></li><li><p><strong>循环分析</strong>：</p><ul><li>检测循环不变量（loop invariants）</li><li>检测循环终止后的任务完整性</li></ul></li><li><p><strong>过程间分析</strong>（Inter-procedural Analysis）：</p><ul><li>跨函数传递异步任务状态</li><li>检测任务泄漏到调用者</li></ul></li><li><p><strong>增强诊断信息</strong>：</p><ul><li>显示任务的启动和等待位置</li><li>提供修复建议（Quick Fix）</li><li>集成到 LSP Code Action</li></ul></li></ol><hr><h2 id="lsp-服务器架构" tabindex="-1">LSP 服务器架构 <a class="header-anchor" href="#lsp-服务器架构" aria-label="Permalink to “LSP 服务器架构”">​</a></h2><h3 id="服务器启动流程" tabindex="-1">服务器启动流程 <a class="header-anchor" href="#服务器启动流程" aria-label="Permalink to “服务器启动流程”">​</a></h3><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Client as IDE/编辑器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Server as LSP Server</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Index as WorkspaceIndex</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Checker as Typecheck</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: initialize(rootUri)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server-&gt;&gt;Index: buildInitialIndex(rootUri)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Index-&gt;&gt;Index: 扫描 .aster 文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Index-&gt;&gt;Index: 构建模块依赖图</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Index--&gt;&gt;Server: WorkspaceIndex</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server--&gt;&gt;Client: initializeResult</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: initialized()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Note over Server: 服务器就绪</span></span></code></pre></div><h3 id="文档变更流程" tabindex="-1">文档变更流程 <a class="header-anchor" href="#文档变更流程" aria-label="Permalink to “文档变更流程”">​</a></h3><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Client as IDE/编辑器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Server as LSP Server</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Checker as Typecheck</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: textDocument/didOpen</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server-&gt;&gt;Server: 更新内存缓存</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server-&gt;&gt;Checker: typecheck(module)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Checker--&gt;&gt;Server: Diagnostics</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server-&gt;&gt;Client: textDocument/publishDiagnostics</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: textDocument/didChange</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server-&gt;&gt;Server: 更新内存缓存</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server-&gt;&gt;Checker: typecheck(module)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Checker--&gt;&gt;Server: Diagnostics</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server-&gt;&gt;Client: textDocument/publishDiagnostics</span></span></code></pre></div><h3 id="hover-请求流程" tabindex="-1">Hover 请求流程 <a class="header-anchor" href="#hover-请求流程" aria-label="Permalink to “Hover 请求流程”">​</a></h3><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Client as IDE/编辑器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Server as LSP Server</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Analysis as LSP Analysis</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: textDocument/hover(position)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server-&gt;&gt;Analysis: findSymbolAt(position)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Analysis-&gt;&gt;Analysis: 解析 Token 流</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Analysis-&gt;&gt;Analysis: 查找符号定义</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Analysis--&gt;&gt;Server: SymbolInfo</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server-&gt;&gt;Server: 构建 Markdown 文档</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server--&gt;&gt;Client: HoverResult(markdown)</span></span></code></pre></div><h3 id="code-action-流程" tabindex="-1">Code Action 流程 <a class="header-anchor" href="#code-action-流程" aria-label="Permalink to “Code Action 流程”">​</a></h3><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Client as IDE/编辑器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Server as LSP Server</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Actions as Code Actions</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: textDocument/codeAction(range, diagnostics)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server-&gt;&gt;Actions: computeActions(diagnostics)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    alt Ambiguous Interop Call</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Actions-&gt;&gt;Actions: computeDisambiguationEdits()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Actions--&gt;&gt;Server: [WorkspaceEdit (add .0)]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    else Missing Module Header</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Actions-&gt;&gt;Actions: generateModuleHeader()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Actions--&gt;&gt;Server: [WorkspaceEdit (insert header)]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    else Effect Violation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Actions-&gt;&gt;Actions: suggestCapabilityAnnotation()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Actions--&gt;&gt;Server: [WorkspaceEdit (add @io)]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server--&gt;&gt;Client: CodeAction[]</span></span></code></pre></div><h3 id="lsp-模块组织" tabindex="-1">LSP 模块组织 <a class="header-anchor" href="#lsp-模块组织" aria-label="Permalink to “LSP 模块组织”">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>src/lsp/</span></span>
<span class="line"><span>├── server.ts              # LSP 主服务器（协议处理）</span></span>
<span class="line"><span>├── workspace_index.ts     # 工作空间索引（文件监控）</span></span>
<span class="line"><span>├── analysis.ts            # 代码分析工具</span></span>
<span class="line"><span>│   ├── findSymbolAt()     # 符号查找</span></span>
<span class="line"><span>│   ├── findReferences()   # 引用查找</span></span>
<span class="line"><span>│   └── findDottedCallAt() # Interop 调用分析</span></span>
<span class="line"><span>└── capabilities.ts        # LSP 能力声明</span></span></code></pre></div><hr><h2 id="类型系统架构" tabindex="-1">类型系统架构 <a class="header-anchor" href="#类型系统架构" aria-label="Permalink to “类型系统架构”">​</a></h2><h3 id="类型推导流程" tabindex="-1">类型推导流程 <a class="header-anchor" href="#类型推导流程" aria-label="Permalink to “类型推导流程”">​</a></h3><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Start[&quot;开始类型检查&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CollectDecls[&quot;收集声明&lt;br/&gt;(函数/类型/常量)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    BuildEnv[&quot;构建类型环境&lt;br/&gt;(TypeEnv)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CheckFunc[&quot;检查每个函数&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    InferExpr[&quot;推导表达式类型&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UnifyTypes[&quot;类型统一&lt;br/&gt;(unifyTypes)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CheckEffects[&quot;Effect 检查&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    EmitDiags[&quot;生成诊断信息&quot;]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Start --&gt; CollectDecls --&gt; BuildEnv --&gt; CheckFunc</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CheckFunc --&gt; InferExpr --&gt; UnifyTypes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UnifyTypes --&gt; CheckEffects --&gt; EmitDiags</span></span></code></pre></div><h3 id="effect-系统" tabindex="-1">Effect 系统 <a class="header-anchor" href="#effect-系统" aria-label="Permalink to “Effect 系统”">​</a></h3><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flowchart LR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Pure[&quot;Pure&lt;br/&gt;(无副作用)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    IO[&quot;@io&lt;br/&gt;(IO 操作)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Files[&quot;@files&lt;br/&gt;(文件访问)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Http[&quot;@http&lt;br/&gt;(网络请求)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Sql[&quot;@sql&lt;br/&gt;(数据库)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Secrets[&quot;@secrets&lt;br/&gt;(密钥访问)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Ai[&quot;@ai&lt;br/&gt;(AI 调用)&quot;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Cpu[&quot;@cpu&lt;br/&gt;(CPU 密集)&quot;]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Pure -.-&gt;|调用| Pure</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    IO -.-&gt;|调用| Files</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    IO -.-&gt;|调用| Http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Files --&gt;|违规| Http</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Http --&gt;|违规| Sql</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Secrets --&gt;|违规| Ai</span></span></code></pre></div><p><strong>Effect 检查规则</strong>：</p><ol><li>Pure 函数不能调用有副作用的函数</li><li>具有细粒度 effect（如 <code>@files</code>）的函数不能调用更广泛的 effect（如 <code>@http</code>）</li><li>Effect 传递性：调用者必须声明被调用函数的所有 effect</li><li>可通过环境变量 <code>ASTER_CAP_EFFECTS_ENFORCE=1</code> 开启严格检查</li></ol><hr><h2 id="关键模块详解" tabindex="-1">关键模块详解 <a class="header-anchor" href="#关键模块详解" aria-label="Permalink to “关键模块详解”">​</a></h2><h3 id="_1-canonicalizer-规范化器" tabindex="-1">1. Canonicalizer（规范化器） <a class="header-anchor" href="#_1-canonicalizer-规范化器" aria-label="Permalink to “1. Canonicalizer（规范化器）”">​</a></h3><p><strong>文件</strong>: <code>src/canonicalizer.ts</code></p><p><strong>职责</strong>：</p><ul><li>Unicode NFC 规范化（统一字符编码）</li><li>换行符统一（CRLF → LF）</li><li>BOM 处理</li></ul><p><strong>特性</strong>：</p><ul><li><strong>幂等性</strong>：多次规范化结果相同</li><li><strong>性能</strong>：使用 String.normalize(&#39;NFC&#39;)，Small 项目 ~0.03ms</li></ul><h3 id="_2-lexer-词法分析器" tabindex="-1">2. Lexer（词法分析器） <a class="header-anchor" href="#_2-lexer-词法分析器" aria-label="Permalink to “2. Lexer（词法分析器）”">​</a></h3><p><strong>文件</strong>: <code>src/lexer.ts</code></p><p><strong>职责</strong>：</p><ul><li>将文本切分为 Token 流</li><li>识别关键字、标识符、字面量、运算符</li><li>处理缩进（Python 风格）</li></ul><p><strong>Token 类型</strong>：</p><ul><li>关键字：<code>To</code>, <code>Define</code>, <code>Return</code>, <code>Let</code>, <code>Match</code>, <code>For Each</code>, <code>Start</code>, <code>Wait</code></li><li>标识符：<code>IDENT</code> (小写开头), <code>TYPE_IDENT</code> (大写开头)</li><li>字面量：<code>INT</code>, <code>STRING</code>, <code>BOOL</code></li><li>运算符：<code>=</code>, <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>and</code>, <code>or</code>, <code>not</code></li><li>结构：<code>INDENT</code>, <code>DEDENT</code>, <code>NEWLINE</code>, <code>EOF</code></li></ul><p><strong>性能</strong>：Small 项目 ~0.03ms</p><h3 id="_3-parser-语法分析器" tabindex="-1">3. Parser（语法分析器） <a class="header-anchor" href="#_3-parser-语法分析器" aria-label="Permalink to “3. Parser（语法分析器）”">​</a></h3><p><strong>文件</strong>: <code>src/parser.ts</code></p><p><strong>职责</strong>：</p><ul><li>将 Token 流解析为 AST</li><li>语法错误检测</li><li>泛型解析（<code>To identity of T</code>）</li></ul><p><strong>AST 节点类型</strong>：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 模块级</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Module</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">kind</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Module&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">decls</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Decl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 声明</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Decl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FuncDecl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DataDecl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SumDecl</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 表达式</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Expr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LiteralExpr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VarExpr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CallExpr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IfExpr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MatchExpr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ForExpr</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 语句</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Stmt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LetStmt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReturnStmt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StartStmt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> WaitStmt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ExprStmt</span></span></code></pre></div><p><strong>性能</strong>：Small 项目 ~0.12ms</p><h3 id="_4-lower-ir-降低器" tabindex="-1">4. Lower（IR 降低器） <a class="header-anchor" href="#_4-lower-ir-降低器" aria-label="Permalink to “4. Lower（IR 降低器）”">​</a></h3><p><strong>文件</strong>: <code>src/lower_to_core.ts</code></p><p><strong>职责</strong>：</p><ul><li>AST → Core IR 转换</li><li>语法糖脱糖（desugaring）</li><li>简化表达式结构</li></ul><p><strong>Core IR 特性</strong>：</p><ul><li>统一的表达式表示</li><li>明确的类型标注位置</li><li>消除语法糖（如 <code>Match</code> 表达式展开）</li></ul><p><strong>性能</strong>：Small 项目 ~0.06ms</p><h3 id="_5-typecheck-类型检查器" tabindex="-1">5. Typecheck（类型检查器） <a class="header-anchor" href="#_5-typecheck-类型检查器" aria-label="Permalink to “5. Typecheck（类型检查器）”">​</a></h3><p><strong>文件</strong>: <code>src/typecheck.ts</code></p><p><strong>职责</strong>：</p><ul><li>类型推导（Hindley-Milner 风格）</li><li>类型统一（unifyTypes）</li><li>Effect 验证</li><li>泛型约束检查</li></ul><p><strong>类型环境（TypeEnv）</strong>：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TypeEnv</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  vars</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  funcs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FuncSignature</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  types</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DataType</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SumType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  lookup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Type</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  bind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Core</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>诊断信息</strong>：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Diagnostic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  severity</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;error&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;warning&#39;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  span</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Span</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>性能</strong>：Small 项目完整管道 ~0.28ms</p><h3 id="_6-emit-代码生成器" tabindex="-1">6. Emit（代码生成器） <a class="header-anchor" href="#_6-emit-代码生成器" aria-label="Permalink to “6. Emit（代码生成器）”">​</a></h3><p><strong>文件</strong>: <code>src/emit.ts</code></p><p><strong>职责</strong>：</p><ul><li>Core IR → JVM 字节码</li><li>类型映射（Aster → JVM）</li><li>字节码优化</li></ul><p><strong>类型映射</strong>：</p><ul><li><code>Int</code> → <code>I</code> (int)</li><li><code>Text</code> → <code>Ljava/lang/String;</code></li><li><code>Bool</code> → <code>Z</code> (boolean)</li><li>Record → Java class</li><li>Sum → Java sealed interface + records</li></ul><hr><h2 id="配置与环境" tabindex="-1">配置与环境 <a class="header-anchor" href="#配置与环境" aria-label="Permalink to “配置与环境”">​</a></h2><h3 id="环境变量" tabindex="-1">环境变量 <a class="header-anchor" href="#环境变量" aria-label="Permalink to “环境变量”">​</a></h3><table tabindex="0"><thead><tr><th>变量</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>ASTER_CAP_EFFECTS_ENFORCE</code></td><td>未设置</td><td>启用严格 effect 检查（设为 <code>1</code>）</td></tr><tr><td><code>ASTER_DEBUG_TYPES</code></td><td>未设置</td><td>输出类型推导调试信息（设为 <code>1</code>）</td></tr><tr><td><code>ASTER_EFFECT_CONFIG</code></td><td>未设置</td><td>自定义 effect 配置文件路径</td></tr><tr><td><code>LOG_LEVEL</code></td><td><code>INFO</code></td><td>日志级别（<code>DEBUG</code>/<code>INFO</code>/<code>WARN</code>/<code>ERROR</code>）</td></tr><tr><td><code>NODE_ENV</code></td><td>未设置</td><td>运行环境（<code>production</code>/<code>development</code>）</td></tr></tbody></table><h3 id="effect-配置文件" tabindex="-1">Effect 配置文件 <a class="header-anchor" href="#effect-配置文件" aria-label="Permalink to “Effect 配置文件”">​</a></h3><p>路径：<code>.aster/effects.json</code> 或 <code>ASTER_EFFECT_CONFIG</code> 指定</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;prefixes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;FileSvc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;@files&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;HttpClient&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;@http&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;DbPool&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;@sql&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;hierarchy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;@io&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;@files&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;@http&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;@sql&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;@files&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;@http&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;@sql&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="性能特征" tabindex="-1">性能特征 <a class="header-anchor" href="#性能特征" aria-label="Permalink to “性能特征”">​</a></h2><h3 id="编译性能-基于-perf-report-json" tabindex="-1">编译性能（基于 perf-report.json） <a class="header-anchor" href="#编译性能-基于-perf-report-json" aria-label="Permalink to “编译性能（基于 perf-report.json）”">​</a></h3><table tabindex="0"><thead><tr><th>规模</th><th>文件数</th><th>代码行数</th><th>parse p50</th><th>完整管道 p50</th></tr></thead><tbody><tr><td><strong>Small</strong></td><td>1</td><td>~10</td><td>0.12 ms</td><td>0.28 ms</td></tr><tr><td><strong>Medium</strong></td><td>40</td><td>~3200</td><td>6.5 ms</td><td>21 ms</td></tr><tr><td><strong>Large</strong></td><td>1</td><td>~350</td><td>0.48 ms</td><td>1.4 ms</td></tr></tbody></table><h3 id="lsp-性能" tabindex="-1">LSP 性能 <a class="header-anchor" href="#lsp-性能" aria-label="Permalink to “LSP 性能”">​</a></h3><table tabindex="0"><thead><tr><th>操作</th><th>Small p95</th><th>Medium p95</th><th>说明</th></tr></thead><tbody><tr><td><strong>Hover</strong></td><td>5000 ms</td><td>5000 ms</td><td>已知性能问题（超时）</td></tr><tr><td><strong>Completion</strong></td><td>2.1 ms</td><td>2.2 ms</td><td>自动补全响应</td></tr><tr><td><strong>Diagnostics</strong></td><td>0 ms</td><td>0 ms</td><td>缓存优化</td></tr></tbody></table><p>详见 <code>docs/performance.md</code>。</p><hr><h2 id="测试架构" tabindex="-1">测试架构 <a class="header-anchor" href="#测试架构" aria-label="Permalink to “测试架构”">​</a></h2><h3 id="测试类型" tabindex="-1">测试类型 <a class="header-anchor" href="#测试类型" aria-label="Permalink to “测试类型”">​</a></h3><ol><li><p><strong>Golden 测试</strong>（<code>test/golden.ts</code>）</p><ul><li>验证编译输出一致性</li><li>117 个测试用例</li><li>包含 AST/Core IR/诊断输出对比</li></ul></li><li><p><strong>属性测试</strong>（<code>test/property.test.ts</code>）</p><ul><li>Canonicalizer 幂等性</li><li>Lexer 总是生成 EOF</li><li>Parser 错误恢复</li></ul></li><li><p><strong>Fuzz 测试</strong>（<code>test/lossless.fuzz.test.ts</code>）</p><ul><li>CST 无损重建</li><li>4000 个随机trivia注入测试</li></ul></li><li><p><strong>LSP 测试</strong></p><ul><li><code>scripts/lsp-*.smoke.js</code> - 烟雾测试</li><li><code>test/lsp.props.test.ts</code> - 属性测试</li></ul></li></ol><h3 id="测试覆盖" tabindex="-1">测试覆盖 <a class="header-anchor" href="#测试覆盖" aria-label="Permalink to “测试覆盖”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # 所有测试</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test:golden</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   # Golden 测试</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test:property</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 属性测试</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test:lossless</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 无损CST测试</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test:lsp</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # LSP属性测试</span></span></code></pre></div><hr><h2 id="依赖与工具链" tabindex="-1">依赖与工具链 <a class="header-anchor" href="#依赖与工具链" aria-label="Permalink to “依赖与工具链”">​</a></h2><h3 id="核心依赖" tabindex="-1">核心依赖 <a class="header-anchor" href="#核心依赖" aria-label="Permalink to “核心依赖”">​</a></h3><table tabindex="0"><thead><tr><th>包</th><th>版本</th><th>用途</th></tr></thead><tbody><tr><td><code>typescript</code></td><td>^5.x</td><td>编译器实现语言</td></tr><tr><td><code>vscode-languageserver</code></td><td>^9.x</td><td>LSP 协议实现</td></tr><tr><td><code>fast-check</code></td><td>^3.x</td><td>属性测试</td></tr><tr><td><code>audit-ci</code></td><td>^7.x</td><td>依赖安全扫描</td></tr></tbody></table><h3 id="构建工具" tabindex="-1">构建工具 <a class="header-anchor" href="#构建工具" aria-label="Permalink to “构建工具”">​</a></h3><ul><li><strong>tsc</strong>: TypeScript 编译器</li><li><strong>build-peg.js</strong>: PEG 解析器生成（headers）</li><li><strong>esbuild</strong>: 未使用（可考虑加速构建）</li></ul><hr><h2 id="扩展点" tabindex="-1">扩展点 <a class="header-anchor" href="#扩展点" aria-label="Permalink to “扩展点”">​</a></h2><h3 id="_1-新增语言特性" tabindex="-1">1. 新增语言特性 <a class="header-anchor" href="#_1-新增语言特性" aria-label="Permalink to “1. 新增语言特性”">​</a></h3><ol><li>更新 <code>src/lexer.ts</code> 添加新 Token</li><li>更新 <code>src/parser.ts</code> 添加语法规则</li><li>更新 <code>src/lower_to_core.ts</code> 降低到 Core IR</li><li>更新 <code>src/typecheck.ts</code> 类型检查逻辑</li><li>更新 <code>src/emit.ts</code> 字节码生成</li><li>添加 Golden 测试用例</li></ol><h3 id="_2-新增-effect-类型" tabindex="-1">2. 新增 Effect 类型 <a class="header-anchor" href="#_2-新增-effect-类型" aria-label="Permalink to “2. 新增 Effect 类型”">​</a></h3><ol><li>更新 <code>.aster/effects.json</code> 配置</li><li>更新 <code>src/config/effects.ts</code> 常量定义</li><li>添加测试用例到 <code>test/cnl/examples/eff_*.aster</code></li></ol><h3 id="_3-新增-lsp-功能" tabindex="-1">3. 新增 LSP 功能 <a class="header-anchor" href="#_3-新增-lsp-功能" aria-label="Permalink to “3. 新增 LSP 功能”">​</a></h3><ol><li>更新 <code>src/lsp/capabilities.ts</code> 声明能力</li><li>在 <code>src/lsp/server.ts</code> 注册处理器</li><li>实现分析逻辑到 <code>src/lsp/analysis.ts</code></li><li>添加烟雾测试到 <code>scripts/lsp-*.smoke.js</code></li></ol><hr><h2 id="已知限制与未来改进" tabindex="-1">已知限制与未来改进 <a class="header-anchor" href="#已知限制与未来改进" aria-label="Permalink to “已知限制与未来改进”">​</a></h2><h3 id="当前限制-1" tabindex="-1">当前限制 <a class="header-anchor" href="#当前限制-1" aria-label="Permalink to “当前限制”">​</a></h3><ol><li><strong>LSP Hover 性能问题</strong>：所有请求超时（5秒），需架构重构</li><li><strong>单线程类型检查</strong>：大型项目性能瓶颈</li><li><strong>缺少增量编译</strong>：每次全量重新编译</li><li><strong>有限的字节码优化</strong>：未实现常量折叠等优化</li></ol><h3 id="roadmap-参考-claude-enterprise-improvement-roadmap-md" tabindex="-1">Roadmap（参考 <code>.claude/enterprise-improvement-roadmap.md</code>） <a class="header-anchor" href="#roadmap-参考-claude-enterprise-improvement-roadmap-md" aria-label="Permalink to “Roadmap（参考 .claude/enterprise-improvement-roadmap.md）”">​</a></h3><ul><li><strong>Stage 3.1</strong>: LSP 架构重构（模块化，Worker线程）</li><li><strong>Stage 3.2</strong>: 性能基准系统 ✅（已完成）</li><li><strong>Stage 3.3</strong>: 代码质量改进 ✅（已完成）</li><li><strong>Stage 4</strong>: 增量编译与缓存</li><li><strong>Stage 5</strong>: 高级类型特性（联合类型、交叉类型）</li></ul><hr><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to “参考资料”">​</a></h2><ul><li><strong>源码仓库</strong>: <code>/Users/rpang/IdeaProjects/aster-lang</code></li><li><strong>运维文档</strong>: <code>docs/operations/</code></li><li><strong>性能报告</strong>: <code>docs/performance.md</code></li><li><strong>测试文档</strong>: <code>docs/testing.md</code></li></ul><h2 id="贡献指南" tabindex="-1">贡献指南 <a class="header-anchor" href="#贡献指南" aria-label="Permalink to “贡献指南”">​</a></h2><ol><li>遵循 <code>.claude/CLAUDE.md</code> 开发准则</li><li>所有代码必须通过 <code>npm run ci</code> 完整测试</li><li>新特性必须包含 Golden 测试用例</li><li>遵循现有命名约定（小驼峰，类型大驼峰）</li><li>使用结构化日志（<code>src/utils/logger.ts</code>）</li></ol><hr><p><strong>维护者</strong>: Aster 开发团队 <strong>最后更新</strong>: 2025-10-09</p></div></div></main><footer class="VPDocFooter" data-v-7011f0d8 data-v-e257564d><!--[--><!--]--><!----><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter" data-v-1df9f90f data-v-c3855bb3><div class="container" data-v-c3855bb3><p class="message" data-v-c3855bb3>Released under the MIT License.</p><p class="copyright" data-v-c3855bb3>Copyright © 2025 Aster Language Team</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"ai-generation-architecture.md\":\"Vh18j_Ok\",\"ai-generation-guide.md\":\"WZhITE4j\",\"api_canonicalizer.md\":\"DUqNQmFC\",\"api_core.md\":\"C1v-bSx3\",\"api_lexer.md\":\"6Sb7VheS\",\"api_overview.md\":\"BAFNlt86\",\"api_parser.md\":\"DB8ukesk\",\"api_typedoc_canonicalizer_functions_canonicalize.md\":\"WBPQNmQy\",\"api_typedoc_canonicalizer_readme.md\":\"DDyy-5aE\",\"api_typedoc_config_semantic_enumerations_capabilitykind.md\":\"DiMngU6F\",\"api_typedoc_config_semantic_enumerations_effect.md\":\"-Wv6MVL-\",\"api_typedoc_config_semantic_functions_getallcapabilityprefixes.md\":\"C-SGsDr5\",\"api_typedoc_config_semantic_functions_getalleffects.md\":\"ZfZkspmh\",\"api_typedoc_config_semantic_functions_infercapabilityfromname.md\":\"D3SbqIdh\",\"api_typedoc_config_semantic_functions_isbuiltinawait.md\":\"Bjk2mhHF\",\"api_typedoc_config_semantic_functions_iskeyword.md\":\"CMdz7b19\",\"api_typedoc_config_semantic_functions_isvalideffect.md\":\"BtjlRux9\",\"api_typedoc_config_semantic_functions_parseeffect.md\":\"Dxivlbar\",\"api_typedoc_config_semantic_readme.md\":\"DXzLTWAb\",\"api_typedoc_config_semantic_variables_builtin_await.md\":\"CQuSeL8o\",\"api_typedoc_config_semantic_variables_capability_prefixes.md\":\"eN_NzjtE\",\"api_typedoc_config_semantic_variables_cpu_prefixes.md\":\"DIM18Z0P\",\"api_typedoc_config_semantic_variables_io_prefixes.md\":\"rWGal5ax\",\"api_typedoc_config_semantic_variables_kw.md\":\"DzFT7LYb\",\"api_typedoc_core_ir_readme.md\":\"CzYk3jG_\",\"api_typedoc_core_ir_variables_core.md\":\"BYPCKiSN\",\"api_typedoc_error_codes_enumerations_errorcode.md\":\"DZx0lVFr\",\"api_typedoc_error_codes_functions_formaterrormessage.md\":\"CcWuzCXR\",\"api_typedoc_error_codes_functions_geterrormetadata.md\":\"CZHpQ86c\",\"api_typedoc_error_codes_interfaces_errormetadata.md\":\"B-eDU2WT\",\"api_typedoc_error_codes_readme.md\":\"A9gSR2lX\",\"api_typedoc_error_codes_type-aliases_errorcategory.md\":\"BpAN-W4i\",\"api_typedoc_error_codes_type-aliases_errorseverity.md\":\"CbW9wP3J\",\"api_typedoc_error_codes_variables_error_messages.md\":\"C1mdRvmQ\",\"api_typedoc_error_codes_variables_error_metadata.md\":\"DulV4BwE\",\"api_typedoc_index_readme.md\":\"QDJLekGi\",\"api_typedoc_index_variables_node.md\":\"DlJtLj6U\",\"api_typedoc_lexer_functions_lex.md\":\"DicCbXzf\",\"api_typedoc_lexer_readme.md\":\"DGGScc2r\",\"api_typedoc_lower_to_core_functions_lowermodule.md\":\"DVlLa1FI\",\"api_typedoc_lower_to_core_readme.md\":\"B-buQyBB\",\"api_typedoc_parser_functions_parse.md\":\"PiSfv-in\",\"api_typedoc_parser_readme.md\":\"BHmR7Q1P\",\"api_typedoc_readme.md\":\"CYskx_Mj\",\"api_typedoc_types_base_interfaces_baseawait.md\":\"BtvqNOva\",\"api_typedoc_types_base_interfaces_baseblock.md\":\"6Z6kS889\",\"api_typedoc_types_base_interfaces_basebool.md\":\"CePTDt4a\",\"api_typedoc_types_base_interfaces_basecall.md\":\"Dq9AXFca\",\"api_typedoc_types_base_interfaces_basecase.md\":\"lnb-YrQx\",\"api_typedoc_types_base_interfaces_baseconstruct.md\":\"DQWwT88l\",\"api_typedoc_types_base_interfaces_baseconstructfield.md\":\"Gc6XMagf\",\"api_typedoc_types_base_interfaces_basedata.md\":\"BRs9Bq2V\",\"api_typedoc_types_base_interfaces_basedouble.md\":\"BJqGsJ_k\",\"api_typedoc_types_base_interfaces_baseenum.md\":\"D-Je-pO0\",\"api_typedoc_types_base_interfaces_baseerr.md\":\"BuaogDmm\",\"api_typedoc_types_base_interfaces_basefield.md\":\"CDWQ3x2z\",\"api_typedoc_types_base_interfaces_basefunc.md\":\"DDrUQUG2\",\"api_typedoc_types_base_interfaces_basefunctype.md\":\"C-k8xojn\",\"api_typedoc_types_base_interfaces_baseif.md\":\"DQb_TMpD\",\"api_typedoc_types_base_interfaces_baseimport.md\":\"BXWwObGc\",\"api_typedoc_types_base_interfaces_baseint.md\":\"BS0A-qzU\",\"api_typedoc_types_base_interfaces_baselambda.md\":\"zdXq9d-P\",\"api_typedoc_types_base_interfaces_baselet.md\":\"DFVO3w7E\",\"api_typedoc_types_base_interfaces_baselist.md\":\"U8Q5Q12b\",\"api_typedoc_types_base_interfaces_baselong.md\":\"BOkmOK6-\",\"api_typedoc_types_base_interfaces_basemap.md\":\"QOV3XraL\",\"api_typedoc_types_base_interfaces_basematch.md\":\"y8sj9fE5\",\"api_typedoc_types_base_interfaces_basemaybe.md\":\"BF-ov2QO\",\"api_typedoc_types_base_interfaces_basemodule.md\":\"DHIWCHik\",\"api_typedoc_types_base_interfaces_basename.md\":\"mJqirMyR\",\"api_typedoc_types_base_interfaces_basenode.md\":\"Dmpju7mt\",\"api_typedoc_types_base_interfaces_basenone.md\":\"C2rluMyW\",\"api_typedoc_types_base_interfaces_basenull.md\":\"_RMr9EtA\",\"api_typedoc_types_base_interfaces_baseok.md\":\"BB4O3YI2\",\"api_typedoc_types_base_interfaces_baseoption.md\":\"Dir0sRHo\",\"api_typedoc_types_base_interfaces_baseparameter.md\":\"8TIciWx5\",\"api_typedoc_types_base_interfaces_basepatternctor.md\":\"yr5iOkrj\",\"api_typedoc_types_base_interfaces_basepatternint.md\":\"C6sqfWA6\",\"api_typedoc_types_base_interfaces_basepatternname.md\":\"D_LJ8S_E\",\"api_typedoc_types_base_interfaces_basepatternnull.md\":\"CmxeYogt\",\"api_typedoc_types_base_interfaces_baseresult.md\":\"D3c617pK\",\"api_typedoc_types_base_interfaces_baseretrypolicy.md\":\"BOjIZs28\",\"api_typedoc_types_base_interfaces_basereturn.md\":\"DF4gtqCH\",\"api_typedoc_types_base_interfaces_basescope.md\":\"F6jW8XV4\",\"api_typedoc_types_base_interfaces_baseset.md\":\"COXYfHII\",\"api_typedoc_types_base_interfaces_basesome.md\":\"DnfgaN7k\",\"api_typedoc_types_base_interfaces_basestart.md\":\"DJ7-g7rd\",\"api_typedoc_types_base_interfaces_basestep.md\":\"BJ9Trlu7\",\"api_typedoc_types_base_interfaces_basestring.md\":\"BpNOeyTw\",\"api_typedoc_types_base_interfaces_basetimeout.md\":\"CDWfsDmt\",\"api_typedoc_types_base_interfaces_basetypeapp.md\":\"DRrynUM5\",\"api_typedoc_types_base_interfaces_basetypename.md\":\"B2JfEqsD\",\"api_typedoc_types_base_interfaces_basetypevar.md\":\"D8PHuHoZ\",\"api_typedoc_types_base_interfaces_basewait.md\":\"8upNum21\",\"api_typedoc_types_base_interfaces_baseworkflow.md\":\"DA-czSxj\",\"api_typedoc_types_base_readme.md\":\"CE9_DSUg\",\"api_typedoc_types_base_type-aliases_hasfileprop.md\":\"ikLqWE4J\",\"api_typedoc_types_enumerations_tokenkind.md\":\"BM_yAt5G\",\"api_typedoc_types_functions_iscommenttoken.md\":\"DrEgOTzq\",\"api_typedoc_types_interfaces_annotation.md\":\"CkEPfgJk\",\"api_typedoc_types_interfaces_astmetadata.md\":\"BP44qKfb\",\"api_typedoc_types_interfaces_await.md\":\"BwctV35q\",\"api_typedoc_types_interfaces_block.md\":\"Dds4cC78\",\"api_typedoc_types_interfaces_bool.md\":\"FxplsY7_\",\"api_typedoc_types_interfaces_call.md\":\"Bn4XBA3g\",\"api_typedoc_types_interfaces_case.md\":\"D6zsiPkw\",\"api_typedoc_types_interfaces_commentvalue.md\":\"BTkSL3vk\",\"api_typedoc_types_interfaces_construct.md\":\"oIfYr1IJ\",\"api_typedoc_types_interfaces_constructfield.md\":\"Cnz0QAqG\",\"api_typedoc_types_interfaces_data.md\":\"DjJQnvW9\",\"api_typedoc_types_interfaces_double.md\":\"fKgF38FL\",\"api_typedoc_types_interfaces_effectcapable.md\":\"DWOTAter\",\"api_typedoc_types_interfaces_effectvar.md\":\"BVp5AXe0\",\"api_typedoc_types_interfaces_enum.md\":\"B00UwgiO\",\"api_typedoc_types_interfaces_err.md\":\"pB9dmUfJ\",\"api_typedoc_types_interfaces_field.md\":\"PsHn4Csn\",\"api_typedoc_types_interfaces_func.md\":\"MlaHEUYy\",\"api_typedoc_types_interfaces_functype.md\":\"6-vZuqmj\",\"api_typedoc_types_interfaces_if.md\":\"D1PKiqqA\",\"api_typedoc_types_interfaces_import.md\":\"BKI8FX07\",\"api_typedoc_types_interfaces_int.md\":\"ANec8qu3\",\"api_typedoc_types_interfaces_lambda.md\":\"7QRRiPjg\",\"api_typedoc_types_interfaces_let.md\":\"1WCoI4Gv\",\"api_typedoc_types_interfaces_list.md\":\"BvE0M76q\",\"api_typedoc_types_interfaces_long.md\":\"Df_9LjrS\",\"api_typedoc_types_interfaces_map.md\":\"bdNZ-rdw\",\"api_typedoc_types_interfaces_match.md\":\"C_zKlFpy\",\"api_typedoc_types_interfaces_maybe.md\":\"P2T9PUk1\",\"api_typedoc_types_interfaces_module.md\":\"BJHg-GmZ\",\"api_typedoc_types_interfaces_name.md\":\"CKmupHQv\",\"api_typedoc_types_interfaces_none.md\":\"DeDnQ3NO\",\"api_typedoc_types_interfaces_null.md\":\"BVY9aJD_\",\"api_typedoc_types_interfaces_ok.md\":\"BYknowER\",\"api_typedoc_types_interfaces_option.md\":\"DvADyFrb\",\"api_typedoc_types_interfaces_origin.md\":\"Bz9Krm9t\",\"api_typedoc_types_interfaces_parameter.md\":\"HbP_2nfa\",\"api_typedoc_types_interfaces_patternctor.md\":\"BsqS63fg\",\"api_typedoc_types_interfaces_patternint.md\":\"Bt9Ge8Yn\",\"api_typedoc_types_interfaces_patternname.md\":\"CLFMUkPE\",\"api_typedoc_types_interfaces_patternnull.md\":\"Beu6gSiS\",\"api_typedoc_types_interfaces_piimeta.md\":\"B-tcVLA7\",\"api_typedoc_types_interfaces_position.md\":\"D4n1y5fc\",\"api_typedoc_types_interfaces_result.md\":\"BWGZBT-p\",\"api_typedoc_types_interfaces_retrypolicy.md\":\"DceUqg9X\",\"api_typedoc_types_interfaces_return.md\":\"CoWpDCEG\",\"api_typedoc_types_interfaces_set.md\":\"BDOQgnhv\",\"api_typedoc_types_interfaces_some.md\":\"6e8EKTI8\",\"api_typedoc_types_interfaces_span.md\":\"g3cVeqBr\",\"api_typedoc_types_interfaces_start.md\":\"BB_v-dqs\",\"api_typedoc_types_interfaces_stepstmt.md\":\"WXBvOkRA\",\"api_typedoc_types_interfaces_string.md\":\"BM7MrnvB\",\"api_typedoc_types_interfaces_timeout.md\":\"CHFjIDI4\",\"api_typedoc_types_interfaces_token.md\":\"BFyuk3_o\",\"api_typedoc_types_interfaces_typeapp.md\":\"D0rs_a1h\",\"api_typedoc_types_interfaces_typecheckdiagnostic.md\":\"Dp30csBQ\",\"api_typedoc_types_interfaces_typename.md\":\"BZdV7vrD\",\"api_typedoc_types_interfaces_typepii.md\":\"DxqrM52d\",\"api_typedoc_types_interfaces_typevar.md\":\"CmYbPngw\",\"api_typedoc_types_interfaces_wait.md\":\"Ag-JlwuU\",\"api_typedoc_types_interfaces_workflowstmt.md\":\"-5sYRqPy\",\"api_typedoc_types_namespaces_core_interfaces_annotation.md\":\"DRtavQMn\",\"api_typedoc_types_namespaces_core_interfaces_await.md\":\"BsNzp_j2\",\"api_typedoc_types_namespaces_core_interfaces_block.md\":\"CJAFt7ug\",\"api_typedoc_types_namespaces_core_interfaces_bool.md\":\"DeTqk7Df\",\"api_typedoc_types_namespaces_core_interfaces_call.md\":\"BA-DbsfY\",\"api_typedoc_types_namespaces_core_interfaces_case.md\":\"DL4iKtJy\",\"api_typedoc_types_namespaces_core_interfaces_construct.md\":\"DYziutvA\",\"api_typedoc_types_namespaces_core_interfaces_constructfield.md\":\"WF-rbPOF\",\"api_typedoc_types_namespaces_core_interfaces_data.md\":\"GUbnBpqj\",\"api_typedoc_types_namespaces_core_interfaces_double.md\":\"ClolhlwM\",\"api_typedoc_types_namespaces_core_interfaces_effectvar.md\":\"CuBMTjUG\",\"api_typedoc_types_namespaces_core_interfaces_enum.md\":\"Dkp-YH79\",\"api_typedoc_types_namespaces_core_interfaces_err.md\":\"JLtHAQUP\",\"api_typedoc_types_namespaces_core_interfaces_field.md\":\"B_CBLfAx\",\"api_typedoc_types_namespaces_core_interfaces_func.md\":\"CdrM072Q\",\"api_typedoc_types_namespaces_core_interfaces_functype.md\":\"DdZESQCb\",\"api_typedoc_types_namespaces_core_interfaces_if.md\":\"BhksuViE\",\"api_typedoc_types_namespaces_core_interfaces_import.md\":\"BP_olXtF\",\"api_typedoc_types_namespaces_core_interfaces_int.md\":\"H9zaMpmg\",\"api_typedoc_types_namespaces_core_interfaces_lambda.md\":\"yb_cThu5\",\"api_typedoc_types_namespaces_core_interfaces_let.md\":\"pkDJ8C47\",\"api_typedoc_types_namespaces_core_interfaces_list.md\":\"yWhK_8n_\",\"api_typedoc_types_namespaces_core_interfaces_long.md\":\"CvfGj_ux\",\"api_typedoc_types_namespaces_core_interfaces_map.md\":\"DVMJnVh1\",\"api_typedoc_types_namespaces_core_interfaces_match.md\":\"Dl3ZI7pz\",\"api_typedoc_types_namespaces_core_interfaces_maybe.md\":\"CfX0Rknw\",\"api_typedoc_types_namespaces_core_interfaces_module.md\":\"CFgF7MlH\",\"api_typedoc_types_namespaces_core_interfaces_name.md\":\"D2bJ60Bx\",\"api_typedoc_types_namespaces_core_interfaces_none.md\":\"BL5iZ3YQ\",\"api_typedoc_types_namespaces_core_interfaces_null.md\":\"cQx17gxh\",\"api_typedoc_types_namespaces_core_interfaces_ok.md\":\"x9tFCrER\",\"api_typedoc_types_namespaces_core_interfaces_option.md\":\"DtHt_lCj\",\"api_typedoc_types_namespaces_core_interfaces_parameter.md\":\"BNvcAWfY\",\"api_typedoc_types_namespaces_core_interfaces_patctor.md\":\"Cg5TfQw1\",\"api_typedoc_types_namespaces_core_interfaces_patint.md\":\"DkAPyXXY\",\"api_typedoc_types_namespaces_core_interfaces_patname.md\":\"Cyq5lM8k\",\"api_typedoc_types_namespaces_core_interfaces_patnull.md\":\"D0N4Qk7W\",\"api_typedoc_types_namespaces_core_interfaces_piitype.md\":\"BnR_GiFH\",\"api_typedoc_types_namespaces_core_interfaces_result.md\":\"0eeB9WiX\",\"api_typedoc_types_namespaces_core_interfaces_retrypolicy.md\":\"kq2SZ92t\",\"api_typedoc_types_namespaces_core_interfaces_return.md\":\"cgSNp3sB\",\"api_typedoc_types_namespaces_core_interfaces_scope.md\":\"RIR179wD\",\"api_typedoc_types_namespaces_core_interfaces_set.md\":\"BwhbnmH-\",\"api_typedoc_types_namespaces_core_interfaces_some.md\":\"BAqnqR4h\",\"api_typedoc_types_namespaces_core_interfaces_start.md\":\"BBrpUgDx\",\"api_typedoc_types_namespaces_core_interfaces_step.md\":\"BJ8rVDln\",\"api_typedoc_types_namespaces_core_interfaces_string.md\":\"BT8hWbQO\",\"api_typedoc_types_namespaces_core_interfaces_timeout.md\":\"DCNnsi5W\",\"api_typedoc_types_namespaces_core_interfaces_typeapp.md\":\"GA-skxGA\",\"api_typedoc_types_namespaces_core_interfaces_typename.md\":\"C7ZsEecJ\",\"api_typedoc_types_namespaces_core_interfaces_typevar.md\":\"CpGnyyhq\",\"api_typedoc_types_namespaces_core_interfaces_wait.md\":\"UKxkEmXL\",\"api_typedoc_types_namespaces_core_interfaces_workflow.md\":\"DlSvRGGW\",\"api_typedoc_types_namespaces_core_readme.md\":\"NzBvLo2Y\",\"api_typedoc_types_namespaces_core_type-aliases_corenode.md\":\"CdM-pinX\",\"api_typedoc_types_namespaces_core_type-aliases_declaration.md\":\"CkdMcssh\",\"api_typedoc_types_namespaces_core_type-aliases_expression.md\":\"tbTNMueI\",\"api_typedoc_types_namespaces_core_type-aliases_pattern.md\":\"Nu3DP6qV\",\"api_typedoc_types_namespaces_core_type-aliases_statement.md\":\"BxCmeSBG\",\"api_typedoc_types_namespaces_core_type-aliases_type.md\":\"BUXcarfq\",\"api_typedoc_types_readme.md\":\"BtX9LMYn\",\"api_typedoc_types_type-aliases_astnode.md\":\"CaELsJp3\",\"api_typedoc_types_type-aliases_capabilitykind.md\":\"Ckf6mSVU\",\"api_typedoc_types_type-aliases_declaration.md\":\"BqmMJrVd\",\"api_typedoc_types_type-aliases_effectcaps.md\":\"4XK2Fsha\",\"api_typedoc_types_type-aliases_expression.md\":\"nnESKY5K\",\"api_typedoc_types_type-aliases_pattern.md\":\"C6z5WUYE\",\"api_typedoc_types_type-aliases_piidatacategory.md\":\"DMb_MLtA\",\"api_typedoc_types_type-aliases_piilevel.md\":\"CPIuBQGw\",\"api_typedoc_types_type-aliases_piisensitivitylevel.md\":\"Da_BnxF_\",\"api_typedoc_types_type-aliases_statement.md\":\"BLMrfDl1\",\"api_typedoc_types_type-aliases_type.md\":\"Bi8ZPa0d\",\"api_typedoc_types_variables_pii_levels.md\":\"D796TvSg\",\"architecture.md\":\"_DEGzzYu\",\"concurrency.md\":\"D4ZmE0BN\",\"core-ir-specification.md\":\"ZoVsz7RT\",\"cross-backend-benchmark-results.md\":\"kZqjNp3b\",\"decisions_adr-001-defer-effect-inference.md\":\"CCHSILPi\",\"dev_workflow-implementation.md\":\"Crwz1_s-\",\"error-codes.md\":\"DZiO8tN-\",\"graalvm-setup-guide.md\":\"Du9LcmOq\",\"guide_ai-code-generation.md\":\"sKTns30w\",\"guide_audit-compliance.md\":\"-wZEc6pt\",\"guide_capabilities.md\":\"0w9HYsTU\",\"guide_cli_commands.md\":\"BGitH93C\",\"guide_commands.md\":\"BLtNYDJa\",\"guide_contributing.md\":\"BZvvPdPI\",\"guide_examples.md\":\"Bt0J0Xwj\",\"guide_formatting.md\":\"BIcHnXgx\",\"guide_getting-started-packages.md\":\"Dd9Wg98j\",\"guide_getting-started.md\":\"ExEQ5ylv\",\"guide_interop-overloads.md\":\"D-3IUfl-\",\"guide_language-overview.md\":\"CrBKH9ia\",\"guide_lsp-code-actions.md\":\"qIDYbolg\",\"guide_lsp-tutorial.md\":\"CaTCrVPF\",\"guide_package-management_manifest-reference.md\":\"CA2s7laZ\",\"guide_package-management_overview.md\":\"2Z9IMAmJ\",\"guide_pii-compliance.md\":\"CQmq-UAy\",\"guide_quickstart.md\":\"_yd4QSXk\",\"guide_truffle-quickstart.md\":\"B9Olssrg\",\"index.md\":\"B6O2FXoC\",\"java25-compatibility.md\":\"Bt_QsLV4\",\"language_workflow.md\":\"DjavpKtt\",\"migration-guide.md\":\"Dawg27uf\",\"native-build-guide.md\":\"BLzGaiax\",\"native-image_build-guide.md\":\"CpjZnOr9\",\"native-image_limitations.md\":\"zHp-FAzG\",\"native-image_performance-comparison.md\":\"_X8Yj_r0\",\"native-image_readme.md\":\"8k_pD_35\",\"native-image_troubleshooting.md\":\"fkOy1U7O\",\"operations.md\":\"B63Kg8_8\",\"operations_configuration.md\":\"DS96Z88D\",\"operations_deployment.md\":\"D8967GHj\",\"operations_lsp-monitoring.md\":\"kGwox_P0\",\"operations_rollback.md\":\"BRdBvO73\",\"operations_troubleshooting.md\":\"CPGTwKd-\",\"p0-4-completion-summary.md\":\"BKJH7bPF\",\"performance-comparison-charts.md\":\"BmL-h3JC\",\"performance-guide.md\":\"DRZ0N8-o\",\"performance-improvement-roadmap.md\":\"Cu5F8qIt\",\"performance-optimization.md\":\"Be3hE-Ax\",\"performance-regression-monitoring.md\":\"CMsysdlw\",\"performance.md\":\"CN30-jwG\",\"phase0_determinism-contract.md\":\"BksgZ75A\",\"phase0_idempotency-helpers.md\":\"COSI9HRx\",\"phase0_pii-logging-policy.md\":\"BS1gfx3F\",\"phase0_readme.md\":\"B5Ib4xxT\",\"phase0_tamper-evident-audit.md\":\"BBrqVw6u\",\"phase1-user-guide.md\":\"PZb7u1Uk\",\"publishing-guide.md\":\"BlF59Hfz\",\"readme.md\":\"CY5Lhu8s\",\"reference_asm-emitter.md\":\"D6rKYQWD\",\"reference_effect-inference-algorithm.md\":\"Dl8fA7nC\",\"reference_effects-capabilities.md\":\"C1YHTPFx\",\"reference_effects.md\":\"CqQiffue\",\"reference_generics.md\":\"DVdbd2sF\",\"reference_jvm-interop.md\":\"DExS3b4v\",\"reference_lambdas.md\":\"Dm_CVDdF\",\"reference_language-specification.md\":\"CHObGSzA\",\"reference_modules.md\":\"CT9_HBUH\",\"reference_native.md\":\"_3X58hKu\",\"reference_pii-taint-analysis.md\":\"B7chE1N_\",\"reference_production-builds.md\":\"GQU4aQ76\",\"reference_runtime-api.md\":\"BDtl3Pn5\",\"reference_stdlib-api.md\":\"De0TooyD\",\"reference_syntax.md\":\"C8HXmQ0O\",\"reference_truffle.md\":\"Czyrxje0\",\"reference_types.md\":\"DYn-fglz\",\"repository-infrastructure.md\":\"BGnhIcdD\",\"runtime_backend-comparison.md\":\"BBXrjxPT\",\"runtime_determinism-contract.md\":\"DYvxgeKt\",\"runtime_retry-semantics.md\":\"BbveN_BY\",\"runtime_truffle-backend.md\":\"DVUEbRm2\",\"tech-effect-inference-design.md\":\"iUj1JwO8\",\"testing.md\":\"DQ-vCAFG\",\"truffle-architecture.md\":\"XvsAP0qq\",\"truffle-backend-limitations.md\":\"D8HHZylJ\",\"truffle-performance-benchmarks.md\":\"ByVLZONC\",\"truffle-performance-comparison.md\":\"CGVqtjWg\",\"user-guide-effect-polymorphism.md\":\"CLCwhjUU\",\"workstreams_23a66060-6637-4a38-b1d8-b5ab76f4f876_operations-log.md\":\"DqbhzKOv\",\"workstreams_342f9631-da63-4044-9b62-bedb1a4a378c_operations-log.md\":\"4fF1lJvO\",\"workstreams_428f8b23-2db0-458e-9be2-a95e310be030_operations-log.md\":\"Dflgyj6D\",\"workstreams_428f8b23-2db0-458e-9be2-a95e310be030_verification_verification.md\":\"B9b4Gp86\",\"workstreams_429d03ce-6581-4279-9bc6-a71307e63ca4_operations-log.md\":\"BKeOeMa6\",\"workstreams_4be2e593-2955-4539-aa3d-7b4c61f4e1a9_operations-log.md\":\"BjHuRelc\",\"workstreams_68daace8-e645-47a7-ae0b-5d7cd4cf8dab_operations-log.md\":\"DIxtWDyE\",\"workstreams_6fd5b600-0163-4efc-bd07-43e517b15587_operations-log.md\":\"376wJ2_T\",\"workstreams_714da447-6391-4864-b689-c03c45b64a72_operations-log.md\":\"C1c1mSeQ\",\"workstreams_714da447-6391-4864-b689-c03c45b64a72_verification.md\":\"C6I6mJmj\",\"workstreams_7f046db7-ce07-4a1a-bafc-00a943de6bbc_operations-log.md\":\"bTo0JAAY\",\"workstreams_7f046db7-ce07-4a1a-bafc-00a943de6bbc_verification.md\":\"CYleL-nQ\",\"workstreams_88f1c8c5-db32-4a9e-a17f-59141b667bb6_operations-log.md\":\"zFXdkA2O\",\"workstreams_88f1c8c5-db32-4a9e-a17f-59141b667bb6_verification_verification.md\":\"BseWxpZU\",\"workstreams_8bd39f4c-e221-4ab5-b4b4-689662fee5ea_operations-log.md\":\"B30SpGE5\",\"workstreams_924f1bef-5079-4e33-bab9-dbbdeab8d9d5_operations-log.md\":\"BRtZwZsQ\",\"workstreams_9bb5de4d-5ea5-4863-8358-055976d96818_operations-log.md\":\"B2m9ImFH\",\"workstreams_9f3bbb1d-4240-447e-94c1-60a73bc0d943_operations-log.md\":\"40DPm_OB\",\"workstreams_a7b1d981-e5b4-4f3f-bbfe-0a593879e649_operations-log.md\":\"tUmhx1CS\",\"workstreams_aee766ca-7a37-4d42-87ad-4aea5cccc281_operations-log.md\":\"DH_Urdtb\",\"workstreams_aster-asm-emitter-refactor_operations-log.md\":\"BmH7yL-K\",\"workstreams_aster-idea-review_operations-log.md\":\"Bd4YCzKT\",\"workstreams_b7decd69-7066-4080-a794-a6f6c400a846_operations-log.md\":\"Ca-3qWp6\",\"workstreams_context-integration-test_operations-log.md\":\"Cw6rnXSA\",\"workstreams_e1cacc8c-9fcd-4759-b20a-23faa3d0fd86_operations-log.md\":\"BR4hjPMT\",\"workstreams_ef32967d-5391-4a6c-8805-9d942d214c13_operations-log.md\":\"BaBewtGQ\",\"workstreams_error-message-improvement_operations-log.md\":\"BwTb4wCM\",\"workstreams_error-message-improvement_verification.md\":\"D4IHXh_V\",\"workstreams_fadc4c83-e616-4654-b224-5cb3873b097a_operations-log.md\":\"C-wfj6T-\",\"workstreams_function-return-type-inference_operations-log.md\":\"CRrrejXN\",\"workstreams_github-actions-optimization_implementation.md\":\"D-xbYPd6\",\"workstreams_github-actions-optimization_verification.md\":\"Bf3eYlyv\",\"workstreams_github-folder-audit_operations-log.md\":\"Bgn7mHD8\",\"workstreams_golden-test-expansion_operations-log.md\":\"DJ6Dmn7z\",\"workstreams_golden-test-expansion_verification.md\":\"Blgp2Qd2\",\"workstreams_java-core-lowering_operations-log.md\":\"BWkGMQCN\",\"workstreams_lsp-coverage_operations-log.md\":\"BtvSef_S\",\"workstreams_native-cli_jar-hotswap-implementation.md\":\"nEcwLSQw\",\"workstreams_native-cli_operations-log.md\":\"BojbyEt5\",\"workstreams_native-cli_parser-consistency-report.md\":\"gc1PTTHr\",\"workstreams_native-cli_verification_verification.md\":\"CFV494mH\",\"workstreams_native-cli_vscode-typescript-compiler-integration.md\":\"CKPDqqo9\",\"workstreams_native-image-review_operations-log.md\":\"acFv2SZ9\",\"workstreams_p0-4_operations-log.md\":\"HfKffxcq\",\"workstreams_p0-5_operations-log.md\":\"DDXOCsYe\",\"workstreams_p1-5_operations-log.md\":\"lndeopTM\",\"workstreams_p1_operations-log.md\":\"BGjMPVNH\",\"workstreams_p2-1_operations-log.md\":\"kaVKwhSp\",\"workstreams_p2-1_verification.md\":\"BncIHJHD\",\"workstreams_p2-2_operations-log.md\":\"CfrodXxv\",\"workstreams_p2-4_implementation_structured-logging-usage.md\":\"CaoZ9r7n\",\"workstreams_p2-4_operations-log.md\":\"B20-50o_\",\"workstreams_p2-4_verification_structured-logging-verification.md\":\"BNeAjwV2\",\"workstreams_p2-5_operations-log.md\":\"C5XZ6AfX\",\"workstreams_p2-6_operations-log.md\":\"CvVuOp-q\",\"workstreams_p2-6_verification.md\":\"CGs8i2vs\",\"workstreams_p2-7-task6_operations-log.md\":\"DeKHUJwq\",\"workstreams_p2-truffle-comparative-benchmark_operations-log.md\":\"Brh4E1Zn\",\"workstreams_p3-1_operations-log.md\":\"DseqUc9p\",\"workstreams_p3-3_operations-log.md\":\"PWYbcZTK\",\"workstreams_p4-0.1_operations-log.md\":\"DPPEJGmm\",\"workstreams_p4-0.1_verification.md\":\"DdFU6q0z\",\"workstreams_p4-0.4_operations-log.md\":\"D-SNz7C_\",\"workstreams_p4-0.4_verification.md\":\"BujuNssP\",\"workstreams_p4-0_index.md\":\"344r-8eD\",\"workstreams_p4-0_operations-log.md\":\"D3KwpiMN\",\"workstreams_p4-0_readme.md\":\"Cr8ryRvi\",\"workstreams_p4-2.6_implementation_report.md\":\"U9XIM3NZ\",\"workstreams_p4-2.6_operations-log.md\":\"uLCeyEZf\",\"workstreams_p4-2_annotation-semantics.md\":\"BpY9KrFd\",\"workstreams_p4-2_index.md\":\"8fYgiRLU\",\"workstreams_p4-2_operations-log.md\":\"CqwZbBzT\",\"workstreams_p4-2_readme.md\":\"BNKCQ8x9\",\"workstreams_p4-batch2_operations-log.md\":\"CyG4plmz\",\"workstreams_p4-batch5_operations-log.md\":\"CMU7-dy9\",\"workstreams_p4-batch5_research_failure-analysis.md\":\"0dO0in7a\",\"workstreams_phase-0-foundation-hardening_operations-log.md\":\"BJDrYnZX\",\"workstreams_phase-3.8_api-changes.md\":\"C4H1cjz7\",\"workstreams_phase-3.8_deployment-checklist.md\":\"Bm3xqMoU\",\"workstreams_phase-3.8_index.md\":\"BewpN0ZJ\",\"workstreams_phase-3.8_monitoring-guide.md\":\"BLDFDae0\",\"workstreams_phase-3.8_performance-test.md\":\"Cw_w3Y21\",\"workstreams_phase-3.8_readme.md\":\"BqE9JPRg\",\"workstreams_phase0-feature-docs_implementation.md\":\"CDeAzj0v\",\"workstreams_phase0-feature-docs_operations-log.md\":\"C680i2aJ\",\"workstreams_phase4.5-priority2_operations-log.md\":\"CKDeG3OP\",\"workstreams_phase7_operations-log.md\":\"DCZE10iu\",\"workstreams_quarkus-policy-api_operations-log.md\":\"zi6cvtxn\",\"workstreams_remaining-examples_implementation_batch-01.md\":\"BbMD71Ni\",\"workstreams_remaining-examples_implementation_batch-02.md\":\"Du5mUMj4\",\"workstreams_remaining-examples_implementation_batch-03.md\":\"B6uFu97O\",\"workstreams_setup-env-action_operations-log.md\":\"xbjmm1BO\",\"workstreams_span-from-sources-fix_operations-log.md\":\"uFEh8cNx\",\"workstreams_task4-emitter_operations-log.md\":\"EpjQS7KO\",\"workstreams_task6-domain-library_operations-log.md\":\"P0JrxsQP\",\"workstreams_task8-compensation_operations-log.md\":\"kpa9l4lj\",\"workstreams_tasks-11-13_implementation.md\":\"D3cNe9US\",\"workstreams_tasks-2-5_operations-log.md\":\"Cd0yWJpd\",\"workstreams_truffle-phase0_operations-log.md\":\"Bayaeg7M\",\"workstreams_truffle-phase1_operations-log.md\":\"OXora7b2\",\"workstreams_truffle-phase2_operations-log.md\":\"B7pBNZPQ\",\"workstreams_truffle-phase2_variable-flow-analysis.md\":\"DzuGttmw\",\"workstreams_truffle-phase2_verification.md\":\"BOHcBCFK\",\"workstreams_truffle-quickstart_operations-log.md\":\"DAnBsxbN\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Aster Language\",\"description\":\"A pragmatic, safe, fast language with a human CNL surface\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/logo.svg\",\"nav\":[{\"text\":\"Guide\",\"link\":\"/guide/getting-started\"},{\"text\":\"Formatting\",\"link\":\"/guide/formatting\"},{\"text\":\"Reference\",\"link\":\"/reference/syntax\"},{\"text\":\"API\",\"link\":\"/api/overview\"},{\"text\":\"GitHub\",\"link\":\"https://github.com/wontlost-ltd/aster-lang\"}],\"sidebar\":{\"/guide/\":[{\"text\":\"Guide\",\"items\":[{\"text\":\"Getting Started\",\"link\":\"/guide/getting-started\"},{\"text\":\"Language Overview\",\"link\":\"/guide/language-overview\"},{\"text\":\"Examples\",\"link\":\"/guide/examples\"},{\"text\":\"Formatting, LSP & CLI\",\"link\":\"/guide/formatting\"},{\"text\":\"JVM Interop Overloads\",\"link\":\"/guide/interop-overloads\"},{\"text\":\"Contributing\",\"link\":\"/guide/contributing\"}]},{\"text\":\"Package Management\",\"items\":[{\"text\":\"包管理快速入门\",\"link\":\"/guide/getting-started-packages\"},{\"text\":\"包管理系统概述\",\"link\":\"/guide/package-management/overview\"},{\"text\":\"manifest.json 参考\",\"link\":\"/guide/package-management/manifest-reference\"},{\"text\":\"CLI 命令参考\",\"link\":\"/guide/cli/commands\"}]}],\"/reference/\":[{\"text\":\"Reference\",\"items\":[{\"text\":\"Syntax\",\"link\":\"/reference/syntax\"},{\"text\":\"Types\",\"link\":\"/reference/types\"},{\"text\":\"Effects\",\"link\":\"/reference/effects\"}]}],\"/api/\":[{\"text\":\"API\",\"items\":[{\"text\":\"Overview\",\"link\":\"/api/overview\"},{\"text\":\"Canonicalizer\",\"link\":\"/api/canonicalizer\"},{\"text\":\"Lexer\",\"link\":\"/api/lexer\"},{\"text\":\"Parser\",\"link\":\"/api/parser\"},{\"text\":\"Core IR\",\"link\":\"/api/core\"},{\"text\":\"Generated (TypeDoc)\",\"link\":\"/api/typedoc/\"}]}]},\"search\":{\"provider\":\"local\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/wontlost-ltd/aster-lang\"}],\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2025 Aster Language Team\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false,\"additionalConfig\":{}}");</script>
    
  </body>
</html>