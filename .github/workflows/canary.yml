name: Canary

on:
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ts-build:
    name: TypeScript Build
    uses: ./.github/workflows/_reusable-build.yml
    with:
      artifact-name: canary-dist
      node-version: '22'

  canary:
    runs-on: ubuntu-latest
    needs: ts-build
    permissions:
      contents: read
      pull-requests: write
      packages: write
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4

      - name: 初始化发布环境
        uses: ./.github/actions/setup-env
        with:
          checkout: 'false'
          fetch-depth: '0'
          enable-java: 'true'
          enable-gradle: 'true'

      - name: 下载 TypeScript 产物
        uses: actions/download-artifact@v4
        with:
          name: canary-dist
          path: dist/

      - name: 测试
        run: npm run ci

      - name: Compute canary version
        id: canary
        run: |
          BASE=$(node -p "require('./package.json').version")
          SHA=${{ github.sha }}
          SHORT=${SHA::7}
          echo "version=${BASE}-canary.${SHORT}" >> $GITHUB_OUTPUT

      - name: Update package version
        run: |
          node -e "const fs=require('fs'); const pkg=require('./package.json'); pkg.version='${{ steps.canary.outputs.version }}'; fs.writeFileSync('package.json', JSON.stringify(pkg,null,2)+'\n');"

      - name: Publish canary to npm (next tag)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm publish --tag next --access public || echo "Canary publish skipped (likely already exists)"

      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: canary
          message: |
            Published canary: `aster-lang@${{ steps.canary.outputs.version }}` with `next` dist-tag.
