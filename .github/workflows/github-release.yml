name: GitHub Release & Publish

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: Tag to release (e.g. v0.2.1). If omitted, uses ref.
        required: false
      skip-docker:
        description: Skip Docker Hub publishing
        type: boolean
        default: false
      publish-vscode:
        description: Publish VS Code extension
        type: boolean
        default: true
      publish-intellij:
        description: Publish IntelliJ plugin
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY_GHCR: ghcr.io
  REGISTRY_DOCKER: docker.io
  IMAGE_NAME: ${{ github.repository_owner }}/policy-api

jobs:
  # åˆ›å»º GitHub Release
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.tag.outputs.value }}
      version: ${{ steps.tag.outputs.version }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag
        id: tag
        run: |
          TAG="${{ inputs.tag || github.event.release.tag_name || github.ref_name }}"
          echo "value=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: github.event_name != 'release'
        uses: softprops/action-gh-release@v2.0.8
        with:
          tag_name: ${{ steps.tag.outputs.value }}
          name: Release ${{ steps.tag.outputs.value }}
          body: |
            Automated release via tag push or manual dispatch.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip release creation (already exists)
        if: github.event_name == 'release'
        run: echo "::notice::Skipping release creation - triggered by existing release event"

  # npm å‘å¸ƒ (éœ€è¦é…ç½® NPM_TOKEN + ENABLE_NPM_PUBLISH=true)
  npm-publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: release
    if: ${{ vars.ENABLE_NPM_PUBLISH == 'true' }}
    permissions:
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Install and build
        run: |
          npm ci
          npm run build

      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Docker Hub å‘å¸ƒ (éœ€è¦é…ç½® DOCKERHUB_* + ENABLE_DOCKER_PUBLISH=true)
  docker-publish:
    name: Publish to Docker Hub
    runs-on: ubuntu-latest
    needs: release
    if: ${{ !inputs.skip-docker && vars.ENABLE_DOCKER_PUBLISH == 'true' }}
    permissions:
      contents: read
      packages: read
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKER }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GHCR (source)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy image from GHCR to Docker Hub
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          GHCR_IMAGE="${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}"
          DOCKER_IMAGE="${{ env.REGISTRY_DOCKER }}/${{ env.IMAGE_NAME }}"

          # ä» GHCR æ‹‰å–ï¼Œè®°å½•å®é™…ä½¿ç”¨çš„æ ‡ç­¾
          if docker pull "${GHCR_IMAGE}:native-latest"; then
            SOURCE_TAG="native-latest"
          elif docker pull "${GHCR_IMAGE}:latest"; then
            SOURCE_TAG="latest"
          else
            echo "::error::Failed to pull image from GHCR"
            exit 1
          fi

          echo "Using source tag: ${SOURCE_TAG}"

          # æ¨é€åˆ° Docker Hub (å¤šæ ‡ç­¾)
          docker tag "${GHCR_IMAGE}:${SOURCE_TAG}" "${DOCKER_IMAGE}:${VERSION}"
          docker tag "${GHCR_IMAGE}:${SOURCE_TAG}" "${DOCKER_IMAGE}:latest"

          docker push "${DOCKER_IMAGE}:${VERSION}"
          docker push "${DOCKER_IMAGE}:latest"

          echo "::notice::Published to Docker Hub: ${DOCKER_IMAGE}:${VERSION}"

  # Maven Central å‘å¸ƒ (éœ€è¦é…ç½® MAVEN_* + GPG_* + ENABLE_MAVEN_PUBLISH=true)
  maven-publish:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    needs: release
    if: ${{ vars.ENABLE_MAVEN_PUBLISH == 'true' }}
    permissions:
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.tag }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Publish to Maven Central
        run: |
          ./gradlew publishToSonatype closeAndReleaseSonatypeStagingRepository \
            -Psigning.gnupg.keyName=${{ secrets.GPG_KEY_ID }} \
            -Psigning.gnupg.passphrase=${{ secrets.GPG_PASSPHRASE }} \
            -PsonatypeUsername=${{ secrets.MAVEN_USERNAME }} \
            -PsonatypePassword=${{ secrets.MAVEN_PASSWORD }}

  # VS Code æ’ä»¶å‘å¸ƒ (éœ€è¦é…ç½® VSCE_PAT + ENABLE_VSCODE_PUBLISH=true)
  vscode-publish:
    name: Publish VS Code Extension
    runs-on: ubuntu-latest
    needs: release
    # tag pushã€release äº‹ä»¶æˆ–æ‰‹åŠ¨è§¦å‘æ—¶å‘å¸ƒ
    if: ${{ (github.event_name == 'push' || github.event_name == 'release' || inputs.publish-vscode == true) && vars.ENABLE_VSCODE_PUBLISH == 'true' }}
    permissions:
      contents: read
    defaults:
      run:
        working-directory: aster-vscode
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Update version in package.json
        run: npm version ${{ needs.release.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Package extension
        run: npx @vscode/vsce package

      - name: Publish to VS Code Marketplace
        run: npx @vscode/vsce publish -p ${{ secrets.VSCE_PAT }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX Registry
        run: npx ovsx publish -p ${{ secrets.OVSX_TOKEN }}
        env:
          OVSX_TOKEN: ${{ secrets.OVSX_TOKEN }}

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: aster-vscode-${{ needs.release.outputs.version }}.vsix
          path: aster-vscode/*.vsix
          retention-days: 30

  # IntelliJ æ’ä»¶å‘å¸ƒ (éœ€è¦é…ç½® JETBRAINS_TOKEN + ENABLE_INTELLIJ_PUBLISH=true)
  intellij-publish:
    name: Publish IntelliJ Plugin
    runs-on: ubuntu-latest
    needs: release
    # tag pushã€release äº‹ä»¶æˆ–æ‰‹åŠ¨è§¦å‘æ—¶å‘å¸ƒ
    if: ${{ (github.event_name == 'push' || github.event_name == 'release' || inputs.publish-intellij == true) && vars.ENABLE_INTELLIJ_PUBLISH == 'true' }}
    permissions:
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build plugin
        run: ./gradlew :aster-idea:buildPlugin -Pversion=${{ needs.release.outputs.version }}

      - name: Verify plugin
        run: ./gradlew :aster-idea:verifyPlugin

      - name: Publish to JetBrains Marketplace
        run: ./gradlew :aster-idea:publishPlugin
        env:
          JETBRAINS_TOKEN: ${{ secrets.JETBRAINS_TOKEN }}

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: aster-idea-${{ needs.release.outputs.version }}.zip
          path: aster-idea/build/distributions/*.zip
          retention-days: 30

  # å‘å¸ƒæ±‡æ€» - åªä¾èµ–å¿…è·‘çš„ release jobï¼Œé€šè¿‡ API è·å–å…¶ä»– job çŠ¶æ€
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [release]
    if: always()
    permissions:
      actions: read
    steps:
      - name: Wait for all jobs and generate summary
        uses: actions/github-script@v8
        with:
          script: |
            // ç­‰å¾…æ‰€æœ‰ job å®Œæˆï¼ˆè½®è¯¢ç›´åˆ°æ‰€æœ‰ job ç»“æŸï¼‰
            const targetJobs = ['Create GitHub Release', 'Publish to npm', 'Publish to Docker Hub',
                                'Publish to Maven Central', 'Publish VS Code Extension', 'Publish IntelliJ Plugin'];
            let allCompleted = false;
            let jobs;

            for (let i = 0; i < 60; i++) { // æœ€å¤šç­‰å¾… 10 åˆ†é’Ÿ
              const { data } = await github.rest.actions.listJobsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: context.runId
              });
              jobs = data.jobs;

              // æ£€æŸ¥æ‰€æœ‰ç›®æ ‡ job æ˜¯å¦å·²å®Œæˆ
              allCompleted = targetJobs.every(name => {
                const job = jobs.find(j => j.name === name);
                return !job || job.status === 'completed';
              });

              if (allCompleted) break;
              await new Promise(r => setTimeout(r, 10000)); // ç­‰å¾… 10 ç§’
            }

            const getStatus = (name) => {
              const job = jobs.find(j => j.name === name);
              if (!job) return 'â­ï¸';
              if (job.conclusion === 'success') return 'âœ…';
              if (job.conclusion === 'skipped') return 'â­ï¸';
              if (job.conclusion === 'cancelled') return 'ğŸš«';
              return 'âŒ';
            };

            const version = '${{ needs.release.outputs.tag }}';
            const date = new Date().toISOString().slice(0, 16).replace('T', ' ') + ' UTC';

            await core.summary
              .addHeading('Release Summary')
              .addRaw(`**Version**: ${version}\n**Date**: ${date}\n\n`)
              .addHeading('Publish Results', 2)
              .addTable([
                [{data: 'Target', header: true}, {data: 'Status', header: true}],
                ['GitHub Release', getStatus('Create GitHub Release')],
                ['npm', getStatus('Publish to npm')],
                ['Docker Hub', getStatus('Publish to Docker Hub')],
                ['Maven Central', getStatus('Publish to Maven Central')],
                ['VS Code', getStatus('Publish VS Code Extension')],
                ['IntelliJ', getStatus('Publish IntelliJ Plugin')]
              ])
              .write();
