name: E2E Tests

on:
  # PR: 快速 JVM 模式测试
  pull_request:
    branches: [main]
    paths:
      - 'quarkus-policy-api/**'
      - 'docker-compose*.yml'
      - '.github/workflows/e2e-tests.yml'
  # Main push: 复用 build-policy-api 构建的 native 镜像
  workflow_run:
    workflows: ["Build Policy API"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      build-mode:
        description: 'Build mode (native reuses existing image, jvm builds fresh)'
        type: choice
        options:
          - native
          - jvm
        default: 'native'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # PR 场景: 使用 JVM 快速构建
  policy-api-build-pr:
    name: Build (JVM - Fast)
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/_reusable-policy-api-build.yml
    with:
      push-image: true
      image-tag: pr-${{ github.event.pull_request.number }}-${{ github.sha }}
      build-mode: jvm
    permissions:
      contents: read
      packages: write

  # Main push 场景 (workflow_run): 复用已构建的 native 镜像
  e2e-native:
    name: E2E (Native Image)
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      packages: read
    env:
      # 复用 build-policy-api 构建的镜像
      POLICY_API_IMAGE: ghcr.io/${{ github.repository_owner }}/policy-api:native-${{ github.event.workflow_run.head_sha }}
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull pre-built native image
        run: |
          echo "Pulling pre-built native image: $POLICY_API_IMAGE"
          docker pull $POLICY_API_IMAGE

      - name: Start services
        run: docker compose --profile monitoring up -d postgres redis policy-api

      - name: Wait for Policy API
        run: timeout 60 bash -c 'until curl -sf http://localhost:8081/q/health; do sleep 2; done'

      - name: Run E2E checks
        run: |
          curl -sf -X POST http://localhost:8081/graphql \
            -H "Content-Type: application/json" \
            -d '{"query":"{__schema{types{name}}}"}'
          curl -sf http://localhost:8081/q/health/live
          curl -sf http://localhost:8081/q/health/ready
          curl -sf http://localhost:8081/q/metrics | head -n 50

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # PR 场景: E2E 测试
  e2e-pr:
    name: E2E (JVM - Fast)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: policy-api-build-pr
    timeout-minutes: 5
    permissions:
      contents: read
      packages: read
    env:
      POLICY_API_IMAGE: ${{ needs.policy-api-build-pr.outputs.image }}
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start services
        run: docker compose --profile monitoring up -d postgres redis policy-api

      - name: Wait for Policy API
        run: timeout 90 bash -c 'until curl -sf http://localhost:8081/q/health; do sleep 2; done'

      - name: Run E2E checks
        run: |
          curl -sf -X POST http://localhost:8081/graphql \
            -H "Content-Type: application/json" \
            -d '{"query":"{__schema{types{name}}}"}'
          curl -sf http://localhost:8081/q/health/live
          curl -sf http://localhost:8081/q/health/ready
          curl -sf http://localhost:8081/q/metrics | head -n 50

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # 手动触发场景
  policy-api-build-manual:
    name: Build (Manual)
    if: github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/_reusable-policy-api-build.yml
    with:
      push-image: true
      image-tag: manual-${{ github.sha }}
      build-mode: ${{ inputs.build-mode }}
    permissions:
      contents: read
      packages: write

  e2e-manual:
    name: E2E (Manual)
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: policy-api-build-manual
    timeout-minutes: 5
    permissions:
      contents: read
      packages: read
    env:
      POLICY_API_IMAGE: ${{ needs.policy-api-build-manual.outputs.image }}
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start services
        run: docker compose --profile monitoring up -d postgres redis policy-api

      - name: Wait for Policy API
        run: timeout 90 bash -c 'until curl -sf http://localhost:8081/q/health; do sleep 2; done'

      - name: Run E2E checks
        run: |
          curl -sf -X POST http://localhost:8081/graphql \
            -H "Content-Type: application/json" \
            -d '{"query":"{__schema{types{name}}}"}'
          curl -sf http://localhost:8081/q/health/live
          curl -sf http://localhost:8081/q/health/ready
          curl -sf http://localhost:8081/q/metrics | head -n 50

      - name: Cleanup
        if: always()
        run: docker compose down -v
