name: Cleanup Workflow Runs

on:
  workflow_dispatch:
    inputs:
      cleanup_mode:
        description: 'æ¸…ç†æ¨¡å¼'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard           # æŒ‰å¤©æ•°æ¸…ç†è¿‡æœŸè®°å½•
          - failed_only        # ä»…åˆ é™¤æ‰€æœ‰å¤±è´¥çš„è¿è¡Œè®°å½•
          - cancelled_only     # ä»…åˆ é™¤æ‰€æœ‰å·²å–æ¶ˆçš„è¿è¡Œè®°å½•
          - failed_and_cancelled  # åˆ é™¤æ‰€æœ‰å¤±è´¥å’Œå·²å–æ¶ˆçš„è¿è¡Œè®°å½•
      days_old:
        description: 'åˆ é™¤å¤šå°‘å¤©å‰çš„è¿è¡Œè®°å½•ï¼ˆä»… standard æ¨¡å¼ï¼‰'
        required: false
        default: '30'
        type: string
      keep_minimum:
        description: 'æ¯ä¸ªå·¥ä½œæµè‡³å°‘ä¿ç•™å¤šå°‘æ¡è®°å½•ï¼ˆä»… standard æ¨¡å¼ï¼‰'
        required: false
        default: '5'
        type: string
      dry_run:
        description: 'ä»…é¢„è§ˆï¼Œä¸å®žé™…åˆ é™¤'
        required: false
        default: false
        type: boolean
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨ 3 ç‚¹è‡ªåŠ¨æ¸…ç†
    - cron: '0 3 * * 0'

permissions:
  actions: write
  contents: read

jobs:
  # æ ‡å‡†æ¸…ç†æ¨¡å¼ï¼šæŒ‰å¤©æ•°æ¸…ç†è¿‡æœŸè®°å½•
  cleanup:
    name: æ¸…ç†è¿‡æœŸ Workflow Runs
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # ä»…åœ¨ standard æ¨¡å¼æˆ–å®šæ—¶è§¦å‘æ—¶è¿è¡Œ
    if: inputs.cleanup_mode == 'standard' || github.event_name == 'schedule'

    steps:
      - name: æ¸…ç†è¿‡æœŸçš„ Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: ${{ inputs.days_old || '30' }}
          keep_minimum_runs: ${{ inputs.keep_minimum || '5' }}
          delete_workflow_pattern: 'all'
          dry_run: ${{ inputs.dry_run || false }}

      - name: æ¸…ç†ç»Ÿè®¡
        run: |
          echo "## ðŸ§¹ Workflow Runs æ¸…ç†å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¸…ç†æ¨¡å¼**: æ ‡å‡†ï¼ˆæŒ‰å¤©æ•°ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¿ç•™å¤©æ•°**: ${{ inputs.days_old || '30' }} å¤©" >> $GITHUB_STEP_SUMMARY
          echo "- **æœ€å°‘ä¿ç•™**: ${{ inputs.keep_minimum || '5' }} æ¡/å·¥ä½œæµ" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ä¸€é”®æ¸…ç†å¤±è´¥/å–æ¶ˆçš„è¿è¡Œè®°å½•
  cleanup-by-status:
    name: æ¸…ç†å¤±è´¥/å–æ¶ˆçš„ Workflow Runs
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # ä»…åœ¨éž standard æ¨¡å¼æ—¶è¿è¡Œ
    if: inputs.cleanup_mode != 'standard' && github.event_name != 'schedule'

    steps:
      - name: åˆ é™¤æŒ‡å®šçŠ¶æ€çš„ Workflow Runs
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const cleanupMode = '${{ inputs.cleanup_mode }}';
            const dryRun = ${{ inputs.dry_run || false }};

            // æ ¹æ®æ¸…ç†æ¨¡å¼ç¡®å®šè¦åˆ é™¤çš„çŠ¶æ€
            let targetConclusions = [];
            switch (cleanupMode) {
              case 'failed_only':
                targetConclusions = ['failure'];
                break;
              case 'cancelled_only':
                targetConclusions = ['cancelled'];
                break;
              case 'failed_and_cancelled':
                targetConclusions = ['failure', 'cancelled'];
                break;
              default:
                core.setFailed(`æœªçŸ¥çš„æ¸…ç†æ¨¡å¼: ${cleanupMode}`);
                return;
            }

            console.log(`ðŸ” æ¸…ç†æ¨¡å¼: ${cleanupMode}`);
            console.log(`ðŸ“‹ ç›®æ ‡çŠ¶æ€: ${targetConclusions.join(', ')}`);
            console.log(`ðŸ”’ é¢„è§ˆæ¨¡å¼: ${dryRun}`);
            console.log('');

            // èŽ·å–æ‰€æœ‰ workflows
            const workflows = await github.paginate(
              github.rest.actions.listRepoWorkflows,
              { owner, repo, per_page: 100 }
            );

            let totalDeleted = 0;
            let totalSkipped = 0;
            const deletedByWorkflow = {};

            for (const workflow of workflows) {
              console.log(`\nðŸ“ å¤„ç†å·¥ä½œæµ: ${workflow.name}`);
              deletedByWorkflow[workflow.name] = 0;

              // èŽ·å–è¯¥ workflow çš„æ‰€æœ‰è¿è¡Œè®°å½•
              try {
                const runs = await github.paginate(
                  github.rest.actions.listWorkflowRuns,
                  { owner, repo, workflow_id: workflow.id, per_page: 100 }
                );

                for (const run of runs) {
                  // æ£€æŸ¥è¿è¡ŒçŠ¶æ€æ˜¯å¦åœ¨ç›®æ ‡åˆ—è¡¨ä¸­
                  if (targetConclusions.includes(run.conclusion)) {
                    if (dryRun) {
                      console.log(`  [é¢„è§ˆ] å°†åˆ é™¤: #${run.run_number} (${run.conclusion}) - ${run.created_at}`);
                      totalSkipped++;
                    } else {
                      try {
                        await github.rest.actions.deleteWorkflowRun({
                          owner,
                          repo,
                          run_id: run.id
                        });
                        console.log(`  âœ… å·²åˆ é™¤: #${run.run_number} (${run.conclusion}) - ${run.created_at}`);
                        totalDeleted++;
                        deletedByWorkflow[workflow.name]++;
                      } catch (e) {
                        console.log(`  âŒ åˆ é™¤å¤±è´¥: #${run.run_number} - ${e.message}`);
                      }
                    }
                  }
                }
              } catch (e) {
                console.log(`  âš ï¸ èŽ·å–è¿è¡Œè®°å½•å¤±è´¥: ${e.message}`);
              }
            }

            // ç”Ÿæˆæ‘˜è¦
            const modeDescriptions = {
              'failed_only': 'ä»…å¤±è´¥çš„è¿è¡Œ',
              'cancelled_only': 'ä»…å·²å–æ¶ˆçš„è¿è¡Œ',
              'failed_and_cancelled': 'å¤±è´¥å’Œå·²å–æ¶ˆçš„è¿è¡Œ'
            };

            let summaryContent = `## ðŸ§¹ Workflow Runs æ¸…ç†å®Œæˆ\n\n`;
            summaryContent += `- **æ¸…ç†æ¨¡å¼**: ${modeDescriptions[cleanupMode]}\n`;
            summaryContent += `- **é¢„è§ˆæ¨¡å¼**: ${dryRun ? 'æ˜¯ï¼ˆæœªå®žé™…åˆ é™¤ï¼‰' : 'å¦'}\n`;
            summaryContent += `- **åˆ é™¤æ•°é‡**: ${dryRun ? `${totalSkipped} æ¡ï¼ˆé¢„è§ˆï¼‰` : `${totalDeleted} æ¡`}\n`;
            summaryContent += `- **æ‰§è¡Œæ—¶é—´**: ${new Date().toISOString()}\n\n`;

            if (totalDeleted > 0 || totalSkipped > 0) {
              summaryContent += `### æŒ‰å·¥ä½œæµç»Ÿè®¡\n\n`;
              summaryContent += `| å·¥ä½œæµ | åˆ é™¤æ•°é‡ |\n`;
              summaryContent += `|--------|----------|\n`;
              for (const [name, count] of Object.entries(deletedByWorkflow)) {
                if (count > 0) {
                  summaryContent += `| ${name} | ${count} |\n`;
                }
              }
            }

            core.summary.addRaw(summaryContent);
            await core.summary.write();

            console.log(`\nðŸ“Š æ€»è®¡: ${dryRun ? totalSkipped + ' æ¡ï¼ˆé¢„è§ˆï¼‰' : totalDeleted + ' æ¡å·²åˆ é™¤'}`);

            // è®¾ç½®è¾“å‡º
            core.setOutput('deleted_count', dryRun ? 0 : totalDeleted);
            core.setOutput('preview_count', dryRun ? totalSkipped : 0);

  cleanup-caches:
    name: æ¸…ç†è¿‡æœŸ Caches
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # ä»…åœ¨ standard æ¨¡å¼æˆ–å®šæ—¶è§¦å‘æ—¶è¿è¡Œ
    if: inputs.cleanup_mode == 'standard' || github.event_name == 'schedule'

    steps:
      - name: æ¸…ç†è¿‡æœŸç¼“å­˜
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // èŽ·å–æ‰€æœ‰ç¼“å­˜ï¼ˆä½¿ç”¨åˆ†é¡µï¼‰
            const caches = await github.paginate(
              github.rest.actions.getActionsCacheList,
              { owner, repo, per_page: 100 },
              (response) => response.data.actions_caches || []
            );

            const now = new Date();
            const maxAgeDays = 14; // ç¼“å­˜æœ€å¤§ä¿ç•™14å¤©
            let deletedCount = 0;
            let totalSize = 0;

            for (const cache of caches) {
              const cacheDate = new Date(cache.last_accessed_at);
              const ageDays = (now - cacheDate) / (1000 * 60 * 60 * 24);

              if (ageDays > maxAgeDays) {
                try {
                  await github.rest.actions.deleteActionsCacheById({
                    owner,
                    repo,
                    cache_id: cache.id
                  });
                  deletedCount++;
                  totalSize += cache.size_in_bytes || 0;
                  console.log(`å·²åˆ é™¤ç¼“å­˜: ${cache.key} (${ageDays.toFixed(1)} å¤©å‰)`);
                } catch (e) {
                  console.log(`åˆ é™¤å¤±è´¥: ${cache.key} - ${e.message}`);
                }
              }
            }

            // å†™å…¥æ‘˜è¦
            const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            core.summary.addHeading('ðŸ—‘ï¸ ç¼“å­˜æ¸…ç†ç»“æžœ', 2);
            core.summary.addTable([
              [{data: 'æŒ‡æ ‡', header: true}, {data: 'å€¼', header: true}],
              ['åˆ é™¤æ•°é‡', `${deletedCount} ä¸ªç¼“å­˜`],
              ['é‡Šæ”¾ç©ºé—´', `${sizeMB} MB`],
              ['ä¿ç•™å¤©æ•°', `${maxAgeDays} å¤©`]
            ]);
            await core.summary.write();

  cleanup-artifacts:
    name: æ¸…ç†è¿‡æœŸ Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # ä»…åœ¨ standard æ¨¡å¼æˆ–å®šæ—¶è§¦å‘æ—¶è¿è¡Œ
    if: inputs.cleanup_mode == 'standard' || github.event_name == 'schedule'

    steps:
      - name: æ¸…ç†è¿‡æœŸ Artifacts
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // èŽ·å–æ‰€æœ‰ artifacts
            const artifacts = await github.paginate(
              github.rest.actions.listArtifactsForRepo,
              { owner, repo, per_page: 100 }
            );

            const now = new Date();
            const maxAgeDays = 7; // Artifacts æœ€å¤§ä¿ç•™7å¤©
            let deletedCount = 0;
            let totalSize = 0;

            for (const artifact of artifacts) {
              // è·³è¿‡æœªè¿‡æœŸçš„
              if (!artifact.expired) {
                const artifactDate = new Date(artifact.created_at);
                const ageDays = (now - artifactDate) / (1000 * 60 * 60 * 24);

                if (ageDays > maxAgeDays) {
                  try {
                    await github.rest.actions.deleteArtifact({
                      owner,
                      repo,
                      artifact_id: artifact.id
                    });
                    deletedCount++;
                    totalSize += artifact.size_in_bytes || 0;
                    console.log(`å·²åˆ é™¤: ${artifact.name} (${ageDays.toFixed(1)} å¤©å‰)`);
                  } catch (e) {
                    console.log(`åˆ é™¤å¤±è´¥: ${artifact.name} - ${e.message}`);
                  }
                }
              }
            }

            const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            core.summary.addHeading('ðŸ“¦ Artifacts æ¸…ç†ç»“æžœ', 2);
            core.summary.addTable([
              [{data: 'æŒ‡æ ‡', header: true}, {data: 'å€¼', header: true}],
              ['åˆ é™¤æ•°é‡', `${deletedCount} ä¸ª artifacts`],
              ['é‡Šæ”¾ç©ºé—´', `${sizeMB} MB`],
              ['ä¿ç•™å¤©æ•°', `${maxAgeDays} å¤©`]
            ]);
            await core.summary.write();

  summary:
    name: æ¸…ç†æ±‡æ€»
    runs-on: ubuntu-latest
    needs: [cleanup, cleanup-by-status, cleanup-caches, cleanup-artifacts]
    if: always()

    steps:
      - name: ç”Ÿæˆæ¸…ç†æŠ¥å‘Š
        run: |
          echo "## ðŸ§¹ GitHub Actions èµ„æºæ¸…ç†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ¸…ç†æ¨¡å¼: ${{ inputs.cleanup_mode || 'standard' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ‰§è¡ŒçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ä»»åŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY

          # æ ¹æ®æ¸…ç†æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„ä»»åŠ¡çŠ¶æ€
          if [[ "${{ inputs.cleanup_mode }}" == "standard" ]] || [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "| Workflow Runs (æŒ‰å¤©æ•°) | ${{ needs.cleanup.result == 'success' && 'âœ… æˆåŠŸ' || (needs.cleanup.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥') }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Caches | ${{ needs.cleanup-caches.result == 'success' && 'âœ… æˆåŠŸ' || (needs.cleanup-caches.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥') }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Artifacts | ${{ needs.cleanup-artifacts.result == 'success' && 'âœ… æˆåŠŸ' || (needs.cleanup-artifacts.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥') }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Workflow Runs (æŒ‰çŠ¶æ€) | ${{ needs.cleanup-by-status.result == 'success' && 'âœ… æˆåŠŸ' || (needs.cleanup-by-status.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥') }} |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ¸…ç†ç­–ç•¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ inputs.cleanup_mode }}" == "standard" ]] || [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "- **Workflow Runs**: ä¿ç•™ ${{ inputs.days_old || '30' }} å¤©ï¼Œæ¯ä¸ªå·¥ä½œæµè‡³å°‘ ${{ inputs.keep_minimum || '5' }} æ¡" >> $GITHUB_STEP_SUMMARY
            echo "- **Caches**: ä¿ç•™ 14 å¤©å†…è®¿é—®è¿‡çš„ç¼“å­˜" >> $GITHUB_STEP_SUMMARY
            echo "- **Artifacts**: ä¿ç•™ 7 å¤©å†…åˆ›å»ºçš„ artifacts" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ inputs.cleanup_mode }}" == "failed_only" ]]; then
            echo "- **Workflow Runs**: åˆ é™¤æ‰€æœ‰å¤±è´¥çš„è¿è¡Œè®°å½•" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ inputs.cleanup_mode }}" == "cancelled_only" ]]; then
            echo "- **Workflow Runs**: åˆ é™¤æ‰€æœ‰å·²å–æ¶ˆçš„è¿è¡Œè®°å½•" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ inputs.cleanup_mode }}" == "failed_and_cancelled" ]]; then
            echo "- **Workflow Runs**: åˆ é™¤æ‰€æœ‰å¤±è´¥å’Œå·²å–æ¶ˆçš„è¿è¡Œè®°å½•" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*æ‰§è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
