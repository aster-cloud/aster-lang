name: Cleanup Workflow Runs

on:
  workflow_dispatch:
    inputs:
      days_old:
        description: 'åˆ é™¤å¤šå°‘å¤©å‰çš„è¿è¡Œè®°å½•'
        required: false
        default: '30'
        type: string
      keep_minimum:
        description: 'æ¯ä¸ªå·¥ä½œæµè‡³å°‘ä¿ç•™å¤šå°‘æ¡è®°å½•'
        required: false
        default: '5'
        type: string
      dry_run:
        description: 'ä»…é¢„è§ˆï¼Œä¸å®žé™…åˆ é™¤'
        required: false
        default: false
        type: boolean
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨ 3 ç‚¹è‡ªåŠ¨æ¸…ç†
    - cron: '0 3 * * 0'

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    name: æ¸…ç†è¿‡æœŸ Workflow Runs
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: æ¸…ç†è¿‡æœŸçš„ Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: ${{ inputs.days_old || '30' }}
          keep_minimum_runs: ${{ inputs.keep_minimum || '5' }}
          delete_workflow_pattern: 'all'
          dry_run: ${{ inputs.dry_run || false }}

      - name: æ¸…ç†ç»Ÿè®¡
        run: |
          echo "## ðŸ§¹ Workflow Runs æ¸…ç†å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¿ç•™å¤©æ•°**: ${{ inputs.days_old || '30' }} å¤©" >> $GITHUB_STEP_SUMMARY
          echo "- **æœ€å°‘ä¿ç•™**: ${{ inputs.keep_minimum || '5' }} æ¡/å·¥ä½œæµ" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  cleanup-caches:
    name: æ¸…ç†è¿‡æœŸ Caches
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: æ¸…ç†è¿‡æœŸç¼“å­˜
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // èŽ·å–æ‰€æœ‰ç¼“å­˜ï¼ˆä½¿ç”¨åˆ†é¡µï¼‰
            const caches = await github.paginate(
              github.rest.actions.getActionsCacheList,
              { owner, repo, per_page: 100 },
              (response) => response.data.actions_caches || []
            );

            const now = new Date();
            const maxAgeDays = 14; // ç¼“å­˜æœ€å¤§ä¿ç•™14å¤©
            let deletedCount = 0;
            let totalSize = 0;

            for (const cache of caches) {
              const cacheDate = new Date(cache.last_accessed_at);
              const ageDays = (now - cacheDate) / (1000 * 60 * 60 * 24);

              if (ageDays > maxAgeDays) {
                try {
                  await github.rest.actions.deleteActionsCacheById({
                    owner,
                    repo,
                    cache_id: cache.id
                  });
                  deletedCount++;
                  totalSize += cache.size_in_bytes || 0;
                  console.log(`å·²åˆ é™¤ç¼“å­˜: ${cache.key} (${ageDays.toFixed(1)} å¤©å‰)`);
                } catch (e) {
                  console.log(`åˆ é™¤å¤±è´¥: ${cache.key} - ${e.message}`);
                }
              }
            }

            // å†™å…¥æ‘˜è¦
            const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            core.summary.addHeading('ðŸ—‘ï¸ ç¼“å­˜æ¸…ç†ç»“æžœ', 2);
            core.summary.addTable([
              [{data: 'æŒ‡æ ‡', header: true}, {data: 'å€¼', header: true}],
              ['åˆ é™¤æ•°é‡', `${deletedCount} ä¸ªç¼“å­˜`],
              ['é‡Šæ”¾ç©ºé—´', `${sizeMB} MB`],
              ['ä¿ç•™å¤©æ•°', `${maxAgeDays} å¤©`]
            ]);
            await core.summary.write();

  cleanup-artifacts:
    name: æ¸…ç†è¿‡æœŸ Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: æ¸…ç†è¿‡æœŸ Artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // èŽ·å–æ‰€æœ‰ artifacts
            const artifacts = await github.paginate(
              github.rest.actions.listArtifactsForRepo,
              { owner, repo, per_page: 100 }
            );

            const now = new Date();
            const maxAgeDays = 7; // Artifacts æœ€å¤§ä¿ç•™7å¤©
            let deletedCount = 0;
            let totalSize = 0;

            for (const artifact of artifacts) {
              // è·³è¿‡æœªè¿‡æœŸçš„
              if (!artifact.expired) {
                const artifactDate = new Date(artifact.created_at);
                const ageDays = (now - artifactDate) / (1000 * 60 * 60 * 24);

                if (ageDays > maxAgeDays) {
                  try {
                    await github.rest.actions.deleteArtifact({
                      owner,
                      repo,
                      artifact_id: artifact.id
                    });
                    deletedCount++;
                    totalSize += artifact.size_in_bytes || 0;
                    console.log(`å·²åˆ é™¤: ${artifact.name} (${ageDays.toFixed(1)} å¤©å‰)`);
                  } catch (e) {
                    console.log(`åˆ é™¤å¤±è´¥: ${artifact.name} - ${e.message}`);
                  }
                }
              }
            }

            const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            core.summary.addHeading('ðŸ“¦ Artifacts æ¸…ç†ç»“æžœ', 2);
            core.summary.addTable([
              [{data: 'æŒ‡æ ‡', header: true}, {data: 'å€¼', header: true}],
              ['åˆ é™¤æ•°é‡', `${deletedCount} ä¸ª artifacts`],
              ['é‡Šæ”¾ç©ºé—´', `${sizeMB} MB`],
              ['ä¿ç•™å¤©æ•°', `${maxAgeDays} å¤©`]
            ]);
            await core.summary.write();

  summary:
    name: æ¸…ç†æ±‡æ€»
    runs-on: ubuntu-latest
    needs: [cleanup, cleanup-caches, cleanup-artifacts]
    if: always()

    steps:
      - name: ç”Ÿæˆæ¸…ç†æŠ¥å‘Š
        run: |
          echo "## ðŸ§¹ GitHub Actions èµ„æºæ¸…ç†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ‰§è¡ŒçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ä»»åŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Runs | ${{ needs.cleanup.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Caches | ${{ needs.cleanup-caches.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifacts | ${{ needs.cleanup-artifacts.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ¸…ç†ç­–ç•¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Runs**: ä¿ç•™ ${{ inputs.days_old || '30' }} å¤©ï¼Œæ¯ä¸ªå·¥ä½œæµè‡³å°‘ ${{ inputs.keep_minimum || '5' }} æ¡" >> $GITHUB_STEP_SUMMARY
          echo "- **Caches**: ä¿ç•™ 14 å¤©å†…è®¿é—®è¿‡çš„ç¼“å­˜" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts**: ä¿ç•™ 7 å¤©å†…åˆ›å»ºçš„ artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*æ‰§è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
