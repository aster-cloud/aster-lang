name: Build Policy API

on:
  push:
    branches: [main]
    paths:
      - 'quarkus-policy-api/**'
      - 'src/**'
      - 'package.json'
      - '.github/workflows/build-policy-api.yml'
      - '.github/workflows/_reusable-policy-api-build.yml'
  workflow_dispatch:
    inputs:
      build-mode:
        description: 'Build mode'
        type: choice
        options:
          - native
          - jvm
        default: 'native'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-native:
    name: Build Native Image
    uses: ./.github/workflows/_reusable-policy-api-build.yml
    with:
      push-image: true
      image-tag: ${{ github.sha }}
      build-mode: ${{ inputs.build-mode || 'native' }}
    permissions:
      contents: read
      packages: write

  # 同时推送 latest 标签
  tag-latest:
    name: Tag Latest
    runs-on: ubuntu-latest
    needs: build-native
    if: github.ref == 'refs/heads/main'
    permissions:
      packages: write
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag as latest
        run: |
          MODE="${{ inputs.build-mode || 'native' }}"
          docker pull ${{ needs.build-native.outputs.image }}
          docker tag ${{ needs.build-native.outputs.image }} ghcr.io/${{ github.repository_owner }}/policy-api:${MODE}-latest
          docker push ghcr.io/${{ github.repository_owner }}/policy-api:${MODE}-latest

  # 容器安全扫描 (从 ci.yml 迁移)
  security-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: tag-latest
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 15
    permissions:
      contents: read
      packages: read        # 需要读取 GHCR 镜像
      security-events: write
    steps:
      # 登录 GHCR 以便 Trivy 可以拉取私有镜像
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Trivy SARIF scan
        uses: aquasecurity/trivy-action@0.30.0  # 锁定版本，避免供应链风险
        with:
          image-ref: 'ghcr.io/${{ github.repository_owner }}/policy-api:${{ inputs.build-mode || ''native'' }}-latest'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif

      - name: Enforce CRITICAL/HIGH policy
        uses: aquasecurity/trivy-action@0.30.0  # 锁定版本
        with:
          image-ref: 'ghcr.io/${{ github.repository_owner }}/policy-api:${{ inputs.build-mode || ''native'' }}-latest'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
